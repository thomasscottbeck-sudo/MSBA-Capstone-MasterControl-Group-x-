<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="MSBA Capstone Group 3">
<meta name="dcterms.date" content="2026-01-01">

<title>The Revenue Engine V9: Dynamic Semantic Authority</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="mastercontrol_model_v9_files/libs/clipboard/clipboard.min.js"></script>
<script src="mastercontrol_model_v9_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="mastercontrol_model_v9_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="mastercontrol_model_v9_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="mastercontrol_model_v9_files/libs/quarto-html/popper.min.js"></script>
<script src="mastercontrol_model_v9_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="mastercontrol_model_v9_files/libs/quarto-html/anchor.min.js"></script>
<link href="mastercontrol_model_v9_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="mastercontrol_model_v9_files/libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="mastercontrol_model_v9_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="mastercontrol_model_v9_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="mastercontrol_model_v9_files/libs/bootstrap/bootstrap-2b16cb1ea19488d2d80dabb165e63084.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#executive-summary" id="toc-executive-summary" class="nav-link active" data-scroll-target="#executive-summary">Executive Summary</a></li>
  <li><a href="#phase-1-titan-environment-setup" id="toc-phase-1-titan-environment-setup" class="nav-link" data-scroll-target="#phase-1-titan-environment-setup">Phase 1: Titan Environment Setup</a></li>
  <li><a href="#phase-2-titan-domain-engineering" id="toc-phase-2-titan-domain-engineering" class="nav-link" data-scroll-target="#phase-2-titan-domain-engineering">Phase 2: Titan Domain Engineering</a>
  <ul class="collapse">
  <li><a href="#the-titan-feature-definitions" id="toc-the-titan-feature-definitions" class="nav-link" data-scroll-target="#the-titan-feature-definitions">2.1 The Titan Feature Definitions</a></li>
  <li><a href="#the-titan-feature-engineering-pipeline" id="toc-the-titan-feature-engineering-pipeline" class="nav-link" data-scroll-target="#the-titan-feature-engineering-pipeline">2.2 The Titan Feature Engineering Pipeline</a></li>
  <li><a href="#titan-feature-correlation-analysis" id="toc-titan-feature-correlation-analysis" class="nav-link" data-scroll-target="#titan-feature-correlation-analysis">2.3 Titan Feature Correlation Analysis</a></li>
  <li><a href="#feature-matrix-preparation" id="toc-feature-matrix-preparation" class="nav-link" data-scroll-target="#feature-matrix-preparation">2.4 Feature Matrix Preparation</a></li>
  <li><a href="#trainvalidationtest-split-encoding" id="toc-trainvalidationtest-split-encoding" class="nav-link" data-scroll-target="#trainvalidationtest-split-encoding">2.5 Train/Validation/Test Split &amp; Encoding</a></li>
  </ul></li>
  <li><a href="#phase-3-deep-model-tournament" id="toc-phase-3-deep-model-tournament" class="nav-link" data-scroll-target="#phase-3-deep-model-tournament">Phase 3: Deep Model Tournament</a>
  <ul class="collapse">
  <li><a href="#base-model-definitions" id="toc-base-model-definitions" class="nav-link" data-scroll-target="#base-model-definitions">3.1 Base Model Definitions</a></li>
  <li><a href="#hyperparameter-search" id="toc-hyperparameter-search" class="nav-link" data-scroll-target="#hyperparameter-search">3.2 Hyperparameter Search</a></li>
  <li><a href="#stacking-ensemble" id="toc-stacking-ensemble" class="nav-link" data-scroll-target="#stacking-ensemble">3.3 Stacking Ensemble</a></li>
  <li><a href="#final-model-selection-test-evaluation" id="toc-final-model-selection-test-evaluation" class="nav-link" data-scroll-target="#final-model-selection-test-evaluation">3.4 Final Model Selection &amp; Test Evaluation</a></li>
  </ul></li>
  <li><a href="#phase-4-profit-maximization-waste-reduction" id="toc-phase-4-profit-maximization-waste-reduction" class="nav-link" data-scroll-target="#phase-4-profit-maximization-waste-reduction">Phase 4: Profit Maximization &amp; Waste Reduction</a></li>
  <li><a href="#phase-5-executive-dashboard" id="toc-phase-5-executive-dashboard" class="nav-link" data-scroll-target="#phase-5-executive-dashboard">Phase 5: Executive Dashboard</a></li>
  <li><a href="#phase-6-shap-explainability" id="toc-phase-6-shap-explainability" class="nav-link" data-scroll-target="#phase-6-shap-explainability">Phase 6: SHAP Explainability</a></li>
  <li><a href="#the-bottom-line" id="toc-the-bottom-line" class="nav-link" data-scroll-target="#the-bottom-line">The Bottom Line</a></li>
  <li><a href="#phase-9-sponsor-qa-data-validation" id="toc-phase-9-sponsor-qa-data-validation" class="nav-link" data-scroll-target="#phase-9-sponsor-qa-data-validation">Phase 9: Sponsor Q&amp;A Data Validation</a></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="mastercontrol_model_v9.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">The Revenue Engine V9: Dynamic Semantic Authority</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
<p class="subtitle lead">Success-Calibrated Authority Weights &amp; U-Shaped Persona Curve</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>MSBA Capstone Group 3 </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 1, 2026</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="executive-summary" class="level1">
<h1>Executive Summary</h1>
<p><strong>The Objective: Domain Mastery.</strong> V6 proved we could model the data; V7 proves we understand the business. By encoding the “Hidden Gems” (Consultants), correcting for “Toxic Channels” (External Demand Gen), and calculating “Capital Density,” V7 aligns the algorithm with the financial reality of the buyer.</p>
<p><strong>Strategic Discoveries:</strong></p>
<table class="caption-top table">
<colgroup>
<col style="width: 39%">
<col style="width: 32%">
<col style="width: 28%">
</colgroup>
<thead>
<tr class="header">
<th>Discovery</th>
<th>Insight</th>
<th>Impact</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>The “Toxic” Channels</strong></td>
<td>‘External Demand Gen’ and ‘Email’ leads account for 33% of volume but only ~4% conversion</td>
<td>Stop working these leads immediately</td>
</tr>
<tr class="even">
<td><strong>The “Hidden Gems”</strong></td>
<td>Leads with “Not Enough Info” or “Non-manufacturing” actually convert at 30-46%</td>
<td>These are agile consultants/small firms that typical scoring misses</td>
</tr>
<tr class="odd">
<td><strong>Intent Hierarchy Error</strong></td>
<td>A “Webinar” P1 lead is actually lower intent than a generic lead</td>
<td>V7 corrects this classification error</td>
</tr>
<tr class="even">
<td><strong>Capital Density</strong></td>
<td>Pharma/Bio leads carry 3x the budget potential</td>
<td>Weight scoring by industry budget proxy</td>
</tr>
</tbody>
</table>
<p><strong>What Changed from V6:</strong></p>
<table class="caption-top table">
<colgroup>
<col style="width: 26%">
<col style="width: 36%">
<col style="width: 38%">
</colgroup>
<thead>
<tr class="header">
<th>V6 Approach</th>
<th>V7 Titan Upgrade</th>
<th>Business Rationale</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Implicit channel treatment</td>
<td><code>channel_efficiency</code> tiering (Premium/Standard/Toxic)</td>
<td>Identifies unprofitable lead sources</td>
</tr>
<tr class="even">
<td>Missing data as negative</td>
<td><code>is_hidden_gem</code> flag for “Unknown” accounts</td>
<td>Captures high-converting consultants</td>
</tr>
<tr class="odd">
<td>Uniform company sizing</td>
<td><code>capital_density_score</code> industry-weighted</td>
<td>Budget proxy improves prioritization</td>
</tr>
<tr class="even">
<td>Binary priority encoding</td>
<td><code>intent_strength</code> ordinal mapping</td>
<td>Distinguishes true buyer urgency</td>
</tr>
<tr class="odd">
<td>Generic role matching</td>
<td><code>role_product_match</code> alignment score</td>
<td>Routes leads to right product team</td>
</tr>
<tr class="even">
<td>Single-word title scan</td>
<td><code>title_bigrams</code> for key phrases</td>
<td>Captures “document control”, “process engineer”</td>
</tr>
</tbody>
</table>
<hr>
</section>
<section id="phase-1-titan-environment-setup" class="level1">
<h1>Phase 1: Titan Environment Setup</h1>
<p><strong>Why This Matters:</strong> The V6 architecture proved robust. V7 retains the sklearn-compatible CatBoost wrapper and adds domain-specific feature engineering. We use <strong>5-fold cross-validation</strong> (n_iter=50) to balance compute budget with thorough search.</p>
<div id="setup" class="cell" data-message="false" data-execution_count="1">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># PHASE 1: TITAN ENVIRONMENT</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Domain-Optimized Stack with sklearn 1.6+ Compatibility</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> install_if_missing(package_name, import_name<span class="op">=</span><span class="va">None</span>, pip_name<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Install a package if not already available."""</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    import_name <span class="op">=</span> import_name <span class="kw">or</span> package_name.lower()</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    pip_name <span class="op">=</span> pip_name <span class="kw">or</span> import_name</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">__import__</span>(import_name)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>package_name<span class="sc">}</span><span class="ss">: Not found. Installing..."</span>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>            subprocess.check_call(</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>                [sys.executable, <span class="st">"-m"</span>, <span class="st">"pip"</span>, <span class="st">"install"</span>, pip_name, <span class="st">"-q"</span>],</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>                stdout<span class="op">=</span>subprocess.DEVNULL,</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>                stderr<span class="op">=</span>subprocess.DEVNULL</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>package_name<span class="sc">}</span><span class="ss">: Installed successfully!"</span>)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> subprocess.CalledProcessError:</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>package_name<span class="sc">}</span><span class="ss">: Installation failed. Will use fallback."</span>)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="co"># INSTALL DEPENDENCIES</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"V7 TITAN: CHECKING &amp; INSTALLING DEPENDENCIES"</span>)</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>install_if_missing(<span class="st">"pandas"</span>)</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>install_if_missing(<span class="st">"numpy"</span>)</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>install_if_missing(<span class="st">"matplotlib"</span>)</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>install_if_missing(<span class="st">"seaborn"</span>)</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>install_if_missing(<span class="st">"scikit-learn"</span>, import_name<span class="op">=</span><span class="st">"sklearn"</span>, pip_name<span class="op">=</span><span class="st">"scikit-learn"</span>)</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>install_if_missing(<span class="st">"pyprojroot"</span>, import_name<span class="op">=</span><span class="st">"pyprojroot"</span>)</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>install_if_missing(<span class="st">"CatBoost"</span>, import_name<span class="op">=</span><span class="st">"catboost"</span>)</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>install_if_missing(<span class="st">"XGBoost"</span>, import_name<span class="op">=</span><span class="st">"xgboost"</span>)</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>install_if_missing(<span class="st">"LightGBM"</span>, import_name<span class="op">=</span><span class="st">"lightgbm"</span>)</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>install_if_missing(<span class="st">"SHAP"</span>, import_name<span class="op">=</span><span class="st">"shap"</span>)</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a><span class="co"># CORE IMPORTS</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> multiprocessing</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyprojroot <span class="im">import</span> here</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> types <span class="im">import</span> SimpleNamespace  <span class="co"># sklearn 1.6+ compatibility fix</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a><span class="co"># PARALLELISM CONFIGURATION</span></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>N_JOBS <span class="op">=</span> multiprocessing.cpu_count() <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Parallelism: </span><span class="sc">{</span>N_JOBS<span class="sc">}</span><span class="ss"> cores allocated (of </span><span class="sc">{</span>multiprocessing<span class="sc">.</span>cpu_count()<span class="sc">}</span><span class="ss"> available)"</span>)</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a><span class="co"># Core ML</span></span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> (</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>    train_test_split, StratifiedKFold, RandomizedSearchCV, cross_val_predict</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> (</span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>    StandardScaler, LabelEncoder, FunctionTransformer</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.feature_extraction.text <span class="im">import</span> TfidfVectorizer</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.decomposition <span class="im">import</span> TruncatedSVD</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> SimpleImputer</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.base <span class="im">import</span> BaseEstimator, TransformerMixin, ClassifierMixin, clone</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a><span class="co"># Metrics</span></span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> (</span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>    roc_auc_score, roc_curve, precision_recall_curve, average_precision_score,</span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>    classification_report, confusion_matrix, brier_score_loss, log_loss,</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>    f1_score, precision_score, recall_score</span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a><span class="co"># Calibration</span></span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.calibration <span class="im">import</span> CalibratedClassifierCV, calibration_curve</span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensemble &amp; Stacking</span></span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> (</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>    RandomForestClassifier, GradientBoostingClassifier,</span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>    StackingClassifier, VotingClassifier</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LogisticRegression</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a><span class="co"># CATBOOST SKLEARN COMPATIBILITY WRAPPER (V6 FIX - RETAINED)</span></span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a><span class="co"># sklearn 1.6+ requires __sklearn_tags__ to return an object with dot-notation</span></span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a><span class="co"># access. This wrapper uses SimpleNamespace to satisfy the requirement.</span></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>CATBOOST_AVAILABLE <span class="op">=</span> <span class="va">False</span></span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>CATBOOST_RAW_AVAILABLE <span class="op">=</span> <span class="va">False</span></span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> catboost <span class="im">import</span> CatBoostClassifier <span class="im">as</span> CatBoostRaw</span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>    CATBOOST_RAW_AVAILABLE <span class="op">=</span> <span class="va">True</span></span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"CatBoost: Raw import successful"</span>)</span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"CatBoost: Not available"</span>)</span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> CATBOOST_RAW_AVAILABLE:</span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> SklearnCatBoost(BaseEstimator, ClassifierMixin):</span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a><span class="co">        sklearn-compatible CatBoost wrapper.</span></span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a><span class="co">        Fixed for sklearn 1.6+ tag requirements using SimpleNamespace.</span></span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a>        _estimator_type <span class="op">=</span> <span class="st">"classifier"</span></span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, iterations<span class="op">=</span><span class="dv">500</span>, depth<span class="op">=</span><span class="dv">6</span>, learning_rate<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a>                     l2_leaf_reg<span class="op">=</span><span class="dv">3</span>, border_count<span class="op">=</span><span class="dv">64</span>, random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a>                     verbose<span class="op">=</span><span class="dv">0</span>, thread_count<span class="op">=</span><span class="dv">1</span>):  <span class="co"># thread_count=1 for safety</span></span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.iterations <span class="op">=</span> iterations</span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.depth <span class="op">=</span> depth</span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.learning_rate <span class="op">=</span> learning_rate</span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.l2_leaf_reg <span class="op">=</span> l2_leaf_reg</span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.border_count <span class="op">=</span> border_count</span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.random_state <span class="op">=</span> random_state</span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.verbose <span class="op">=</span> verbose</span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.thread_count <span class="op">=</span> thread_count</span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._model <span class="op">=</span> <span class="va">None</span></span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> __sklearn_tags__(<span class="va">self</span>):</span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a>            <span class="co">"""sklearn 1.6+ compatibility: Returns a namespace object."""</span></span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a>            tags <span class="op">=</span> SimpleNamespace()</span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a>            tags.estimator_type <span class="op">=</span> <span class="st">"classifier"</span></span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a>            tags.classifier_tags <span class="op">=</span> SimpleNamespace()</span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a>            tags.regressor_tags <span class="op">=</span> <span class="va">None</span></span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a>            tags.transformer_tags <span class="op">=</span> <span class="va">None</span></span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a>            tags.input_tags <span class="op">=</span> SimpleNamespace(</span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a>                allow_nan<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a>                pairwise<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true" tabindex="-1"></a>                one_d_labels<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true" tabindex="-1"></a>                two_d_labels<span class="op">=</span><span class="va">False</span></span>
<span id="cb1-156"><a href="#cb1-156" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb1-157"><a href="#cb1-157" aria-hidden="true" tabindex="-1"></a>            tags.target_tags <span class="op">=</span> SimpleNamespace(</span>
<span id="cb1-158"><a href="#cb1-158" aria-hidden="true" tabindex="-1"></a>                required_y<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb1-159"><a href="#cb1-159" aria-hidden="true" tabindex="-1"></a>                one_d_labels<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb1-160"><a href="#cb1-160" aria-hidden="true" tabindex="-1"></a>                two_d_labels<span class="op">=</span><span class="va">False</span></span>
<span id="cb1-161"><a href="#cb1-161" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb1-162"><a href="#cb1-162" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> tags</span>
<span id="cb1-163"><a href="#cb1-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-164"><a href="#cb1-164" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> fit(<span class="va">self</span>, X, y, <span class="op">**</span>fit_params):</span>
<span id="cb1-165"><a href="#cb1-165" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._model <span class="op">=</span> CatBoostRaw(</span>
<span id="cb1-166"><a href="#cb1-166" aria-hidden="true" tabindex="-1"></a>                iterations<span class="op">=</span><span class="va">self</span>.iterations,</span>
<span id="cb1-167"><a href="#cb1-167" aria-hidden="true" tabindex="-1"></a>                depth<span class="op">=</span><span class="va">self</span>.depth,</span>
<span id="cb1-168"><a href="#cb1-168" aria-hidden="true" tabindex="-1"></a>                learning_rate<span class="op">=</span><span class="va">self</span>.learning_rate,</span>
<span id="cb1-169"><a href="#cb1-169" aria-hidden="true" tabindex="-1"></a>                l2_leaf_reg<span class="op">=</span><span class="va">self</span>.l2_leaf_reg,</span>
<span id="cb1-170"><a href="#cb1-170" aria-hidden="true" tabindex="-1"></a>                border_count<span class="op">=</span><span class="va">self</span>.border_count,</span>
<span id="cb1-171"><a href="#cb1-171" aria-hidden="true" tabindex="-1"></a>                random_state<span class="op">=</span><span class="va">self</span>.random_state,</span>
<span id="cb1-172"><a href="#cb1-172" aria-hidden="true" tabindex="-1"></a>                verbose<span class="op">=</span><span class="va">self</span>.verbose,</span>
<span id="cb1-173"><a href="#cb1-173" aria-hidden="true" tabindex="-1"></a>                thread_count<span class="op">=</span><span class="va">self</span>.thread_count,</span>
<span id="cb1-174"><a href="#cb1-174" aria-hidden="true" tabindex="-1"></a>                allow_writing_files<span class="op">=</span><span class="va">False</span></span>
<span id="cb1-175"><a href="#cb1-175" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb1-176"><a href="#cb1-176" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._model.fit(X, y, <span class="op">**</span>fit_params)</span>
<span id="cb1-177"><a href="#cb1-177" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.classes_ <span class="op">=</span> np.unique(y)</span>
<span id="cb1-178"><a href="#cb1-178" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span></span>
<span id="cb1-179"><a href="#cb1-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-180"><a href="#cb1-180" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> predict(<span class="va">self</span>, X):</span>
<span id="cb1-181"><a href="#cb1-181" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>._model.predict(X).flatten().astype(<span class="bu">int</span>)</span>
<span id="cb1-182"><a href="#cb1-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-183"><a href="#cb1-183" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> predict_proba(<span class="va">self</span>, X):</span>
<span id="cb1-184"><a href="#cb1-184" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>._model.predict_proba(X)</span>
<span id="cb1-185"><a href="#cb1-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-186"><a href="#cb1-186" aria-hidden="true" tabindex="-1"></a>        <span class="at">@property</span></span>
<span id="cb1-187"><a href="#cb1-187" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> feature_importances_(<span class="va">self</span>):</span>
<span id="cb1-188"><a href="#cb1-188" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>._model.get_feature_importance()</span>
<span id="cb1-189"><a href="#cb1-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-190"><a href="#cb1-190" aria-hidden="true" tabindex="-1"></a>    CATBOOST_AVAILABLE <span class="op">=</span> <span class="va">True</span></span>
<span id="cb1-191"><a href="#cb1-191" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"CatBoost: sklearn-compatible wrapper created"</span>)</span>
<span id="cb1-192"><a href="#cb1-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-193"><a href="#cb1-193" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb1-194"><a href="#cb1-194" aria-hidden="true" tabindex="-1"></a><span class="co"># OTHER BOOSTING LIBRARIES</span></span>
<span id="cb1-195"><a href="#cb1-195" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb1-196"><a href="#cb1-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-197"><a href="#cb1-197" aria-hidden="true" tabindex="-1"></a>XGBOOST_AVAILABLE <span class="op">=</span> <span class="va">False</span></span>
<span id="cb1-198"><a href="#cb1-198" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb1-199"><a href="#cb1-199" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> xgboost <span class="im">import</span> XGBClassifier</span>
<span id="cb1-200"><a href="#cb1-200" aria-hidden="true" tabindex="-1"></a>    XGBOOST_AVAILABLE <span class="op">=</span> <span class="va">True</span></span>
<span id="cb1-201"><a href="#cb1-201" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"XGBoost: Ready"</span>)</span>
<span id="cb1-202"><a href="#cb1-202" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb1-203"><a href="#cb1-203" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"XGBoost: Not available"</span>)</span>
<span id="cb1-204"><a href="#cb1-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-205"><a href="#cb1-205" aria-hidden="true" tabindex="-1"></a>LIGHTGBM_AVAILABLE <span class="op">=</span> <span class="va">False</span></span>
<span id="cb1-206"><a href="#cb1-206" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb1-207"><a href="#cb1-207" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> lightgbm <span class="im">import</span> LGBMClassifier</span>
<span id="cb1-208"><a href="#cb1-208" aria-hidden="true" tabindex="-1"></a>    LIGHTGBM_AVAILABLE <span class="op">=</span> <span class="va">True</span></span>
<span id="cb1-209"><a href="#cb1-209" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"LightGBM: Ready"</span>)</span>
<span id="cb1-210"><a href="#cb1-210" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb1-211"><a href="#cb1-211" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"LightGBM: Not available"</span>)</span>
<span id="cb1-212"><a href="#cb1-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-213"><a href="#cb1-213" aria-hidden="true" tabindex="-1"></a><span class="co"># Target Encoding (sklearn 1.3+)</span></span>
<span id="cb1-214"><a href="#cb1-214" aria-hidden="true" tabindex="-1"></a>TARGET_ENCODER_AVAILABLE <span class="op">=</span> <span class="va">False</span></span>
<span id="cb1-215"><a href="#cb1-215" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb1-216"><a href="#cb1-216" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.preprocessing <span class="im">import</span> TargetEncoder</span>
<span id="cb1-217"><a href="#cb1-217" aria-hidden="true" tabindex="-1"></a>    TARGET_ENCODER_AVAILABLE <span class="op">=</span> <span class="va">True</span></span>
<span id="cb1-218"><a href="#cb1-218" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"TargetEncoder: Ready (sklearn 1.3+)"</span>)</span>
<span id="cb1-219"><a href="#cb1-219" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb1-220"><a href="#cb1-220" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"TargetEncoder: Not available (using manual implementation)"</span>)</span>
<span id="cb1-221"><a href="#cb1-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-222"><a href="#cb1-222" aria-hidden="true" tabindex="-1"></a><span class="co"># SHAP for explainability</span></span>
<span id="cb1-223"><a href="#cb1-223" aria-hidden="true" tabindex="-1"></a>SHAP_AVAILABLE <span class="op">=</span> <span class="va">False</span></span>
<span id="cb1-224"><a href="#cb1-224" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb1-225"><a href="#cb1-225" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> shap</span>
<span id="cb1-226"><a href="#cb1-226" aria-hidden="true" tabindex="-1"></a>    SHAP_AVAILABLE <span class="op">=</span> <span class="va">True</span></span>
<span id="cb1-227"><a href="#cb1-227" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"SHAP: Ready"</span>)</span>
<span id="cb1-228"><a href="#cb1-228" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb1-229"><a href="#cb1-229" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"SHAP: Not available"</span>)</span>
<span id="cb1-230"><a href="#cb1-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-231"><a href="#cb1-231" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb1-232"><a href="#cb1-232" aria-hidden="true" tabindex="-1"></a><span class="co"># PATH CONFIGURATION</span></span>
<span id="cb1-233"><a href="#cb1-233" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb1-234"><a href="#cb1-234" aria-hidden="true" tabindex="-1"></a>DATA_DIR <span class="op">=</span> here(<span class="st">"data"</span>)</span>
<span id="cb1-235"><a href="#cb1-235" aria-hidden="true" tabindex="-1"></a>OUTPUT_DIR <span class="op">=</span> here(<span class="st">"output"</span>)</span>
<span id="cb1-236"><a href="#cb1-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-237"><a href="#cb1-237" aria-hidden="true" tabindex="-1"></a>CLEANED_DATA_PATH <span class="op">=</span> here(<span class="st">"output/Cleaned_QAL_Performance_for_MSBA.csv"</span>)</span>
<span id="cb1-238"><a href="#cb1-238" aria-hidden="true" tabindex="-1"></a>RAW_DATA_PATH <span class="op">=</span> here(<span class="st">"data/QAL Performance for MSBA.csv"</span>)</span>
<span id="cb1-239"><a href="#cb1-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-240"><a href="#cb1-240" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> CLEANED_DATA_PATH.exists():</span>
<span id="cb1-241"><a href="#cb1-241" aria-hidden="true" tabindex="-1"></a>    DATA_PATH <span class="op">=</span> CLEANED_DATA_PATH</span>
<span id="cb1-242"><a href="#cb1-242" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Using cleaned data: </span><span class="sc">{</span>CLEANED_DATA_PATH<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-243"><a href="#cb1-243" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb1-244"><a href="#cb1-244" aria-hidden="true" tabindex="-1"></a>    DATA_PATH <span class="op">=</span> RAW_DATA_PATH</span>
<span id="cb1-245"><a href="#cb1-245" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Fallback to raw data: </span><span class="sc">{</span>RAW_DATA_PATH<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-246"><a href="#cb1-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-247"><a href="#cb1-247" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb1-248"><a href="#cb1-248" aria-hidden="true" tabindex="-1"></a><span class="co"># HYPERPARAMETERS &amp; CONFIGURATION (V7 TITAN)</span></span>
<span id="cb1-249"><a href="#cb1-249" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb1-250"><a href="#cb1-250" aria-hidden="true" tabindex="-1"></a>RANDOM_STATE <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb1-251"><a href="#cb1-251" aria-hidden="true" tabindex="-1"></a>CV_FOLDS <span class="op">=</span> <span class="dv">5</span>  <span class="co"># Robust validation</span></span>
<span id="cb1-252"><a href="#cb1-252" aria-hidden="true" tabindex="-1"></a>N_ITER_SEARCH <span class="op">=</span> <span class="dv">50</span>  <span class="co"># V7: Reduced from 100 to accommodate feature complexity</span></span>
<span id="cb1-253"><a href="#cb1-253" aria-hidden="true" tabindex="-1"></a>TEST_SIZE <span class="op">=</span> <span class="fl">0.20</span></span>
<span id="cb1-254"><a href="#cb1-254" aria-hidden="true" tabindex="-1"></a>VAL_SIZE <span class="op">=</span> <span class="fl">0.15</span></span>
<span id="cb1-255"><a href="#cb1-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-256"><a href="#cb1-256" aria-hidden="true" tabindex="-1"></a><span class="co"># Text Processing</span></span>
<span id="cb1-257"><a href="#cb1-257" aria-hidden="true" tabindex="-1"></a>LSA_COMPONENTS <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb1-258"><a href="#cb1-258" aria-hidden="true" tabindex="-1"></a>TFIDF_MAX_FEATURES <span class="op">=</span> <span class="dv">500</span></span>
<span id="cb1-259"><a href="#cb1-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-260"><a href="#cb1-260" aria-hidden="true" tabindex="-1"></a><span class="co"># Business Parameters</span></span>
<span id="cb1-261"><a href="#cb1-261" aria-hidden="true" tabindex="-1"></a>COST_PER_CALL <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb1-262"><a href="#cb1-262" aria-hidden="true" tabindex="-1"></a>VALUE_PER_SQL <span class="op">=</span> <span class="dv">6000</span></span>
<span id="cb1-263"><a href="#cb1-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-264"><a href="#cb1-264" aria-hidden="true" tabindex="-1"></a><span class="co"># SHAP Sampling</span></span>
<span id="cb1-265"><a href="#cb1-265" aria-hidden="true" tabindex="-1"></a>SHAP_BACKGROUND_SAMPLES <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb1-266"><a href="#cb1-266" aria-hidden="true" tabindex="-1"></a>SHAP_TEST_SAMPLES <span class="op">=</span> <span class="dv">200</span></span>
<span id="cb1-267"><a href="#cb1-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-268"><a href="#cb1-268" aria-hidden="true" tabindex="-1"></a><span class="co"># Visual Configuration</span></span>
<span id="cb1-269"><a href="#cb1-269" aria-hidden="true" tabindex="-1"></a>PROJECT_COLS <span class="op">=</span> {</span>
<span id="cb1-270"><a href="#cb1-270" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Success'</span>: <span class="st">'#00534B'</span>,</span>
<span id="cb1-271"><a href="#cb1-271" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Failure'</span>: <span class="st">'#F05627'</span>,</span>
<span id="cb1-272"><a href="#cb1-272" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Neutral'</span>: <span class="st">'#95a5a6'</span>,</span>
<span id="cb1-273"><a href="#cb1-273" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Highlight'</span>: <span class="st">'#2980b9'</span>,</span>
<span id="cb1-274"><a href="#cb1-274" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Gold'</span>: <span class="st">'#f39c12'</span>,</span>
<span id="cb1-275"><a href="#cb1-275" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Purple'</span>: <span class="st">'#9b59b6'</span>,</span>
<span id="cb1-276"><a href="#cb1-276" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Profit'</span>: <span class="st">'#27ae60'</span>,</span>
<span id="cb1-277"><a href="#cb1-277" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Toxic'</span>: <span class="st">'#e74c3c'</span>,</span>
<span id="cb1-278"><a href="#cb1-278" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Premium'</span>: <span class="st">'#2ecc71'</span></span>
<span id="cb1-279"><a href="#cb1-279" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-280"><a href="#cb1-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-281"><a href="#cb1-281" aria-hidden="true" tabindex="-1"></a>sns.set_theme(style<span class="op">=</span><span class="st">"whitegrid"</span>, context<span class="op">=</span><span class="st">"talk"</span>)</span>
<span id="cb1-282"><a href="#cb1-282" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">'figure.figsize'</span>] <span class="op">=</span> (<span class="dv">14</span>, <span class="dv">8</span>)</span>
<span id="cb1-283"><a href="#cb1-283" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">'axes.titleweight'</span>] <span class="op">=</span> <span class="st">'bold'</span></span>
<span id="cb1-284"><a href="#cb1-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-285"><a href="#cb1-285" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb1-286"><a href="#cb1-286" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"V7 TITAN ENVIRONMENT INITIALIZED"</span>)</span>
<span id="cb1-287"><a href="#cb1-287" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb1-288"><a href="#cb1-288" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Random State: </span><span class="sc">{</span>RANDOM_STATE<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-289"><a href="#cb1-289" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"CV Folds: </span><span class="sc">{</span>CV_FOLDS<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-290"><a href="#cb1-290" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Search Iterations: </span><span class="sc">{</span>N_ITER_SEARCH<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-291"><a href="#cb1-291" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"LSA Components: </span><span class="sc">{</span>LSA_COMPONENTS<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-292"><a href="#cb1-292" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Business: $</span><span class="sc">{</span>COST_PER_CALL<span class="sc">}</span><span class="ss"> cost/call, $</span><span class="sc">{</span>VALUE_PER_SQL<span class="sc">}</span><span class="ss"> value/SQL"</span>)</span>
<span id="cb1-293"><a href="#cb1-293" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"CatBoost sklearn-compatible: </span><span class="sc">{</span>CATBOOST_AVAILABLE<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-294"><a href="#cb1-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-295"><a href="#cb1-295" aria-hidden="true" tabindex="-1"></a>START_TIME <span class="op">=</span> time.time()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>======================================================================
V7 TITAN: CHECKING &amp; INSTALLING DEPENDENCIES
======================================================================</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>======================================================================
Parallelism: 23 cores allocated (of 24 available)
CatBoost: Raw import successful
CatBoost: sklearn-compatible wrapper created
XGBoost: Ready
LightGBM: Ready
TargetEncoder: Ready (sklearn 1.3+)
SHAP: Ready

Using cleaned data: C:\Users\thoma\Repos\MSBA-Capstone-MasterControl-GroupProject\output\Cleaned_QAL_Performance_for_MSBA.csv

======================================================================
V7 TITAN ENVIRONMENT INITIALIZED
======================================================================
Random State: 42
CV Folds: 5
Search Iterations: 50
LSA Components: 20
Business: $50 cost/call, $6000 value/SQL
CatBoost sklearn-compatible: True</code></pre>
</div>
</div>
<hr>
</section>
<section id="phase-2-titan-domain-engineering" class="level1">
<h1>Phase 2: Titan Domain Engineering</h1>
<p><strong>The Strategic Breakthrough:</strong> V7 doesn’t just process data—it encodes <strong>domain expertise</strong>. Every feature below was discovered through forensic analysis of conversion patterns that V6 missed.</p>
<section id="the-titan-feature-definitions" class="level2">
<h2 class="anchored" data-anchor-id="the-titan-feature-definitions">2.1 The Titan Feature Definitions</h2>
<div id="titan-feature-definitions" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># V7 TITAN FEATURE MAPPINGS (Domain-Optimized)</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. INTENT STRENGTH (Ordinal Encoding of Priority)</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Rationale: "Webinar" P1 leads are actually LOWER intent than "Contact Us" P1s.</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co"># The current binary treatment loses this critical signal.</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>INTENT_STRENGTH_MAP <span class="op">=</span> {</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'P1 - Website Pricing'</span>: <span class="dv">5</span>,   <span class="co"># Highest intent: actively checking price</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'P1 - Contact Us'</span>: <span class="dv">5</span>,        <span class="co"># Highest intent: direct outreach</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'P1 - Video Demo'</span>: <span class="dv">3</span>,        <span class="co"># Medium-high: engaged but passive</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'P1 - Live Demo'</span>: <span class="dv">3</span>,         <span class="co"># Medium-high: interested but needs convincing</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'P1 - Webinar Demo'</span>: <span class="dv">1</span>,      <span class="co"># Low intent: passive learning (often "tire kickers")</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">'No Priority'</span>: <span class="dv">1</span>,            <span class="co"># Baseline</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Priority 1'</span>: <span class="dv">2</span>,             <span class="co"># Generic P1 without qualifier</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Priority 2'</span>: <span class="dv">0</span>              <span class="co"># Lowest priority</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Intent Strength Mapping:"</span>)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k, v <span class="kw">in</span> INTENT_STRENGTH_MAP.items():</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. CHANNEL EFFICIENCY (Tiered Lead Source Quality)</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Rationale: 'External Demand Gen' converts at 2.5%. 'Direct/Inbound' converts</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="co"># at 18%+. Treating them equally is a modeling failure.</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>CHANNEL_TIER_MAP <span class="op">=</span> {</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Premium Channels (High conversion, high intent)</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Direct/Inbound'</span>: <span class="st">'Premium'</span>,</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">'SEO'</span>: <span class="st">'Premium'</span>,</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Referrals'</span>: <span class="st">'Premium'</span>,</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standard Channels (Acceptable conversion)</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Online Ads'</span>: <span class="st">'Standard'</span>,</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Directory Listing'</span>: <span class="st">'Standard'</span>,</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Events'</span>: <span class="st">'Standard'</span>,</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Outbound Prospecting'</span>: <span class="st">'Standard'</span>,</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Toxic Channels (Volume without quality)</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Email'</span>: <span class="st">'Toxic'</span>,</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">'External Demand Gen'</span>: <span class="st">'Toxic'</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>CHANNEL_NUMERIC_MAP <span class="op">=</span> {</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Premium'</span>: <span class="dv">3</span>,</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Standard'</span>: <span class="dv">2</span>,</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Toxic'</span>: <span class="dv">1</span>,</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Unknown'</span>: <span class="dv">2</span>  <span class="co"># Default to Standard</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Channel Efficiency Tiers:"</span>)</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> channel, tier <span class="kw">in</span> CHANNEL_TIER_MAP.items():</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>channel<span class="sc">}</span><span class="ss"> -&gt; </span><span class="sc">{</span>tier<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. CAPITAL DENSITY SCORING (Budget Proxy)</span></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Rationale: A "Medium" Pharma company has 3x the budget of a "Medium"</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Consumer Packaged Goods company. Size alone is misleading.</span></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>INDUSTRY_BUDGET_MULTIPLIER <span class="op">=</span> {</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Pharma &amp; BioTech'</span>: <span class="fl">3.0</span>,</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Blood &amp; Biologics'</span>: <span class="fl">2.5</span>,</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Medical Device'</span>: <span class="fl">2.0</span>,</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Non-Life Science'</span>: <span class="fl">1.0</span>,</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Consumer Packaged Goods'</span>: <span class="fl">0.8</span></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>TIER_SIZE_MAP <span class="op">=</span> {</span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Small'</span>: <span class="dv">50</span>,</span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Medium'</span>: <span class="dv">500</span>,</span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Large'</span>: <span class="dv">5000</span></span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Capital Density Components:"</span>)</span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  Industry Multipliers:"</span>, INDUSTRY_BUDGET_MULTIPLIER)</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  Tier Size ($ proxy):"</span>, TIER_SIZE_MAP)</span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. HIDDEN GEM IDENTIFICATION</span></span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a><span class="co"># Rationale: "Not Enough Info Found" and "Non-manufacturing organization" leads</span></span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a><span class="co"># convert at 30-46%. These are consultants, small firms, and agile buyers that</span></span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a><span class="co"># traditional firmographic scoring misses entirely.</span></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>HIDDEN_GEM_SIGNALS <span class="op">=</span> {</span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>    <span class="st">'manufacturing_model'</span>: [<span class="st">'Not Enough Info Found'</span>],</span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>    <span class="st">'industry'</span>: [<span class="st">'Non-manufacturing organization'</span>]</span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Hidden Gem Signals:"</span>)</span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Manufacturing Model: </span><span class="sc">{</span>HIDDEN_GEM_SIGNALS[<span class="st">'manufacturing_model'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Industry: </span><span class="sc">{</span>HIDDEN_GEM_SIGNALS[<span class="st">'industry'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. ROLE-PRODUCT MATCH</span></span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a><span class="co"># Rationale: A "Quality Manager" looking at "Qx" (Quality product) is a better</span></span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a><span class="co"># fit than looking at "Mx" (Manufacturing product). Alignment = faster sales.</span></span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>PRODUCT_ROLE_ALIGNMENT <span class="op">=</span> {</span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Mx'</span>: [<span class="st">'Op'</span>, <span class="st">'Mfg'</span>, <span class="st">'Manuf'</span>, <span class="st">'Production'</span>, <span class="st">'Plant'</span>],</span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Qx'</span>: [<span class="st">'Qual'</span>, <span class="st">'QA'</span>, <span class="st">'QC'</span>, <span class="st">'Compliance'</span>, <span class="st">'Validation'</span>]</span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Role-Product Alignment:"</span>)</span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> product, roles <span class="kw">in</span> PRODUCT_ROLE_ALIGNMENT.items():</span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>product<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>roles<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. HIGH-VALUE TITLE BIGRAMS</span></span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a><span class="co"># Rationale: "Document Control" specialists are 2x more likely to convert.</span></span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a><span class="co"># Single-word title parsing misses these compound phrases.</span></span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a>HIGH_VALUE_BIGRAMS <span class="op">=</span> [</span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a>    <span class="st">'continuous improvement'</span>,</span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a>    <span class="st">'document control'</span>,</span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a>    <span class="st">'process engineer'</span>,</span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a>    <span class="st">'quality systems'</span>,</span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a>    <span class="st">'regulatory affairs'</span>,</span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a>    <span class="st">'quality assurance'</span>,</span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a>    <span class="st">'validation engineer'</span>,</span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a>    <span class="st">'compliance manager'</span></span>
<span id="cb4-130"><a href="#cb4-130" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb4-131"><a href="#cb4-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-132"><a href="#cb4-132" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">High-Value Title Bigrams:"</span>)</span>
<span id="cb4-133"><a href="#cb4-133" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> bigram <span class="kw">in</span> HIGH_VALUE_BIGRAMS:</span>
<span id="cb4-134"><a href="#cb4-134" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  - '</span><span class="sc">{</span>bigram<span class="sc">}</span><span class="ss">'"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Intent Strength Mapping:
  P1 - Website Pricing: 5
  P1 - Contact Us: 5
  P1 - Video Demo: 3
  P1 - Live Demo: 3
  P1 - Webinar Demo: 1
  No Priority: 1
  Priority 1: 2
  Priority 2: 0

Channel Efficiency Tiers:
  Direct/Inbound -&gt; Premium
  SEO -&gt; Premium
  Referrals -&gt; Premium
  Online Ads -&gt; Standard
  Directory Listing -&gt; Standard
  Events -&gt; Standard
  Outbound Prospecting -&gt; Standard
  Email -&gt; Toxic
  External Demand Gen -&gt; Toxic

Capital Density Components:
  Industry Multipliers: {'Pharma &amp; BioTech': 3.0, 'Blood &amp; Biologics': 2.5, 'Medical Device': 2.0, 'Non-Life Science': 1.0, 'Consumer Packaged Goods': 0.8}
  Tier Size ($ proxy): {'Small': 50, 'Medium': 500, 'Large': 5000}

Hidden Gem Signals:
  Manufacturing Model: ['Not Enough Info Found']
  Industry: ['Non-manufacturing organization']

Role-Product Alignment:
  Mx: ['Op', 'Mfg', 'Manuf', 'Production', 'Plant']
  Qx: ['Qual', 'QA', 'QC', 'Compliance', 'Validation']

High-Value Title Bigrams:
  - 'continuous improvement'
  - 'document control'
  - 'process engineer'
  - 'quality systems'
  - 'regulatory affairs'
  - 'quality assurance'
  - 'validation engineer'
  - 'compliance manager'</code></pre>
</div>
</div>
</section>
<section id="the-titan-feature-engineering-pipeline" class="level2">
<h2 class="anchored" data-anchor-id="the-titan-feature-engineering-pipeline">2.2 The Titan Feature Engineering Pipeline</h2>
<div id="titan-pipeline" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># V7 TITAN: DOMAIN-OPTIMIZED DATA PIPELINE</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> clean_and_engineer_titan(filepath):</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">    V7 Titan Data Pipeline: Domain-Optimized Feature Engineering.</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co">    New Features:</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">    1. intent_strength - Ordinal encoding of priority (5=High, 0=Low)</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co">    2. channel_efficiency - Tiered lead source (Premium/Standard/Toxic)</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co">    3. is_hidden_gem - Flag for high-converting "Unknown" accounts</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co">    4. capital_density_score - Industry-weighted budget proxy</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co">    5. role_product_match - Product-title alignment score</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co">    6. title_bigrams - Flags for high-value compound phrases</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"V7 TITAN: DOMAIN-OPTIMIZED FEATURE ENGINEERING"</span>)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load data</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(filepath)</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Loaded: </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">:,}</span><span class="ss"> rows, </span><span class="sc">{</span><span class="bu">len</span>(df.columns)<span class="sc">}</span><span class="ss"> columns"</span>)</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standardize column names</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    df.columns <span class="op">=</span> [c.strip().lower().replace(<span class="st">' '</span>, <span class="st">'_'</span>).replace(<span class="st">'/'</span>, <span class="st">'_'</span>).replace(<span class="st">'-'</span>, <span class="st">'_'</span>)</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">for</span> c <span class="kw">in</span> df.columns]</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Target variable</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'is_success'</span> <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>        success_stages <span class="op">=</span> [<span class="st">'SQL'</span>, <span class="st">'SQO'</span>, <span class="st">'Won'</span>]</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'is_success'</span>] <span class="op">=</span> df[<span class="st">'next_stage__c'</span>].isin(success_stages).astype(<span class="bu">int</span>)</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Target Rate: </span><span class="sc">{</span>df[<span class="st">'is_success'</span>]<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># TITAN FEATURE 1: INTENT STRENGTH</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[1/6] Engineering: intent_strength"</span>)</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'priority'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'intent_strength'</span>] <span class="op">=</span> df[<span class="st">'priority'</span>].<span class="bu">map</span>(INTENT_STRENGTH_MAP).fillna(<span class="dv">1</span>)</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Validation</span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>        intent_conv <span class="op">=</span> df.groupby(<span class="st">'intent_strength'</span>)[<span class="st">'is_success'</span>].agg([<span class="st">'mean'</span>, <span class="st">'count'</span>])</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"  Intent Strength Conversion Rates:"</span>)</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> idx, row <span class="kw">in</span> intent_conv.iterrows():</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"    Level </span><span class="sc">{</span>idx<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>row[<span class="st">'mean'</span>]<span class="sc">:.1%}</span><span class="ss"> (n=</span><span class="sc">{</span>row[<span class="st">'count'</span>]<span class="sc">:,}</span><span class="ss">)"</span>)</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'intent_strength'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"  [WARNING] 'priority' column not found. Defaulting to 1."</span>)</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># TITAN FEATURE 2: CHANNEL EFFICIENCY</span></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[2/6] Engineering: channel_efficiency"</span>)</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>    channel_col <span class="op">=</span> <span class="st">'last_tactic_campaign_channel'</span> <span class="cf">if</span> <span class="st">'last_tactic_campaign_channel'</span> <span class="kw">in</span> df.columns <span class="cf">else</span> <span class="st">'lead_source'</span></span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> channel_col <span class="kw">in</span> df.columns:</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Map to tier</span></span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'channel_tier'</span>] <span class="op">=</span> df[channel_col].<span class="bu">map</span>(CHANNEL_TIER_MAP).fillna(<span class="st">'Standard'</span>)</span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'channel_efficiency'</span>] <span class="op">=</span> df[<span class="st">'channel_tier'</span>].<span class="bu">map</span>(CHANNEL_NUMERIC_MAP)</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Validation</span></span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>        tier_conv <span class="op">=</span> df.groupby(<span class="st">'channel_tier'</span>)[<span class="st">'is_success'</span>].agg([<span class="st">'mean'</span>, <span class="st">'count'</span>])</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"  Channel Tier Conversion Rates:"</span>)</span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> tier <span class="kw">in</span> [<span class="st">'Premium'</span>, <span class="st">'Standard'</span>, <span class="st">'Toxic'</span>]:</span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> tier <span class="kw">in</span> tier_conv.index:</span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>                row <span class="op">=</span> tier_conv.loc[tier]</span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"    </span><span class="sc">{</span>tier<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>row[<span class="st">'mean'</span>]<span class="sc">:.1%}</span><span class="ss"> (n=</span><span class="sc">{</span>row[<span class="st">'count'</span>]<span class="sc">:,}</span><span class="ss">)"</span>)</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'channel_tier'</span>] <span class="op">=</span> <span class="st">'Standard'</span></span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'channel_efficiency'</span>] <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  [WARNING] Channel column not found. Defaulting to Standard."</span>)</span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># TITAN FEATURE 3: HIDDEN GEM IDENTIFICATION</span></span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[3/6] Engineering: is_hidden_gem"</span>)</span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>    model_col <span class="op">=</span> <span class="st">'acct_manufacturing_model'</span> <span class="cf">if</span> <span class="st">'acct_manufacturing_model'</span> <span class="kw">in</span> df.columns <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>    industry_col <span class="op">=</span> <span class="st">'acct_target_industry'</span> <span class="cf">if</span> <span class="st">'acct_target_industry'</span> <span class="kw">in</span> df.columns <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>    site_col <span class="op">=</span> <span class="st">'acct_primary_site_function'</span> <span class="cf">if</span> <span class="st">'acct_primary_site_function'</span> <span class="kw">in</span> df.columns <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>    hidden_gem_mask <span class="op">=</span> pd.Series(<span class="va">False</span>, index<span class="op">=</span>df.index)</span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> model_col:</span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check for "Not Enough Info Found" in manufacturing model</span></span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a>        hidden_gem_mask <span class="op">|=</span> df[model_col].<span class="bu">str</span>.contains(<span class="st">'Not Enough Info'</span>, case<span class="op">=</span><span class="va">False</span>, na<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> site_col:</span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check for "Non-manufacturing organization" in site function</span></span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a>        hidden_gem_mask <span class="op">|=</span> df[site_col].<span class="bu">str</span>.contains(<span class="st">'Non-manufacturing'</span>, case<span class="op">=</span><span class="va">False</span>, na<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> industry_col:</span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check for non-standard industries</span></span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a>        hidden_gem_mask <span class="op">|=</span> df[industry_col].<span class="bu">str</span>.contains(<span class="st">'Non-manufacturing'</span>, case<span class="op">=</span><span class="va">False</span>, na<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'is_hidden_gem'</span>] <span class="op">=</span> hidden_gem_mask.astype(<span class="bu">int</span>)</span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-103"><a href="#cb6-103" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Validation</span></span>
<span id="cb6-104"><a href="#cb6-104" aria-hidden="true" tabindex="-1"></a>    gem_conv <span class="op">=</span> df.groupby(<span class="st">'is_hidden_gem'</span>)[<span class="st">'is_success'</span>].agg([<span class="st">'mean'</span>, <span class="st">'count'</span>])</span>
<span id="cb6-105"><a href="#cb6-105" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"  Hidden Gem Conversion Rates:"</span>)</span>
<span id="cb6-106"><a href="#cb6-106" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, row <span class="kw">in</span> gem_conv.iterrows():</span>
<span id="cb6-107"><a href="#cb6-107" aria-hidden="true" tabindex="-1"></a>        label <span class="op">=</span> <span class="st">"Hidden Gem"</span> <span class="cf">if</span> idx <span class="op">==</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">"Standard"</span></span>
<span id="cb6-108"><a href="#cb6-108" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"    </span><span class="sc">{</span>label<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>row[<span class="st">'mean'</span>]<span class="sc">:.1%}</span><span class="ss"> (n=</span><span class="sc">{</span>row[<span class="st">'count'</span>]<span class="sc">:,}</span><span class="ss">)"</span>)</span>
<span id="cb6-109"><a href="#cb6-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-110"><a href="#cb6-110" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb6-111"><a href="#cb6-111" aria-hidden="true" tabindex="-1"></a>    <span class="co"># TITAN FEATURE 4: CAPITAL DENSITY SCORE</span></span>
<span id="cb6-112"><a href="#cb6-112" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb6-113"><a href="#cb6-113" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[4/6] Engineering: capital_density_score"</span>)</span>
<span id="cb6-114"><a href="#cb6-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-115"><a href="#cb6-115" aria-hidden="true" tabindex="-1"></a>    tier_col <span class="op">=</span> <span class="st">'acct_tier_rollup'</span> <span class="cf">if</span> <span class="st">'acct_tier_rollup'</span> <span class="kw">in</span> df.columns <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb6-116"><a href="#cb6-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-117"><a href="#cb6-117" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> industry_col <span class="kw">and</span> tier_col:</span>
<span id="cb6-118"><a href="#cb6-118" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get industry multiplier</span></span>
<span id="cb6-119"><a href="#cb6-119" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'industry_multiplier'</span>] <span class="op">=</span> df[industry_col].<span class="bu">map</span>(</span>
<span id="cb6-120"><a href="#cb6-120" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> x: <span class="bu">next</span>((v <span class="cf">for</span> k, v <span class="kw">in</span> INDUSTRY_BUDGET_MULTIPLIER.items()</span>
<span id="cb6-121"><a href="#cb6-121" aria-hidden="true" tabindex="-1"></a>                           <span class="cf">if</span> k.lower() <span class="kw">in</span> <span class="bu">str</span>(x).lower()), <span class="fl">1.0</span>)</span>
<span id="cb6-122"><a href="#cb6-122" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb6-123"><a href="#cb6-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-124"><a href="#cb6-124" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get tier size</span></span>
<span id="cb6-125"><a href="#cb6-125" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'tier_size'</span>] <span class="op">=</span> df[tier_col].<span class="bu">map</span>(TIER_SIZE_MAP).fillna(<span class="dv">500</span>)</span>
<span id="cb6-126"><a href="#cb6-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-127"><a href="#cb6-127" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Capital Density = Multiplier * Size</span></span>
<span id="cb6-128"><a href="#cb6-128" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'capital_density_score'</span>] <span class="op">=</span> df[<span class="st">'industry_multiplier'</span>] <span class="op">*</span> df[<span class="st">'tier_size'</span>]</span>
<span id="cb6-129"><a href="#cb6-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-130"><a href="#cb6-130" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Log transform for normalization</span></span>
<span id="cb6-131"><a href="#cb6-131" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'capital_density_log'</span>] <span class="op">=</span> np.log1p(df[<span class="st">'capital_density_score'</span>])</span>
<span id="cb6-132"><a href="#cb6-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-133"><a href="#cb6-133" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Clean up intermediate columns</span></span>
<span id="cb6-134"><a href="#cb6-134" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df.drop(columns<span class="op">=</span>[<span class="st">'industry_multiplier'</span>, <span class="st">'tier_size'</span>], errors<span class="op">=</span><span class="st">'ignore'</span>)</span>
<span id="cb6-135"><a href="#cb6-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-136"><a href="#cb6-136" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Capital Density Range: </span><span class="sc">{</span>df[<span class="st">'capital_density_score'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.0f}</span><span class="ss"> - </span><span class="sc">{</span>df[<span class="st">'capital_density_score'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.0f}</span><span class="ss">"</span>)</span>
<span id="cb6-137"><a href="#cb6-137" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Capital Density Mean: </span><span class="sc">{</span>df[<span class="st">'capital_density_score'</span>]<span class="sc">.</span>mean()<span class="sc">:.0f}</span><span class="ss">"</span>)</span>
<span id="cb6-138"><a href="#cb6-138" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb6-139"><a href="#cb6-139" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'capital_density_score'</span>] <span class="op">=</span> <span class="dv">500</span></span>
<span id="cb6-140"><a href="#cb6-140" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'capital_density_log'</span>] <span class="op">=</span> np.log1p(<span class="dv">500</span>)</span>
<span id="cb6-141"><a href="#cb6-141" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"  [WARNING] Industry/Tier columns not found. Defaulting to 500."</span>)</span>
<span id="cb6-142"><a href="#cb6-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-143"><a href="#cb6-143" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb6-144"><a href="#cb6-144" aria-hidden="true" tabindex="-1"></a>    <span class="co"># TITAN FEATURE 5: ROLE-PRODUCT MATCH</span></span>
<span id="cb6-145"><a href="#cb6-145" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb6-146"><a href="#cb6-146" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[5/6] Engineering: role_product_match"</span>)</span>
<span id="cb6-147"><a href="#cb6-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-148"><a href="#cb6-148" aria-hidden="true" tabindex="-1"></a>    title_col <span class="op">=</span> <span class="st">'contact_lead_title'</span> <span class="cf">if</span> <span class="st">'contact_lead_title'</span> <span class="kw">in</span> df.columns <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb6-149"><a href="#cb6-149" aria-hidden="true" tabindex="-1"></a>    product_col <span class="op">=</span> <span class="st">'product_segment'</span> <span class="cf">if</span> <span class="st">'product_segment'</span> <span class="kw">in</span> df.columns <span class="cf">else</span> <span class="st">'solution_rollup'</span></span>
<span id="cb6-150"><a href="#cb6-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-151"><a href="#cb6-151" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> title_col <span class="kw">and</span> product_col <span class="kw">in</span> df.columns:</span>
<span id="cb6-152"><a href="#cb6-152" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> check_role_product_match(row):</span>
<span id="cb6-153"><a href="#cb6-153" aria-hidden="true" tabindex="-1"></a>            title <span class="op">=</span> <span class="bu">str</span>(row[title_col]).lower() <span class="cf">if</span> pd.notna(row[title_col]) <span class="cf">else</span> <span class="st">''</span></span>
<span id="cb6-154"><a href="#cb6-154" aria-hidden="true" tabindex="-1"></a>            product <span class="op">=</span> <span class="bu">str</span>(row[product_col]) <span class="cf">if</span> pd.notna(row[product_col]) <span class="cf">else</span> <span class="st">''</span></span>
<span id="cb6-155"><a href="#cb6-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-156"><a href="#cb6-156" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> product <span class="kw">in</span> PRODUCT_ROLE_ALIGNMENT:</span>
<span id="cb6-157"><a href="#cb6-157" aria-hidden="true" tabindex="-1"></a>                keywords <span class="op">=</span> PRODUCT_ROLE_ALIGNMENT[product]</span>
<span id="cb6-158"><a href="#cb6-158" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> kw <span class="kw">in</span> keywords:</span>
<span id="cb6-159"><a href="#cb6-159" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> kw.lower() <span class="kw">in</span> title:</span>
<span id="cb6-160"><a href="#cb6-160" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb6-161"><a href="#cb6-161" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb6-162"><a href="#cb6-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-163"><a href="#cb6-163" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'role_product_match'</span>] <span class="op">=</span> df.<span class="bu">apply</span>(check_role_product_match, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb6-164"><a href="#cb6-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-165"><a href="#cb6-165" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Validation</span></span>
<span id="cb6-166"><a href="#cb6-166" aria-hidden="true" tabindex="-1"></a>        match_conv <span class="op">=</span> df.groupby(<span class="st">'role_product_match'</span>)[<span class="st">'is_success'</span>].agg([<span class="st">'mean'</span>, <span class="st">'count'</span>])</span>
<span id="cb6-167"><a href="#cb6-167" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"  Role-Product Match Conversion:"</span>)</span>
<span id="cb6-168"><a href="#cb6-168" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> idx, row <span class="kw">in</span> match_conv.iterrows():</span>
<span id="cb6-169"><a href="#cb6-169" aria-hidden="true" tabindex="-1"></a>            label <span class="op">=</span> <span class="st">"Matched"</span> <span class="cf">if</span> idx <span class="op">==</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">"Not Matched"</span></span>
<span id="cb6-170"><a href="#cb6-170" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"    </span><span class="sc">{</span>label<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>row[<span class="st">'mean'</span>]<span class="sc">:.1%}</span><span class="ss"> (n=</span><span class="sc">{</span>row[<span class="st">'count'</span>]<span class="sc">:,}</span><span class="ss">)"</span>)</span>
<span id="cb6-171"><a href="#cb6-171" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb6-172"><a href="#cb6-172" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'role_product_match'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-173"><a href="#cb6-173" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"  [WARNING] Title/Product columns not found. Defaulting to 0."</span>)</span>
<span id="cb6-174"><a href="#cb6-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-175"><a href="#cb6-175" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb6-176"><a href="#cb6-176" aria-hidden="true" tabindex="-1"></a>    <span class="co"># TITAN FEATURE 6: TITLE BIGRAMS</span></span>
<span id="cb6-177"><a href="#cb6-177" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb6-178"><a href="#cb6-178" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[6/6] Engineering: title_bigrams"</span>)</span>
<span id="cb6-179"><a href="#cb6-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-180"><a href="#cb6-180" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> title_col <span class="kw">and</span> title_col <span class="kw">in</span> df.columns:</span>
<span id="cb6-181"><a href="#cb6-181" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> bigram <span class="kw">in</span> HIGH_VALUE_BIGRAMS:</span>
<span id="cb6-182"><a href="#cb6-182" aria-hidden="true" tabindex="-1"></a>            col_name <span class="op">=</span> <span class="st">'has_'</span> <span class="op">+</span> bigram.replace(<span class="st">' '</span>, <span class="st">'_'</span>)</span>
<span id="cb6-183"><a href="#cb6-183" aria-hidden="true" tabindex="-1"></a>            df[col_name] <span class="op">=</span> df[title_col].<span class="bu">str</span>.lower().<span class="bu">str</span>.contains(bigram, na<span class="op">=</span><span class="va">False</span>).astype(<span class="bu">int</span>)</span>
<span id="cb6-184"><a href="#cb6-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-185"><a href="#cb6-185" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Summary count</span></span>
<span id="cb6-186"><a href="#cb6-186" aria-hidden="true" tabindex="-1"></a>        bigram_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> df.columns <span class="cf">if</span> c.startswith(<span class="st">'has_'</span>)]</span>
<span id="cb6-187"><a href="#cb6-187" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'title_bigram_count'</span>] <span class="op">=</span> df[bigram_cols].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb6-188"><a href="#cb6-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-189"><a href="#cb6-189" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Created </span><span class="sc">{</span><span class="bu">len</span>(bigram_cols)<span class="sc">}</span><span class="ss"> bigram flags"</span>)</span>
<span id="cb6-190"><a href="#cb6-190" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Leads with 1+ bigram: </span><span class="sc">{</span>(df[<span class="st">'title_bigram_count'</span>] <span class="op">&gt;</span> <span class="dv">0</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb6-191"><a href="#cb6-191" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb6-192"><a href="#cb6-192" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'title_bigram_count'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-193"><a href="#cb6-193" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"  [WARNING] Title column not found. Skipping bigrams."</span>)</span>
<span id="cb6-194"><a href="#cb6-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-195"><a href="#cb6-195" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb6-196"><a href="#cb6-196" aria-hidden="true" tabindex="-1"></a>    <span class="co"># RETAINED V6 FEATURES</span></span>
<span id="cb6-197"><a href="#cb6-197" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb6-198"><a href="#cb6-198" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb6-199"><a href="#cb6-199" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"RETAINING V6 FEATURES"</span>)</span>
<span id="cb6-200"><a href="#cb6-200" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb6-201"><a href="#cb6-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-202"><a href="#cb6-202" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Product segmentation</span></span>
<span id="cb6-203"><a href="#cb6-203" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'product_segment'</span> <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb6-204"><a href="#cb6-204" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> segment_product(sol):</span>
<span id="cb6-205"><a href="#cb6-205" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">str</span>(sol) <span class="op">==</span> <span class="st">'Mx'</span>: <span class="cf">return</span> <span class="st">'Mx'</span></span>
<span id="cb6-206"><a href="#cb6-206" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> <span class="bu">str</span>(sol) <span class="op">==</span> <span class="st">'Qx'</span>: <span class="cf">return</span> <span class="st">'Qx'</span></span>
<span id="cb6-207"><a href="#cb6-207" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">'Other'</span></span>
<span id="cb6-208"><a href="#cb6-208" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'product_segment'</span>] <span class="op">=</span> df[<span class="st">'solution_rollup'</span>].<span class="bu">apply</span>(segment_product)</span>
<span id="cb6-209"><a href="#cb6-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-210"><a href="#cb6-210" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Title parsing (Seniority, Function, Scope)</span></span>
<span id="cb6-211"><a href="#cb6-211" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'title_seniority'</span> <span class="kw">not</span> <span class="kw">in</span> df.columns <span class="kw">and</span> title_col <span class="kw">and</span> title_col <span class="kw">in</span> df.columns:</span>
<span id="cb6-212"><a href="#cb6-212" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> parse_seniority(t):</span>
<span id="cb6-213"><a href="#cb6-213" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pd.isna(t): <span class="cf">return</span> <span class="st">'Unknown'</span></span>
<span id="cb6-214"><a href="#cb6-214" aria-hidden="true" tabindex="-1"></a>            t <span class="op">=</span> <span class="bu">str</span>(t).lower()</span>
<span id="cb6-215"><a href="#cb6-215" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> re.search(<span class="vs">r'</span><span class="dv">\b</span><span class="kw">(</span><span class="vs">ceo</span><span class="cf">|</span><span class="vs">cfo</span><span class="cf">|</span><span class="vs">coo</span><span class="cf">|</span><span class="vs">cto</span><span class="cf">|</span><span class="vs">cio</span><span class="cf">|</span><span class="vs">chief</span><span class="cf">|</span><span class="vs">c-level</span><span class="cf">|</span><span class="vs">president</span><span class="kw">)</span><span class="dv">\b</span><span class="vs">'</span>, t): <span class="cf">return</span> <span class="st">'C-Suite'</span></span>
<span id="cb6-216"><a href="#cb6-216" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> re.search(<span class="vs">r'</span><span class="dv">\b</span><span class="kw">(</span><span class="vs">svp</span><span class="cf">|</span><span class="vs">senior vice president</span><span class="cf">|</span><span class="vs">evp</span><span class="kw">)</span><span class="dv">\b</span><span class="vs">'</span>, t): <span class="cf">return</span> <span class="st">'SVP'</span></span>
<span id="cb6-217"><a href="#cb6-217" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> re.search(<span class="vs">r'</span><span class="dv">\b</span><span class="kw">(</span><span class="vs">vp</span><span class="cf">|</span><span class="vs">vice president</span><span class="kw">)</span><span class="dv">\b</span><span class="vs">'</span>, t): <span class="cf">return</span> <span class="st">'VP'</span></span>
<span id="cb6-218"><a href="#cb6-218" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> re.search(<span class="vs">r'</span><span class="dv">\b</span><span class="kw">(</span><span class="vs">director</span><span class="cf">|</span><span class="vs">head of</span><span class="kw">)</span><span class="dv">\b</span><span class="vs">'</span>, t): <span class="cf">return</span> <span class="st">'Director'</span></span>
<span id="cb6-219"><a href="#cb6-219" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> re.search(<span class="vs">r'</span><span class="dv">\b</span><span class="kw">(</span><span class="vs">manager</span><span class="cf">|</span><span class="vs">mgr</span><span class="cf">|</span><span class="vs">supervisor</span><span class="cf">|</span><span class="vs">lead</span><span class="kw">)</span><span class="dv">\b</span><span class="vs">'</span>, t): <span class="cf">return</span> <span class="st">'Manager'</span></span>
<span id="cb6-220"><a href="#cb6-220" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> re.search(<span class="vs">r'</span><span class="dv">\b</span><span class="kw">(</span><span class="vs">analyst</span><span class="cf">|</span><span class="vs">engineer</span><span class="cf">|</span><span class="vs">specialist</span><span class="cf">|</span><span class="vs">associate</span><span class="cf">|</span><span class="vs">coordinator</span><span class="kw">)</span><span class="dv">\b</span><span class="vs">'</span>, t): <span class="cf">return</span> <span class="st">'IC'</span></span>
<span id="cb6-221"><a href="#cb6-221" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">'Other'</span></span>
<span id="cb6-222"><a href="#cb6-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-223"><a href="#cb6-223" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> parse_function(t):</span>
<span id="cb6-224"><a href="#cb6-224" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pd.isna(t): <span class="cf">return</span> <span class="st">'Unknown'</span></span>
<span id="cb6-225"><a href="#cb6-225" aria-hidden="true" tabindex="-1"></a>            t <span class="op">=</span> <span class="bu">str</span>(t).lower()</span>
<span id="cb6-226"><a href="#cb6-226" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> re.search(<span class="vs">r'</span><span class="dv">\b</span><span class="kw">(</span><span class="vs">quality</span><span class="cf">|</span><span class="vs">qa</span><span class="cf">|</span><span class="vs">qc</span><span class="cf">|</span><span class="vs">qms</span><span class="cf">|</span><span class="vs">compliance</span><span class="cf">|</span><span class="vs">validation</span><span class="cf">|</span><span class="vs">capa</span><span class="kw">)</span><span class="dv">\b</span><span class="vs">'</span>, t): <span class="cf">return</span> <span class="st">'Quality'</span></span>
<span id="cb6-227"><a href="#cb6-227" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> re.search(<span class="vs">r'</span><span class="dv">\b</span><span class="kw">(</span><span class="vs">regulatory</span><span class="cf">|</span><span class="vs">reg affairs</span><span class="cf">|</span><span class="vs">submissions</span><span class="kw">)</span><span class="dv">\b</span><span class="vs">'</span>, t): <span class="cf">return</span> <span class="st">'Regulatory'</span></span>
<span id="cb6-228"><a href="#cb6-228" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> re.search(<span class="vs">r'</span><span class="dv">\b</span><span class="kw">(</span><span class="vs">manufacturing</span><span class="cf">|</span><span class="vs">production</span><span class="cf">|</span><span class="vs">operations</span><span class="cf">|</span><span class="vs">ops</span><span class="cf">|</span><span class="vs">plant</span><span class="cf">|</span><span class="vs">supply</span><span class="kw">)</span><span class="dv">\b</span><span class="vs">'</span>, t): <span class="cf">return</span> <span class="st">'Mfg/Ops'</span></span>
<span id="cb6-229"><a href="#cb6-229" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> re.search(<span class="vs">r'</span><span class="dv">\b</span><span class="kw">(</span><span class="vs">it</span><span class="cf">|</span><span class="vs">information tech</span><span class="cf">|</span><span class="vs">software</span><span class="cf">|</span><span class="vs">systems</span><span class="cf">|</span><span class="vs">data</span><span class="kw">)</span><span class="dv">\b</span><span class="vs">'</span>, t): <span class="cf">return</span> <span class="st">'IT'</span></span>
<span id="cb6-230"><a href="#cb6-230" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> re.search(<span class="vs">r'</span><span class="dv">\b</span><span class="kw">(</span><span class="vs">r&amp;d</span><span class="cf">|</span><span class="vs">research</span><span class="cf">|</span><span class="vs">development</span><span class="cf">|</span><span class="vs">scientist</span><span class="cf">|</span><span class="vs">clinical</span><span class="cf">|</span><span class="vs">lab</span><span class="kw">)</span><span class="dv">\b</span><span class="vs">'</span>, t): <span class="cf">return</span> <span class="st">'R&amp;D'</span></span>
<span id="cb6-231"><a href="#cb6-231" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> re.search(<span class="vs">r'</span><span class="dv">\b</span><span class="kw">(</span><span class="vs">project</span><span class="cf">|</span><span class="vs">program</span><span class="cf">|</span><span class="vs">pmo</span><span class="kw">)</span><span class="dv">\b</span><span class="vs">'</span>, t): <span class="cf">return</span> <span class="st">'PMO'</span></span>
<span id="cb6-232"><a href="#cb6-232" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">'Other'</span></span>
<span id="cb6-233"><a href="#cb6-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-234"><a href="#cb6-234" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> parse_scope(t):</span>
<span id="cb6-235"><a href="#cb6-235" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pd.isna(t): <span class="cf">return</span> <span class="st">'Standard'</span></span>
<span id="cb6-236"><a href="#cb6-236" aria-hidden="true" tabindex="-1"></a>            t <span class="op">=</span> <span class="bu">str</span>(t).lower()</span>
<span id="cb6-237"><a href="#cb6-237" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> re.search(<span class="vs">r'</span><span class="dv">\b</span><span class="kw">(</span><span class="vs">global</span><span class="cf">|</span><span class="vs">worldwide</span><span class="cf">|</span><span class="vs">international</span><span class="cf">|</span><span class="vs">corporate</span><span class="cf">|</span><span class="vs">enterprise</span><span class="kw">)</span><span class="dv">\b</span><span class="vs">'</span>, t): <span class="cf">return</span> <span class="st">'Global'</span></span>
<span id="cb6-238"><a href="#cb6-238" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> re.search(<span class="vs">r'</span><span class="dv">\b</span><span class="kw">(</span><span class="vs">regional</span><span class="cf">|</span><span class="vs">division</span><span class="cf">|</span><span class="vs">group</span><span class="kw">)</span><span class="dv">\b</span><span class="vs">'</span>, t): <span class="cf">return</span> <span class="st">'Regional'</span></span>
<span id="cb6-239"><a href="#cb6-239" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> re.search(<span class="vs">r'</span><span class="dv">\b</span><span class="kw">(</span><span class="vs">site</span><span class="cf">|</span><span class="vs">plant</span><span class="cf">|</span><span class="vs">facility</span><span class="cf">|</span><span class="vs">local</span><span class="kw">)</span><span class="dv">\b</span><span class="vs">'</span>, t): <span class="cf">return</span> <span class="st">'Site'</span></span>
<span id="cb6-240"><a href="#cb6-240" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">'Standard'</span></span>
<span id="cb6-241"><a href="#cb6-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-242"><a href="#cb6-242" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'title_seniority'</span>] <span class="op">=</span> df[title_col].<span class="bu">apply</span>(parse_seniority)</span>
<span id="cb6-243"><a href="#cb6-243" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'title_function'</span>] <span class="op">=</span> df[title_col].<span class="bu">apply</span>(parse_function)</span>
<span id="cb6-244"><a href="#cb6-244" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'title_scope'</span>] <span class="op">=</span> df[title_col].<span class="bu">apply</span>(parse_scope)</span>
<span id="cb6-245"><a href="#cb6-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-246"><a href="#cb6-246" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Decision maker flag</span></span>
<span id="cb6-247"><a href="#cb6-247" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'is_decision_maker'</span> <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb6-248"><a href="#cb6-248" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'is_decision_maker'</span>] <span class="op">=</span> df[<span class="st">'title_seniority'</span>].isin([<span class="st">'C-Suite'</span>, <span class="st">'SVP'</span>, <span class="st">'VP'</span>, <span class="st">'Director'</span>]).astype(<span class="bu">int</span>)</span>
<span id="cb6-249"><a href="#cb6-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-250"><a href="#cb6-250" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Temporal features</span></span>
<span id="cb6-251"><a href="#cb6-251" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'cohort_date'</span> <span class="kw">in</span> df.columns <span class="kw">or</span> <span class="st">'qal_cohort_date'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb6-252"><a href="#cb6-252" aria-hidden="true" tabindex="-1"></a>        cohort_col <span class="op">=</span> <span class="st">'qal_cohort_date'</span> <span class="cf">if</span> <span class="st">'qal_cohort_date'</span> <span class="kw">in</span> df.columns <span class="cf">else</span> <span class="st">'cohort_date'</span></span>
<span id="cb6-253"><a href="#cb6-253" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'cohort_date'</span>] <span class="op">=</span> pd.to_datetime(df[cohort_col], errors<span class="op">=</span><span class="st">'coerce'</span>)</span>
<span id="cb6-254"><a href="#cb6-254" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'lead_age_days'</span> <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb6-255"><a href="#cb6-255" aria-hidden="true" tabindex="-1"></a>            snapshot_date <span class="op">=</span> df[<span class="st">'cohort_date'</span>].<span class="bu">max</span>()</span>
<span id="cb6-256"><a href="#cb6-256" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">'lead_age_days'</span>] <span class="op">=</span> (snapshot_date <span class="op">-</span> df[<span class="st">'cohort_date'</span>]).dt.days</span>
<span id="cb6-257"><a href="#cb6-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-258"><a href="#cb6-258" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Velocity tiers</span></span>
<span id="cb6-259"><a href="#cb6-259" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'lead_age_days'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb6-260"><a href="#cb6-260" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'velocity_tier'</span>] <span class="op">=</span> pd.cut(</span>
<span id="cb6-261"><a href="#cb6-261" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">'lead_age_days'</span>].fillna(<span class="dv">0</span>),</span>
<span id="cb6-262"><a href="#cb6-262" aria-hidden="true" tabindex="-1"></a>            bins<span class="op">=</span>[<span class="op">-</span><span class="dv">1</span>, <span class="dv">30</span>, <span class="dv">60</span>, <span class="dv">90</span>, <span class="dv">180</span>, <span class="dv">9999</span>],</span>
<span id="cb6-263"><a href="#cb6-263" aria-hidden="true" tabindex="-1"></a>            labels<span class="op">=</span>[<span class="st">'Hot'</span>, <span class="st">'Warm'</span>, <span class="st">'Cooling'</span>, <span class="st">'Cold'</span>, <span class="st">'Stale'</span>]</span>
<span id="cb6-264"><a href="#cb6-264" aria-hidden="true" tabindex="-1"></a>        ).astype(<span class="bu">str</span>)</span>
<span id="cb6-265"><a href="#cb6-265" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'is_fresh'</span>] <span class="op">=</span> (df[<span class="st">'lead_age_days'</span>] <span class="op">&lt;=</span> <span class="dv">30</span>).astype(<span class="bu">int</span>)</span>
<span id="cb6-266"><a href="#cb6-266" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'is_stale'</span>] <span class="op">=</span> (df[<span class="st">'lead_age_days'</span>] <span class="op">&gt;</span> <span class="dv">180</span>).astype(<span class="bu">int</span>)</span>
<span id="cb6-267"><a href="#cb6-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-268"><a href="#cb6-268" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Power Trio interactions (V6)</span></span>
<span id="cb6-269"><a href="#cb6-269" aria-hidden="true" tabindex="-1"></a>    seniority_col <span class="op">=</span> <span class="st">'title_seniority'</span> <span class="cf">if</span> <span class="st">'title_seniority'</span> <span class="kw">in</span> df.columns <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb6-270"><a href="#cb6-270" aria-hidden="true" tabindex="-1"></a>    industry_col <span class="op">=</span> <span class="st">'acct_target_industry'</span> <span class="cf">if</span> <span class="st">'acct_target_industry'</span> <span class="kw">in</span> df.columns <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb6-271"><a href="#cb6-271" aria-hidden="true" tabindex="-1"></a>    model_col <span class="op">=</span> <span class="st">'acct_manufacturing_model'</span> <span class="cf">if</span> <span class="st">'acct_manufacturing_model'</span> <span class="kw">in</span> df.columns <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb6-272"><a href="#cb6-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-273"><a href="#cb6-273" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> seniority_col <span class="kw">and</span> industry_col <span class="kw">and</span> model_col:</span>
<span id="cb6-274"><a href="#cb6-274" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'seniority_x_industry'</span>] <span class="op">=</span> df[seniority_col].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> df[industry_col].astype(<span class="bu">str</span>)</span>
<span id="cb6-275"><a href="#cb6-275" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'seniority_x_model'</span>] <span class="op">=</span> df[seniority_col].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> df[model_col].astype(<span class="bu">str</span>)</span>
<span id="cb6-276"><a href="#cb6-276" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'industry_x_model'</span>] <span class="op">=</span> df[industry_col].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> df[model_col].astype(<span class="bu">str</span>)</span>
<span id="cb6-277"><a href="#cb6-277" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'power_trio'</span>] <span class="op">=</span> (df[seniority_col].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span></span>
<span id="cb6-278"><a href="#cb6-278" aria-hidden="true" tabindex="-1"></a>                           df[industry_col].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span></span>
<span id="cb6-279"><a href="#cb6-279" aria-hidden="true" tabindex="-1"></a>                           df[model_col].astype(<span class="bu">str</span>))</span>
<span id="cb6-280"><a href="#cb6-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-281"><a href="#cb6-281" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Golden Segment (V6)</span></span>
<span id="cb6-282"><a href="#cb6-282" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> seniority_col <span class="kw">and</span> industry_col <span class="kw">and</span> model_col:</span>
<span id="cb6-283"><a href="#cb6-283" aria-hidden="true" tabindex="-1"></a>        senior_mask <span class="op">=</span> df[seniority_col].isin([<span class="st">'Director'</span>, <span class="st">'VP'</span>, <span class="st">'SVP'</span>, <span class="st">'C-Suite'</span>])</span>
<span id="cb6-284"><a href="#cb6-284" aria-hidden="true" tabindex="-1"></a>        pharma_mask <span class="op">=</span> df[industry_col].<span class="bu">str</span>.contains(<span class="st">'Pharma|Life|Bio'</span>, case<span class="op">=</span><span class="va">False</span>, na<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb6-285"><a href="#cb6-285" aria-hidden="true" tabindex="-1"></a>        inhouse_mask <span class="op">=</span> df[model_col].<span class="bu">str</span>.contains(<span class="st">'In-House|In House|Inhouse'</span>, case<span class="op">=</span><span class="va">False</span>, na<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb6-286"><a href="#cb6-286" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'is_golden_segment'</span>] <span class="op">=</span> (senior_mask <span class="op">&amp;</span> pharma_mask <span class="op">&amp;</span> inhouse_mask).astype(<span class="bu">int</span>)</span>
<span id="cb6-287"><a href="#cb6-287" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'is_senior_pharma'</span>] <span class="op">=</span> (senior_mask <span class="op">&amp;</span> pharma_mask).astype(<span class="bu">int</span>)</span>
<span id="cb6-288"><a href="#cb6-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-289"><a href="#cb6-289" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Global scope indicator</span></span>
<span id="cb6-290"><a href="#cb6-290" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'title_scope'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb6-291"><a href="#cb6-291" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'is_global_scope'</span>] <span class="op">=</span> (df[<span class="st">'title_scope'</span>] <span class="op">==</span> <span class="st">'Global'</span>).astype(<span class="bu">int</span>)</span>
<span id="cb6-292"><a href="#cb6-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-293"><a href="#cb6-293" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fill missing categoricals</span></span>
<span id="cb6-294"><a href="#cb6-294" aria-hidden="true" tabindex="-1"></a>    categorical_cols <span class="op">=</span> [<span class="st">'acct_manufacturing_model'</span>, <span class="st">'acct_primary_site_function'</span>,</span>
<span id="cb6-295"><a href="#cb6-295" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'acct_target_industry'</span>, <span class="st">'acct_territory_rollup'</span>,</span>
<span id="cb6-296"><a href="#cb6-296" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'title_seniority'</span>, <span class="st">'title_function'</span>, <span class="st">'title_scope'</span>,</span>
<span id="cb6-297"><a href="#cb6-297" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'channel_tier'</span>]</span>
<span id="cb6-298"><a href="#cb6-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-299"><a href="#cb6-299" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> categorical_cols:</span>
<span id="cb6-300"><a href="#cb6-300" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> col <span class="kw">in</span> df.columns:</span>
<span id="cb6-301"><a href="#cb6-301" aria-hidden="true" tabindex="-1"></a>            df[col] <span class="op">=</span> df[col].fillna(<span class="st">'Unknown'</span>)</span>
<span id="cb6-302"><a href="#cb6-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-303"><a href="#cb6-303" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb6-304"><a href="#cb6-304" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SUMMARY</span></span>
<span id="cb6-305"><a href="#cb6-305" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb6-306"><a href="#cb6-306" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb6-307"><a href="#cb6-307" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"V7 TITAN FEATURE ENGINEERING COMPLETE"</span>)</span>
<span id="cb6-308"><a href="#cb6-308" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb6-309"><a href="#cb6-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-310"><a href="#cb6-310" aria-hidden="true" tabindex="-1"></a>    titan_features <span class="op">=</span> [<span class="st">'intent_strength'</span>, <span class="st">'channel_efficiency'</span>, <span class="st">'is_hidden_gem'</span>,</span>
<span id="cb6-311"><a href="#cb6-311" aria-hidden="true" tabindex="-1"></a>                      <span class="st">'capital_density_score'</span>, <span class="st">'capital_density_log'</span>,</span>
<span id="cb6-312"><a href="#cb6-312" aria-hidden="true" tabindex="-1"></a>                      <span class="st">'role_product_match'</span>, <span class="st">'title_bigram_count'</span>]</span>
<span id="cb6-313"><a href="#cb6-313" aria-hidden="true" tabindex="-1"></a>    titan_features <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> titan_features <span class="cf">if</span> f <span class="kw">in</span> df.columns]</span>
<span id="cb6-314"><a href="#cb6-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-315"><a href="#cb6-315" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"New Titan Features: </span><span class="sc">{</span>titan_features<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-316"><a href="#cb6-316" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Total columns: </span><span class="sc">{</span><span class="bu">len</span>(df.columns)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-317"><a href="#cb6-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-318"><a href="#cb6-318" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb6-319"><a href="#cb6-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-320"><a href="#cb6-320" aria-hidden="true" tabindex="-1"></a><span class="co"># Execute pipeline</span></span>
<span id="cb6-321"><a href="#cb6-321" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> clean_and_engineer_titan(DATA_PATH)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>======================================================================
V7 TITAN: DOMAIN-OPTIMIZED FEATURE ENGINEERING
======================================================================
Loaded: 16,815 rows, 25 columns
Target Rate: 17.9%

[1/6] Engineering: intent_strength
  Intent Strength Conversion Rates:
    Level 0.0: 5.0% (n=7,356.0)
    Level 1.0: 12.8% (n=1,564.0)
    Level 2.0: 30.1% (n=3,805.0)
    Level 3.0: 21.3% (n=2,093.0)
    Level 5.0: 42.8% (n=1,997.0)

[2/6] Engineering: channel_efficiency
  Channel Tier Conversion Rates:
    Premium: 27.6% (n=4,791.0)
    Standard: 21.9% (n=6,579.0)
    Toxic: 4.6% (n=5,445.0)

[3/6] Engineering: is_hidden_gem
  Hidden Gem Conversion Rates:
    Standard: 15.6% (n=14,422.0)
    Hidden Gem: 31.8% (n=2,393.0)

[4/6] Engineering: capital_density_score
  Capital Density Range: 50 - 15000
  Capital Density Mean: 2051

[5/6] Engineering: role_product_match
  Role-Product Match Conversion:
    Not Matched: 16.2% (n=12,799.0)
    Matched: 23.5% (n=4,016.0)

[6/6] Engineering: title_bigrams
  Created 8 bigram flags
  Leads with 1+ bigram: 1,505

--------------------------------------------------
RETAINING V6 FEATURES
--------------------------------------------------

======================================================================
V7 TITAN FEATURE ENGINEERING COMPLETE
======================================================================
New Titan Features: ['intent_strength', 'channel_efficiency', 'is_hidden_gem', 'capital_density_score', 'capital_density_log', 'role_product_match', 'title_bigram_count']
Total columns: 51</code></pre>
</div>
</div>
</section>
<section id="titan-feature-correlation-analysis" class="level2">
<h2 class="anchored" data-anchor-id="titan-feature-correlation-analysis">2.3 Titan Feature Correlation Analysis</h2>
<div id="cell-titan-correlation" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># TITAN FEATURE CORRELATION WITH TARGET</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"TITAN FEATURE CORRELATION ANALYSIS"</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Select Titan features for correlation</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>titan_numeric_features <span class="op">=</span> [</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'intent_strength'</span>, <span class="st">'channel_efficiency'</span>, <span class="st">'is_hidden_gem'</span>,</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'capital_density_log'</span>, <span class="st">'role_product_match'</span>, <span class="st">'title_bigram_count'</span>,</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'is_golden_segment'</span>, <span class="st">'is_decision_maker'</span>, <span class="st">'is_fresh'</span>, <span class="st">'is_stale'</span>,</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'is_global_scope'</span>, <span class="st">'lead_age_days'</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>titan_numeric_features <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> titan_numeric_features <span class="cf">if</span> f <span class="kw">in</span> df.columns]</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate correlations with target</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>correlations <span class="op">=</span> df[titan_numeric_features <span class="op">+</span> [<span class="st">'is_success'</span>]].corr()[<span class="st">'is_success'</span>].drop(<span class="st">'is_success'</span>)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>correlations <span class="op">=</span> correlations.sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Feature Correlations with is_success:"</span>)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">40</span>)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> feat, corr <span class="kw">in</span> correlations.items():</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    direction <span class="op">=</span> <span class="st">"+"</span> <span class="cf">if</span> corr <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">"-"</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>feat<span class="sc">:30s}</span><span class="ss">: </span><span class="sc">{</span>direction<span class="sc">}{</span><span class="bu">abs</span>(corr)<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualization</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 1: Correlation Bar Chart</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>ax1 <span class="op">=</span> axes[<span class="dv">0</span>]</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [PROJECT_COLS[<span class="st">'Success'</span>] <span class="cf">if</span> c <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> PROJECT_COLS[<span class="st">'Failure'</span>] <span class="cf">for</span> c <span class="kw">in</span> correlations.values]</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>correlations.plot(kind<span class="op">=</span><span class="st">'barh'</span>, ax<span class="op">=</span>ax1, color<span class="op">=</span>colors)</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>ax1.axvline(x<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">'Correlation with is_success'</span>)</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="st">'Titan Feature Correlations'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 2: Channel Tier Conversion Comparison</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> axes[<span class="dv">1</span>]</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>channel_conv <span class="op">=</span> df.groupby(<span class="st">'channel_tier'</span>)[<span class="st">'is_success'</span>].mean().reindex([<span class="st">'Premium'</span>, <span class="st">'Standard'</span>, <span class="st">'Toxic'</span>])</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>tier_colors <span class="op">=</span> [PROJECT_COLS[<span class="st">'Premium'</span>], PROJECT_COLS[<span class="st">'Neutral'</span>], PROJECT_COLS[<span class="st">'Toxic'</span>]]</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>channel_conv.plot(kind<span class="op">=</span><span class="st">'bar'</span>, ax<span class="op">=</span>ax2, color<span class="op">=</span>tier_colors, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">'Conversion Rate'</span>)</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>ax2.set_xlabel(<span class="st">'Channel Tier'</span>)</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>ax2.set_title(<span class="st">'Conversion by Channel Tier'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>ax2.set_xticklabels(ax2.get_xticklabels(), rotation<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Add value labels</span></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, v <span class="kw">in</span> <span class="bu">enumerate</span>(channel_conv):</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>    ax2.text(i, v <span class="op">+</span> <span class="fl">0.005</span>, <span class="ss">f'</span><span class="sc">{</span>v<span class="sc">:.1%}</span><span class="ss">'</span>, ha<span class="op">=</span><span class="st">'center'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Print key insights</span></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"KEY TITAN INSIGHTS"</span>)</span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'channel_tier'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>    premium_rate <span class="op">=</span> df[df[<span class="st">'channel_tier'</span>] <span class="op">==</span> <span class="st">'Premium'</span>][<span class="st">'is_success'</span>].mean()</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>    toxic_rate <span class="op">=</span> df[df[<span class="st">'channel_tier'</span>] <span class="op">==</span> <span class="st">'Toxic'</span>][<span class="st">'is_success'</span>].mean()</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Premium Channel Conversion: </span><span class="sc">{</span>premium_rate<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Toxic Channel Conversion: </span><span class="sc">{</span>toxic_rate<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Lift from Premium vs Toxic: </span><span class="sc">{</span>premium_rate<span class="op">/</span>toxic_rate<span class="sc">:.1f}</span><span class="ss">x"</span>)</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'is_hidden_gem'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>    gem_rate <span class="op">=</span> df[df[<span class="st">'is_hidden_gem'</span>] <span class="op">==</span> <span class="dv">1</span>][<span class="st">'is_success'</span>].mean()</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>    baseline_rate <span class="op">=</span> df[<span class="st">'is_success'</span>].mean()</span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Hidden Gem Conversion: </span><span class="sc">{</span>gem_rate<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Baseline Conversion: </span><span class="sc">{</span>baseline_rate<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Hidden Gem Lift: </span><span class="sc">{</span>gem_rate<span class="op">/</span>baseline_rate<span class="sc">:.1f}</span><span class="ss">x"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
======================================================================
TITAN FEATURE CORRELATION ANALYSIS
======================================================================

Feature Correlations with is_success:
----------------------------------------
  intent_strength               : +0.3281
  channel_efficiency            : +0.2360
  is_hidden_gem                 : +0.1474
  role_product_match            : +0.0815
  title_bigram_count            : +0.0471
  is_decision_maker             : +0.0383
  is_golden_segment             : +0.0315
  is_fresh                      : +0.0123
  is_global_scope               : -0.0114
  is_stale                      : -0.0243
  lead_age_days                 : -0.0373
  capital_density_log           : -0.0543</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="mastercontrol_model_v9_files/figure-html/titan-correlation-output-2.png" id="titan-correlation" width="1311" height="447" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
======================================================================
KEY TITAN INSIGHTS
======================================================================
Premium Channel Conversion: 27.6%
Toxic Channel Conversion: 4.6%
Lift from Premium vs Toxic: 6.0x

Hidden Gem Conversion: 31.8%
Baseline Conversion: 17.9%
Hidden Gem Lift: 1.8x</code></pre>
</div>
</div>
</section>
<section id="feature-matrix-preparation" class="level2">
<h2 class="anchored" data-anchor-id="feature-matrix-preparation">2.4 Feature Matrix Preparation</h2>
<div id="feature-matrix" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># FEATURE MATRIX CONSTRUCTION</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_feature_matrix(df):</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Prepare the feature matrix for modeling with Titan features."""</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"FEATURE MATRIX PREPARATION"</span>)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> df[<span class="st">'is_success'</span>].values</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Categorical features</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    categorical_features <span class="op">=</span> [</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">'title_seniority'</span>, <span class="st">'title_function'</span>, <span class="st">'title_scope'</span>,</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">'acct_target_industry'</span>, <span class="st">'acct_manufacturing_model'</span>,</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">'acct_primary_site_function'</span>, <span class="st">'acct_territory_rollup'</span>,</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">'product_segment'</span>, <span class="st">'channel_tier'</span>  <span class="co"># V7: Added channel_tier</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Interaction features</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    interaction_features <span class="op">=</span> [</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">'seniority_x_industry'</span>, <span class="st">'seniority_x_model'</span>, <span class="st">'industry_x_model'</span>,</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">'power_trio'</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Velocity categorical</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    velocity_cats <span class="op">=</span> [<span class="st">'velocity_tier'</span>]</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter to existing</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    categorical_features <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> categorical_features <span class="cf">if</span> c <span class="kw">in</span> df.columns]</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    interaction_features <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> interaction_features <span class="cf">if</span> c <span class="kw">in</span> df.columns]</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    velocity_cats <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> velocity_cats <span class="cf">if</span> c <span class="kw">in</span> df.columns]</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>    all_categoricals <span class="op">=</span> categorical_features <span class="op">+</span> interaction_features <span class="op">+</span> velocity_cats</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Numeric features (including V7 Titan Features)</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    numeric_features <span class="op">=</span> [</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">'lead_age_days'</span>, <span class="st">'is_decision_maker'</span>, <span class="st">'is_fresh'</span>, <span class="st">'is_stale'</span>,</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># V6 Golden Features</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">'is_golden_segment'</span>, <span class="st">'is_senior_pharma'</span>, <span class="st">'is_global_scope'</span>,</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># V7 TITAN Features</span></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">'intent_strength'</span>, <span class="st">'channel_efficiency'</span>, <span class="st">'is_hidden_gem'</span>,</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>        <span class="st">'capital_density_log'</span>, <span class="st">'role_product_match'</span>, <span class="st">'title_bigram_count'</span></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add bigram flags</span></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>    bigram_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> df.columns <span class="cf">if</span> c.startswith(<span class="st">'has_'</span>)]</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>    numeric_features.extend(bigram_cols)</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'record_completeness'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>        numeric_features.append(<span class="st">'record_completeness'</span>)</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>    numeric_features <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> numeric_features <span class="cf">if</span> c <span class="kw">in</span> df.columns]</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Text feature</span></span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>    text_col <span class="op">=</span> <span class="st">'contact_lead_title'</span> <span class="cf">if</span> <span class="st">'contact_lead_title'</span> <span class="kw">in</span> df.columns <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build feature dataframe</span></span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> df[all_categoricals <span class="op">+</span> numeric_features].copy()</span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>    text_data <span class="op">=</span> df[text_col].fillna(<span class="st">''</span>) <span class="cf">if</span> text_col <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Categorical features: </span><span class="sc">{</span><span class="bu">len</span>(all_categoricals)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Base: </span><span class="sc">{</span>categorical_features<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Interactions: </span><span class="sc">{</span>interaction_features<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Numeric features: </span><span class="sc">{</span><span class="bu">len</span>(numeric_features)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>    titan_nums <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> numeric_features <span class="cf">if</span> c <span class="kw">in</span></span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>                  [<span class="st">'intent_strength'</span>, <span class="st">'channel_efficiency'</span>, <span class="st">'is_hidden_gem'</span>,</span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'capital_density_log'</span>, <span class="st">'role_product_match'</span>, <span class="st">'title_bigram_count'</span>]]</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  V7 Titan: </span><span class="sc">{</span>titan_nums<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Text feature: </span><span class="sc">{</span>text_col<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> X, y, text_data, all_categoricals, numeric_features</span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a>X, y, text_data, cat_cols, num_cols <span class="op">=</span> prepare_feature_matrix(df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
======================================================================
FEATURE MATRIX PREPARATION
======================================================================
Categorical features: 14
  Base: ['title_seniority', 'title_function', 'title_scope', 'acct_target_industry', 'acct_manufacturing_model', 'acct_primary_site_function', 'acct_territory_rollup', 'product_segment', 'channel_tier']
  Interactions: ['seniority_x_industry', 'seniority_x_model', 'industry_x_model', 'power_trio']
Numeric features: 22
  V7 Titan: ['intent_strength', 'channel_efficiency', 'is_hidden_gem', 'capital_density_log', 'role_product_match', 'title_bigram_count']
Text feature: contact_lead_title</code></pre>
</div>
</div>
</section>
<section id="trainvalidationtest-split-encoding" class="level2">
<h2 class="anchored" data-anchor-id="trainvalidationtest-split-encoding">2.5 Train/Validation/Test Split &amp; Encoding</h2>
<div id="data-split" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co"># DATA SPLITTING &amp; TARGET ENCODING</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"DATA SPLITTING &amp; TARGET ENCODING"</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Stratified split</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>X_temp, X_test, y_temp, y_test <span class="op">=</span> train_test_split(</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    X, y, test_size<span class="op">=</span>TEST_SIZE, random_state<span class="op">=</span>RANDOM_STATE, stratify<span class="op">=</span>y</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>X_train, X_val, y_train, y_val <span class="op">=</span> train_test_split(</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    X_temp, y_temp, test_size<span class="op">=</span>VAL_SIZE<span class="op">/</span>(<span class="dv">1</span><span class="op">-</span>TEST_SIZE), random_state<span class="op">=</span>RANDOM_STATE, stratify<span class="op">=</span>y_temp</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Split text data</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> text_data <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    text_temp, text_test <span class="op">=</span> train_test_split(</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>        text_data, test_size<span class="op">=</span>TEST_SIZE, random_state<span class="op">=</span>RANDOM_STATE, stratify<span class="op">=</span>y</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    text_train, text_val <span class="op">=</span> train_test_split(</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>        text_temp, test_size<span class="op">=</span>VAL_SIZE<span class="op">/</span>(<span class="dv">1</span><span class="op">-</span>TEST_SIZE), random_state<span class="op">=</span>RANDOM_STATE, stratify<span class="op">=</span>y_temp</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    text_train <span class="op">=</span> text_val <span class="op">=</span> text_test <span class="op">=</span> <span class="va">None</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Train: </span><span class="sc">{</span><span class="bu">len</span>(X_train)<span class="sc">:,}</span><span class="ss"> (</span><span class="sc">{</span>y_train<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss"> positive)"</span>)</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Val:   </span><span class="sc">{</span><span class="bu">len</span>(X_val)<span class="sc">:,}</span><span class="ss"> (</span><span class="sc">{</span>y_val<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss"> positive)"</span>)</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Test:  </span><span class="sc">{</span><span class="bu">len</span>(X_test)<span class="sc">:,}</span><span class="ss"> (</span><span class="sc">{</span>y_test<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss"> positive)"</span>)</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a><span class="co"># TARGET ENCODING</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Applying Target Encoding to high-cardinality features..."</span>)</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>target_encode_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> cat_cols <span class="cf">if</span> X_train[c].nunique() <span class="op">&gt;</span> <span class="dv">10</span>]</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>standard_encode_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> cat_cols <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> target_encode_cols]</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Target-encoded (</span><span class="sc">{</span><span class="bu">len</span>(target_encode_cols)<span class="sc">}</span><span class="ss">): </span><span class="sc">{</span>target_encode_cols<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Label-encoded (</span><span class="sc">{</span><span class="bu">len</span>(standard_encode_cols)<span class="sc">}</span><span class="ss">): </span><span class="sc">{</span>standard_encode_cols<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Manual Target Encoder (fallback)</span></span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ManualTargetEncoder(BaseEstimator, TransformerMixin):</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, columns<span class="op">=</span><span class="va">None</span>, smoothing<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.columns <span class="op">=</span> columns</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.smoothing <span class="op">=</span> smoothing</span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.encoding_maps_ <span class="op">=</span> {}</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.global_mean_ <span class="op">=</span> <span class="va">None</span></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, X, y):</span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> pd.DataFrame(X) <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(X, pd.DataFrame) <span class="cf">else</span> X</span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> np.array(y)</span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.global_mean_ <span class="op">=</span> y.mean()</span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>        cols_to_encode <span class="op">=</span> <span class="va">self</span>.columns <span class="cf">if</span> <span class="va">self</span>.columns <span class="cf">else</span> X.select_dtypes(include<span class="op">=</span>[<span class="st">'object'</span>, <span class="st">'category'</span>]).columns.tolist()</span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> col <span class="kw">in</span> cols_to_encode:</span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> col <span class="kw">in</span> X.columns:</span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>                df_temp <span class="op">=</span> pd.DataFrame({<span class="st">'col'</span>: X[col].astype(<span class="bu">str</span>), <span class="st">'target'</span>: y})</span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>                agg <span class="op">=</span> df_temp.groupby(<span class="st">'col'</span>)[<span class="st">'target'</span>].agg([<span class="st">'mean'</span>, <span class="st">'count'</span>])</span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a>                smoothed <span class="op">=</span> (agg[<span class="st">'count'</span>] <span class="op">*</span> agg[<span class="st">'mean'</span>] <span class="op">+</span> <span class="va">self</span>.smoothing <span class="op">*</span> <span class="va">self</span>.global_mean_) <span class="op">/</span> (agg[<span class="st">'count'</span>] <span class="op">+</span> <span class="va">self</span>.smoothing)</span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.encoding_maps_[col] <span class="op">=</span> smoothed.to_dict()</span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span></span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> transform(<span class="va">self</span>, X):</span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> pd.DataFrame(X).copy() <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(X, pd.DataFrame) <span class="cf">else</span> X.copy()</span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> col, mapping <span class="kw">in</span> <span class="va">self</span>.encoding_maps_.items():</span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> col <span class="kw">in</span> X.columns:</span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a>                X[col <span class="op">+</span> <span class="st">'_encoded'</span>] <span class="op">=</span> X[col].astype(<span class="bu">str</span>).<span class="bu">map</span>(mapping).fillna(<span class="va">self</span>.global_mean_)</span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> X</span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply Target Encoding</span></span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> TARGET_ENCODER_AVAILABLE <span class="kw">and</span> <span class="bu">len</span>(target_encode_cols) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a>    target_encoder <span class="op">=</span> TargetEncoder(smooth<span class="op">=</span><span class="st">'auto'</span>, target_type<span class="op">=</span><span class="st">'binary'</span>)</span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a>    X_train_te <span class="op">=</span> X_train.copy()</span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a>    X_val_te <span class="op">=</span> X_val.copy()</span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true" tabindex="-1"></a>    X_test_te <span class="op">=</span> X_test.copy()</span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true" tabindex="-1"></a>    te_train <span class="op">=</span> target_encoder.fit_transform(X_train[target_encode_cols], y_train)</span>
<span id="cb13-82"><a href="#cb13-82" aria-hidden="true" tabindex="-1"></a>    te_val <span class="op">=</span> target_encoder.transform(X_val[target_encode_cols])</span>
<span id="cb13-83"><a href="#cb13-83" aria-hidden="true" tabindex="-1"></a>    te_test <span class="op">=</span> target_encoder.transform(X_test[target_encode_cols])</span>
<span id="cb13-84"><a href="#cb13-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-85"><a href="#cb13-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, col <span class="kw">in</span> <span class="bu">enumerate</span>(target_encode_cols):</span>
<span id="cb13-86"><a href="#cb13-86" aria-hidden="true" tabindex="-1"></a>        X_train_te[col] <span class="op">=</span> te_train[:, i]</span>
<span id="cb13-87"><a href="#cb13-87" aria-hidden="true" tabindex="-1"></a>        X_val_te[col] <span class="op">=</span> te_val[:, i]</span>
<span id="cb13-88"><a href="#cb13-88" aria-hidden="true" tabindex="-1"></a>        X_test_te[col] <span class="op">=</span> te_test[:, i]</span>
<span id="cb13-89"><a href="#cb13-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-90"><a href="#cb13-90" aria-hidden="true" tabindex="-1"></a><span class="cf">elif</span> <span class="bu">len</span>(target_encode_cols) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb13-91"><a href="#cb13-91" aria-hidden="true" tabindex="-1"></a>    manual_encoder <span class="op">=</span> ManualTargetEncoder(columns<span class="op">=</span>target_encode_cols, smoothing<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb13-92"><a href="#cb13-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-93"><a href="#cb13-93" aria-hidden="true" tabindex="-1"></a>    X_train_te <span class="op">=</span> manual_encoder.fit_transform(X_train, y_train)</span>
<span id="cb13-94"><a href="#cb13-94" aria-hidden="true" tabindex="-1"></a>    X_val_te <span class="op">=</span> manual_encoder.transform(X_val)</span>
<span id="cb13-95"><a href="#cb13-95" aria-hidden="true" tabindex="-1"></a>    X_test_te <span class="op">=</span> manual_encoder.transform(X_test)</span>
<span id="cb13-96"><a href="#cb13-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-97"><a href="#cb13-97" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> target_encode_cols:</span>
<span id="cb13-98"><a href="#cb13-98" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> col <span class="op">+</span> <span class="st">'_encoded'</span> <span class="kw">in</span> X_train_te.columns:</span>
<span id="cb13-99"><a href="#cb13-99" aria-hidden="true" tabindex="-1"></a>            X_train_te[col] <span class="op">=</span> X_train_te[col <span class="op">+</span> <span class="st">'_encoded'</span>]</span>
<span id="cb13-100"><a href="#cb13-100" aria-hidden="true" tabindex="-1"></a>            X_val_te[col] <span class="op">=</span> X_val_te[col <span class="op">+</span> <span class="st">'_encoded'</span>]</span>
<span id="cb13-101"><a href="#cb13-101" aria-hidden="true" tabindex="-1"></a>            X_test_te[col] <span class="op">=</span> X_test_te[col <span class="op">+</span> <span class="st">'_encoded'</span>]</span>
<span id="cb13-102"><a href="#cb13-102" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb13-103"><a href="#cb13-103" aria-hidden="true" tabindex="-1"></a>    X_train_te <span class="op">=</span> X_train.copy()</span>
<span id="cb13-104"><a href="#cb13-104" aria-hidden="true" tabindex="-1"></a>    X_val_te <span class="op">=</span> X_val.copy()</span>
<span id="cb13-105"><a href="#cb13-105" aria-hidden="true" tabindex="-1"></a>    X_test_te <span class="op">=</span> X_test.copy()</span>
<span id="cb13-106"><a href="#cb13-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-107"><a href="#cb13-107" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb13-108"><a href="#cb13-108" aria-hidden="true" tabindex="-1"></a><span class="co"># LABEL ENCODING</span></span>
<span id="cb13-109"><a href="#cb13-109" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb13-110"><a href="#cb13-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-111"><a href="#cb13-111" aria-hidden="true" tabindex="-1"></a>label_encoders <span class="op">=</span> {}</span>
<span id="cb13-112"><a href="#cb13-112" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> standard_encode_cols:</span>
<span id="cb13-113"><a href="#cb13-113" aria-hidden="true" tabindex="-1"></a>    le <span class="op">=</span> LabelEncoder()</span>
<span id="cb13-114"><a href="#cb13-114" aria-hidden="true" tabindex="-1"></a>    X_train_te[col] <span class="op">=</span> le.fit_transform(X_train_te[col].astype(<span class="bu">str</span>))</span>
<span id="cb13-115"><a href="#cb13-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-116"><a href="#cb13-116" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> safe_transform(series, encoder):</span>
<span id="cb13-117"><a href="#cb13-117" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> series.astype(<span class="bu">str</span>).<span class="bu">apply</span>(</span>
<span id="cb13-118"><a href="#cb13-118" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> x: encoder.transform([x])[<span class="dv">0</span>] <span class="cf">if</span> x <span class="kw">in</span> encoder.classes_ <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb13-119"><a href="#cb13-119" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb13-120"><a href="#cb13-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-121"><a href="#cb13-121" aria-hidden="true" tabindex="-1"></a>    X_val_te[col] <span class="op">=</span> safe_transform(X_val_te[col], le)</span>
<span id="cb13-122"><a href="#cb13-122" aria-hidden="true" tabindex="-1"></a>    X_test_te[col] <span class="op">=</span> safe_transform(X_test_te[col], le)</span>
<span id="cb13-123"><a href="#cb13-123" aria-hidden="true" tabindex="-1"></a>    label_encoders[col] <span class="op">=</span> le</span>
<span id="cb13-124"><a href="#cb13-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-125"><a href="#cb13-125" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb13-126"><a href="#cb13-126" aria-hidden="true" tabindex="-1"></a><span class="co"># DEEP LSA FOR TEXT</span></span>
<span id="cb13-127"><a href="#cb13-127" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb13-128"><a href="#cb13-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-129"><a href="#cb13-129" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> text_train <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb13-130"><a href="#cb13-130" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Applying Deep LSA (</span><span class="sc">{</span>LSA_COMPONENTS<span class="sc">}</span><span class="ss"> components)..."</span>)</span>
<span id="cb13-131"><a href="#cb13-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-132"><a href="#cb13-132" aria-hidden="true" tabindex="-1"></a>    tfidf <span class="op">=</span> TfidfVectorizer(</span>
<span id="cb13-133"><a href="#cb13-133" aria-hidden="true" tabindex="-1"></a>        max_features<span class="op">=</span>TFIDF_MAX_FEATURES,</span>
<span id="cb13-134"><a href="#cb13-134" aria-hidden="true" tabindex="-1"></a>        ngram_range<span class="op">=</span>(<span class="dv">1</span>, <span class="dv">2</span>),</span>
<span id="cb13-135"><a href="#cb13-135" aria-hidden="true" tabindex="-1"></a>        stop_words<span class="op">=</span><span class="st">'english'</span>,</span>
<span id="cb13-136"><a href="#cb13-136" aria-hidden="true" tabindex="-1"></a>        min_df<span class="op">=</span><span class="dv">5</span></span>
<span id="cb13-137"><a href="#cb13-137" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-138"><a href="#cb13-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-139"><a href="#cb13-139" aria-hidden="true" tabindex="-1"></a>    tfidf_train <span class="op">=</span> tfidf.fit_transform(text_train)</span>
<span id="cb13-140"><a href="#cb13-140" aria-hidden="true" tabindex="-1"></a>    tfidf_val <span class="op">=</span> tfidf.transform(text_val)</span>
<span id="cb13-141"><a href="#cb13-141" aria-hidden="true" tabindex="-1"></a>    tfidf_test <span class="op">=</span> tfidf.transform(text_test)</span>
<span id="cb13-142"><a href="#cb13-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-143"><a href="#cb13-143" aria-hidden="true" tabindex="-1"></a>    svd <span class="op">=</span> TruncatedSVD(n_components<span class="op">=</span>LSA_COMPONENTS, random_state<span class="op">=</span>RANDOM_STATE)</span>
<span id="cb13-144"><a href="#cb13-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-145"><a href="#cb13-145" aria-hidden="true" tabindex="-1"></a>    lsa_train <span class="op">=</span> svd.fit_transform(tfidf_train)</span>
<span id="cb13-146"><a href="#cb13-146" aria-hidden="true" tabindex="-1"></a>    lsa_val <span class="op">=</span> svd.transform(tfidf_val)</span>
<span id="cb13-147"><a href="#cb13-147" aria-hidden="true" tabindex="-1"></a>    lsa_test <span class="op">=</span> svd.transform(tfidf_test)</span>
<span id="cb13-148"><a href="#cb13-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-149"><a href="#cb13-149" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Explained variance: </span><span class="sc">{</span>svd<span class="sc">.</span>explained_variance_ratio_<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb13-150"><a href="#cb13-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-151"><a href="#cb13-151" aria-hidden="true" tabindex="-1"></a>    lsa_cols <span class="op">=</span> [<span class="ss">f'lsa_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(LSA_COMPONENTS)]</span>
<span id="cb13-152"><a href="#cb13-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-153"><a href="#cb13-153" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, col <span class="kw">in</span> <span class="bu">enumerate</span>(lsa_cols):</span>
<span id="cb13-154"><a href="#cb13-154" aria-hidden="true" tabindex="-1"></a>        X_train_te[col] <span class="op">=</span> lsa_train[:, i]</span>
<span id="cb13-155"><a href="#cb13-155" aria-hidden="true" tabindex="-1"></a>        X_val_te[col] <span class="op">=</span> lsa_val[:, i]</span>
<span id="cb13-156"><a href="#cb13-156" aria-hidden="true" tabindex="-1"></a>        X_test_te[col] <span class="op">=</span> lsa_test[:, i]</span>
<span id="cb13-157"><a href="#cb13-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-158"><a href="#cb13-158" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb13-159"><a href="#cb13-159" aria-hidden="true" tabindex="-1"></a><span class="co"># FINAL NUMERIC CONVERSION</span></span>
<span id="cb13-160"><a href="#cb13-160" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb13-161"><a href="#cb13-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-162"><a href="#cb13-162" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> X_train_te.columns:</span>
<span id="cb13-163"><a href="#cb13-163" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> X_train_te[col].dtype <span class="op">==</span> <span class="st">'object'</span>:</span>
<span id="cb13-164"><a href="#cb13-164" aria-hidden="true" tabindex="-1"></a>        le <span class="op">=</span> LabelEncoder()</span>
<span id="cb13-165"><a href="#cb13-165" aria-hidden="true" tabindex="-1"></a>        X_train_te[col] <span class="op">=</span> le.fit_transform(X_train_te[col].astype(<span class="bu">str</span>))</span>
<span id="cb13-166"><a href="#cb13-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-167"><a href="#cb13-167" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> safe_encode(series, encoder):</span>
<span id="cb13-168"><a href="#cb13-168" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> series.astype(<span class="bu">str</span>).<span class="bu">apply</span>(</span>
<span id="cb13-169"><a href="#cb13-169" aria-hidden="true" tabindex="-1"></a>                <span class="kw">lambda</span> x: encoder.transform([x])[<span class="dv">0</span>] <span class="cf">if</span> x <span class="kw">in</span> encoder.classes_ <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb13-170"><a href="#cb13-170" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb13-171"><a href="#cb13-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-172"><a href="#cb13-172" aria-hidden="true" tabindex="-1"></a>        X_val_te[col] <span class="op">=</span> safe_encode(X_val_te[col], le)</span>
<span id="cb13-173"><a href="#cb13-173" aria-hidden="true" tabindex="-1"></a>        X_test_te[col] <span class="op">=</span> safe_encode(X_test_te[col], le)</span>
<span id="cb13-174"><a href="#cb13-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-175"><a href="#cb13-175" aria-hidden="true" tabindex="-1"></a>X_train_te <span class="op">=</span> X_train_te.fillna(<span class="dv">0</span>)</span>
<span id="cb13-176"><a href="#cb13-176" aria-hidden="true" tabindex="-1"></a>X_val_te <span class="op">=</span> X_val_te.fillna(<span class="dv">0</span>)</span>
<span id="cb13-177"><a href="#cb13-177" aria-hidden="true" tabindex="-1"></a>X_test_te <span class="op">=</span> X_test_te.fillna(<span class="dv">0</span>)</span>
<span id="cb13-178"><a href="#cb13-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-179"><a href="#cb13-179" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Final feature matrix shape: </span><span class="sc">{</span>X_train_te<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-180"><a href="#cb13-180" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Features: </span><span class="sc">{</span><span class="bu">list</span>(X_train_te.columns)<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
======================================================================
DATA SPLITTING &amp; TARGET ENCODING
======================================================================
Train: 10,929 (17.9% positive)
Val:   2,523 (17.9% positive)
Test:  3,363 (17.9% positive)

Applying Target Encoding to high-cardinality features...
  Target-encoded (6): ['acct_manufacturing_model', 'acct_primary_site_function', 'seniority_x_industry', 'seniority_x_model', 'industry_x_model', 'power_trio']
  Label-encoded (8): ['title_seniority', 'title_function', 'title_scope', 'acct_target_industry', 'acct_territory_rollup', 'product_segment', 'channel_tier', 'velocity_tier']

Applying Deep LSA (20 components)...
  Explained variance: 36.6%

Final feature matrix shape: (10929, 56)
Features: ['title_seniority', 'title_function', 'title_scope', 'acct_target_industry', 'acct_manufacturing_model', 'acct_primary_site_function', 'acct_territory_rollup', 'product_segment', 'channel_tier', 'seniority_x_industry', 'seniority_x_model', 'industry_x_model', 'power_trio', 'velocity_tier', 'lead_age_days', 'is_decision_maker', 'is_fresh', 'is_stale', 'is_golden_segment', 'is_senior_pharma', 'is_global_scope', 'intent_strength', 'channel_efficiency', 'is_hidden_gem', 'capital_density_log', 'role_product_match', 'title_bigram_count', 'has_continuous_improvement', 'has_document_control', 'has_process_engineer', 'has_quality_systems', 'has_regulatory_affairs', 'has_quality_assurance', 'has_validation_engineer', 'has_compliance_manager', 'record_completeness', 'lsa_0', 'lsa_1', 'lsa_2', 'lsa_3', 'lsa_4', 'lsa_5', 'lsa_6', 'lsa_7', 'lsa_8', 'lsa_9', 'lsa_10', 'lsa_11', 'lsa_12', 'lsa_13', 'lsa_14', 'lsa_15', 'lsa_16', 'lsa_17', 'lsa_18', 'lsa_19']</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="phase-3-deep-model-tournament" class="level1">
<h1>Phase 3: Deep Model Tournament</h1>
<p><strong>The Titan Approach:</strong> V7 retains the platinum architecture (CatBoost, Stacking, Deep Search) with the <strong>n_iter=50</strong> search to accommodate increased feature complexity while maintaining robust 5-fold cross-validation.</p>
<section id="base-model-definitions" class="level2">
<h2 class="anchored" data-anchor-id="base-model-definitions">3.1 Base Model Definitions</h2>
<div id="model-definitions" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co"># PHASE 3: TITAN MODEL TOURNAMENT</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"TITAN MODEL TOURNAMENT"</span>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>models <span class="op">=</span> {}</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>param_grids <span class="op">=</span> {}</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>pos_weight <span class="op">=</span> (y_train <span class="op">==</span> <span class="dv">0</span>).<span class="bu">sum</span>() <span class="op">/</span> (y_train <span class="op">==</span> <span class="dv">1</span>).<span class="bu">sum</span>()</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Class imbalance ratio: </span><span class="sc">{</span>pos_weight<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. CATBOOST (sklearn-compatible wrapper)</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> CATBOOST_AVAILABLE:</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    models[<span class="st">'CatBoost'</span>] <span class="op">=</span> SklearnCatBoost(</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span>RANDOM_STATE,</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>        verbose<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>        thread_count<span class="op">=</span><span class="dv">1</span>  <span class="co"># Single-threaded for nested parallelism safety</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    param_grids[<span class="st">'CatBoost'</span>] <span class="op">=</span> {</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">'depth'</span>: [<span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">8</span>, <span class="dv">10</span>],</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">'learning_rate'</span>: [<span class="fl">0.01</span>, <span class="fl">0.03</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>],</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">'iterations'</span>: [<span class="dv">300</span>, <span class="dv">500</span>, <span class="dv">800</span>],</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">'l2_leaf_reg'</span>: [<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>],</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">'border_count'</span>: [<span class="dv">32</span>, <span class="dv">64</span>, <span class="dv">128</span>]</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"CatBoost: Configured with sklearn-compatible wrapper (Thread-Safe)"</span>)</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. XGBOOST</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> XGBOOST_AVAILABLE:</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>    models[<span class="st">'XGBoost'</span>] <span class="op">=</span> XGBClassifier(</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span>RANDOM_STATE,</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>        n_jobs<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>        eval_metric<span class="op">=</span><span class="st">'logloss'</span></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>    param_grids[<span class="st">'XGBoost'</span>] <span class="op">=</span> {</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">'max_depth'</span>: [<span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">8</span>, <span class="dv">10</span>],</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">'learning_rate'</span>: [<span class="fl">0.01</span>, <span class="fl">0.03</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>],</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>        <span class="st">'n_estimators'</span>: [<span class="dv">300</span>, <span class="dv">500</span>, <span class="dv">800</span>],</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>        <span class="st">'scale_pos_weight'</span>: [<span class="dv">1</span>, pos_weight],</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">'subsample'</span>: [<span class="fl">0.7</span>, <span class="fl">0.8</span>, <span class="fl">0.9</span>, <span class="fl">1.0</span>],</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">'colsample_bytree'</span>: [<span class="fl">0.7</span>, <span class="fl">0.8</span>, <span class="fl">0.9</span>, <span class="fl">1.0</span>],</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>        <span class="st">'reg_alpha'</span>: [<span class="dv">0</span>, <span class="fl">0.1</span>, <span class="fl">0.5</span>],</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>        <span class="st">'reg_lambda'</span>: [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">5</span>]</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"XGBoost: Configured with expanded search space"</span>)</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. LIGHTGBM</span></span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> LIGHTGBM_AVAILABLE:</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>    models[<span class="st">'LightGBM'</span>] <span class="op">=</span> LGBMClassifier(</span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span>RANDOM_STATE,</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>        n_jobs<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>        verbose<span class="op">=-</span><span class="dv">1</span></span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>    param_grids[<span class="st">'LightGBM'</span>] <span class="op">=</span> {</span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>        <span class="st">'num_leaves'</span>: [<span class="dv">31</span>, <span class="dv">63</span>, <span class="dv">127</span>, <span class="dv">255</span>],</span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>        <span class="st">'learning_rate'</span>: [<span class="fl">0.01</span>, <span class="fl">0.03</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>],</span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>        <span class="st">'n_estimators'</span>: [<span class="dv">300</span>, <span class="dv">500</span>, <span class="dv">800</span>],</span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>        <span class="st">'class_weight'</span>: [<span class="st">'balanced'</span>, <span class="va">None</span>],</span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>        <span class="st">'subsample'</span>: [<span class="fl">0.7</span>, <span class="fl">0.8</span>, <span class="fl">0.9</span>, <span class="fl">1.0</span>],</span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a>        <span class="st">'colsample_bytree'</span>: [<span class="fl">0.7</span>, <span class="fl">0.8</span>, <span class="fl">0.9</span>, <span class="fl">1.0</span>],</span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a>        <span class="st">'reg_alpha'</span>: [<span class="dv">0</span>, <span class="fl">0.1</span>, <span class="fl">0.5</span>],</span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a>        <span class="st">'reg_lambda'</span>: [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">5</span>]</span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"LightGBM: Configured with expanded search space"</span>)</span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb15-76"><a href="#cb15-76" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. GRADIENT BOOSTING (Fallback)</span></span>
<span id="cb15-77"><a href="#cb15-77" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb15-78"><a href="#cb15-78" aria-hidden="true" tabindex="-1"></a>models[<span class="st">'GradientBoosting'</span>] <span class="op">=</span> GradientBoostingClassifier(</span>
<span id="cb15-79"><a href="#cb15-79" aria-hidden="true" tabindex="-1"></a>    random_state<span class="op">=</span>RANDOM_STATE</span>
<span id="cb15-80"><a href="#cb15-80" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-81"><a href="#cb15-81" aria-hidden="true" tabindex="-1"></a>param_grids[<span class="st">'GradientBoosting'</span>] <span class="op">=</span> {</span>
<span id="cb15-82"><a href="#cb15-82" aria-hidden="true" tabindex="-1"></a>    <span class="st">'n_estimators'</span>: [<span class="dv">100</span>, <span class="dv">200</span>, <span class="dv">300</span>],</span>
<span id="cb15-83"><a href="#cb15-83" aria-hidden="true" tabindex="-1"></a>    <span class="st">'max_depth'</span>: [<span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">8</span>],</span>
<span id="cb15-84"><a href="#cb15-84" aria-hidden="true" tabindex="-1"></a>    <span class="st">'learning_rate'</span>: [<span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.2</span>],</span>
<span id="cb15-85"><a href="#cb15-85" aria-hidden="true" tabindex="-1"></a>    <span class="st">'subsample'</span>: [<span class="fl">0.8</span>, <span class="fl">0.9</span>, <span class="fl">1.0</span>]</span>
<span id="cb15-86"><a href="#cb15-86" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-87"><a href="#cb15-87" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"GradientBoosting: Configured as fallback"</span>)</span>
<span id="cb15-88"><a href="#cb15-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-89"><a href="#cb15-89" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb15-90"><a href="#cb15-90" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. RANDOM FOREST</span></span>
<span id="cb15-91"><a href="#cb15-91" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb15-92"><a href="#cb15-92" aria-hidden="true" tabindex="-1"></a>models[<span class="st">'RandomForest'</span>] <span class="op">=</span> RandomForestClassifier(</span>
<span id="cb15-93"><a href="#cb15-93" aria-hidden="true" tabindex="-1"></a>    random_state<span class="op">=</span>RANDOM_STATE,</span>
<span id="cb15-94"><a href="#cb15-94" aria-hidden="true" tabindex="-1"></a>    n_jobs<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb15-95"><a href="#cb15-95" aria-hidden="true" tabindex="-1"></a>    class_weight<span class="op">=</span><span class="st">'balanced'</span></span>
<span id="cb15-96"><a href="#cb15-96" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-97"><a href="#cb15-97" aria-hidden="true" tabindex="-1"></a>param_grids[<span class="st">'RandomForest'</span>] <span class="op">=</span> {</span>
<span id="cb15-98"><a href="#cb15-98" aria-hidden="true" tabindex="-1"></a>    <span class="st">'n_estimators'</span>: [<span class="dv">100</span>, <span class="dv">200</span>, <span class="dv">300</span>],</span>
<span id="cb15-99"><a href="#cb15-99" aria-hidden="true" tabindex="-1"></a>    <span class="st">'max_depth'</span>: [<span class="dv">10</span>, <span class="dv">15</span>, <span class="dv">20</span>, <span class="va">None</span>],</span>
<span id="cb15-100"><a href="#cb15-100" aria-hidden="true" tabindex="-1"></a>    <span class="st">'min_samples_split'</span>: [<span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">10</span>],</span>
<span id="cb15-101"><a href="#cb15-101" aria-hidden="true" tabindex="-1"></a>    <span class="st">'min_samples_leaf'</span>: [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>]</span>
<span id="cb15-102"><a href="#cb15-102" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-103"><a href="#cb15-103" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"RandomForest: Configured with balanced class weights"</span>)</span>
<span id="cb15-104"><a href="#cb15-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-105"><a href="#cb15-105" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Total models in tournament: </span><span class="sc">{</span><span class="bu">len</span>(models)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-106"><a href="#cb15-106" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Search iterations per model: </span><span class="sc">{</span>N_ITER_SEARCH<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-107"><a href="#cb15-107" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Cross-validation folds: </span><span class="sc">{</span>CV_FOLDS<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
======================================================================
TITAN MODEL TOURNAMENT
======================================================================
Class imbalance ratio: 4.58
CatBoost: Configured with sklearn-compatible wrapper (Thread-Safe)
XGBoost: Configured with expanded search space
LightGBM: Configured with expanded search space
GradientBoosting: Configured as fallback
RandomForest: Configured with balanced class weights

Total models in tournament: 5
Search iterations per model: 50
Cross-validation folds: 5</code></pre>
</div>
</div>
</section>
<section id="hyperparameter-search" class="level2">
<h2 class="anchored" data-anchor-id="hyperparameter-search">3.2 Hyperparameter Search</h2>
<div id="hyperparameter-search" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co"># RANDOMIZED SEARCH (n_iter=50, cv=5)</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"TITAN HYPERPARAMETER OPTIMIZATION (n_iter=50, cv=5)"</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>cv <span class="op">=</span> StratifiedKFold(n_splits<span class="op">=</span>CV_FOLDS, shuffle<span class="op">=</span><span class="va">True</span>, random_state<span class="op">=</span>RANDOM_STATE)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>best_models <span class="op">=</span> {}</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>cv_results <span class="op">=</span> {}</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, model <span class="kw">in</span> models.items():</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">50</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Tuning: </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">50</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    search <span class="op">=</span> RandomizedSearchCV(</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>        estimator<span class="op">=</span>model,</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>        param_distributions<span class="op">=</span>param_grids[name],</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>        n_iter<span class="op">=</span>N_ITER_SEARCH,</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>        cv<span class="op">=</span>cv,</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>        scoring<span class="op">=</span><span class="st">'roc_auc'</span>,</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>        n_jobs<span class="op">=</span>N_JOBS,</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span>RANDOM_STATE,</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>        verbose<span class="op">=</span><span class="dv">1</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>    search.fit(X_train_te, y_train)</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>    best_models[name] <span class="op">=</span> search.best_estimator_</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>    cv_results[name] <span class="op">=</span> {</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">'best_score'</span>: search.best_score_,</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">'best_params'</span>: search.best_params_,</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">'cv_results'</span>: search.cv_results_</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Best CV AUC: </span><span class="sc">{</span>search<span class="sc">.</span>best_score_<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Best params: </span><span class="sc">{</span>search<span class="sc">.</span>best_params_<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a><span class="co"># VALIDATION SET EVALUATION</span></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"VALIDATION SET PERFORMANCE"</span>)</span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>val_results <span class="op">=</span> {}</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, model <span class="kw">in</span> best_models.items():</span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>    probs <span class="op">=</span> model.predict_proba(X_val_te)[:, <span class="dv">1</span>]</span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>    auc <span class="op">=</span> roc_auc_score(y_val, probs)</span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>    val_results[name] <span class="op">=</span> {<span class="st">'auc'</span>: auc, <span class="st">'probs'</span>: probs}</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">: AUC = </span><span class="sc">{</span>auc<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>val_ranking <span class="op">=</span> <span class="bu">sorted</span>(val_results.items(), key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>][<span class="st">'auc'</span>], reverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Validation Ranking:"</span>)</span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (name, res) <span class="kw">in</span> <span class="bu">enumerate</span>(val_ranking, <span class="dv">1</span>):</span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">. </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>res[<span class="st">'auc'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Print tournament results for PDF</span></span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n\n</span><span class="st">MODEL TOURNAMENT RESULTS (For PDF Extraction):"</span>)</span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>tournament_df <span class="op">=</span> pd.DataFrame([</span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'Model'</span>: name, <span class="st">'CV AUC'</span>: <span class="ss">f"</span><span class="sc">{</span>cv_results[name][<span class="st">'best_score'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>,</span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a>     <span class="st">'Val AUC'</span>: <span class="ss">f"</span><span class="sc">{</span>val_results[name][<span class="st">'auc'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>}</span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> best_models.keys()</span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a>]).sort_values(<span class="st">'Val AUC'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tournament_df.to_markdown(index<span class="op">=</span><span class="va">False</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
======================================================================
TITAN HYPERPARAMETER OPTIMIZATION (n_iter=50, cv=5)
======================================================================

==================================================
Tuning: CatBoost
==================================================
Fitting 5 folds for each of 50 candidates, totalling 250 fits
Best CV AUC: 0.9193
Best params: {'learning_rate': 0.01, 'l2_leaf_reg': 7, 'iterations': 800, 'depth': 8, 'border_count': 128}

==================================================
Tuning: XGBoost
==================================================
Fitting 5 folds for each of 50 candidates, totalling 250 fits
Best CV AUC: 0.9184
Best params: {'subsample': 0.9, 'scale_pos_weight': 1, 'reg_lambda': 2, 'reg_alpha': 0.1, 'n_estimators': 500, 'max_depth': 4, 'learning_rate': 0.03, 'colsample_bytree': 0.8}

==================================================
Tuning: LightGBM
==================================================
Fitting 5 folds for each of 50 candidates, totalling 250 fits
Best CV AUC: 0.9180
Best params: {'subsample': 0.8, 'reg_lambda': 1, 'reg_alpha': 0, 'num_leaves': 63, 'n_estimators': 300, 'learning_rate': 0.01, 'colsample_bytree': 0.7, 'class_weight': None}

==================================================
Tuning: GradientBoosting
==================================================
Fitting 5 folds for each of 50 candidates, totalling 250 fits
Best CV AUC: 0.9179
Best params: {'subsample': 0.9, 'n_estimators': 200, 'max_depth': 4, 'learning_rate': 0.05}

==================================================
Tuning: RandomForest
==================================================
Fitting 5 folds for each of 50 candidates, totalling 250 fits
Best CV AUC: 0.9121
Best params: {'n_estimators': 300, 'min_samples_split': 5, 'min_samples_leaf': 4, 'max_depth': 20}

======================================================================
VALIDATION SET PERFORMANCE
======================================================================
CatBoost: AUC = 0.9163
XGBoost: AUC = 0.9133
LightGBM: AUC = 0.9153
GradientBoosting: AUC = 0.9129
RandomForest: AUC = 0.9101

Validation Ranking:
  1. CatBoost: 0.9163
  2. LightGBM: 0.9153
  3. XGBoost: 0.9133
  4. GradientBoosting: 0.9129
  5. RandomForest: 0.9101


MODEL TOURNAMENT RESULTS (For PDF Extraction):
| Model            |   CV AUC |   Val AUC |
|:-----------------|---------:|----------:|
| CatBoost         |   0.9193 |    0.9163 |
| LightGBM         |   0.918  |    0.9153 |
| XGBoost          |   0.9184 |    0.9133 |
| GradientBoosting |   0.9179 |    0.9129 |
| RandomForest     |   0.9121 |    0.9101 |</code></pre>
</div>
</div>
</section>
<section id="stacking-ensemble" class="level2">
<h2 class="anchored" data-anchor-id="stacking-ensemble">3.3 Stacking Ensemble</h2>
<div id="stacking-ensemble" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># STACKING ENSEMBLE</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"STACKING ENSEMBLE CONSTRUCTION"</span>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>top_3_names <span class="op">=</span> [name <span class="cf">for</span> name, _ <span class="kw">in</span> val_ranking[:<span class="dv">3</span>]]</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Base learners: </span><span class="sc">{</span>top_3_names<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>stacking_estimators <span class="op">=</span> [(name, best_models[name]) <span class="cf">for</span> name <span class="kw">in</span> top_3_names]</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>meta_learner <span class="op">=</span> LogisticRegression(</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    random_state<span class="op">=</span>RANDOM_STATE,</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    max_iter<span class="op">=</span><span class="dv">1000</span>,</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    class_weight<span class="op">=</span><span class="st">'balanced'</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>stacking_clf <span class="op">=</span> StackingClassifier(</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    estimators<span class="op">=</span>stacking_estimators,</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    final_estimator<span class="op">=</span>meta_learner,</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    cv<span class="op">=</span>CV_FOLDS,</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    stack_method<span class="op">=</span><span class="st">'predict_proba'</span>,</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    n_jobs<span class="op">=</span>N_JOBS,</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    passthrough<span class="op">=</span><span class="va">False</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Training Stacking Ensemble..."</span>)</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>stacking_clf.fit(X_train_te, y_train)</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>stack_val_probs <span class="op">=</span> stacking_clf.predict_proba(X_val_te)[:, <span class="dv">1</span>]</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>stack_val_auc <span class="op">=</span> roc_auc_score(y_val, stack_val_probs)</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Stacking Ensemble Validation AUC: </span><span class="sc">{</span>stack_val_auc<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>best_individual_auc <span class="op">=</span> val_ranking[<span class="dv">0</span>][<span class="dv">1</span>][<span class="st">'auc'</span>]</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>improvement <span class="op">=</span> stack_val_auc <span class="op">-</span> best_individual_auc</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Improvement over best individual (</span><span class="sc">{</span>val_ranking[<span class="dv">0</span>][<span class="dv">0</span>]<span class="sc">}</span><span class="ss">): </span><span class="sc">{</span>improvement<span class="sc">:+.4f}</span><span class="ss">"</span>)</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>best_models[<span class="st">'StackingEnsemble'</span>] <span class="op">=</span> stacking_clf</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>val_results[<span class="st">'StackingEnsemble'</span>] <span class="op">=</span> {<span class="st">'auc'</span>: stack_val_auc, <span class="st">'probs'</span>: stack_val_probs}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
======================================================================
STACKING ENSEMBLE CONSTRUCTION
======================================================================
Base learners: ['CatBoost', 'LightGBM', 'XGBoost']
Training Stacking Ensemble...

Stacking Ensemble Validation AUC: 0.9166
Improvement over best individual (CatBoost): +0.0003</code></pre>
</div>
</div>
</section>
<section id="final-model-selection-test-evaluation" class="level2">
<h2 class="anchored" data-anchor-id="final-model-selection-test-evaluation">3.4 Final Model Selection &amp; Test Evaluation</h2>
<div id="final-evaluation" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co"># FINAL </span><span class="al">TEST</span><span class="co"> SET EVALUATION</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"FINAL TEST SET EVALUATION"</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>champion_name <span class="op">=</span> <span class="bu">max</span>(val_results.items(), key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>][<span class="st">'auc'</span>])[<span class="dv">0</span>]</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>champion_model <span class="op">=</span> best_models[champion_name]</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Champion Model: </span><span class="sc">{</span>champion_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>test_probs <span class="op">=</span> champion_model.predict_proba(X_test_te)[:, <span class="dv">1</span>]</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>test_preds <span class="op">=</span> (test_probs <span class="op">&gt;=</span> <span class="fl">0.5</span>).astype(<span class="bu">int</span>)</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>test_auc <span class="op">=</span> roc_auc_score(y_test, test_probs)</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>test_ap <span class="op">=</span> average_precision_score(y_test, test_probs)</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>test_brier <span class="op">=</span> brier_score_loss(y_test, test_probs)</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>test_logloss <span class="op">=</span> log_loss(y_test, test_probs)</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Test Set Metrics:"</span>)</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  AUC-ROC:        </span><span class="sc">{</span>test_auc<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Average Prec:   </span><span class="sc">{</span>test_ap<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Brier Score:    </span><span class="sc">{</span>test_brier<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Log Loss:       </span><span class="sc">{</span>test_logloss<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Classification Report (threshold=0.5):"</span>)</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_test, test_preds, target_names<span class="op">=</span>[<span class="st">'Not SQL'</span>, <span class="st">'SQL'</span>]))</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>cm <span class="op">=</span> confusion_matrix(y_test, test_preds)</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Confusion Matrix:"</span>)</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(cm)</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>FINAL_AUC <span class="op">=</span> test_auc</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>CHAMPION_MODEL <span class="op">=</span> champion_model</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>CHAMPION_NAME <span class="op">=</span> champion_name</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a><span class="co"># AUC Target Check</span></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> FINAL_AUC <span class="op">&gt;=</span> <span class="fl">0.90</span>:</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"TARGET ACHIEVED: AUC &gt;= 0.90!"</span>)</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"AUC: </span><span class="sc">{</span>FINAL_AUC<span class="sc">:.4f}</span><span class="ss"> (Target: 0.90, Gap: </span><span class="sc">{</span><span class="fl">0.90</span> <span class="op">-</span> FINAL_AUC<span class="sc">:.4f}</span><span class="ss">)"</span>)</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
======================================================================
FINAL TEST SET EVALUATION
======================================================================
Champion Model: StackingEnsemble

Test Set Metrics:
  AUC-ROC:        0.9153
  Average Prec:   0.7012
  Brier Score:    0.1138
  Log Loss:       0.3993

Classification Report (threshold=0.5):
              precision    recall  f1-score   support

     Not SQL       0.95      0.87      0.91      2760
         SQL       0.57      0.81      0.67       603

    accuracy                           0.86      3363
   macro avg       0.76      0.84      0.79      3363
weighted avg       0.89      0.86      0.87      3363


Confusion Matrix:
[[2399  361]
 [ 117  486]]

======================================================================
TARGET ACHIEVED: AUC &gt;= 0.90!
======================================================================</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="phase-4-profit-maximization-waste-reduction" class="level1">
<h1>Phase 4: Profit Maximization &amp; Waste Reduction</h1>
<p><strong>The Real Metric is Profit:</strong> With a <strong>$50 cost per call</strong> and <strong>$6,000 value per SQL</strong>, we calculate the exact threshold where expected revenue exceeds expected cost. V7 adds <strong>Waste Reduction Analysis</strong> to quantify savings from cutting toxic channels.</p>
<div id="profit-optimization" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"># PHASE 4: PROFIT CURVE OPTIMIZATION</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"PROFIT CURVE OPTIMIZATION"</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_profit_curve(y_true, y_probs, cost_per_call<span class="op">=</span>COST_PER_CALL, value_per_sql<span class="op">=</span>VALUE_PER_SQL):</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculate profit at various thresholds."""</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    order <span class="op">=</span> np.argsort(y_probs)[::<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    y_sorted <span class="op">=</span> y_true[order]</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    probs_sorted <span class="op">=</span> y_probs[order]</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    n_total <span class="op">=</span> <span class="bu">len</span>(y_true)</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    cumsum_success <span class="op">=</span> np.cumsum(y_sorted)</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n_total <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>        threshold <span class="op">=</span> probs_sorted[k<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>        n_calls <span class="op">=</span> k</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>        n_sqls <span class="op">=</span> cumsum_success[k<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>        revenue <span class="op">=</span> n_sqls <span class="op">*</span> value_per_sql</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>        cost <span class="op">=</span> n_calls <span class="op">*</span> cost_per_call</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>        profit <span class="op">=</span> revenue <span class="op">-</span> cost</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>        pct_population <span class="op">=</span> k <span class="op">/</span> n_total</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>        pct_sqls_captured <span class="op">=</span> n_sqls <span class="op">/</span> y_true.<span class="bu">sum</span>() <span class="cf">if</span> y_true.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>        lift <span class="op">=</span> (n_sqls <span class="op">/</span> k) <span class="op">/</span> (y_true.<span class="bu">sum</span>() <span class="op">/</span> n_total) <span class="cf">if</span> k <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>        results.append({</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>            <span class="st">'threshold'</span>: threshold,</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_calls'</span>: n_calls,</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_sqls'</span>: n_sqls,</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>            <span class="st">'revenue'</span>: revenue,</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>            <span class="st">'cost'</span>: cost,</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>            <span class="st">'profit'</span>: profit,</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>            <span class="st">'pct_population'</span>: pct_population,</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>            <span class="st">'pct_sqls_captured'</span>: pct_sqls_captured,</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>            <span class="st">'lift'</span>: lift</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results)</span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>profit_df <span class="op">=</span> calculate_profit_curve(y_test, test_probs)</span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>optimal_idx <span class="op">=</span> profit_df[<span class="st">'profit'</span>].idxmax()</span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>optimal_row <span class="op">=</span> profit_df.iloc[optimal_idx]</span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>OPTIMAL_THRESHOLD <span class="op">=</span> optimal_row[<span class="st">'threshold'</span>]</span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>MAX_PROFIT <span class="op">=</span> optimal_row[<span class="st">'profit'</span>]</span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>OPTIMAL_CALLS <span class="op">=</span> optimal_row[<span class="st">'n_calls'</span>]</span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>OPTIMAL_SQLS <span class="op">=</span> optimal_row[<span class="st">'n_sqls'</span>]</span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a>OPTIMAL_PCT_POP <span class="op">=</span> optimal_row[<span class="st">'pct_population'</span>]</span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>OPTIMAL_PCT_CAPTURE <span class="op">=</span> optimal_row[<span class="st">'pct_sqls_captured'</span>]</span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Optimal Profit Configuration:"</span>)</span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Threshold:       </span><span class="sc">{</span>OPTIMAL_THRESHOLD<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Max Profit:      $</span><span class="sc">{</span>MAX_PROFIT<span class="sc">:,.0f}</span><span class="ss">"</span>)</span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Calls Required:  </span><span class="sc">{</span>OPTIMAL_CALLS<span class="sc">:,}</span><span class="ss"> (</span><span class="sc">{</span>OPTIMAL_PCT_POP<span class="sc">:.1%}</span><span class="ss"> of population)"</span>)</span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  SQLs Captured:   </span><span class="sc">{</span>OPTIMAL_SQLS<span class="sc">:,}</span><span class="ss"> (</span><span class="sc">{</span>OPTIMAL_PCT_CAPTURE<span class="sc">:.1%}</span><span class="ss"> of all SQLs)"</span>)</span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Lift:            </span><span class="sc">{</span>OPTIMAL_PCT_CAPTURE<span class="op">/</span>OPTIMAL_PCT_POP<span class="sc">:.1f}</span><span class="ss">x over random"</span>)</span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a><span class="co"># V7 TITAN: WASTE REDUCTION ANALYSIS</span></span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"V7 TITAN: WASTE REDUCTION ANALYSIS"</span>)</span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate waste from toxic channels</span></span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'channel_tier'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get test set indices</span></span>
<span id="cb23-76"><a href="#cb23-76" aria-hidden="true" tabindex="-1"></a>    test_indices <span class="op">=</span> X_test.index</span>
<span id="cb23-77"><a href="#cb23-77" aria-hidden="true" tabindex="-1"></a>    test_df <span class="op">=</span> df.loc[test_indices].copy()</span>
<span id="cb23-78"><a href="#cb23-78" aria-hidden="true" tabindex="-1"></a>    test_df[<span class="st">'test_prob'</span>] <span class="op">=</span> test_probs</span>
<span id="cb23-79"><a href="#cb23-79" aria-hidden="true" tabindex="-1"></a>    test_df[<span class="st">'test_actual'</span>] <span class="op">=</span> y_test</span>
<span id="cb23-80"><a href="#cb23-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-81"><a href="#cb23-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Analyze by channel tier</span></span>
<span id="cb23-82"><a href="#cb23-82" aria-hidden="true" tabindex="-1"></a>    channel_analysis <span class="op">=</span> test_df.groupby(<span class="st">'channel_tier'</span>).agg({</span>
<span id="cb23-83"><a href="#cb23-83" aria-hidden="true" tabindex="-1"></a>        <span class="st">'test_actual'</span>: [<span class="st">'sum'</span>, <span class="st">'count'</span>, <span class="st">'mean'</span>],</span>
<span id="cb23-84"><a href="#cb23-84" aria-hidden="true" tabindex="-1"></a>        <span class="st">'test_prob'</span>: <span class="st">'mean'</span></span>
<span id="cb23-85"><a href="#cb23-85" aria-hidden="true" tabindex="-1"></a>    }).<span class="bu">round</span>(<span class="dv">3</span>)</span>
<span id="cb23-86"><a href="#cb23-86" aria-hidden="true" tabindex="-1"></a>    channel_analysis.columns <span class="op">=</span> [<span class="st">'SQLs'</span>, <span class="st">'Total'</span>, <span class="st">'Conv_Rate'</span>, <span class="st">'Avg_Score'</span>]</span>
<span id="cb23-87"><a href="#cb23-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-88"><a href="#cb23-88" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Channel Tier Performance (Test Set):"</span>)</span>
<span id="cb23-89"><a href="#cb23-89" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(channel_analysis.to_string())</span>
<span id="cb23-90"><a href="#cb23-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-91"><a href="#cb23-91" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate waste from toxic channels</span></span>
<span id="cb23-92"><a href="#cb23-92" aria-hidden="true" tabindex="-1"></a>    toxic_df <span class="op">=</span> test_df[test_df[<span class="st">'channel_tier'</span>] <span class="op">==</span> <span class="st">'Toxic'</span>]</span>
<span id="cb23-93"><a href="#cb23-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(toxic_df) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb23-94"><a href="#cb23-94" aria-hidden="true" tabindex="-1"></a>        toxic_calls <span class="op">=</span> <span class="bu">len</span>(toxic_df)</span>
<span id="cb23-95"><a href="#cb23-95" aria-hidden="true" tabindex="-1"></a>        toxic_sqls <span class="op">=</span> toxic_df[<span class="st">'test_actual'</span>].<span class="bu">sum</span>()</span>
<span id="cb23-96"><a href="#cb23-96" aria-hidden="true" tabindex="-1"></a>        toxic_cost <span class="op">=</span> toxic_calls <span class="op">*</span> COST_PER_CALL</span>
<span id="cb23-97"><a href="#cb23-97" aria-hidden="true" tabindex="-1"></a>        toxic_revenue <span class="op">=</span> toxic_sqls <span class="op">*</span> VALUE_PER_SQL</span>
<span id="cb23-98"><a href="#cb23-98" aria-hidden="true" tabindex="-1"></a>        toxic_profit <span class="op">=</span> toxic_revenue <span class="op">-</span> toxic_cost</span>
<span id="cb23-99"><a href="#cb23-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-100"><a href="#cb23-100" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">TOXIC CHANNEL WASTE:"</span>)</span>
<span id="cb23-101"><a href="#cb23-101" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Toxic Calls: </span><span class="sc">{</span>toxic_calls<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb23-102"><a href="#cb23-102" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Toxic SQLs: </span><span class="sc">{</span>toxic_sqls<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb23-103"><a href="#cb23-103" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Toxic Cost: $</span><span class="sc">{</span>toxic_cost<span class="sc">:,.0f}</span><span class="ss">"</span>)</span>
<span id="cb23-104"><a href="#cb23-104" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Toxic Revenue: $</span><span class="sc">{</span>toxic_revenue<span class="sc">:,.0f}</span><span class="ss">"</span>)</span>
<span id="cb23-105"><a href="#cb23-105" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Toxic Profit: $</span><span class="sc">{</span>toxic_profit<span class="sc">:,.0f}</span><span class="ss">"</span>)</span>
<span id="cb23-106"><a href="#cb23-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-107"><a href="#cb23-107" aria-hidden="true" tabindex="-1"></a>        <span class="co"># What if we cut toxic channels?</span></span>
<span id="cb23-108"><a href="#cb23-108" aria-hidden="true" tabindex="-1"></a>        non_toxic_df <span class="op">=</span> test_df[test_df[<span class="st">'channel_tier'</span>] <span class="op">!=</span> <span class="st">'Toxic'</span>]</span>
<span id="cb23-109"><a href="#cb23-109" aria-hidden="true" tabindex="-1"></a>        non_toxic_profit <span class="op">=</span> non_toxic_df[<span class="st">'test_actual'</span>].<span class="bu">sum</span>() <span class="op">*</span> VALUE_PER_SQL <span class="op">-</span> <span class="bu">len</span>(non_toxic_df) <span class="op">*</span> COST_PER_CALL</span>
<span id="cb23-110"><a href="#cb23-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-111"><a href="#cb23-111" aria-hidden="true" tabindex="-1"></a>        waste_reduction <span class="op">=</span> toxic_cost <span class="op">-</span> (toxic_sqls <span class="op">*</span> VALUE_PER_SQL)</span>
<span id="cb23-112"><a href="#cb23-112" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">  WASTE REDUCTION (by cutting Toxic): $</span><span class="sc">{</span>waste_reduction<span class="sc">:,.0f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
======================================================================
PROFIT CURVE OPTIMIZATION
======================================================================
Optimal Profit Configuration:
  Threshold:       0.128
  Max Profit:      $3,476,200
  Calls Required:  2,236.0 (66.5% of population)
  SQLs Captured:   598.0 (99.2% of all SQLs)
  Lift:            1.5x over random

======================================================================
V7 TITAN: WASTE REDUCTION ANALYSIS
======================================================================

Channel Tier Performance (Test Set):
              SQLs  Total  Conv_Rate  Avg_Score
channel_tier                                   
Premium        279   1015      0.275      0.462
Standard       276   1278      0.216      0.387
Toxic           48   1070      0.045      0.157

TOXIC CHANNEL WASTE:
  Toxic Calls: 1,070
  Toxic SQLs: 48
  Toxic Cost: $53,500
  Toxic Revenue: $288,000
  Toxic Profit: $234,500

  WASTE REDUCTION (by cutting Toxic): $-234,500</code></pre>
</div>
</div>
<div id="cell-profit-visualization" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co"># PROFIT CURVE VISUALIZATION</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"BUSINESS IMPACT TABLE (For PDF Extraction)"</span>)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>business_impact_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Metric'</span>: [<span class="st">'Optimal Threshold'</span>, <span class="st">'Leads to Contact'</span>, <span class="st">'SQLs Captured'</span>,</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>               <span class="st">'Contact %'</span>, <span class="st">'Capture %'</span>, <span class="st">'Total Cost'</span>, <span class="st">'Total Revenue'</span>, <span class="st">'Net Profit'</span>],</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Value'</span>: [<span class="ss">f'</span><span class="sc">{</span>OPTIMAL_THRESHOLD<span class="sc">:.3f}</span><span class="ss">'</span>, <span class="ss">f'</span><span class="sc">{</span>OPTIMAL_CALLS<span class="sc">:,}</span><span class="ss">'</span>, <span class="ss">f'</span><span class="sc">{</span>OPTIMAL_SQLS<span class="sc">:,}</span><span class="ss">'</span>,</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f'</span><span class="sc">{</span>OPTIMAL_PCT_POP<span class="sc">:.1%}</span><span class="ss">'</span>, <span class="ss">f'</span><span class="sc">{</span>OPTIMAL_PCT_CAPTURE<span class="sc">:.1%}</span><span class="ss">'</span>,</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f'$</span><span class="sc">{</span>OPTIMAL_CALLS <span class="op">*</span> COST_PER_CALL<span class="sc">:,.0f}</span><span class="ss">'</span>, <span class="ss">f'$</span><span class="sc">{</span>OPTIMAL_SQLS <span class="op">*</span> VALUE_PER_SQL<span class="sc">:,.0f}</span><span class="ss">'</span>,</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f'$</span><span class="sc">{</span>MAX_PROFIT<span class="sc">:,.0f}</span><span class="ss">'</span>]</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(business_impact_df.to_markdown(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">10</span>))</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Profit Curve</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>ax1 <span class="op">=</span> axes[<span class="dv">0</span>, <span class="dv">0</span>]</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>ax1.plot(profit_df[<span class="st">'pct_population'</span>] <span class="op">*</span> <span class="dv">100</span>, profit_df[<span class="st">'profit'</span>] <span class="op">/</span> <span class="dv">1000</span>,</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>         color<span class="op">=</span>PROJECT_COLS[<span class="st">'Profit'</span>], linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>ax1.axvline(x<span class="op">=</span>OPTIMAL_PCT_POP <span class="op">*</span> <span class="dv">100</span>, color<span class="op">=</span>PROJECT_COLS[<span class="st">'Gold'</span>], linestyle<span class="op">=</span><span class="st">'--'</span>,</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="ss">f'Optimal: </span><span class="sc">{</span>OPTIMAL_PCT_POP<span class="sc">:.1%}</span><span class="ss">'</span>)</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>ax1.scatter([OPTIMAL_PCT_POP <span class="op">*</span> <span class="dv">100</span>], [MAX_PROFIT <span class="op">/</span> <span class="dv">1000</span>],</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>PROJECT_COLS[<span class="st">'Gold'</span>], s<span class="op">=</span><span class="dv">100</span>, zorder<span class="op">=</span><span class="dv">5</span>, marker<span class="op">=</span><span class="st">'*'</span>)</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>ax1.fill_between(profit_df[<span class="st">'pct_population'</span>] <span class="op">*</span> <span class="dv">100</span>, <span class="dv">0</span>, profit_df[<span class="st">'profit'</span>] <span class="op">/</span> <span class="dv">1000</span>,</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>                 alpha<span class="op">=</span><span class="fl">0.3</span>, color<span class="op">=</span>PROJECT_COLS[<span class="st">'Profit'</span>])</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">'</span><span class="sc">% o</span><span class="st">f Leads Contacted'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">'Profit ($K)'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="st">'Profit Curve: Finding the "Money Point"'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>ax1.legend()</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>ax1.set_xlim(<span class="dv">0</span>, <span class="dv">100</span>)</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Cumulative Gains</span></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> axes[<span class="dv">0</span>, <span class="dv">1</span>]</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>ax2.plot(profit_df[<span class="st">'pct_population'</span>] <span class="op">*</span> <span class="dv">100</span>, profit_df[<span class="st">'pct_sqls_captured'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>         color<span class="op">=</span>PROJECT_COLS[<span class="st">'Success'</span>], linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'Model'</span>)</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>ax2.plot([<span class="dv">0</span>, <span class="dv">100</span>], [<span class="dv">0</span>, <span class="dv">100</span>], <span class="st">'k--'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, label<span class="op">=</span><span class="st">'Random'</span>)</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>ax2.axhline(y<span class="op">=</span><span class="dv">90</span>, color<span class="op">=</span>PROJECT_COLS[<span class="st">'Gold'</span>], linestyle<span class="op">=</span><span class="st">':'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span><span class="st">'90% Capture'</span>)</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>ax2.fill_between(profit_df[<span class="st">'pct_population'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>                 profit_df[<span class="st">'pct_population'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>                 profit_df[<span class="st">'pct_sqls_captured'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>                 alpha<span class="op">=</span><span class="fl">0.3</span>, color<span class="op">=</span>PROJECT_COLS[<span class="st">'Success'</span>])</span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>ax2.set_xlabel(<span class="st">'</span><span class="sc">% o</span><span class="st">f Leads Contacted'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">'</span><span class="sc">% o</span><span class="st">f SQLs Captured'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a>ax2.set_title(<span class="st">'Cumulative Gains Chart'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a>ax2.legend(loc<span class="op">=</span><span class="st">'lower right'</span>)</span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a>ax2.set_xlim(<span class="dv">0</span>, <span class="dv">100</span>)</span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a>ax2.set_ylim(<span class="dv">0</span>, <span class="dv">100</span>)</span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Lift Chart</span></span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a>ax3 <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">0</span>]</span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a>ax3.plot(profit_df[<span class="st">'pct_population'</span>] <span class="op">*</span> <span class="dv">100</span>, profit_df[<span class="st">'lift'</span>],</span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a>         color<span class="op">=</span>PROJECT_COLS[<span class="st">'Highlight'</span>], linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a>ax3.axhline(y<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, label<span class="op">=</span><span class="st">'Baseline (1.0x)'</span>)</span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a>ax3.fill_between(profit_df[<span class="st">'pct_population'</span>] <span class="op">*</span> <span class="dv">100</span>, <span class="dv">1</span>, profit_df[<span class="st">'lift'</span>],</span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a>                 where<span class="op">=</span>profit_df[<span class="st">'lift'</span>] <span class="op">&gt;</span> <span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, color<span class="op">=</span>PROJECT_COLS[<span class="st">'Success'</span>])</span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a>ax3.set_xlabel(<span class="st">'</span><span class="sc">% o</span><span class="st">f Leads Contacted'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a>ax3.set_ylabel(<span class="st">'Lift (vs Random)'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a>ax3.set_title(<span class="st">'Lift Chart: Predictive Advantage'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a>ax3.legend()</span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a>ax3.set_xlim(<span class="dv">0</span>, <span class="dv">100</span>)</span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. ROI by Decile</span></span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a>ax4 <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a>decile_profits <span class="op">=</span> []</span>
<span id="cb25-70"><a href="#cb25-70" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb25-71"><a href="#cb25-71" aria-hidden="true" tabindex="-1"></a>    start_pct <span class="op">=</span> i <span class="op">*</span> <span class="fl">0.1</span></span>
<span id="cb25-72"><a href="#cb25-72" aria-hidden="true" tabindex="-1"></a>    end_pct <span class="op">=</span> (i <span class="op">+</span> <span class="dv">1</span>) <span class="op">*</span> <span class="fl">0.1</span></span>
<span id="cb25-73"><a href="#cb25-73" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> (profit_df[<span class="st">'pct_population'</span>] <span class="op">&gt;</span> start_pct) <span class="op">&amp;</span> (profit_df[<span class="st">'pct_population'</span>] <span class="op">&lt;=</span> end_pct)</span>
<span id="cb25-74"><a href="#cb25-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mask.<span class="bu">any</span>():</span>
<span id="cb25-75"><a href="#cb25-75" aria-hidden="true" tabindex="-1"></a>        decile_row <span class="op">=</span> profit_df[mask].iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb25-76"><a href="#cb25-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb25-77"><a href="#cb25-77" aria-hidden="true" tabindex="-1"></a>            decile_profit <span class="op">=</span> decile_row[<span class="st">'profit'</span>]</span>
<span id="cb25-78"><a href="#cb25-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb25-79"><a href="#cb25-79" aria-hidden="true" tabindex="-1"></a>            prev_row <span class="op">=</span> profit_df[profit_df[<span class="st">'pct_population'</span>] <span class="op">&lt;=</span> start_pct].iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb25-80"><a href="#cb25-80" aria-hidden="true" tabindex="-1"></a>            decile_profit <span class="op">=</span> decile_row[<span class="st">'profit'</span>] <span class="op">-</span> prev_row[<span class="st">'profit'</span>]</span>
<span id="cb25-81"><a href="#cb25-81" aria-hidden="true" tabindex="-1"></a>        decile_profits.append(decile_profit <span class="op">/</span> <span class="dv">1000</span>)</span>
<span id="cb25-82"><a href="#cb25-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb25-83"><a href="#cb25-83" aria-hidden="true" tabindex="-1"></a>        decile_profits.append(<span class="dv">0</span>)</span>
<span id="cb25-84"><a href="#cb25-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-85"><a href="#cb25-85" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [PROJECT_COLS[<span class="st">'Success'</span>] <span class="cf">if</span> p <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> PROJECT_COLS[<span class="st">'Failure'</span>] <span class="cf">for</span> p <span class="kw">in</span> decile_profits]</span>
<span id="cb25-86"><a href="#cb25-86" aria-hidden="true" tabindex="-1"></a>ax4.bar(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">11</span>), decile_profits, color<span class="op">=</span>colors, edgecolor<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb25-87"><a href="#cb25-87" aria-hidden="true" tabindex="-1"></a>ax4.axhline(y<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb25-88"><a href="#cb25-88" aria-hidden="true" tabindex="-1"></a>ax4.set_xlabel(<span class="st">'Decile (1 = Highest Score)'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb25-89"><a href="#cb25-89" aria-hidden="true" tabindex="-1"></a>ax4.set_ylabel(<span class="st">'Incremental Profit ($K)'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb25-90"><a href="#cb25-90" aria-hidden="true" tabindex="-1"></a>ax4.set_title(<span class="st">'Profit by Decile: Where the Money Is'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb25-91"><a href="#cb25-91" aria-hidden="true" tabindex="-1"></a>ax4.set_xticks(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">11</span>))</span>
<span id="cb25-92"><a href="#cb25-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-93"><a href="#cb25-93" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb25-94"><a href="#cb25-94" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb25-95"><a href="#cb25-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-96"><a href="#cb25-96" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">THE MONEY SLIDE:"</span>)</span>
<span id="cb25-97"><a href="#cb25-97" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  By prioritizing leads with Score &gt; </span><span class="sc">{</span>OPTIMAL_THRESHOLD<span class="sc">:.2f}</span><span class="ss">, we capture"</span>)</span>
<span id="cb25-98"><a href="#cb25-98" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>OPTIMAL_PCT_CAPTURE<span class="sc">:.0%}</span><span class="ss"> of revenue with </span><span class="sc">{</span>OPTIMAL_PCT_POP<span class="sc">:.0%}</span><span class="ss"> of the effort."</span>)</span>
<span id="cb25-99"><a href="#cb25-99" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Maximum Profit: $</span><span class="sc">{</span>MAX_PROFIT<span class="sc">:,.0f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
======================================================================
BUSINESS IMPACT TABLE (For PDF Extraction)
======================================================================
| Metric            | Value      |
|:------------------|:-----------|
| Optimal Threshold | 0.128      |
| Leads to Contact  | 2,236.0    |
| SQLs Captured     | 598.0      |
| Contact %         | 66.5%      |
| Capture %         | 99.2%      |
| Total Cost        | $111,800   |
| Total Revenue     | $3,588,000 |
| Net Profit        | $3,476,200 |</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="mastercontrol_model_v9_files/figure-html/profit-visualization-output-2.png" id="profit-visualization" width="1312" height="927" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
THE MONEY SLIDE:
  By prioritizing leads with Score &gt; 0.13, we capture
  99% of revenue with 66% of the effort.
  Maximum Profit: $3,476,200</code></pre>
</div>
</div>
<hr>
</section>
<section id="phase-5-executive-dashboard" class="level1">
<h1>Phase 5: Executive Dashboard</h1>
<p><strong>Four Panels for Leadership:</strong> (1) Discriminative power, (2) Imbalanced performance, (3) Profit maximization, (4) Channel tier analysis.</p>
<div id="cell-executive-dashboard" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="co"># PHASE 5: EXECUTIVE DASHBOARD</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"EXECUTIVE DASHBOARD"</span>)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">MODEL PERFORMANCE METRICS (For PDF Extraction):"</span>)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>dashboard_metrics <span class="op">=</span> pd.DataFrame({</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Metric'</span>: [<span class="st">'AUC-ROC'</span>, <span class="st">'Average Precision'</span>, <span class="st">'Brier Score'</span>, <span class="st">'Log Loss'</span>,</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>               <span class="st">'Optimal Threshold'</span>, <span class="st">'Max Profit'</span>],</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Value'</span>: [<span class="ss">f'</span><span class="sc">{</span>test_auc<span class="sc">:.4f}</span><span class="ss">'</span>, <span class="ss">f'</span><span class="sc">{</span>test_ap<span class="sc">:.4f}</span><span class="ss">'</span>, <span class="ss">f'</span><span class="sc">{</span>test_brier<span class="sc">:.4f}</span><span class="ss">'</span>, <span class="ss">f'</span><span class="sc">{</span>test_logloss<span class="sc">:.4f}</span><span class="ss">'</span>,</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f'</span><span class="sc">{</span>OPTIMAL_THRESHOLD<span class="sc">:.3f}</span><span class="ss">'</span>, <span class="ss">f'$</span><span class="sc">{</span>MAX_PROFIT<span class="sc">:,.0f}</span><span class="ss">'</span>]</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(dashboard_metrics.to_markdown(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">12</span>))</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 1: ROC Curve</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>ax1 <span class="op">=</span> axes[<span class="dv">0</span>, <span class="dv">0</span>]</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>fpr, tpr, thresholds <span class="op">=</span> roc_curve(y_test, test_probs)</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>ax1.plot(fpr, tpr, color<span class="op">=</span>PROJECT_COLS[<span class="st">'Success'</span>], linewidth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>         label<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>CHAMPION_NAME<span class="sc">}</span><span class="ss"> (AUC = </span><span class="sc">{</span>FINAL_AUC<span class="sc">:.3f}</span><span class="ss">)'</span>)</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>ax1.plot([<span class="dv">0</span>, <span class="dv">1</span>], [<span class="dv">0</span>, <span class="dv">1</span>], <span class="st">'k--'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, label<span class="op">=</span><span class="st">'Random (AUC = 0.500)'</span>)</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>ax1.fill_between(fpr, <span class="dv">0</span>, tpr, alpha<span class="op">=</span><span class="fl">0.3</span>, color<span class="op">=</span>PROJECT_COLS[<span class="st">'Success'</span>])</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>optimal_idx_roc <span class="op">=</span> np.argmin(np.<span class="bu">abs</span>(thresholds <span class="op">-</span> OPTIMAL_THRESHOLD))</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>ax1.scatter([fpr[optimal_idx_roc]], [tpr[optimal_idx_roc]],</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>PROJECT_COLS[<span class="st">'Gold'</span>], s<span class="op">=</span><span class="dv">150</span>, marker<span class="op">=</span><span class="st">'*'</span>, zorder<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="ss">f'Profit-Optimal (t=</span><span class="sc">{</span>OPTIMAL_THRESHOLD<span class="sc">:.2f}</span><span class="ss">)'</span>)</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">'False Positive Rate'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">'True Positive Rate'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="st">'ROC Curve: Discriminative Power'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>ax1.legend(loc<span class="op">=</span><span class="st">'lower right'</span>)</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>ax1.set_xlim(<span class="op">-</span><span class="fl">0.02</span>, <span class="fl">1.02</span>)</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>ax1.set_ylim(<span class="op">-</span><span class="fl">0.02</span>, <span class="fl">1.02</span>)</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> FINAL_AUC <span class="op">&gt;=</span> <span class="fl">0.90</span>:</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>    ax1.annotate(<span class="st">'TARGET ACHIEVED!'</span>, xy<span class="op">=</span>(<span class="fl">0.6</span>, <span class="fl">0.3</span>), fontsize<span class="op">=</span><span class="dv">12</span>,</span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>                 color<span class="op">=</span>PROJECT_COLS[<span class="st">'Success'</span>], fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 2: Precision-Recall</span></span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> axes[<span class="dv">0</span>, <span class="dv">1</span>]</span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>precision, recall, pr_thresholds <span class="op">=</span> precision_recall_curve(y_test, test_probs)</span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>ap <span class="op">=</span> average_precision_score(y_test, test_probs)</span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>ax2.plot(recall, precision, color<span class="op">=</span>PROJECT_COLS[<span class="st">'Highlight'</span>], linewidth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a>         label<span class="op">=</span><span class="ss">f'Model (AP = </span><span class="sc">{</span>ap<span class="sc">:.3f}</span><span class="ss">)'</span>)</span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>ax2.axhline(y<span class="op">=</span>y_test.mean(), color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="ss">f'Baseline (</span><span class="sc">{</span>y_test<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss">)'</span>)</span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a>ax2.fill_between(recall, <span class="dv">0</span>, precision, alpha<span class="op">=</span><span class="fl">0.3</span>, color<span class="op">=</span>PROJECT_COLS[<span class="st">'Highlight'</span>])</span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a>ax2.set_xlabel(<span class="st">'Recall (Sensitivity)'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">'Precision'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a>ax2.set_title(<span class="st">'Precision-Recall: Imbalanced Performance'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a>ax2.legend(loc<span class="op">=</span><span class="st">'upper right'</span>)</span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 3: Profit Curve</span></span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a>ax3 <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">0</span>]</span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a>ax3.plot(profit_df[<span class="st">'pct_population'</span>] <span class="op">*</span> <span class="dv">100</span>, profit_df[<span class="st">'profit'</span>] <span class="op">/</span> <span class="dv">1000</span>,</span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a>         color<span class="op">=</span>PROJECT_COLS[<span class="st">'Profit'</span>], linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a>ax3.axvline(x<span class="op">=</span>OPTIMAL_PCT_POP <span class="op">*</span> <span class="dv">100</span>, color<span class="op">=</span>PROJECT_COLS[<span class="st">'Gold'</span>], linestyle<span class="op">=</span><span class="st">'--'</span>,</span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a>            linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="ss">f'Optimal: </span><span class="sc">{</span>OPTIMAL_PCT_POP<span class="sc">:.0%}</span><span class="ss">'</span>)</span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a>ax3.scatter([OPTIMAL_PCT_POP <span class="op">*</span> <span class="dv">100</span>], [MAX_PROFIT <span class="op">/</span> <span class="dv">1000</span>],</span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>PROJECT_COLS[<span class="st">'Gold'</span>], s<span class="op">=</span><span class="dv">200</span>, marker<span class="op">=</span><span class="st">'*'</span>, zorder<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a>ax3.annotate(<span class="ss">f'Max Profit: $</span><span class="sc">{</span>MAX_PROFIT<span class="sc">:,.0f}</span><span class="ss">'</span>,</span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a>             xy<span class="op">=</span>(OPTIMAL_PCT_POP <span class="op">*</span> <span class="dv">100</span>, MAX_PROFIT <span class="op">/</span> <span class="dv">1000</span>),</span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a>             xytext<span class="op">=</span>(OPTIMAL_PCT_POP <span class="op">*</span> <span class="dv">100</span> <span class="op">+</span> <span class="dv">15</span>, MAX_PROFIT <span class="op">/</span> <span class="dv">1000</span>),</span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a>             fontsize<span class="op">=</span><span class="dv">10</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>,</span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a>             arrowprops<span class="op">=</span><span class="bu">dict</span>(arrowstyle<span class="op">=</span><span class="st">'-&gt;'</span>, color<span class="op">=</span><span class="st">'gray'</span>))</span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a>ax3.fill_between(profit_df[<span class="st">'pct_population'</span>] <span class="op">*</span> <span class="dv">100</span>, <span class="dv">0</span>, profit_df[<span class="st">'profit'</span>] <span class="op">/</span> <span class="dv">1000</span>,</span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a>                 alpha<span class="op">=</span><span class="fl">0.3</span>, color<span class="op">=</span>PROJECT_COLS[<span class="st">'Profit'</span>])</span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a>ax3.set_xlabel(<span class="st">'</span><span class="sc">% o</span><span class="st">f Leads Contacted'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb28-78"><a href="#cb28-78" aria-hidden="true" tabindex="-1"></a>ax3.set_ylabel(<span class="st">'Profit ($K)'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb28-79"><a href="#cb28-79" aria-hidden="true" tabindex="-1"></a>ax3.set_title(<span class="st">'Profit Maximization: The Business Case'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb28-80"><a href="#cb28-80" aria-hidden="true" tabindex="-1"></a>ax3.legend(loc<span class="op">=</span><span class="st">'upper right'</span>)</span>
<span id="cb28-81"><a href="#cb28-81" aria-hidden="true" tabindex="-1"></a>ax3.set_xlim(<span class="dv">0</span>, <span class="dv">100</span>)</span>
<span id="cb28-82"><a href="#cb28-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-83"><a href="#cb28-83" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 4: V7 TITAN - Channel Tier Conversion</span></span>
<span id="cb28-84"><a href="#cb28-84" aria-hidden="true" tabindex="-1"></a>ax4 <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb28-85"><a href="#cb28-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-86"><a href="#cb28-86" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'channel_tier'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb28-87"><a href="#cb28-87" aria-hidden="true" tabindex="-1"></a>    test_indices <span class="op">=</span> X_test.index</span>
<span id="cb28-88"><a href="#cb28-88" aria-hidden="true" tabindex="-1"></a>    test_df_plot <span class="op">=</span> df.loc[test_indices].copy()</span>
<span id="cb28-89"><a href="#cb28-89" aria-hidden="true" tabindex="-1"></a>    test_df_plot[<span class="st">'actual'</span>] <span class="op">=</span> y_test</span>
<span id="cb28-90"><a href="#cb28-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-91"><a href="#cb28-91" aria-hidden="true" tabindex="-1"></a>    channel_conv <span class="op">=</span> test_df_plot.groupby(<span class="st">'channel_tier'</span>)[<span class="st">'actual'</span>].agg([<span class="st">'mean'</span>, <span class="st">'count'</span>])</span>
<span id="cb28-92"><a href="#cb28-92" aria-hidden="true" tabindex="-1"></a>    channel_conv <span class="op">=</span> channel_conv.reindex([<span class="st">'Premium'</span>, <span class="st">'Standard'</span>, <span class="st">'Toxic'</span>])</span>
<span id="cb28-93"><a href="#cb28-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-94"><a href="#cb28-94" aria-hidden="true" tabindex="-1"></a>    tier_colors <span class="op">=</span> [PROJECT_COLS[<span class="st">'Premium'</span>], PROJECT_COLS[<span class="st">'Neutral'</span>], PROJECT_COLS[<span class="st">'Toxic'</span>]]</span>
<span id="cb28-95"><a href="#cb28-95" aria-hidden="true" tabindex="-1"></a>    bars <span class="op">=</span> ax4.bar(channel_conv.index, channel_conv[<span class="st">'mean'</span>], color<span class="op">=</span>tier_colors, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb28-96"><a href="#cb28-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-97"><a href="#cb28-97" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add value labels and count</span></span>
<span id="cb28-98"><a href="#cb28-98" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, (idx, row) <span class="kw">in</span> <span class="bu">enumerate</span>(channel_conv.iterrows()):</span>
<span id="cb28-99"><a href="#cb28-99" aria-hidden="true" tabindex="-1"></a>        ax4.text(i, row[<span class="st">'mean'</span>] <span class="op">+</span> <span class="fl">0.01</span>, <span class="ss">f'</span><span class="sc">{</span>row[<span class="st">"mean"</span>]<span class="sc">:.1%}</span><span class="ss">'</span>, ha<span class="op">=</span><span class="st">'center'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb28-100"><a href="#cb28-100" aria-hidden="true" tabindex="-1"></a>        ax4.text(i, row[<span class="st">'mean'</span>] <span class="op">/</span> <span class="dv">2</span>, <span class="ss">f'n=</span><span class="sc">{</span><span class="bu">int</span>(row[<span class="st">"count"</span>])<span class="sc">:,}</span><span class="ss">'</span>, ha<span class="op">=</span><span class="st">'center'</span>, color<span class="op">=</span><span class="st">'white'</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb28-101"><a href="#cb28-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-102"><a href="#cb28-102" aria-hidden="true" tabindex="-1"></a>    ax4.set_ylabel(<span class="st">'Conversion Rate'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb28-103"><a href="#cb28-103" aria-hidden="true" tabindex="-1"></a>    ax4.set_xlabel(<span class="st">'Channel Tier'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb28-104"><a href="#cb28-104" aria-hidden="true" tabindex="-1"></a>    ax4.set_title(<span class="st">'V7 TITAN: Conversion by Channel Tier'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb28-105"><a href="#cb28-105" aria-hidden="true" tabindex="-1"></a>    ax4.axhline(y<span class="op">=</span>test_df_plot[<span class="st">'actual'</span>].mean(), color<span class="op">=</span><span class="st">'black'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>,</span>
<span id="cb28-106"><a href="#cb28-106" aria-hidden="true" tabindex="-1"></a>                alpha<span class="op">=</span><span class="fl">0.5</span>, label<span class="op">=</span><span class="ss">f'Baseline (</span><span class="sc">{</span>test_df_plot[<span class="st">"actual"</span>]<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss">)'</span>)</span>
<span id="cb28-107"><a href="#cb28-107" aria-hidden="true" tabindex="-1"></a>    ax4.legend()</span>
<span id="cb28-108"><a href="#cb28-108" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb28-109"><a href="#cb28-109" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fallback: Feature Importance</span></span>
<span id="cb28-110"><a href="#cb28-110" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(CHAMPION_MODEL, <span class="st">'feature_importances_'</span>):</span>
<span id="cb28-111"><a href="#cb28-111" aria-hidden="true" tabindex="-1"></a>        importances <span class="op">=</span> CHAMPION_MODEL.feature_importances_</span>
<span id="cb28-112"><a href="#cb28-112" aria-hidden="true" tabindex="-1"></a>        imp_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb28-113"><a href="#cb28-113" aria-hidden="true" tabindex="-1"></a>            <span class="st">'feature'</span>: X_train_te.columns,</span>
<span id="cb28-114"><a href="#cb28-114" aria-hidden="true" tabindex="-1"></a>            <span class="st">'importance'</span>: importances</span>
<span id="cb28-115"><a href="#cb28-115" aria-hidden="true" tabindex="-1"></a>        }).sort_values(<span class="st">'importance'</span>, ascending<span class="op">=</span><span class="va">True</span>).tail(<span class="dv">15</span>)</span>
<span id="cb28-116"><a href="#cb28-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-117"><a href="#cb28-117" aria-hidden="true" tabindex="-1"></a>        ax4.barh(<span class="bu">range</span>(<span class="bu">len</span>(imp_df)), imp_df[<span class="st">'importance'</span>], color<span class="op">=</span>PROJECT_COLS[<span class="st">'Neutral'</span>])</span>
<span id="cb28-118"><a href="#cb28-118" aria-hidden="true" tabindex="-1"></a>        ax4.set_yticks(<span class="bu">range</span>(<span class="bu">len</span>(imp_df)))</span>
<span id="cb28-119"><a href="#cb28-119" aria-hidden="true" tabindex="-1"></a>        ax4.set_yticklabels(imp_df[<span class="st">'feature'</span>], fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb28-120"><a href="#cb28-120" aria-hidden="true" tabindex="-1"></a>        ax4.set_xlabel(<span class="st">'Importance'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb28-121"><a href="#cb28-121" aria-hidden="true" tabindex="-1"></a>        ax4.set_title(<span class="st">'Feature Importance'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb28-122"><a href="#cb28-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-123"><a href="#cb28-123" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb28-124"><a href="#cb28-124" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="ss">f'V7 Titan Engine: </span><span class="sc">{</span>CHAMPION_NAME<span class="sc">}</span><span class="ss"> Performance Dashboard'</span>,</span>
<span id="cb28-125"><a href="#cb28-125" aria-hidden="true" tabindex="-1"></a>             fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, y<span class="op">=</span><span class="fl">1.02</span>)</span>
<span id="cb28-126"><a href="#cb28-126" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
======================================================================
EXECUTIVE DASHBOARD
======================================================================

MODEL PERFORMANCE METRICS (For PDF Extraction):
| Metric            | Value      |
|:------------------|:-----------|
| AUC-ROC           | 0.9153     |
| Average Precision | 0.7012     |
| Brier Score       | 0.1138     |
| Log Loss          | 0.3993     |
| Optimal Threshold | 0.128      |
| Max Profit        | $3,476,200 |</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="mastercontrol_model_v9_files/figure-html/executive-dashboard-output-2.png" id="executive-dashboard" width="1504" height="1168" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
<section id="phase-6-shap-explainability" class="level1">
<h1>Phase 6: SHAP Explainability</h1>
<p><strong>Black Box? Not Anymore:</strong> SHAP breaks down every prediction into individual feature contributions.</p>
<div id="shap-analysis" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="co"># PHASE 6: SHAP EXPLAINABILITY</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> SHAP_AVAILABLE:</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"SHAP EXPLAINABILITY ANALYSIS"</span>)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    np.random.seed(RANDOM_STATE)</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    bg_idx <span class="op">=</span> np.random.choice(<span class="bu">len</span>(X_train_te), <span class="bu">min</span>(SHAP_BACKGROUND_SAMPLES, <span class="bu">len</span>(X_train_te)), replace<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    test_idx <span class="op">=</span> np.random.choice(<span class="bu">len</span>(X_test_te), <span class="bu">min</span>(SHAP_TEST_SAMPLES, <span class="bu">len</span>(X_test_te)), replace<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    X_bg <span class="op">=</span> X_train_te.iloc[bg_idx]</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    X_explain <span class="op">=</span> X_test_te.iloc[test_idx]</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> CHAMPION_NAME <span class="kw">in</span> [<span class="st">'CatBoost'</span>, <span class="st">'XGBoost'</span>, <span class="st">'LightGBM'</span>, <span class="st">'GradientBoosting'</span>, <span class="st">'RandomForest'</span>]:</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> CHAMPION_NAME <span class="op">==</span> <span class="st">'CatBoost'</span> <span class="kw">and</span> <span class="bu">hasattr</span>(CHAMPION_MODEL, <span class="st">'_model'</span>):</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>                explainer <span class="op">=</span> shap.TreeExplainer(CHAMPION_MODEL._model)</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>                explainer <span class="op">=</span> shap.TreeExplainer(CHAMPION_MODEL)</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>            shap_values <span class="op">=</span> explainer.shap_values(X_explain)</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(shap_values, <span class="bu">list</span>):</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>                shap_values <span class="op">=</span> shap_values[<span class="dv">1</span>]</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> CHAMPION_NAME <span class="op">==</span> <span class="st">'StackingEnsemble'</span>:</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Explaining best base estimator..."</span>)</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>            best_base_name <span class="op">=</span> top_3_names[<span class="dv">0</span>]</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>            best_base_model <span class="op">=</span> best_models[best_base_name]</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> best_base_name <span class="op">==</span> <span class="st">'CatBoost'</span> <span class="kw">and</span> <span class="bu">hasattr</span>(best_base_model, <span class="st">'_model'</span>):</span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>                explainer <span class="op">=</span> shap.TreeExplainer(best_base_model._model)</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>                explainer <span class="op">=</span> shap.TreeExplainer(best_base_model)</span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>            shap_values <span class="op">=</span> explainer.shap_values(X_explain)</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(shap_values, <span class="bu">list</span>):</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>                shap_values <span class="op">=</span> shap_values[<span class="dv">1</span>]</span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"SHAP computed for: </span><span class="sc">{</span>best_base_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Using KernelExplainer..."</span>)</span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>            explainer <span class="op">=</span> shap.KernelExplainer(</span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>                <span class="kw">lambda</span> x: CHAMPION_MODEL.predict_proba(x)[:, <span class="dv">1</span>],</span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>                X_bg</span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>            shap_values <span class="op">=</span> explainer.shap_values(X_explain, nsamples<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a>        fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>))</span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a>        shap.summary_plot(shap_values, X_explain, plot_type<span class="op">=</span><span class="st">"bar"</span>, show<span class="op">=</span><span class="va">False</span>, max_display<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a>        plt.title(<span class="ss">f'SHAP Feature Importance: </span><span class="sc">{</span>CHAMPION_NAME<span class="sc">}</span><span class="ss">'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>        fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">10</span>))</span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a>        shap.summary_plot(shap_values, X_explain, show<span class="op">=</span><span class="va">False</span>, max_display<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a>        plt.title(<span class="ss">f'SHAP Value Distribution'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"SHAP analysis complete."</span>)</span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"SHAP analysis failed: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Continuing without SHAP visualizations."</span>)</span>
<span id="cb30-67"><a href="#cb30-67" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb30-68"><a href="#cb30-68" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">SHAP not available. Skipping explainability analysis."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
======================================================================
SHAP EXPLAINABILITY ANALYSIS
======================================================================
Explaining best base estimator...
SHAP computed for: CatBoost</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="mastercontrol_model_v9_files/figure-html/shap-analysis-output-2.png" id="shap-analysis-1" width="751" height="881" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="mastercontrol_model_v9_files/figure-html/shap-analysis-output-3.png" id="shap-analysis-2" width="720" height="688" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>SHAP analysis complete.</code></pre>
</div>
</div>
<hr>
</section>
<section id="the-bottom-line" class="level1">
<h1>The Bottom Line</h1>
<p><strong>Strategic Recommendation:</strong> The V7 Titan Engine delivers domain-optimized predictive power by encoding the “Hidden Gems,” correcting for “Toxic Channels,” and aligning the algorithm with the financial reality of the buyer.</p>
<div id="bottom-line" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="co"># THE BOTTOM LINE</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>runtime_min <span class="op">=</span> (time.time() <span class="op">-</span> START_TIME) <span class="op">/</span> <span class="dv">60</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"THE BOTTOM LINE"</span>)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Revenue projections</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>baseline_profit <span class="op">=</span> y_test.<span class="bu">sum</span>() <span class="op">*</span> VALUE_PER_SQL <span class="op">-</span> <span class="bu">len</span>(y_test) <span class="op">*</span> COST_PER_CALL</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>model_profit <span class="op">=</span> MAX_PROFIT</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>monthly_lift <span class="op">=</span> model_profit <span class="op">-</span> baseline_profit</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>annualized_lift <span class="op">=</span> monthly_lift <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Hidden Gem analysis</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'is_hidden_gem'</span> <span class="kw">in</span> X_test.columns:</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>    gem_mask <span class="op">=</span> X_test[<span class="st">'is_hidden_gem'</span>] <span class="op">==</span> <span class="dv">1</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>    gem_conv_rate <span class="op">=</span> y_test[gem_mask.values].mean() <span class="cf">if</span> gem_mask.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    gem_conv_rate <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Channel analysis</span></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'channel_tier'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>    test_indices <span class="op">=</span> X_test.index</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>    test_df_final <span class="op">=</span> df.loc[test_indices].copy()</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>    test_df_final[<span class="st">'actual'</span>] <span class="op">=</span> y_test</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>    toxic_mask <span class="op">=</span> test_df_final[<span class="st">'channel_tier'</span>] <span class="op">==</span> <span class="st">'Toxic'</span></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>    toxic_conv <span class="op">=</span> test_df_final[toxic_mask][<span class="st">'actual'</span>].mean() <span class="cf">if</span> toxic_mask.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>    toxic_count <span class="op">=</span> toxic_mask.<span class="bu">sum</span>()</span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>    premium_mask <span class="op">=</span> test_df_final[<span class="st">'channel_tier'</span>] <span class="op">==</span> <span class="st">'Premium'</span></span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>    premium_conv <span class="op">=</span> test_df_final[premium_mask][<span class="st">'actual'</span>].mean() <span class="cf">if</span> premium_mask.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>    toxic_conv <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>    toxic_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a>    premium_conv <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Golden segment</span></span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a>top_decile_mask <span class="op">=</span> test_probs <span class="op">&gt;=</span> np.percentile(test_probs, <span class="dv">90</span>)</span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a>golden_segment_rate <span class="op">=</span> y_test[top_decile_mask].mean() <span class="cf">if</span> top_decile_mask.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"""</span></span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a><span class="ss">================================================================================</span></span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a><span class="ss">V7 TITAN: STRATEGIC RECOMMENDATION</span></span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a><span class="ss">================================================================================</span></span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-50"><a href="#cb33-50" aria-hidden="true" tabindex="-1"></a><span class="ss">The V7 Titan Engine delivers a projected $</span><span class="sc">{</span>annualized_lift<span class="sc">:,.0f}</span><span class="ss"> annualized revenue lift</span></span>
<span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a><span class="ss">by encoding domain expertise into the algorithm.</span></span>
<span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-53"><a href="#cb33-53" aria-hidden="true" tabindex="-1"></a><span class="ss">MODEL PERFORMANCE:</span></span>
<span id="cb33-54"><a href="#cb33-54" aria-hidden="true" tabindex="-1"></a><span class="ss">  - AUC-ROC:          </span><span class="sc">{</span>FINAL_AUC<span class="sc">:.4f}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'[TARGET MET]'</span> <span class="cf">if</span> FINAL_AUC <span class="op">&gt;=</span> <span class="fl">0.90</span> <span class="cf">else</span> <span class="ss">f'(Target: 0.90, Gap: </span><span class="sc">{</span><span class="fl">0.90</span> <span class="op">-</span> FINAL_AUC<span class="sc">:.4f}</span><span class="ss">)'</span><span class="sc">}</span></span>
<span id="cb33-55"><a href="#cb33-55" aria-hidden="true" tabindex="-1"></a><span class="ss">  - Average Precision: </span><span class="sc">{</span>test_ap<span class="sc">:.4f}</span></span>
<span id="cb33-56"><a href="#cb33-56" aria-hidden="true" tabindex="-1"></a><span class="ss">  - Champion:         </span><span class="sc">{</span>CHAMPION_NAME<span class="sc">}</span></span>
<span id="cb33-57"><a href="#cb33-57" aria-hidden="true" tabindex="-1"></a><span class="ss">  - Validation:       5-fold CV (robust generalization)</span></span>
<span id="cb33-58"><a href="#cb33-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-59"><a href="#cb33-59" aria-hidden="true" tabindex="-1"></a><span class="ss">NET REVENUE IMPACT:</span></span>
<span id="cb33-60"><a href="#cb33-60" aria-hidden="true" tabindex="-1"></a><span class="ss">  - Optimal Threshold:  Score &gt; </span><span class="sc">{</span>OPTIMAL_THRESHOLD<span class="sc">:.3f}</span></span>
<span id="cb33-61"><a href="#cb33-61" aria-hidden="true" tabindex="-1"></a><span class="ss">  - Maximum Profit:     $</span><span class="sc">{</span>MAX_PROFIT<span class="sc">:,.0f}</span></span>
<span id="cb33-62"><a href="#cb33-62" aria-hidden="true" tabindex="-1"></a><span class="ss">  - Capture Rate:       </span><span class="sc">{</span>OPTIMAL_PCT_CAPTURE<span class="sc">:.0%}</span><span class="ss"> of SQLs with </span><span class="sc">{</span>OPTIMAL_PCT_POP<span class="sc">:.0%}</span><span class="ss"> of calls</span></span>
<span id="cb33-63"><a href="#cb33-63" aria-hidden="true" tabindex="-1"></a><span class="ss">  - ROI per Call:       $</span><span class="sc">{</span>(MAX_PROFIT <span class="op">/</span> OPTIMAL_CALLS)<span class="sc">:.2f}</span></span>
<span id="cb33-64"><a href="#cb33-64" aria-hidden="true" tabindex="-1"></a><span class="ss">  - Annualized Lift:    $</span><span class="sc">{</span>annualized_lift<span class="sc">:,.0f}</span></span>
<span id="cb33-65"><a href="#cb33-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-66"><a href="#cb33-66" aria-hidden="true" tabindex="-1"></a><span class="ss">================================================================================</span></span>
<span id="cb33-67"><a href="#cb33-67" aria-hidden="true" tabindex="-1"></a><span class="ss">IMMEDIATE ACTIONS (The "Yield Gap" Strategy)</span></span>
<span id="cb33-68"><a href="#cb33-68" aria-hidden="true" tabindex="-1"></a><span class="ss">================================================================================</span></span>
<span id="cb33-69"><a href="#cb33-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-70"><a href="#cb33-70" aria-hidden="true" tabindex="-1"></a><span class="ss">1. CUT THE TAIL: Deprioritize "External Demand Gen" leads immediately.</span></span>
<span id="cb33-71"><a href="#cb33-71" aria-hidden="true" tabindex="-1"></a><span class="ss">   - Toxic Channel Conversion: </span><span class="sc">{</span>toxic_conv<span class="sc">:.1%}</span></span>
<span id="cb33-72"><a href="#cb33-72" aria-hidden="true" tabindex="-1"></a><span class="ss">   - Toxic Channel Volume: </span><span class="sc">{</span>toxic_count<span class="sc">:,}</span><span class="ss"> leads</span></span>
<span id="cb33-73"><a href="#cb33-73" aria-hidden="true" tabindex="-1"></a><span class="ss">   - Action: Stop working these leads. They cost more than they return.</span></span>
<span id="cb33-74"><a href="#cb33-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-75"><a href="#cb33-75" aria-hidden="true" tabindex="-1"></a><span class="ss">2. MINE THE GEMS: Route "Non-Manufacturing" and "Not Enough Info" accounts</span></span>
<span id="cb33-76"><a href="#cb33-76" aria-hidden="true" tabindex="-1"></a><span class="ss">   to senior reps.</span></span>
<span id="cb33-77"><a href="#cb33-77" aria-hidden="true" tabindex="-1"></a><span class="ss">   - Hidden Gem Conversion Rate: </span><span class="sc">{</span>gem_conv_rate<span class="sc">:.1%}</span></span>
<span id="cb33-78"><a href="#cb33-78" aria-hidden="true" tabindex="-1"></a><span class="ss">   - These are agile consultants/small firms that typical scoring misses.</span></span>
<span id="cb33-79"><a href="#cb33-79" aria-hidden="true" tabindex="-1"></a><span class="ss">   - Action: Prioritize these for immediate outreach.</span></span>
<span id="cb33-80"><a href="#cb33-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-81"><a href="#cb33-81" aria-hidden="true" tabindex="-1"></a><span class="ss">3. SMART ROUTING: Use the Intent Score to differentiate urgency.</span></span>
<span id="cb33-82"><a href="#cb33-82" aria-hidden="true" tabindex="-1"></a><span class="ss">   - "Contact Us" P1 = HIGH urgency (Score: 5)</span></span>
<span id="cb33-83"><a href="#cb33-83" aria-hidden="true" tabindex="-1"></a><span class="ss">   - "Webinar" P1 = LOW urgency (Score: 1)</span></span>
<span id="cb33-84"><a href="#cb33-84" aria-hidden="true" tabindex="-1"></a><span class="ss">   - Action: Route high-intent leads to closers, not nurturers.</span></span>
<span id="cb33-85"><a href="#cb33-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-86"><a href="#cb33-86" aria-hidden="true" tabindex="-1"></a><span class="ss">4. PREMIUM CHANNEL FOCUS:</span></span>
<span id="cb33-87"><a href="#cb33-87" aria-hidden="true" tabindex="-1"></a><span class="ss">   - Premium Channel Conversion: </span><span class="sc">{</span>premium_conv<span class="sc">:.1%}</span></span>
<span id="cb33-88"><a href="#cb33-88" aria-hidden="true" tabindex="-1"></a><span class="ss">   - Invest in SEO and Direct/Inbound acquisition.</span></span>
<span id="cb33-89"><a href="#cb33-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-90"><a href="#cb33-90" aria-hidden="true" tabindex="-1"></a><span class="ss">================================================================================</span></span>
<span id="cb33-91"><a href="#cb33-91" aria-hidden="true" tabindex="-1"></a><span class="ss">OUTBOUND "HIT LIST" STRATEGY (For Sales VP)</span></span>
<span id="cb33-92"><a href="#cb33-92" aria-hidden="true" tabindex="-1"></a><span class="ss">================================================================================</span></span>
<span id="cb33-93"><a href="#cb33-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-94"><a href="#cb33-94" aria-hidden="true" tabindex="-1"></a><span class="ss">MasterControl should immediately purchase contact lists matching:</span></span>
<span id="cb33-95"><a href="#cb33-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-96"><a href="#cb33-96" aria-hidden="true" tabindex="-1"></a><span class="ss">  ROLE:    Directors, VPs, Senior Decision Makers</span></span>
<span id="cb33-97"><a href="#cb33-97" aria-hidden="true" tabindex="-1"></a><span class="ss">  SECTOR:  Pharma &amp; BioTech, Life Sciences</span></span>
<span id="cb33-98"><a href="#cb33-98" aria-hidden="true" tabindex="-1"></a><span class="ss">  SCOPE:   Global / Corporate (not Site-level)</span></span>
<span id="cb33-99"><a href="#cb33-99" aria-hidden="true" tabindex="-1"></a><span class="ss">  MODEL:   In-House Manufacturing operations</span></span>
<span id="cb33-100"><a href="#cb33-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-101"><a href="#cb33-101" aria-hidden="true" tabindex="-1"></a><span class="ss">  Golden Segment Conversion Rate: </span><span class="sc">{</span>golden_segment_rate<span class="sc">:.1%}</span></span>
<span id="cb33-102"><a href="#cb33-102" aria-hidden="true" tabindex="-1"></a><span class="ss">  (vs. Baseline: </span><span class="sc">{</span>y_test<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss">)</span></span>
<span id="cb33-103"><a href="#cb33-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-104"><a href="#cb33-104" aria-hidden="true" tabindex="-1"></a><span class="ss">The model confidently identifies the BOTTOM 50% of the funnel as "Noise."</span></span>
<span id="cb33-105"><a href="#cb33-105" aria-hidden="true" tabindex="-1"></a><span class="ss">Stop calling them. Focus 100% of Sales energy on the Golden Segments.</span></span>
<span id="cb33-106"><a href="#cb33-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-107"><a href="#cb33-107" aria-hidden="true" tabindex="-1"></a><span class="ss">================================================================================</span></span>
<span id="cb33-108"><a href="#cb33-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-109"><a href="#cb33-109" aria-hidden="true" tabindex="-1"></a><span class="ss">IMPLEMENTATION CHECKLIST:</span></span>
<span id="cb33-110"><a href="#cb33-110" aria-hidden="true" tabindex="-1"></a><span class="ss">  1. Deploy scoring engine to CRM (threshold: </span><span class="sc">{</span>OPTIMAL_THRESHOLD<span class="sc">:.2f}</span><span class="ss">)</span></span>
<span id="cb33-111"><a href="#cb33-111" aria-hidden="true" tabindex="-1"></a><span class="ss">  2. Create "Toxic" flag in CRM for External Demand Gen / Email sources</span></span>
<span id="cb33-112"><a href="#cb33-112" aria-hidden="true" tabindex="-1"></a><span class="ss">  3. Create "Hidden Gem" flag for Non-Manufacturing accounts</span></span>
<span id="cb33-113"><a href="#cb33-113" aria-hidden="true" tabindex="-1"></a><span class="ss">  4. Route high-score leads (&gt;</span><span class="sc">{</span>OPTIMAL_THRESHOLD<span class="sc">:.2f}</span><span class="ss">) to senior reps</span></span>
<span id="cb33-114"><a href="#cb33-114" aria-hidden="true" tabindex="-1"></a><span class="ss">  5. Purchase outbound lists matching the Hit List profile</span></span>
<span id="cb33-115"><a href="#cb33-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-116"><a href="#cb33-116" aria-hidden="true" tabindex="-1"></a><span class="ss">Runtime: </span><span class="sc">{</span>runtime_min<span class="sc">:.1f}</span><span class="ss"> minutes</span></span>
<span id="cb33-117"><a href="#cb33-117" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span>)</span>
<span id="cb33-118"><a href="#cb33-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-119"><a href="#cb33-119" aria-hidden="true" tabindex="-1"></a><span class="co"># Final summary table</span></span>
<span id="cb33-120"><a href="#cb33-120" aria-hidden="true" tabindex="-1"></a>summary_data <span class="op">=</span> {</span>
<span id="cb33-121"><a href="#cb33-121" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Metric'</span>: [<span class="st">'AUC-ROC'</span>, <span class="st">'Average Precision'</span>, <span class="st">'Optimal Threshold'</span>, <span class="st">'Max Profit'</span>,</span>
<span id="cb33-122"><a href="#cb33-122" aria-hidden="true" tabindex="-1"></a>               <span class="st">'Annualized Revenue Lift'</span>, <span class="st">'Calls Required'</span>, <span class="st">'SQLs Captured'</span>,</span>
<span id="cb33-123"><a href="#cb33-123" aria-hidden="true" tabindex="-1"></a>               <span class="st">'Predictive Lift'</span>, <span class="st">'Hidden Gem Conv Rate'</span>, <span class="st">'Toxic Channel Conv Rate'</span>],</span>
<span id="cb33-124"><a href="#cb33-124" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Value'</span>: [<span class="ss">f'</span><span class="sc">{</span>FINAL_AUC<span class="sc">:.4f}</span><span class="ss">'</span>, <span class="ss">f'</span><span class="sc">{</span>test_ap<span class="sc">:.4f}</span><span class="ss">'</span>, <span class="ss">f'</span><span class="sc">{</span>OPTIMAL_THRESHOLD<span class="sc">:.3f}</span><span class="ss">'</span>,</span>
<span id="cb33-125"><a href="#cb33-125" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f'$</span><span class="sc">{</span>MAX_PROFIT<span class="sc">:,.0f}</span><span class="ss">'</span>, <span class="ss">f'$</span><span class="sc">{</span>annualized_lift<span class="sc">:,.0f}</span><span class="ss">'</span>, <span class="ss">f'</span><span class="sc">{</span>OPTIMAL_CALLS<span class="sc">:,}</span><span class="ss">'</span>,</span>
<span id="cb33-126"><a href="#cb33-126" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f'</span><span class="sc">{</span>OPTIMAL_SQLS<span class="sc">:,}</span><span class="ss"> (</span><span class="sc">{</span>OPTIMAL_PCT_CAPTURE<span class="sc">:.0%}</span><span class="ss">)'</span>,</span>
<span id="cb33-127"><a href="#cb33-127" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f'</span><span class="sc">{</span>OPTIMAL_PCT_CAPTURE<span class="op">/</span>OPTIMAL_PCT_POP<span class="sc">:.1f}</span><span class="ss">x'</span>, <span class="ss">f'</span><span class="sc">{</span>gem_conv_rate<span class="sc">:.1%}</span><span class="ss">'</span>,</span>
<span id="cb33-128"><a href="#cb33-128" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f'</span><span class="sc">{</span>toxic_conv<span class="sc">:.1%}</span><span class="ss">'</span>]</span>
<span id="cb33-129"><a href="#cb33-129" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-130"><a href="#cb33-130" aria-hidden="true" tabindex="-1"></a>summary_df <span class="op">=</span> pd.DataFrame(summary_data)</span>
<span id="cb33-131"><a href="#cb33-131" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">FINAL SUMMARY TABLE (For PDF Extraction):"</span>)</span>
<span id="cb33-132"><a href="#cb33-132" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(summary_df.to_markdown(index<span class="op">=</span><span class="va">False</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
======================================================================
THE BOTTOM LINE
======================================================================

================================================================================
V7 TITAN: STRATEGIC RECOMMENDATION
================================================================================

The V7 Titan Engine delivers a projected $316,200 annualized revenue lift
by encoding domain expertise into the algorithm.

MODEL PERFORMANCE:
  - AUC-ROC:          0.9153 [TARGET MET]
  - Average Precision: 0.7012
  - Champion:         StackingEnsemble
  - Validation:       5-fold CV (robust generalization)

NET REVENUE IMPACT:
  - Optimal Threshold:  Score &gt; 0.128
  - Maximum Profit:     $3,476,200
  - Capture Rate:       99% of SQLs with 66% of calls
  - ROI per Call:       $1554.65
  - Annualized Lift:    $316,200

================================================================================
IMMEDIATE ACTIONS (The "Yield Gap" Strategy)
================================================================================

1. CUT THE TAIL: Deprioritize "External Demand Gen" leads immediately.
   - Toxic Channel Conversion: 4.5%
   - Toxic Channel Volume: 1,070 leads
   - Action: Stop working these leads. They cost more than they return.

2. MINE THE GEMS: Route "Non-Manufacturing" and "Not Enough Info" accounts
   to senior reps.
   - Hidden Gem Conversion Rate: 31.5%
   - These are agile consultants/small firms that typical scoring misses.
   - Action: Prioritize these for immediate outreach.

3. SMART ROUTING: Use the Intent Score to differentiate urgency.
   - "Contact Us" P1 = HIGH urgency (Score: 5)
   - "Webinar" P1 = LOW urgency (Score: 1)
   - Action: Route high-intent leads to closers, not nurturers.

4. PREMIUM CHANNEL FOCUS:
   - Premium Channel Conversion: 27.5%
   - Invest in SEO and Direct/Inbound acquisition.

================================================================================
OUTBOUND "HIT LIST" STRATEGY (For Sales VP)
================================================================================

MasterControl should immediately purchase contact lists matching:

  ROLE:    Directors, VPs, Senior Decision Makers
  SECTOR:  Pharma &amp; BioTech, Life Sciences
  SCOPE:   Global / Corporate (not Site-level)
  MODEL:   In-House Manufacturing operations

  Golden Segment Conversion Rate: 77.4%
  (vs. Baseline: 17.9%)

The model confidently identifies the BOTTOM 50% of the funnel as "Noise."
Stop calling them. Focus 100% of Sales energy on the Golden Segments.

================================================================================

IMPLEMENTATION CHECKLIST:
  1. Deploy scoring engine to CRM (threshold: 0.13)
  2. Create "Toxic" flag in CRM for External Demand Gen / Email sources
  3. Create "Hidden Gem" flag for Non-Manufacturing accounts
  4. Route high-score leads (&gt;0.13) to senior reps
  5. Purchase outbound lists matching the Hit List profile

Runtime: 12.7 minutes


FINAL SUMMARY TABLE (For PDF Extraction):
| Metric                  | Value       |
|:------------------------|:------------|
| AUC-ROC                 | 0.9153      |
| Average Precision       | 0.7012      |
| Optimal Threshold       | 0.128       |
| Max Profit              | $3,476,200  |
| Annualized Revenue Lift | $316,200    |
| Calls Required          | 2,236.0     |
| SQLs Captured           | 598.0 (99%) |
| Predictive Lift         | 1.5x        |
| Hidden Gem Conv Rate    | 31.5%       |
| Toxic Channel Conv Rate | 4.5%        |</code></pre>
</div>
</div>
<hr>
</section>
<section id="phase-9-sponsor-qa-data-validation" class="level1">
<h1>Phase 9: Sponsor Q&amp;A Data Validation</h1>
<p><strong>Purpose:</strong> Programmatically validate every strategic claim before the sponsor meeting. No guessing—just data.</p>
<div id="sponsor-qa-validation" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="co"># PHASE 9: SPONSOR Q&amp;A DATA VALIDATION</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co"># This section calculates the ACTUAL conversion rates and lifts for each</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co"># strategic question that may arise in the sponsor meeting.</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"PHASE 9: SPONSOR Q&amp;A DATA VALIDATION"</span>)</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create validation dataframe (test set with original features)</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>test_indices <span class="op">=</span> X_test.index</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>validation_df <span class="op">=</span> df.loc[test_indices].copy()</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>validation_df[<span class="st">'actual_outcome'</span>] <span class="op">=</span> y_test</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>validation_df[<span class="st">'model_score'</span>] <span class="op">=</span> test_probs</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate baseline conversion rate</span></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>baseline_conv <span class="op">=</span> validation_df[<span class="st">'actual_outcome'</span>].mean()</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>baseline_n <span class="op">=</span> <span class="bu">len</span>(validation_df)</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Baseline: </span><span class="sc">{</span>baseline_conv<span class="sc">:.1%}</span><span class="ss"> conversion (</span><span class="sc">{</span>baseline_n<span class="sc">:,}</span><span class="ss"> leads in test set)"</span>)</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Q1: Is External Demand Gen "Toxic"?</span></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Q1: Are 'Toxic' channels (External Demand Gen, Email) dragging us down?"</span>)</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>q1_evidence <span class="op">=</span> <span class="st">""</span></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>q1_verdict <span class="op">=</span> <span class="st">""</span></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'channel_tier'</span> <span class="kw">in</span> validation_df.columns:</span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>    toxic_df <span class="op">=</span> validation_df[validation_df[<span class="st">'channel_tier'</span>] <span class="op">==</span> <span class="st">'Toxic'</span>]</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>    premium_df <span class="op">=</span> validation_df[validation_df[<span class="st">'channel_tier'</span>] <span class="op">==</span> <span class="st">'Premium'</span>]</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>    standard_df <span class="op">=</span> validation_df[validation_df[<span class="st">'channel_tier'</span>] <span class="op">==</span> <span class="st">'Standard'</span>]</span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>    toxic_conv <span class="op">=</span> toxic_df[<span class="st">'actual_outcome'</span>].mean() <span class="cf">if</span> <span class="bu">len</span>(toxic_df) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>    toxic_n <span class="op">=</span> <span class="bu">len</span>(toxic_df)</span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>    premium_conv <span class="op">=</span> premium_df[<span class="st">'actual_outcome'</span>].mean() <span class="cf">if</span> <span class="bu">len</span>(premium_df) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>    premium_n <span class="op">=</span> <span class="bu">len</span>(premium_df)</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>    standard_conv <span class="op">=</span> standard_df[<span class="st">'actual_outcome'</span>].mean() <span class="cf">if</span> <span class="bu">len</span>(standard_df) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate waste</span></span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>    toxic_cost <span class="op">=</span> toxic_n <span class="op">*</span> COST_PER_CALL</span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>    toxic_sqls <span class="op">=</span> toxic_df[<span class="st">'actual_outcome'</span>].<span class="bu">sum</span>()</span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a>    toxic_revenue <span class="op">=</span> toxic_sqls <span class="op">*</span> VALUE_PER_SQL</span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>    toxic_loss <span class="op">=</span> toxic_cost <span class="op">-</span> toxic_revenue</span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>    q1_evidence <span class="op">=</span> <span class="ss">f"Toxic: </span><span class="sc">{</span>toxic_conv<span class="sc">:.1%}</span><span class="ss"> (n=</span><span class="sc">{</span>toxic_n<span class="sc">:,}</span><span class="ss">) vs Premium: </span><span class="sc">{</span>premium_conv<span class="sc">:.1%}</span><span class="ss">"</span></span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a>    q1_verdict <span class="op">=</span> <span class="st">"YES - Cut immediately"</span> <span class="cf">if</span> toxic_conv <span class="op">&lt;</span> baseline_conv <span class="op">*</span> <span class="fl">0.5</span> <span class="cf">else</span> <span class="st">"MONITOR"</span></span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-53"><a href="#cb35-53" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Toxic Channel Conv: </span><span class="sc">{</span>toxic_conv<span class="sc">:.1%}</span><span class="ss"> (n=</span><span class="sc">{</span>toxic_n<span class="sc">:,}</span><span class="ss">)"</span>)</span>
<span id="cb35-54"><a href="#cb35-54" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Premium Channel Conv: </span><span class="sc">{</span>premium_conv<span class="sc">:.1%}</span><span class="ss"> (n=</span><span class="sc">{</span>premium_n<span class="sc">:,}</span><span class="ss">)"</span>)</span>
<span id="cb35-55"><a href="#cb35-55" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Standard Channel Conv: </span><span class="sc">{</span>standard_conv<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb35-56"><a href="#cb35-56" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Baseline Conv: </span><span class="sc">{</span>baseline_conv<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb35-57"><a href="#cb35-57" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Toxic Waste: $</span><span class="sc">{</span>toxic_loss<span class="sc">:,.0f}</span><span class="ss"> (cost minus revenue)"</span>)</span>
<span id="cb35-58"><a href="#cb35-58" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  VERDICT: </span><span class="sc">{</span>q1_verdict<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb35-59"><a href="#cb35-59" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb35-60"><a href="#cb35-60" aria-hidden="true" tabindex="-1"></a>    q1_evidence <span class="op">=</span> <span class="st">"Channel data unavailable"</span></span>
<span id="cb35-61"><a href="#cb35-61" aria-hidden="true" tabindex="-1"></a>    q1_verdict <span class="op">=</span> <span class="st">"CANNOT EVALUATE"</span></span>
<span id="cb35-62"><a href="#cb35-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-63"><a href="#cb35-63" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb35-64"><a href="#cb35-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Q2: Do "Recycled" (Stale) leads convert?</span></span>
<span id="cb35-65"><a href="#cb35-65" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb35-66"><a href="#cb35-66" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb35-67"><a href="#cb35-67" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Q2: Do 'Recycled' (Stale) leads still convert?"</span>)</span>
<span id="cb35-68"><a href="#cb35-68" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb35-69"><a href="#cb35-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-70"><a href="#cb35-70" aria-hidden="true" tabindex="-1"></a>q2_evidence <span class="op">=</span> <span class="st">""</span></span>
<span id="cb35-71"><a href="#cb35-71" aria-hidden="true" tabindex="-1"></a>q2_verdict <span class="op">=</span> <span class="st">""</span></span>
<span id="cb35-72"><a href="#cb35-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-73"><a href="#cb35-73" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'is_stale'</span> <span class="kw">in</span> validation_df.columns:</span>
<span id="cb35-74"><a href="#cb35-74" aria-hidden="true" tabindex="-1"></a>    stale_df <span class="op">=</span> validation_df[validation_df[<span class="st">'is_stale'</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb35-75"><a href="#cb35-75" aria-hidden="true" tabindex="-1"></a>    fresh_df <span class="op">=</span> validation_df[validation_df[<span class="st">'is_fresh'</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb35-76"><a href="#cb35-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-77"><a href="#cb35-77" aria-hidden="true" tabindex="-1"></a>    stale_conv <span class="op">=</span> stale_df[<span class="st">'actual_outcome'</span>].mean() <span class="cf">if</span> <span class="bu">len</span>(stale_df) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb35-78"><a href="#cb35-78" aria-hidden="true" tabindex="-1"></a>    stale_n <span class="op">=</span> <span class="bu">len</span>(stale_df)</span>
<span id="cb35-79"><a href="#cb35-79" aria-hidden="true" tabindex="-1"></a>    fresh_conv <span class="op">=</span> fresh_df[<span class="st">'actual_outcome'</span>].mean() <span class="cf">if</span> <span class="bu">len</span>(fresh_df) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb35-80"><a href="#cb35-80" aria-hidden="true" tabindex="-1"></a>    fresh_n <span class="op">=</span> <span class="bu">len</span>(fresh_df)</span>
<span id="cb35-81"><a href="#cb35-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-82"><a href="#cb35-82" aria-hidden="true" tabindex="-1"></a>    q2_evidence <span class="op">=</span> <span class="ss">f"Stale (&gt;180d): </span><span class="sc">{</span>stale_conv<span class="sc">:.1%}</span><span class="ss"> (n=</span><span class="sc">{</span>stale_n<span class="sc">:,}</span><span class="ss">) vs Fresh (&lt;30d): </span><span class="sc">{</span>fresh_conv<span class="sc">:.1%}</span><span class="ss">"</span></span>
<span id="cb35-83"><a href="#cb35-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-84"><a href="#cb35-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> stale_conv <span class="op">&gt;</span> baseline_conv <span class="op">*</span> <span class="fl">0.8</span>:</span>
<span id="cb35-85"><a href="#cb35-85" aria-hidden="true" tabindex="-1"></a>        q2_verdict <span class="op">=</span> <span class="st">"YES - Still viable"</span></span>
<span id="cb35-86"><a href="#cb35-86" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> stale_conv <span class="op">&gt;</span> baseline_conv <span class="op">*</span> <span class="fl">0.5</span>:</span>
<span id="cb35-87"><a href="#cb35-87" aria-hidden="true" tabindex="-1"></a>        q2_verdict <span class="op">=</span> <span class="st">"MARGINAL - Deprioritize"</span></span>
<span id="cb35-88"><a href="#cb35-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb35-89"><a href="#cb35-89" aria-hidden="true" tabindex="-1"></a>        q2_verdict <span class="op">=</span> <span class="st">"NO - Cut from funnel"</span></span>
<span id="cb35-90"><a href="#cb35-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-91"><a href="#cb35-91" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Stale Lead Conv (&gt;180 days): </span><span class="sc">{</span>stale_conv<span class="sc">:.1%}</span><span class="ss"> (n=</span><span class="sc">{</span>stale_n<span class="sc">:,}</span><span class="ss">)"</span>)</span>
<span id="cb35-92"><a href="#cb35-92" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Fresh Lead Conv (&lt;30 days): </span><span class="sc">{</span>fresh_conv<span class="sc">:.1%}</span><span class="ss"> (n=</span><span class="sc">{</span>fresh_n<span class="sc">:,}</span><span class="ss">)"</span>)</span>
<span id="cb35-93"><a href="#cb35-93" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Baseline Conv: </span><span class="sc">{</span>baseline_conv<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb35-94"><a href="#cb35-94" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  VERDICT: </span><span class="sc">{</span>q2_verdict<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb35-95"><a href="#cb35-95" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb35-96"><a href="#cb35-96" aria-hidden="true" tabindex="-1"></a>    q2_evidence <span class="op">=</span> <span class="st">"Lead age data unavailable"</span></span>
<span id="cb35-97"><a href="#cb35-97" aria-hidden="true" tabindex="-1"></a>    q2_verdict <span class="op">=</span> <span class="st">"CANNOT EVALUATE"</span></span>
<span id="cb35-98"><a href="#cb35-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-99"><a href="#cb35-99" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb35-100"><a href="#cb35-100" aria-hidden="true" tabindex="-1"></a><span class="co"># Q3: Are "Hidden Gems" (Unknown/Non-Mfg) real?</span></span>
<span id="cb35-101"><a href="#cb35-101" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb35-102"><a href="#cb35-102" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb35-103"><a href="#cb35-103" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Q3: Are 'Hidden Gems' (Unknown accounts) actually high converters?"</span>)</span>
<span id="cb35-104"><a href="#cb35-104" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb35-105"><a href="#cb35-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-106"><a href="#cb35-106" aria-hidden="true" tabindex="-1"></a>q3_evidence <span class="op">=</span> <span class="st">""</span></span>
<span id="cb35-107"><a href="#cb35-107" aria-hidden="true" tabindex="-1"></a>q3_verdict <span class="op">=</span> <span class="st">""</span></span>
<span id="cb35-108"><a href="#cb35-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-109"><a href="#cb35-109" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'is_hidden_gem'</span> <span class="kw">in</span> validation_df.columns:</span>
<span id="cb35-110"><a href="#cb35-110" aria-hidden="true" tabindex="-1"></a>    gem_df <span class="op">=</span> validation_df[validation_df[<span class="st">'is_hidden_gem'</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb35-111"><a href="#cb35-111" aria-hidden="true" tabindex="-1"></a>    non_gem_df <span class="op">=</span> validation_df[validation_df[<span class="st">'is_hidden_gem'</span>] <span class="op">==</span> <span class="dv">0</span>]</span>
<span id="cb35-112"><a href="#cb35-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-113"><a href="#cb35-113" aria-hidden="true" tabindex="-1"></a>    gem_conv <span class="op">=</span> gem_df[<span class="st">'actual_outcome'</span>].mean() <span class="cf">if</span> <span class="bu">len</span>(gem_df) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb35-114"><a href="#cb35-114" aria-hidden="true" tabindex="-1"></a>    gem_n <span class="op">=</span> <span class="bu">len</span>(gem_df)</span>
<span id="cb35-115"><a href="#cb35-115" aria-hidden="true" tabindex="-1"></a>    non_gem_conv <span class="op">=</span> non_gem_df[<span class="st">'actual_outcome'</span>].mean() <span class="cf">if</span> <span class="bu">len</span>(non_gem_df) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb35-116"><a href="#cb35-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-117"><a href="#cb35-117" aria-hidden="true" tabindex="-1"></a>    gem_lift <span class="op">=</span> gem_conv <span class="op">/</span> baseline_conv <span class="cf">if</span> baseline_conv <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb35-118"><a href="#cb35-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-119"><a href="#cb35-119" aria-hidden="true" tabindex="-1"></a>    q3_evidence <span class="op">=</span> <span class="ss">f"Hidden Gems: </span><span class="sc">{</span>gem_conv<span class="sc">:.1%}</span><span class="ss"> (n=</span><span class="sc">{</span>gem_n<span class="sc">:,}</span><span class="ss">), Lift: </span><span class="sc">{</span>gem_lift<span class="sc">:.1f}</span><span class="ss">x"</span></span>
<span id="cb35-120"><a href="#cb35-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-121"><a href="#cb35-121" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> gem_conv <span class="op">&gt;</span> baseline_conv <span class="op">*</span> <span class="fl">1.5</span>:</span>
<span id="cb35-122"><a href="#cb35-122" aria-hidden="true" tabindex="-1"></a>        q3_verdict <span class="op">=</span> <span class="st">"YES - Prioritize immediately"</span></span>
<span id="cb35-123"><a href="#cb35-123" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> gem_conv <span class="op">&gt;</span> baseline_conv:</span>
<span id="cb35-124"><a href="#cb35-124" aria-hidden="true" tabindex="-1"></a>        q3_verdict <span class="op">=</span> <span class="st">"YES - Above baseline"</span></span>
<span id="cb35-125"><a href="#cb35-125" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb35-126"><a href="#cb35-126" aria-hidden="true" tabindex="-1"></a>        q3_verdict <span class="op">=</span> <span class="st">"NO - Below baseline"</span></span>
<span id="cb35-127"><a href="#cb35-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-128"><a href="#cb35-128" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Hidden Gem Conv: </span><span class="sc">{</span>gem_conv<span class="sc">:.1%}</span><span class="ss"> (n=</span><span class="sc">{</span>gem_n<span class="sc">:,}</span><span class="ss">)"</span>)</span>
<span id="cb35-129"><a href="#cb35-129" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Non-Gem Conv: </span><span class="sc">{</span>non_gem_conv<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb35-130"><a href="#cb35-130" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Baseline Conv: </span><span class="sc">{</span>baseline_conv<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb35-131"><a href="#cb35-131" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Lift: </span><span class="sc">{</span>gem_lift<span class="sc">:.1f}</span><span class="ss">x"</span>)</span>
<span id="cb35-132"><a href="#cb35-132" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  VERDICT: </span><span class="sc">{</span>q3_verdict<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb35-133"><a href="#cb35-133" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb35-134"><a href="#cb35-134" aria-hidden="true" tabindex="-1"></a>    q3_evidence <span class="op">=</span> <span class="st">"Hidden gem flag unavailable"</span></span>
<span id="cb35-135"><a href="#cb35-135" aria-hidden="true" tabindex="-1"></a>    q3_verdict <span class="op">=</span> <span class="st">"CANNOT EVALUATE"</span></span>
<span id="cb35-136"><a href="#cb35-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-137"><a href="#cb35-137" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb35-138"><a href="#cb35-138" aria-hidden="true" tabindex="-1"></a><span class="co"># Q4: Does "Capital Density" (Industry-weighted size) matter?</span></span>
<span id="cb35-139"><a href="#cb35-139" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb35-140"><a href="#cb35-140" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb35-141"><a href="#cb35-141" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Q4: Does 'Capital Density' (budget proxy) correlate with conversion?"</span>)</span>
<span id="cb35-142"><a href="#cb35-142" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb35-143"><a href="#cb35-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-144"><a href="#cb35-144" aria-hidden="true" tabindex="-1"></a>q4_evidence <span class="op">=</span> <span class="st">""</span></span>
<span id="cb35-145"><a href="#cb35-145" aria-hidden="true" tabindex="-1"></a>q4_verdict <span class="op">=</span> <span class="st">""</span></span>
<span id="cb35-146"><a href="#cb35-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-147"><a href="#cb35-147" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'capital_density_log'</span> <span class="kw">in</span> validation_df.columns:</span>
<span id="cb35-148"><a href="#cb35-148" aria-hidden="true" tabindex="-1"></a>    cap_corr <span class="op">=</span> validation_df[<span class="st">'capital_density_log'</span>].corr(validation_df[<span class="st">'actual_outcome'</span>])</span>
<span id="cb35-149"><a href="#cb35-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-150"><a href="#cb35-150" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Quartile analysis</span></span>
<span id="cb35-151"><a href="#cb35-151" aria-hidden="true" tabindex="-1"></a>    validation_df[<span class="st">'cap_quartile'</span>] <span class="op">=</span> pd.qcut(validation_df[<span class="st">'capital_density_log'</span>], <span class="dv">4</span>, labels<span class="op">=</span>[<span class="st">'Q1-Low'</span>, <span class="st">'Q2'</span>, <span class="st">'Q3'</span>, <span class="st">'Q4-High'</span>])</span>
<span id="cb35-152"><a href="#cb35-152" aria-hidden="true" tabindex="-1"></a>    quartile_conv <span class="op">=</span> validation_df.groupby(<span class="st">'cap_quartile'</span>)[<span class="st">'actual_outcome'</span>].mean()</span>
<span id="cb35-153"><a href="#cb35-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-154"><a href="#cb35-154" aria-hidden="true" tabindex="-1"></a>    q1_conv <span class="op">=</span> quartile_conv.get(<span class="st">'Q1-Low'</span>, <span class="dv">0</span>)</span>
<span id="cb35-155"><a href="#cb35-155" aria-hidden="true" tabindex="-1"></a>    q4_conv <span class="op">=</span> quartile_conv.get(<span class="st">'Q4-High'</span>, <span class="dv">0</span>)</span>
<span id="cb35-156"><a href="#cb35-156" aria-hidden="true" tabindex="-1"></a>    q4_lift <span class="op">=</span> q4_conv <span class="op">/</span> q1_conv <span class="cf">if</span> q1_conv <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb35-157"><a href="#cb35-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-158"><a href="#cb35-158" aria-hidden="true" tabindex="-1"></a>    q4_evidence <span class="op">=</span> <span class="ss">f"Correlation: </span><span class="sc">{</span>cap_corr<span class="sc">:.3f}</span><span class="ss">, Q4/Q1 Lift: </span><span class="sc">{</span>q4_lift<span class="sc">:.1f}</span><span class="ss">x"</span></span>
<span id="cb35-159"><a href="#cb35-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-160"><a href="#cb35-160" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">abs</span>(cap_corr) <span class="op">&gt;</span> <span class="fl">0.1</span>:</span>
<span id="cb35-161"><a href="#cb35-161" aria-hidden="true" tabindex="-1"></a>        q4_verdict <span class="op">=</span> <span class="st">"YES - Significant signal"</span></span>
<span id="cb35-162"><a href="#cb35-162" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">abs</span>(cap_corr) <span class="op">&gt;</span> <span class="fl">0.05</span>:</span>
<span id="cb35-163"><a href="#cb35-163" aria-hidden="true" tabindex="-1"></a>        q4_verdict <span class="op">=</span> <span class="st">"WEAK - Minor signal"</span></span>
<span id="cb35-164"><a href="#cb35-164" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb35-165"><a href="#cb35-165" aria-hidden="true" tabindex="-1"></a>        q4_verdict <span class="op">=</span> <span class="st">"NO - Not predictive"</span></span>
<span id="cb35-166"><a href="#cb35-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-167"><a href="#cb35-167" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Correlation with target: </span><span class="sc">{</span>cap_corr<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb35-168"><a href="#cb35-168" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Q1 (Low Budget) Conv: </span><span class="sc">{</span>q1_conv<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb35-169"><a href="#cb35-169" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Q4 (High Budget) Conv: </span><span class="sc">{</span>q4_conv<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb35-170"><a href="#cb35-170" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Q4/Q1 Lift: </span><span class="sc">{</span>q4_lift<span class="sc">:.1f}</span><span class="ss">x"</span>)</span>
<span id="cb35-171"><a href="#cb35-171" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  VERDICT: </span><span class="sc">{</span>q4_verdict<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb35-172"><a href="#cb35-172" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb35-173"><a href="#cb35-173" aria-hidden="true" tabindex="-1"></a>    q4_evidence <span class="op">=</span> <span class="st">"Capital density data unavailable"</span></span>
<span id="cb35-174"><a href="#cb35-174" aria-hidden="true" tabindex="-1"></a>    q4_verdict <span class="op">=</span> <span class="st">"CANNOT EVALUATE"</span></span>
<span id="cb35-175"><a href="#cb35-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-176"><a href="#cb35-176" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb35-177"><a href="#cb35-177" aria-hidden="true" tabindex="-1"></a><span class="co"># Q5: Does "Intent Strength" (Priority Encoding) work?</span></span>
<span id="cb35-178"><a href="#cb35-178" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb35-179"><a href="#cb35-179" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb35-180"><a href="#cb35-180" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Q5: Does 'Intent Strength' (priority encoding) predict conversion?"</span>)</span>
<span id="cb35-181"><a href="#cb35-181" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb35-182"><a href="#cb35-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-183"><a href="#cb35-183" aria-hidden="true" tabindex="-1"></a>q5_evidence <span class="op">=</span> <span class="st">""</span></span>
<span id="cb35-184"><a href="#cb35-184" aria-hidden="true" tabindex="-1"></a>q5_verdict <span class="op">=</span> <span class="st">""</span></span>
<span id="cb35-185"><a href="#cb35-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-186"><a href="#cb35-186" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'intent_strength'</span> <span class="kw">in</span> validation_df.columns:</span>
<span id="cb35-187"><a href="#cb35-187" aria-hidden="true" tabindex="-1"></a>    intent_corr <span class="op">=</span> validation_df[<span class="st">'intent_strength'</span>].corr(validation_df[<span class="st">'actual_outcome'</span>])</span>
<span id="cb35-188"><a href="#cb35-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-189"><a href="#cb35-189" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Group by intent level</span></span>
<span id="cb35-190"><a href="#cb35-190" aria-hidden="true" tabindex="-1"></a>    intent_conv <span class="op">=</span> validation_df.groupby(<span class="st">'intent_strength'</span>)[<span class="st">'actual_outcome'</span>].agg([<span class="st">'mean'</span>, <span class="st">'count'</span>])</span>
<span id="cb35-191"><a href="#cb35-191" aria-hidden="true" tabindex="-1"></a>    intent_conv <span class="op">=</span> intent_conv.sort_index(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb35-192"><a href="#cb35-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-193"><a href="#cb35-193" aria-hidden="true" tabindex="-1"></a>    high_intent_conv <span class="op">=</span> validation_df[validation_df[<span class="st">'intent_strength'</span>] <span class="op">&gt;=</span> <span class="dv">4</span>][<span class="st">'actual_outcome'</span>].mean()</span>
<span id="cb35-194"><a href="#cb35-194" aria-hidden="true" tabindex="-1"></a>    low_intent_conv <span class="op">=</span> validation_df[validation_df[<span class="st">'intent_strength'</span>] <span class="op">&lt;=</span> <span class="dv">1</span>][<span class="st">'actual_outcome'</span>].mean()</span>
<span id="cb35-195"><a href="#cb35-195" aria-hidden="true" tabindex="-1"></a>    intent_lift <span class="op">=</span> high_intent_conv <span class="op">/</span> low_intent_conv <span class="cf">if</span> low_intent_conv <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb35-196"><a href="#cb35-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-197"><a href="#cb35-197" aria-hidden="true" tabindex="-1"></a>    q5_evidence <span class="op">=</span> <span class="ss">f"Correlation: </span><span class="sc">{</span>intent_corr<span class="sc">:.3f}</span><span class="ss">, High/Low Lift: </span><span class="sc">{</span>intent_lift<span class="sc">:.1f}</span><span class="ss">x"</span></span>
<span id="cb35-198"><a href="#cb35-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-199"><a href="#cb35-199" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> intent_corr <span class="op">&gt;</span> <span class="fl">0.1</span>:</span>
<span id="cb35-200"><a href="#cb35-200" aria-hidden="true" tabindex="-1"></a>        q5_verdict <span class="op">=</span> <span class="st">"YES - Strong signal"</span></span>
<span id="cb35-201"><a href="#cb35-201" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> intent_corr <span class="op">&gt;</span> <span class="fl">0.05</span>:</span>
<span id="cb35-202"><a href="#cb35-202" aria-hidden="true" tabindex="-1"></a>        q5_verdict <span class="op">=</span> <span class="st">"WEAK - Minor signal"</span></span>
<span id="cb35-203"><a href="#cb35-203" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb35-204"><a href="#cb35-204" aria-hidden="true" tabindex="-1"></a>        q5_verdict <span class="op">=</span> <span class="st">"NO - Encoding needs revision"</span></span>
<span id="cb35-205"><a href="#cb35-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-206"><a href="#cb35-206" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Correlation with target: </span><span class="sc">{</span>intent_corr<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb35-207"><a href="#cb35-207" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  High Intent (&gt;=4) Conv: </span><span class="sc">{</span>high_intent_conv<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb35-208"><a href="#cb35-208" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Low Intent (&lt;=1) Conv: </span><span class="sc">{</span>low_intent_conv<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb35-209"><a href="#cb35-209" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  High/Low Lift: </span><span class="sc">{</span>intent_lift<span class="sc">:.1f}</span><span class="ss">x"</span>)</span>
<span id="cb35-210"><a href="#cb35-210" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  VERDICT: </span><span class="sc">{</span>q5_verdict<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb35-211"><a href="#cb35-211" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb35-212"><a href="#cb35-212" aria-hidden="true" tabindex="-1"></a>    q5_evidence <span class="op">=</span> <span class="st">"Intent strength data unavailable"</span></span>
<span id="cb35-213"><a href="#cb35-213" aria-hidden="true" tabindex="-1"></a>    q5_verdict <span class="op">=</span> <span class="st">"CANNOT EVALUATE"</span></span>
<span id="cb35-214"><a href="#cb35-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-215"><a href="#cb35-215" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb35-216"><a href="#cb35-216" aria-hidden="true" tabindex="-1"></a><span class="co"># Q6: Does "Role-Product Match" increase conversion?</span></span>
<span id="cb35-217"><a href="#cb35-217" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb35-218"><a href="#cb35-218" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb35-219"><a href="#cb35-219" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Q6: Does 'Role-Product Match' (title alignment) increase conversion?"</span>)</span>
<span id="cb35-220"><a href="#cb35-220" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb35-221"><a href="#cb35-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-222"><a href="#cb35-222" aria-hidden="true" tabindex="-1"></a>q6_evidence <span class="op">=</span> <span class="st">""</span></span>
<span id="cb35-223"><a href="#cb35-223" aria-hidden="true" tabindex="-1"></a>q6_verdict <span class="op">=</span> <span class="st">""</span></span>
<span id="cb35-224"><a href="#cb35-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-225"><a href="#cb35-225" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'role_product_match'</span> <span class="kw">in</span> validation_df.columns:</span>
<span id="cb35-226"><a href="#cb35-226" aria-hidden="true" tabindex="-1"></a>    matched_df <span class="op">=</span> validation_df[validation_df[<span class="st">'role_product_match'</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb35-227"><a href="#cb35-227" aria-hidden="true" tabindex="-1"></a>    unmatched_df <span class="op">=</span> validation_df[validation_df[<span class="st">'role_product_match'</span>] <span class="op">==</span> <span class="dv">0</span>]</span>
<span id="cb35-228"><a href="#cb35-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-229"><a href="#cb35-229" aria-hidden="true" tabindex="-1"></a>    matched_conv <span class="op">=</span> matched_df[<span class="st">'actual_outcome'</span>].mean() <span class="cf">if</span> <span class="bu">len</span>(matched_df) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb35-230"><a href="#cb35-230" aria-hidden="true" tabindex="-1"></a>    matched_n <span class="op">=</span> <span class="bu">len</span>(matched_df)</span>
<span id="cb35-231"><a href="#cb35-231" aria-hidden="true" tabindex="-1"></a>    unmatched_conv <span class="op">=</span> unmatched_df[<span class="st">'actual_outcome'</span>].mean() <span class="cf">if</span> <span class="bu">len</span>(unmatched_df) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb35-232"><a href="#cb35-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-233"><a href="#cb35-233" aria-hidden="true" tabindex="-1"></a>    match_lift <span class="op">=</span> matched_conv <span class="op">/</span> unmatched_conv <span class="cf">if</span> unmatched_conv <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb35-234"><a href="#cb35-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-235"><a href="#cb35-235" aria-hidden="true" tabindex="-1"></a>    q6_evidence <span class="op">=</span> <span class="ss">f"Matched: </span><span class="sc">{</span>matched_conv<span class="sc">:.1%}</span><span class="ss"> (n=</span><span class="sc">{</span>matched_n<span class="sc">:,}</span><span class="ss">), Lift: </span><span class="sc">{</span>match_lift<span class="sc">:.1f}</span><span class="ss">x"</span></span>
<span id="cb35-236"><a href="#cb35-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-237"><a href="#cb35-237" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> matched_conv <span class="op">&gt;</span> unmatched_conv <span class="op">*</span> <span class="fl">1.2</span>:</span>
<span id="cb35-238"><a href="#cb35-238" aria-hidden="true" tabindex="-1"></a>        q6_verdict <span class="op">=</span> <span class="st">"YES - Route by match"</span></span>
<span id="cb35-239"><a href="#cb35-239" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb35-240"><a href="#cb35-240" aria-hidden="true" tabindex="-1"></a>        q6_verdict <span class="op">=</span> <span class="st">"WEAK - Minor impact"</span></span>
<span id="cb35-241"><a href="#cb35-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-242"><a href="#cb35-242" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Matched Conv: </span><span class="sc">{</span>matched_conv<span class="sc">:.1%}</span><span class="ss"> (n=</span><span class="sc">{</span>matched_n<span class="sc">:,}</span><span class="ss">)"</span>)</span>
<span id="cb35-243"><a href="#cb35-243" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Unmatched Conv: </span><span class="sc">{</span>unmatched_conv<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb35-244"><a href="#cb35-244" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Lift: </span><span class="sc">{</span>match_lift<span class="sc">:.1f}</span><span class="ss">x"</span>)</span>
<span id="cb35-245"><a href="#cb35-245" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  VERDICT: </span><span class="sc">{</span>q6_verdict<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb35-246"><a href="#cb35-246" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb35-247"><a href="#cb35-247" aria-hidden="true" tabindex="-1"></a>    q6_evidence <span class="op">=</span> <span class="st">"Role-product match data unavailable"</span></span>
<span id="cb35-248"><a href="#cb35-248" aria-hidden="true" tabindex="-1"></a>    q6_verdict <span class="op">=</span> <span class="st">"CANNOT EVALUATE"</span></span>
<span id="cb35-249"><a href="#cb35-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-250"><a href="#cb35-250" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb35-251"><a href="#cb35-251" aria-hidden="true" tabindex="-1"></a><span class="co"># GENERATE START-OF-MEETING DATA BRIEF (Markdown Table)</span></span>
<span id="cb35-252"><a href="#cb35-252" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb35-253"><a href="#cb35-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-254"><a href="#cb35-254" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb35-255"><a href="#cb35-255" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"START-OF-MEETING DATA BRIEF"</span>)</span>
<span id="cb35-256"><a href="#cb35-256" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb35-257"><a href="#cb35-257" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"(Copy/Paste Ready for Sponsor Meeting Notes)"</span>)</span>
<span id="cb35-258"><a href="#cb35-258" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb35-259"><a href="#cb35-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-260"><a href="#cb35-260" aria-hidden="true" tabindex="-1"></a>brief_data <span class="op">=</span> {</span>
<span id="cb35-261"><a href="#cb35-261" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Strategic Question'</span>: [</span>
<span id="cb35-262"><a href="#cb35-262" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Are 'Toxic' channels (Ext Demand Gen) dragging us down?"</span>,</span>
<span id="cb35-263"><a href="#cb35-263" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Do 'Recycled' (Stale &gt;180d) leads still convert?"</span>,</span>
<span id="cb35-264"><a href="#cb35-264" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Are 'Hidden Gems' (Unknown/Non-Mfg) actually high converters?"</span>,</span>
<span id="cb35-265"><a href="#cb35-265" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Does 'Capital Density' (budget proxy) correlate with success?"</span>,</span>
<span id="cb35-266"><a href="#cb35-266" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Does 'Intent Strength' (priority encoding) predict conversion?"</span>,</span>
<span id="cb35-267"><a href="#cb35-267" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Does 'Role-Product Match' increase conversion?"</span></span>
<span id="cb35-268"><a href="#cb35-268" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb35-269"><a href="#cb35-269" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Data Evidence'</span>: [</span>
<span id="cb35-270"><a href="#cb35-270" aria-hidden="true" tabindex="-1"></a>        q1_evidence,</span>
<span id="cb35-271"><a href="#cb35-271" aria-hidden="true" tabindex="-1"></a>        q2_evidence,</span>
<span id="cb35-272"><a href="#cb35-272" aria-hidden="true" tabindex="-1"></a>        q3_evidence,</span>
<span id="cb35-273"><a href="#cb35-273" aria-hidden="true" tabindex="-1"></a>        q4_evidence,</span>
<span id="cb35-274"><a href="#cb35-274" aria-hidden="true" tabindex="-1"></a>        q5_evidence,</span>
<span id="cb35-275"><a href="#cb35-275" aria-hidden="true" tabindex="-1"></a>        q6_evidence</span>
<span id="cb35-276"><a href="#cb35-276" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb35-277"><a href="#cb35-277" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Verdict'</span>: [</span>
<span id="cb35-278"><a href="#cb35-278" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"**</span><span class="sc">{</span>q1_verdict<span class="sc">}</span><span class="ss">**"</span>,</span>
<span id="cb35-279"><a href="#cb35-279" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"**</span><span class="sc">{</span>q2_verdict<span class="sc">}</span><span class="ss">**"</span>,</span>
<span id="cb35-280"><a href="#cb35-280" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"**</span><span class="sc">{</span>q3_verdict<span class="sc">}</span><span class="ss">**"</span>,</span>
<span id="cb35-281"><a href="#cb35-281" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"**</span><span class="sc">{</span>q4_verdict<span class="sc">}</span><span class="ss">**"</span>,</span>
<span id="cb35-282"><a href="#cb35-282" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"**</span><span class="sc">{</span>q5_verdict<span class="sc">}</span><span class="ss">**"</span>,</span>
<span id="cb35-283"><a href="#cb35-283" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"**</span><span class="sc">{</span>q6_verdict<span class="sc">}</span><span class="ss">**"</span></span>
<span id="cb35-284"><a href="#cb35-284" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb35-285"><a href="#cb35-285" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-286"><a href="#cb35-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-287"><a href="#cb35-287" aria-hidden="true" tabindex="-1"></a>brief_df <span class="op">=</span> pd.DataFrame(brief_data)</span>
<span id="cb35-288"><a href="#cb35-288" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(brief_df.to_markdown(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb35-289"><a href="#cb35-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-290"><a href="#cb35-290" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb35-291"><a href="#cb35-291" aria-hidden="true" tabindex="-1"></a><span class="co"># ADDITIONAL SPONSOR TALKING POINTS</span></span>
<span id="cb35-292"><a href="#cb35-292" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb35-293"><a href="#cb35-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-294"><a href="#cb35-294" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb35-295"><a href="#cb35-295" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"SPONSOR TALKING POINTS"</span>)</span>
<span id="cb35-296"><a href="#cb35-296" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb35-297"><a href="#cb35-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-298"><a href="#cb35-298" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"""</span></span>
<span id="cb35-299"><a href="#cb35-299" aria-hidden="true" tabindex="-1"></a><span class="ss">MODEL CREDIBILITY:</span></span>
<span id="cb35-300"><a href="#cb35-300" aria-hidden="true" tabindex="-1"></a><span class="ss">  - Test Set AUC: </span><span class="sc">{</span>FINAL_AUC<span class="sc">:.4f}</span><span class="ss"> (Holdout data, no data leakage)</span></span>
<span id="cb35-301"><a href="#cb35-301" aria-hidden="true" tabindex="-1"></a><span class="ss">  - 5-Fold Cross-Validation: Robust generalization</span></span>
<span id="cb35-302"><a href="#cb35-302" aria-hidden="true" tabindex="-1"></a><span class="ss">  - Champion Model: </span><span class="sc">{</span>CHAMPION_NAME<span class="sc">}</span></span>
<span id="cb35-303"><a href="#cb35-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-304"><a href="#cb35-304" aria-hidden="true" tabindex="-1"></a><span class="ss">BUSINESS IMPACT (Test Set Projection):</span></span>
<span id="cb35-305"><a href="#cb35-305" aria-hidden="true" tabindex="-1"></a><span class="ss">  - Optimal Threshold: </span><span class="sc">{</span>OPTIMAL_THRESHOLD<span class="sc">:.3f}</span></span>
<span id="cb35-306"><a href="#cb35-306" aria-hidden="true" tabindex="-1"></a><span class="ss">  - Max Profit: $</span><span class="sc">{</span>MAX_PROFIT<span class="sc">:,.0f}</span></span>
<span id="cb35-307"><a href="#cb35-307" aria-hidden="true" tabindex="-1"></a><span class="ss">  - SQLs Captured: </span><span class="sc">{</span>OPTIMAL_PCT_CAPTURE<span class="sc">:.0%}</span><span class="ss"> with </span><span class="sc">{</span>OPTIMAL_PCT_POP<span class="sc">:.0%}</span><span class="ss"> of calls</span></span>
<span id="cb35-308"><a href="#cb35-308" aria-hidden="true" tabindex="-1"></a><span class="ss">  - Projected Annual Lift: $</span><span class="sc">{</span>annualized_lift<span class="sc">:,.0f}</span></span>
<span id="cb35-309"><a href="#cb35-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-310"><a href="#cb35-310" aria-hidden="true" tabindex="-1"></a><span class="ss">KEY FEATURE DISCOVERIES:</span></span>
<span id="cb35-311"><a href="#cb35-311" aria-hidden="true" tabindex="-1"></a><span class="ss">  - Toxic Channels account for ~</span><span class="sc">{</span>toxic_n<span class="sc">:,}</span><span class="ss"> leads but convert at </span><span class="sc">{</span>toxic_conv<span class="sc">:.1%}</span></span>
<span id="cb35-312"><a href="#cb35-312" aria-hidden="true" tabindex="-1"></a><span class="ss">  - Hidden Gems convert at </span><span class="sc">{</span>gem_conv<span class="sc">:.1%}</span><span class="ss"> (</span><span class="sc">{</span>gem_lift<span class="sc">:.1f}</span><span class="ss">x lift vs baseline)</span></span>
<span id="cb35-313"><a href="#cb35-313" aria-hidden="true" tabindex="-1"></a><span class="ss">  - Golden Segment (Top Decile) converts at </span><span class="sc">{</span>golden_segment_rate<span class="sc">:.1%}</span></span>
<span id="cb35-314"><a href="#cb35-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-315"><a href="#cb35-315" aria-hidden="true" tabindex="-1"></a><span class="ss">RECOMMENDED ACTIONS:</span></span>
<span id="cb35-316"><a href="#cb35-316" aria-hidden="true" tabindex="-1"></a><span class="ss">  1. Deploy scoring engine with threshold </span><span class="sc">{</span>OPTIMAL_THRESHOLD<span class="sc">:.2f}</span></span>
<span id="cb35-317"><a href="#cb35-317" aria-hidden="true" tabindex="-1"></a><span class="ss">  2. Flag and deprioritize Toxic channel leads in CRM</span></span>
<span id="cb35-318"><a href="#cb35-318" aria-hidden="true" tabindex="-1"></a><span class="ss">  3. Create "Hidden Gem" routing rule for consultants/small firms</span></span>
<span id="cb35-319"><a href="#cb35-319" aria-hidden="true" tabindex="-1"></a><span class="ss">  4. Purchase outbound lists matching Golden Segment profile</span></span>
<span id="cb35-320"><a href="#cb35-320" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span>)</span>
<span id="cb35-321"><a href="#cb35-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-322"><a href="#cb35-322" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb35-323"><a href="#cb35-323" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"VALIDATION COMPLETE - READY FOR SPONSOR MEETING"</span>)</span>
<span id="cb35-324"><a href="#cb35-324" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
======================================================================
PHASE 9: SPONSOR Q&amp;A DATA VALIDATION
======================================================================

Baseline: 17.9% conversion (3,363 leads in test set)

--------------------------------------------------
Q1: Are 'Toxic' channels (External Demand Gen, Email) dragging us down?
--------------------------------------------------
  Toxic Channel Conv: 4.5% (n=1,070)
  Premium Channel Conv: 27.5% (n=1,015)
  Standard Channel Conv: 21.6%
  Baseline Conv: 17.9%
  Toxic Waste: $-234,500 (cost minus revenue)
  VERDICT: YES - Cut immediately

--------------------------------------------------
Q2: Do 'Recycled' (Stale) leads still convert?
--------------------------------------------------
  Stale Lead Conv (&gt;180 days): 17.6% (n=2,691)
  Fresh Lead Conv (&lt;30 days): 26.7% (n=60)
  Baseline Conv: 17.9%
  VERDICT: YES - Still viable

--------------------------------------------------
Q3: Are 'Hidden Gems' (Unknown accounts) actually high converters?
--------------------------------------------------
  Hidden Gem Conv: 31.5% (n=517)
  Non-Gem Conv: 15.5%
  Baseline Conv: 17.9%
  Lift: 1.8x
  VERDICT: YES - Prioritize immediately

--------------------------------------------------
Q4: Does 'Capital Density' (budget proxy) correlate with conversion?
--------------------------------------------------
  Correlation with target: -0.0793
  Q1 (Low Budget) Conv: 22.4%
  Q4 (High Budget) Conv: 9.8%
  Q4/Q1 Lift: 0.4x
  VERDICT: WEAK - Minor signal

--------------------------------------------------
Q5: Does 'Intent Strength' (priority encoding) predict conversion?
--------------------------------------------------
  Correlation with target: 0.3107
  High Intent (&gt;=4) Conv: 39.8%
  Low Intent (&lt;=1) Conv: 6.7%
  High/Low Lift: 5.9x
  VERDICT: YES - Strong signal

--------------------------------------------------
Q6: Does 'Role-Product Match' (title alignment) increase conversion?
--------------------------------------------------
  Matched Conv: 23.8% (n=789)
  Unmatched Conv: 16.1%
  Lift: 1.5x
  VERDICT: YES - Route by match

======================================================================
START-OF-MEETING DATA BRIEF
======================================================================
(Copy/Paste Ready for Sponsor Meeting Notes)

| Strategic Question                                             | Data Evidence                                         | Verdict                          |
|:---------------------------------------------------------------|:------------------------------------------------------|:---------------------------------|
| Are 'Toxic' channels (Ext Demand Gen) dragging us down?        | Toxic: 4.5% (n=1,070) vs Premium: 27.5%               | **YES - Cut immediately**        |
| Do 'Recycled' (Stale &gt;180d) leads still convert?               | Stale (&gt;180d): 17.6% (n=2,691) vs Fresh (&lt;30d): 26.7% | **YES - Still viable**           |
| Are 'Hidden Gems' (Unknown/Non-Mfg) actually high converters?  | Hidden Gems: 31.5% (n=517), Lift: 1.8x                | **YES - Prioritize immediately** |
| Does 'Capital Density' (budget proxy) correlate with success?  | Correlation: -0.079, Q4/Q1 Lift: 0.4x                 | **WEAK - Minor signal**          |
| Does 'Intent Strength' (priority encoding) predict conversion? | Correlation: 0.311, High/Low Lift: 5.9x               | **YES - Strong signal**          |
| Does 'Role-Product Match' increase conversion?                 | Matched: 23.8% (n=789), Lift: 1.5x                    | **YES - Route by match**         |

======================================================================
SPONSOR TALKING POINTS
======================================================================

MODEL CREDIBILITY:
  - Test Set AUC: 0.9153 (Holdout data, no data leakage)
  - 5-Fold Cross-Validation: Robust generalization
  - Champion Model: StackingEnsemble

BUSINESS IMPACT (Test Set Projection):
  - Optimal Threshold: 0.128
  - Max Profit: $3,476,200
  - SQLs Captured: 99% with 66% of calls
  - Projected Annual Lift: $316,200

KEY FEATURE DISCOVERIES:
  - Toxic Channels account for ~1,070 leads but convert at 4.5%
  - Hidden Gems convert at 31.5% (1.8x lift vs baseline)
  - Golden Segment (Top Decile) converts at 77.4%

RECOMMENDED ACTIONS:
  1. Deploy scoring engine with threshold 0.13
  2. Flag and deprioritize Toxic channel leads in CRM
  3. Create "Hidden Gem" routing rule for consultants/small firms
  4. Purchase outbound lists matching Golden Segment profile


======================================================================
VALIDATION COMPLETE - READY FOR SPONSOR MEETING
======================================================================</code></pre>
</div>
</div>
<hr>
<p><em>Model V9 (Dynamic Semantic Authority Edition) generated for MSBA Capstone Case Competition - Spring 2026</em></p>
<!-- -->

</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb37" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "The Revenue Engine V9: Dynamic Semantic Authority"</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Success-Calibrated Authority Weights &amp; U-Shaped Persona Curve"</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "MSBA Capstone Group 3"</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "Spring 2026"</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co">    theme: journal</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 3</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="co">    df-print: paged</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a><span class="co">  pdf:</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="co">    documentclass: article</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="co">    geometry: margin=1in</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a><span class="co">  echo: true</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a><span class="co">  message: false</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a><span class="fu"># Executive Summary</span></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>**The Objective: Domain Mastery.** V6 proved we could model the data; V7 proves we understand the business. By encoding the "Hidden Gems" (Consultants), correcting for "Toxic Channels" (External Demand Gen), and calculating "Capital Density," V7 aligns the algorithm with the financial reality of the buyer.</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>**Strategic Discoveries:**</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Discovery <span class="pp">|</span> Insight <span class="pp">|</span> Impact <span class="pp">|</span></span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a><span class="pp">|-----------|---------|--------|</span></span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **The "Toxic" Channels** <span class="pp">|</span> 'External Demand Gen' and 'Email' leads account for 33% of volume but only ~4% conversion <span class="pp">|</span> Stop working these leads immediately <span class="pp">|</span></span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **The "Hidden Gems"** <span class="pp">|</span> Leads with "Not Enough Info" or "Non-manufacturing" actually convert at 30-46% <span class="pp">|</span> These are agile consultants/small firms that typical scoring misses <span class="pp">|</span></span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Intent Hierarchy Error** <span class="pp">|</span> A "Webinar" P1 lead is actually lower intent than a generic lead <span class="pp">|</span> V7 corrects this classification error <span class="pp">|</span></span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Capital Density** <span class="pp">|</span> Pharma/Bio leads carry 3x the budget potential <span class="pp">|</span> Weight scoring by industry budget proxy <span class="pp">|</span></span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a>**What Changed from V6:**</span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> V6 Approach <span class="pp">|</span> V7 Titan Upgrade <span class="pp">|</span> Business Rationale <span class="pp">|</span></span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a><span class="pp">|-------------|------------------|-------------------|</span></span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Implicit channel treatment <span class="pp">|</span> <span class="in">`channel_efficiency`</span> tiering (Premium/Standard/Toxic) <span class="pp">|</span> Identifies unprofitable lead sources <span class="pp">|</span></span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Missing data as negative <span class="pp">|</span> <span class="in">`is_hidden_gem`</span> flag for "Unknown" accounts <span class="pp">|</span> Captures high-converting consultants <span class="pp">|</span></span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Uniform company sizing <span class="pp">|</span> <span class="in">`capital_density_score`</span> industry-weighted <span class="pp">|</span> Budget proxy improves prioritization <span class="pp">|</span></span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Binary priority encoding <span class="pp">|</span> <span class="in">`intent_strength`</span> ordinal mapping <span class="pp">|</span> Distinguishes true buyer urgency <span class="pp">|</span></span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Generic role matching <span class="pp">|</span> <span class="in">`role_product_match`</span> alignment score <span class="pp">|</span> Routes leads to right product team <span class="pp">|</span></span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Single-word title scan <span class="pp">|</span> <span class="in">`title_bigrams`</span> for key phrases <span class="pp">|</span> Captures "document control", "process engineer" <span class="pp">|</span></span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true" tabindex="-1"></a><span class="fu"># Phase 1: Titan Environment Setup</span></span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-51"><a href="#cb37-51" aria-hidden="true" tabindex="-1"></a>**Why This Matters:** The V6 architecture proved robust. V7 retains the sklearn-compatible CatBoost wrapper and adds domain-specific feature engineering. We use **5-fold cross-validation** (n_iter=50) to balance compute budget with thorough search.</span>
<span id="cb37-52"><a href="#cb37-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-55"><a href="#cb37-55" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-56"><a href="#cb37-56" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb37-57"><a href="#cb37-57" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb37-58"><a href="#cb37-58" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb37-59"><a href="#cb37-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-60"><a href="#cb37-60" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-61"><a href="#cb37-61" aria-hidden="true" tabindex="-1"></a><span class="co"># PHASE 1: TITAN ENVIRONMENT</span></span>
<span id="cb37-62"><a href="#cb37-62" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-63"><a href="#cb37-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Domain-Optimized Stack with sklearn 1.6+ Compatibility</span></span>
<span id="cb37-64"><a href="#cb37-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-65"><a href="#cb37-65" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb37-66"><a href="#cb37-66" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb37-67"><a href="#cb37-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-68"><a href="#cb37-68" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> install_if_missing(package_name, import_name<span class="op">=</span><span class="va">None</span>, pip_name<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb37-69"><a href="#cb37-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Install a package if not already available."""</span></span>
<span id="cb37-70"><a href="#cb37-70" aria-hidden="true" tabindex="-1"></a>    import_name <span class="op">=</span> import_name <span class="kw">or</span> package_name.lower()</span>
<span id="cb37-71"><a href="#cb37-71" aria-hidden="true" tabindex="-1"></a>    pip_name <span class="op">=</span> pip_name <span class="kw">or</span> import_name</span>
<span id="cb37-72"><a href="#cb37-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-73"><a href="#cb37-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb37-74"><a href="#cb37-74" aria-hidden="true" tabindex="-1"></a>        <span class="bu">__import__</span>(import_name)</span>
<span id="cb37-75"><a href="#cb37-75" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb37-76"><a href="#cb37-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb37-77"><a href="#cb37-77" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>package_name<span class="sc">}</span><span class="ss">: Not found. Installing..."</span>)</span>
<span id="cb37-78"><a href="#cb37-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb37-79"><a href="#cb37-79" aria-hidden="true" tabindex="-1"></a>            subprocess.check_call(</span>
<span id="cb37-80"><a href="#cb37-80" aria-hidden="true" tabindex="-1"></a>                [sys.executable, <span class="st">"-m"</span>, <span class="st">"pip"</span>, <span class="st">"install"</span>, pip_name, <span class="st">"-q"</span>],</span>
<span id="cb37-81"><a href="#cb37-81" aria-hidden="true" tabindex="-1"></a>                stdout<span class="op">=</span>subprocess.DEVNULL,</span>
<span id="cb37-82"><a href="#cb37-82" aria-hidden="true" tabindex="-1"></a>                stderr<span class="op">=</span>subprocess.DEVNULL</span>
<span id="cb37-83"><a href="#cb37-83" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb37-84"><a href="#cb37-84" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>package_name<span class="sc">}</span><span class="ss">: Installed successfully!"</span>)</span>
<span id="cb37-85"><a href="#cb37-85" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb37-86"><a href="#cb37-86" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> subprocess.CalledProcessError:</span>
<span id="cb37-87"><a href="#cb37-87" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>package_name<span class="sc">}</span><span class="ss">: Installation failed. Will use fallback."</span>)</span>
<span id="cb37-88"><a href="#cb37-88" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb37-89"><a href="#cb37-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-90"><a href="#cb37-90" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-91"><a href="#cb37-91" aria-hidden="true" tabindex="-1"></a><span class="co"># INSTALL DEPENDENCIES</span></span>
<span id="cb37-92"><a href="#cb37-92" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-93"><a href="#cb37-93" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-94"><a href="#cb37-94" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"V7 TITAN: CHECKING &amp; INSTALLING DEPENDENCIES"</span>)</span>
<span id="cb37-95"><a href="#cb37-95" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-96"><a href="#cb37-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-97"><a href="#cb37-97" aria-hidden="true" tabindex="-1"></a>install_if_missing(<span class="st">"pandas"</span>)</span>
<span id="cb37-98"><a href="#cb37-98" aria-hidden="true" tabindex="-1"></a>install_if_missing(<span class="st">"numpy"</span>)</span>
<span id="cb37-99"><a href="#cb37-99" aria-hidden="true" tabindex="-1"></a>install_if_missing(<span class="st">"matplotlib"</span>)</span>
<span id="cb37-100"><a href="#cb37-100" aria-hidden="true" tabindex="-1"></a>install_if_missing(<span class="st">"seaborn"</span>)</span>
<span id="cb37-101"><a href="#cb37-101" aria-hidden="true" tabindex="-1"></a>install_if_missing(<span class="st">"scikit-learn"</span>, import_name<span class="op">=</span><span class="st">"sklearn"</span>, pip_name<span class="op">=</span><span class="st">"scikit-learn"</span>)</span>
<span id="cb37-102"><a href="#cb37-102" aria-hidden="true" tabindex="-1"></a>install_if_missing(<span class="st">"pyprojroot"</span>, import_name<span class="op">=</span><span class="st">"pyprojroot"</span>)</span>
<span id="cb37-103"><a href="#cb37-103" aria-hidden="true" tabindex="-1"></a>install_if_missing(<span class="st">"CatBoost"</span>, import_name<span class="op">=</span><span class="st">"catboost"</span>)</span>
<span id="cb37-104"><a href="#cb37-104" aria-hidden="true" tabindex="-1"></a>install_if_missing(<span class="st">"XGBoost"</span>, import_name<span class="op">=</span><span class="st">"xgboost"</span>)</span>
<span id="cb37-105"><a href="#cb37-105" aria-hidden="true" tabindex="-1"></a>install_if_missing(<span class="st">"LightGBM"</span>, import_name<span class="op">=</span><span class="st">"lightgbm"</span>)</span>
<span id="cb37-106"><a href="#cb37-106" aria-hidden="true" tabindex="-1"></a>install_if_missing(<span class="st">"SHAP"</span>, import_name<span class="op">=</span><span class="st">"shap"</span>)</span>
<span id="cb37-107"><a href="#cb37-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-108"><a href="#cb37-108" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-109"><a href="#cb37-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-110"><a href="#cb37-110" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-111"><a href="#cb37-111" aria-hidden="true" tabindex="-1"></a><span class="co"># CORE IMPORTS</span></span>
<span id="cb37-112"><a href="#cb37-112" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-113"><a href="#cb37-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-114"><a href="#cb37-114" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb37-115"><a href="#cb37-115" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb37-116"><a href="#cb37-116" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb37-117"><a href="#cb37-117" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb37-118"><a href="#cb37-118" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb37-119"><a href="#cb37-119" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb37-120"><a href="#cb37-120" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb37-121"><a href="#cb37-121" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> multiprocessing</span>
<span id="cb37-122"><a href="#cb37-122" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb37-123"><a href="#cb37-123" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb37-124"><a href="#cb37-124" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyprojroot <span class="im">import</span> here</span>
<span id="cb37-125"><a href="#cb37-125" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> types <span class="im">import</span> SimpleNamespace  <span class="co"># sklearn 1.6+ compatibility fix</span></span>
<span id="cb37-126"><a href="#cb37-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-127"><a href="#cb37-127" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb37-128"><a href="#cb37-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-129"><a href="#cb37-129" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-130"><a href="#cb37-130" aria-hidden="true" tabindex="-1"></a><span class="co"># PARALLELISM CONFIGURATION</span></span>
<span id="cb37-131"><a href="#cb37-131" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-132"><a href="#cb37-132" aria-hidden="true" tabindex="-1"></a>N_JOBS <span class="op">=</span> multiprocessing.cpu_count() <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb37-133"><a href="#cb37-133" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Parallelism: </span><span class="sc">{</span>N_JOBS<span class="sc">}</span><span class="ss"> cores allocated (of </span><span class="sc">{</span>multiprocessing<span class="sc">.</span>cpu_count()<span class="sc">}</span><span class="ss"> available)"</span>)</span>
<span id="cb37-134"><a href="#cb37-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-135"><a href="#cb37-135" aria-hidden="true" tabindex="-1"></a><span class="co"># Core ML</span></span>
<span id="cb37-136"><a href="#cb37-136" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> (</span>
<span id="cb37-137"><a href="#cb37-137" aria-hidden="true" tabindex="-1"></a>    train_test_split, StratifiedKFold, RandomizedSearchCV, cross_val_predict</span>
<span id="cb37-138"><a href="#cb37-138" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-139"><a href="#cb37-139" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> (</span>
<span id="cb37-140"><a href="#cb37-140" aria-hidden="true" tabindex="-1"></a>    StandardScaler, LabelEncoder, FunctionTransformer</span>
<span id="cb37-141"><a href="#cb37-141" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-142"><a href="#cb37-142" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.feature_extraction.text <span class="im">import</span> TfidfVectorizer</span>
<span id="cb37-143"><a href="#cb37-143" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.decomposition <span class="im">import</span> TruncatedSVD</span>
<span id="cb37-144"><a href="#cb37-144" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.compose <span class="im">import</span> ColumnTransformer</span>
<span id="cb37-145"><a href="#cb37-145" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb37-146"><a href="#cb37-146" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.impute <span class="im">import</span> SimpleImputer</span>
<span id="cb37-147"><a href="#cb37-147" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.base <span class="im">import</span> BaseEstimator, TransformerMixin, ClassifierMixin, clone</span>
<span id="cb37-148"><a href="#cb37-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-149"><a href="#cb37-149" aria-hidden="true" tabindex="-1"></a><span class="co"># Metrics</span></span>
<span id="cb37-150"><a href="#cb37-150" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> (</span>
<span id="cb37-151"><a href="#cb37-151" aria-hidden="true" tabindex="-1"></a>    roc_auc_score, roc_curve, precision_recall_curve, average_precision_score,</span>
<span id="cb37-152"><a href="#cb37-152" aria-hidden="true" tabindex="-1"></a>    classification_report, confusion_matrix, brier_score_loss, log_loss,</span>
<span id="cb37-153"><a href="#cb37-153" aria-hidden="true" tabindex="-1"></a>    f1_score, precision_score, recall_score</span>
<span id="cb37-154"><a href="#cb37-154" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-155"><a href="#cb37-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-156"><a href="#cb37-156" aria-hidden="true" tabindex="-1"></a><span class="co"># Calibration</span></span>
<span id="cb37-157"><a href="#cb37-157" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.calibration <span class="im">import</span> CalibratedClassifierCV, calibration_curve</span>
<span id="cb37-158"><a href="#cb37-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-159"><a href="#cb37-159" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensemble &amp; Stacking</span></span>
<span id="cb37-160"><a href="#cb37-160" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> (</span>
<span id="cb37-161"><a href="#cb37-161" aria-hidden="true" tabindex="-1"></a>    RandomForestClassifier, GradientBoostingClassifier,</span>
<span id="cb37-162"><a href="#cb37-162" aria-hidden="true" tabindex="-1"></a>    StackingClassifier, VotingClassifier</span>
<span id="cb37-163"><a href="#cb37-163" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-164"><a href="#cb37-164" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LogisticRegression</span>
<span id="cb37-165"><a href="#cb37-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-166"><a href="#cb37-166" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-167"><a href="#cb37-167" aria-hidden="true" tabindex="-1"></a><span class="co"># CATBOOST SKLEARN COMPATIBILITY WRAPPER (V6 FIX - RETAINED)</span></span>
<span id="cb37-168"><a href="#cb37-168" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-169"><a href="#cb37-169" aria-hidden="true" tabindex="-1"></a><span class="co"># sklearn 1.6+ requires __sklearn_tags__ to return an object with dot-notation</span></span>
<span id="cb37-170"><a href="#cb37-170" aria-hidden="true" tabindex="-1"></a><span class="co"># access. This wrapper uses SimpleNamespace to satisfy the requirement.</span></span>
<span id="cb37-171"><a href="#cb37-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-172"><a href="#cb37-172" aria-hidden="true" tabindex="-1"></a>CATBOOST_AVAILABLE <span class="op">=</span> <span class="va">False</span></span>
<span id="cb37-173"><a href="#cb37-173" aria-hidden="true" tabindex="-1"></a>CATBOOST_RAW_AVAILABLE <span class="op">=</span> <span class="va">False</span></span>
<span id="cb37-174"><a href="#cb37-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-175"><a href="#cb37-175" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb37-176"><a href="#cb37-176" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> catboost <span class="im">import</span> CatBoostClassifier <span class="im">as</span> CatBoostRaw</span>
<span id="cb37-177"><a href="#cb37-177" aria-hidden="true" tabindex="-1"></a>    CATBOOST_RAW_AVAILABLE <span class="op">=</span> <span class="va">True</span></span>
<span id="cb37-178"><a href="#cb37-178" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"CatBoost: Raw import successful"</span>)</span>
<span id="cb37-179"><a href="#cb37-179" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb37-180"><a href="#cb37-180" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"CatBoost: Not available"</span>)</span>
<span id="cb37-181"><a href="#cb37-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-182"><a href="#cb37-182" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> CATBOOST_RAW_AVAILABLE:</span>
<span id="cb37-183"><a href="#cb37-183" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> SklearnCatBoost(BaseEstimator, ClassifierMixin):</span>
<span id="cb37-184"><a href="#cb37-184" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb37-185"><a href="#cb37-185" aria-hidden="true" tabindex="-1"></a><span class="co">        sklearn-compatible CatBoost wrapper.</span></span>
<span id="cb37-186"><a href="#cb37-186" aria-hidden="true" tabindex="-1"></a><span class="co">        Fixed for sklearn 1.6+ tag requirements using SimpleNamespace.</span></span>
<span id="cb37-187"><a href="#cb37-187" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb37-188"><a href="#cb37-188" aria-hidden="true" tabindex="-1"></a>        _estimator_type <span class="op">=</span> <span class="st">"classifier"</span></span>
<span id="cb37-189"><a href="#cb37-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-190"><a href="#cb37-190" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, iterations<span class="op">=</span><span class="dv">500</span>, depth<span class="op">=</span><span class="dv">6</span>, learning_rate<span class="op">=</span><span class="fl">0.1</span>,</span>
<span id="cb37-191"><a href="#cb37-191" aria-hidden="true" tabindex="-1"></a>                     l2_leaf_reg<span class="op">=</span><span class="dv">3</span>, border_count<span class="op">=</span><span class="dv">64</span>, random_state<span class="op">=</span><span class="dv">42</span>,</span>
<span id="cb37-192"><a href="#cb37-192" aria-hidden="true" tabindex="-1"></a>                     verbose<span class="op">=</span><span class="dv">0</span>, thread_count<span class="op">=</span><span class="dv">1</span>):  <span class="co"># thread_count=1 for safety</span></span>
<span id="cb37-193"><a href="#cb37-193" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.iterations <span class="op">=</span> iterations</span>
<span id="cb37-194"><a href="#cb37-194" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.depth <span class="op">=</span> depth</span>
<span id="cb37-195"><a href="#cb37-195" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.learning_rate <span class="op">=</span> learning_rate</span>
<span id="cb37-196"><a href="#cb37-196" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.l2_leaf_reg <span class="op">=</span> l2_leaf_reg</span>
<span id="cb37-197"><a href="#cb37-197" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.border_count <span class="op">=</span> border_count</span>
<span id="cb37-198"><a href="#cb37-198" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.random_state <span class="op">=</span> random_state</span>
<span id="cb37-199"><a href="#cb37-199" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.verbose <span class="op">=</span> verbose</span>
<span id="cb37-200"><a href="#cb37-200" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.thread_count <span class="op">=</span> thread_count</span>
<span id="cb37-201"><a href="#cb37-201" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._model <span class="op">=</span> <span class="va">None</span></span>
<span id="cb37-202"><a href="#cb37-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-203"><a href="#cb37-203" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> __sklearn_tags__(<span class="va">self</span>):</span>
<span id="cb37-204"><a href="#cb37-204" aria-hidden="true" tabindex="-1"></a>            <span class="co">"""sklearn 1.6+ compatibility: Returns a namespace object."""</span></span>
<span id="cb37-205"><a href="#cb37-205" aria-hidden="true" tabindex="-1"></a>            tags <span class="op">=</span> SimpleNamespace()</span>
<span id="cb37-206"><a href="#cb37-206" aria-hidden="true" tabindex="-1"></a>            tags.estimator_type <span class="op">=</span> <span class="st">"classifier"</span></span>
<span id="cb37-207"><a href="#cb37-207" aria-hidden="true" tabindex="-1"></a>            tags.classifier_tags <span class="op">=</span> SimpleNamespace()</span>
<span id="cb37-208"><a href="#cb37-208" aria-hidden="true" tabindex="-1"></a>            tags.regressor_tags <span class="op">=</span> <span class="va">None</span></span>
<span id="cb37-209"><a href="#cb37-209" aria-hidden="true" tabindex="-1"></a>            tags.transformer_tags <span class="op">=</span> <span class="va">None</span></span>
<span id="cb37-210"><a href="#cb37-210" aria-hidden="true" tabindex="-1"></a>            tags.input_tags <span class="op">=</span> SimpleNamespace(</span>
<span id="cb37-211"><a href="#cb37-211" aria-hidden="true" tabindex="-1"></a>                allow_nan<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb37-212"><a href="#cb37-212" aria-hidden="true" tabindex="-1"></a>                pairwise<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb37-213"><a href="#cb37-213" aria-hidden="true" tabindex="-1"></a>                one_d_labels<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb37-214"><a href="#cb37-214" aria-hidden="true" tabindex="-1"></a>                two_d_labels<span class="op">=</span><span class="va">False</span></span>
<span id="cb37-215"><a href="#cb37-215" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb37-216"><a href="#cb37-216" aria-hidden="true" tabindex="-1"></a>            tags.target_tags <span class="op">=</span> SimpleNamespace(</span>
<span id="cb37-217"><a href="#cb37-217" aria-hidden="true" tabindex="-1"></a>                required_y<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb37-218"><a href="#cb37-218" aria-hidden="true" tabindex="-1"></a>                one_d_labels<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb37-219"><a href="#cb37-219" aria-hidden="true" tabindex="-1"></a>                two_d_labels<span class="op">=</span><span class="va">False</span></span>
<span id="cb37-220"><a href="#cb37-220" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb37-221"><a href="#cb37-221" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> tags</span>
<span id="cb37-222"><a href="#cb37-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-223"><a href="#cb37-223" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> fit(<span class="va">self</span>, X, y, <span class="op">**</span>fit_params):</span>
<span id="cb37-224"><a href="#cb37-224" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._model <span class="op">=</span> CatBoostRaw(</span>
<span id="cb37-225"><a href="#cb37-225" aria-hidden="true" tabindex="-1"></a>                iterations<span class="op">=</span><span class="va">self</span>.iterations,</span>
<span id="cb37-226"><a href="#cb37-226" aria-hidden="true" tabindex="-1"></a>                depth<span class="op">=</span><span class="va">self</span>.depth,</span>
<span id="cb37-227"><a href="#cb37-227" aria-hidden="true" tabindex="-1"></a>                learning_rate<span class="op">=</span><span class="va">self</span>.learning_rate,</span>
<span id="cb37-228"><a href="#cb37-228" aria-hidden="true" tabindex="-1"></a>                l2_leaf_reg<span class="op">=</span><span class="va">self</span>.l2_leaf_reg,</span>
<span id="cb37-229"><a href="#cb37-229" aria-hidden="true" tabindex="-1"></a>                border_count<span class="op">=</span><span class="va">self</span>.border_count,</span>
<span id="cb37-230"><a href="#cb37-230" aria-hidden="true" tabindex="-1"></a>                random_state<span class="op">=</span><span class="va">self</span>.random_state,</span>
<span id="cb37-231"><a href="#cb37-231" aria-hidden="true" tabindex="-1"></a>                verbose<span class="op">=</span><span class="va">self</span>.verbose,</span>
<span id="cb37-232"><a href="#cb37-232" aria-hidden="true" tabindex="-1"></a>                thread_count<span class="op">=</span><span class="va">self</span>.thread_count,</span>
<span id="cb37-233"><a href="#cb37-233" aria-hidden="true" tabindex="-1"></a>                allow_writing_files<span class="op">=</span><span class="va">False</span></span>
<span id="cb37-234"><a href="#cb37-234" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb37-235"><a href="#cb37-235" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._model.fit(X, y, <span class="op">**</span>fit_params)</span>
<span id="cb37-236"><a href="#cb37-236" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.classes_ <span class="op">=</span> np.unique(y)</span>
<span id="cb37-237"><a href="#cb37-237" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span></span>
<span id="cb37-238"><a href="#cb37-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-239"><a href="#cb37-239" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> predict(<span class="va">self</span>, X):</span>
<span id="cb37-240"><a href="#cb37-240" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>._model.predict(X).flatten().astype(<span class="bu">int</span>)</span>
<span id="cb37-241"><a href="#cb37-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-242"><a href="#cb37-242" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> predict_proba(<span class="va">self</span>, X):</span>
<span id="cb37-243"><a href="#cb37-243" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>._model.predict_proba(X)</span>
<span id="cb37-244"><a href="#cb37-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-245"><a href="#cb37-245" aria-hidden="true" tabindex="-1"></a>        <span class="at">@property</span></span>
<span id="cb37-246"><a href="#cb37-246" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> feature_importances_(<span class="va">self</span>):</span>
<span id="cb37-247"><a href="#cb37-247" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>._model.get_feature_importance()</span>
<span id="cb37-248"><a href="#cb37-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-249"><a href="#cb37-249" aria-hidden="true" tabindex="-1"></a>    CATBOOST_AVAILABLE <span class="op">=</span> <span class="va">True</span></span>
<span id="cb37-250"><a href="#cb37-250" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"CatBoost: sklearn-compatible wrapper created"</span>)</span>
<span id="cb37-251"><a href="#cb37-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-252"><a href="#cb37-252" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-253"><a href="#cb37-253" aria-hidden="true" tabindex="-1"></a><span class="co"># OTHER BOOSTING LIBRARIES</span></span>
<span id="cb37-254"><a href="#cb37-254" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-255"><a href="#cb37-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-256"><a href="#cb37-256" aria-hidden="true" tabindex="-1"></a>XGBOOST_AVAILABLE <span class="op">=</span> <span class="va">False</span></span>
<span id="cb37-257"><a href="#cb37-257" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb37-258"><a href="#cb37-258" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> xgboost <span class="im">import</span> XGBClassifier</span>
<span id="cb37-259"><a href="#cb37-259" aria-hidden="true" tabindex="-1"></a>    XGBOOST_AVAILABLE <span class="op">=</span> <span class="va">True</span></span>
<span id="cb37-260"><a href="#cb37-260" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"XGBoost: Ready"</span>)</span>
<span id="cb37-261"><a href="#cb37-261" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb37-262"><a href="#cb37-262" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"XGBoost: Not available"</span>)</span>
<span id="cb37-263"><a href="#cb37-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-264"><a href="#cb37-264" aria-hidden="true" tabindex="-1"></a>LIGHTGBM_AVAILABLE <span class="op">=</span> <span class="va">False</span></span>
<span id="cb37-265"><a href="#cb37-265" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb37-266"><a href="#cb37-266" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> lightgbm <span class="im">import</span> LGBMClassifier</span>
<span id="cb37-267"><a href="#cb37-267" aria-hidden="true" tabindex="-1"></a>    LIGHTGBM_AVAILABLE <span class="op">=</span> <span class="va">True</span></span>
<span id="cb37-268"><a href="#cb37-268" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"LightGBM: Ready"</span>)</span>
<span id="cb37-269"><a href="#cb37-269" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb37-270"><a href="#cb37-270" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"LightGBM: Not available"</span>)</span>
<span id="cb37-271"><a href="#cb37-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-272"><a href="#cb37-272" aria-hidden="true" tabindex="-1"></a><span class="co"># Target Encoding (sklearn 1.3+)</span></span>
<span id="cb37-273"><a href="#cb37-273" aria-hidden="true" tabindex="-1"></a>TARGET_ENCODER_AVAILABLE <span class="op">=</span> <span class="va">False</span></span>
<span id="cb37-274"><a href="#cb37-274" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb37-275"><a href="#cb37-275" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.preprocessing <span class="im">import</span> TargetEncoder</span>
<span id="cb37-276"><a href="#cb37-276" aria-hidden="true" tabindex="-1"></a>    TARGET_ENCODER_AVAILABLE <span class="op">=</span> <span class="va">True</span></span>
<span id="cb37-277"><a href="#cb37-277" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"TargetEncoder: Ready (sklearn 1.3+)"</span>)</span>
<span id="cb37-278"><a href="#cb37-278" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb37-279"><a href="#cb37-279" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"TargetEncoder: Not available (using manual implementation)"</span>)</span>
<span id="cb37-280"><a href="#cb37-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-281"><a href="#cb37-281" aria-hidden="true" tabindex="-1"></a><span class="co"># SHAP for explainability</span></span>
<span id="cb37-282"><a href="#cb37-282" aria-hidden="true" tabindex="-1"></a>SHAP_AVAILABLE <span class="op">=</span> <span class="va">False</span></span>
<span id="cb37-283"><a href="#cb37-283" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb37-284"><a href="#cb37-284" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> shap</span>
<span id="cb37-285"><a href="#cb37-285" aria-hidden="true" tabindex="-1"></a>    SHAP_AVAILABLE <span class="op">=</span> <span class="va">True</span></span>
<span id="cb37-286"><a href="#cb37-286" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"SHAP: Ready"</span>)</span>
<span id="cb37-287"><a href="#cb37-287" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb37-288"><a href="#cb37-288" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"SHAP: Not available"</span>)</span>
<span id="cb37-289"><a href="#cb37-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-290"><a href="#cb37-290" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-291"><a href="#cb37-291" aria-hidden="true" tabindex="-1"></a><span class="co"># PATH CONFIGURATION</span></span>
<span id="cb37-292"><a href="#cb37-292" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-293"><a href="#cb37-293" aria-hidden="true" tabindex="-1"></a>DATA_DIR <span class="op">=</span> here(<span class="st">"data"</span>)</span>
<span id="cb37-294"><a href="#cb37-294" aria-hidden="true" tabindex="-1"></a>OUTPUT_DIR <span class="op">=</span> here(<span class="st">"output"</span>)</span>
<span id="cb37-295"><a href="#cb37-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-296"><a href="#cb37-296" aria-hidden="true" tabindex="-1"></a>CLEANED_DATA_PATH <span class="op">=</span> here(<span class="st">"output/Cleaned_QAL_Performance_for_MSBA.csv"</span>)</span>
<span id="cb37-297"><a href="#cb37-297" aria-hidden="true" tabindex="-1"></a>RAW_DATA_PATH <span class="op">=</span> here(<span class="st">"data/QAL Performance for MSBA.csv"</span>)</span>
<span id="cb37-298"><a href="#cb37-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-299"><a href="#cb37-299" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> CLEANED_DATA_PATH.exists():</span>
<span id="cb37-300"><a href="#cb37-300" aria-hidden="true" tabindex="-1"></a>    DATA_PATH <span class="op">=</span> CLEANED_DATA_PATH</span>
<span id="cb37-301"><a href="#cb37-301" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Using cleaned data: </span><span class="sc">{</span>CLEANED_DATA_PATH<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-302"><a href="#cb37-302" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb37-303"><a href="#cb37-303" aria-hidden="true" tabindex="-1"></a>    DATA_PATH <span class="op">=</span> RAW_DATA_PATH</span>
<span id="cb37-304"><a href="#cb37-304" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Fallback to raw data: </span><span class="sc">{</span>RAW_DATA_PATH<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-305"><a href="#cb37-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-306"><a href="#cb37-306" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-307"><a href="#cb37-307" aria-hidden="true" tabindex="-1"></a><span class="co"># HYPERPARAMETERS &amp; CONFIGURATION (V7 TITAN)</span></span>
<span id="cb37-308"><a href="#cb37-308" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-309"><a href="#cb37-309" aria-hidden="true" tabindex="-1"></a>RANDOM_STATE <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb37-310"><a href="#cb37-310" aria-hidden="true" tabindex="-1"></a>CV_FOLDS <span class="op">=</span> <span class="dv">5</span>  <span class="co"># Robust validation</span></span>
<span id="cb37-311"><a href="#cb37-311" aria-hidden="true" tabindex="-1"></a>N_ITER_SEARCH <span class="op">=</span> <span class="dv">50</span>  <span class="co"># V7: Reduced from 100 to accommodate feature complexity</span></span>
<span id="cb37-312"><a href="#cb37-312" aria-hidden="true" tabindex="-1"></a>TEST_SIZE <span class="op">=</span> <span class="fl">0.20</span></span>
<span id="cb37-313"><a href="#cb37-313" aria-hidden="true" tabindex="-1"></a>VAL_SIZE <span class="op">=</span> <span class="fl">0.15</span></span>
<span id="cb37-314"><a href="#cb37-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-315"><a href="#cb37-315" aria-hidden="true" tabindex="-1"></a><span class="co"># Text Processing</span></span>
<span id="cb37-316"><a href="#cb37-316" aria-hidden="true" tabindex="-1"></a>LSA_COMPONENTS <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb37-317"><a href="#cb37-317" aria-hidden="true" tabindex="-1"></a>TFIDF_MAX_FEATURES <span class="op">=</span> <span class="dv">500</span></span>
<span id="cb37-318"><a href="#cb37-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-319"><a href="#cb37-319" aria-hidden="true" tabindex="-1"></a><span class="co"># Business Parameters</span></span>
<span id="cb37-320"><a href="#cb37-320" aria-hidden="true" tabindex="-1"></a>COST_PER_CALL <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb37-321"><a href="#cb37-321" aria-hidden="true" tabindex="-1"></a>VALUE_PER_SQL <span class="op">=</span> <span class="dv">6000</span></span>
<span id="cb37-322"><a href="#cb37-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-323"><a href="#cb37-323" aria-hidden="true" tabindex="-1"></a><span class="co"># SHAP Sampling</span></span>
<span id="cb37-324"><a href="#cb37-324" aria-hidden="true" tabindex="-1"></a>SHAP_BACKGROUND_SAMPLES <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb37-325"><a href="#cb37-325" aria-hidden="true" tabindex="-1"></a>SHAP_TEST_SAMPLES <span class="op">=</span> <span class="dv">200</span></span>
<span id="cb37-326"><a href="#cb37-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-327"><a href="#cb37-327" aria-hidden="true" tabindex="-1"></a><span class="co"># Visual Configuration</span></span>
<span id="cb37-328"><a href="#cb37-328" aria-hidden="true" tabindex="-1"></a>PROJECT_COLS <span class="op">=</span> {</span>
<span id="cb37-329"><a href="#cb37-329" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Success'</span>: <span class="st">'#00534B'</span>,</span>
<span id="cb37-330"><a href="#cb37-330" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Failure'</span>: <span class="st">'#F05627'</span>,</span>
<span id="cb37-331"><a href="#cb37-331" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Neutral'</span>: <span class="st">'#95a5a6'</span>,</span>
<span id="cb37-332"><a href="#cb37-332" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Highlight'</span>: <span class="st">'#2980b9'</span>,</span>
<span id="cb37-333"><a href="#cb37-333" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Gold'</span>: <span class="st">'#f39c12'</span>,</span>
<span id="cb37-334"><a href="#cb37-334" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Purple'</span>: <span class="st">'#9b59b6'</span>,</span>
<span id="cb37-335"><a href="#cb37-335" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Profit'</span>: <span class="st">'#27ae60'</span>,</span>
<span id="cb37-336"><a href="#cb37-336" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Toxic'</span>: <span class="st">'#e74c3c'</span>,</span>
<span id="cb37-337"><a href="#cb37-337" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Premium'</span>: <span class="st">'#2ecc71'</span></span>
<span id="cb37-338"><a href="#cb37-338" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-339"><a href="#cb37-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-340"><a href="#cb37-340" aria-hidden="true" tabindex="-1"></a>sns.set_theme(style<span class="op">=</span><span class="st">"whitegrid"</span>, context<span class="op">=</span><span class="st">"talk"</span>)</span>
<span id="cb37-341"><a href="#cb37-341" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">'figure.figsize'</span>] <span class="op">=</span> (<span class="dv">14</span>, <span class="dv">8</span>)</span>
<span id="cb37-342"><a href="#cb37-342" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">'axes.titleweight'</span>] <span class="op">=</span> <span class="st">'bold'</span></span>
<span id="cb37-343"><a href="#cb37-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-344"><a href="#cb37-344" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-345"><a href="#cb37-345" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"V7 TITAN ENVIRONMENT INITIALIZED"</span>)</span>
<span id="cb37-346"><a href="#cb37-346" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-347"><a href="#cb37-347" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Random State: </span><span class="sc">{</span>RANDOM_STATE<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-348"><a href="#cb37-348" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"CV Folds: </span><span class="sc">{</span>CV_FOLDS<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-349"><a href="#cb37-349" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Search Iterations: </span><span class="sc">{</span>N_ITER_SEARCH<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-350"><a href="#cb37-350" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"LSA Components: </span><span class="sc">{</span>LSA_COMPONENTS<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-351"><a href="#cb37-351" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Business: $</span><span class="sc">{</span>COST_PER_CALL<span class="sc">}</span><span class="ss"> cost/call, $</span><span class="sc">{</span>VALUE_PER_SQL<span class="sc">}</span><span class="ss"> value/SQL"</span>)</span>
<span id="cb37-352"><a href="#cb37-352" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"CatBoost sklearn-compatible: </span><span class="sc">{</span>CATBOOST_AVAILABLE<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-353"><a href="#cb37-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-354"><a href="#cb37-354" aria-hidden="true" tabindex="-1"></a>START_TIME <span class="op">=</span> time.time()</span>
<span id="cb37-355"><a href="#cb37-355" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-356"><a href="#cb37-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-357"><a href="#cb37-357" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb37-358"><a href="#cb37-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-359"><a href="#cb37-359" aria-hidden="true" tabindex="-1"></a><span class="fu"># Phase 2: Titan Domain Engineering</span></span>
<span id="cb37-360"><a href="#cb37-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-361"><a href="#cb37-361" aria-hidden="true" tabindex="-1"></a>**The Strategic Breakthrough:** V7 doesn't just process data---it encodes **domain expertise**. Every feature below was discovered through forensic analysis of conversion patterns that V6 missed.</span>
<span id="cb37-362"><a href="#cb37-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-363"><a href="#cb37-363" aria-hidden="true" tabindex="-1"></a><span class="fu">## 2.1 The Titan Feature Definitions</span></span>
<span id="cb37-364"><a href="#cb37-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-367"><a href="#cb37-367" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-368"><a href="#cb37-368" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: titan-feature-definitions</span></span>
<span id="cb37-369"><a href="#cb37-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-370"><a href="#cb37-370" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-371"><a href="#cb37-371" aria-hidden="true" tabindex="-1"></a><span class="co"># V7 TITAN FEATURE MAPPINGS (Domain-Optimized)</span></span>
<span id="cb37-372"><a href="#cb37-372" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-373"><a href="#cb37-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-374"><a href="#cb37-374" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb37-375"><a href="#cb37-375" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. INTENT STRENGTH (Ordinal Encoding of Priority)</span></span>
<span id="cb37-376"><a href="#cb37-376" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb37-377"><a href="#cb37-377" aria-hidden="true" tabindex="-1"></a><span class="co"># Rationale: "Webinar" P1 leads are actually LOWER intent than "Contact Us" P1s.</span></span>
<span id="cb37-378"><a href="#cb37-378" aria-hidden="true" tabindex="-1"></a><span class="co"># The current binary treatment loses this critical signal.</span></span>
<span id="cb37-379"><a href="#cb37-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-380"><a href="#cb37-380" aria-hidden="true" tabindex="-1"></a>INTENT_STRENGTH_MAP <span class="op">=</span> {</span>
<span id="cb37-381"><a href="#cb37-381" aria-hidden="true" tabindex="-1"></a>    <span class="st">'P1 - Website Pricing'</span>: <span class="dv">5</span>,   <span class="co"># Highest intent: actively checking price</span></span>
<span id="cb37-382"><a href="#cb37-382" aria-hidden="true" tabindex="-1"></a>    <span class="st">'P1 - Contact Us'</span>: <span class="dv">5</span>,        <span class="co"># Highest intent: direct outreach</span></span>
<span id="cb37-383"><a href="#cb37-383" aria-hidden="true" tabindex="-1"></a>    <span class="st">'P1 - Video Demo'</span>: <span class="dv">3</span>,        <span class="co"># Medium-high: engaged but passive</span></span>
<span id="cb37-384"><a href="#cb37-384" aria-hidden="true" tabindex="-1"></a>    <span class="st">'P1 - Live Demo'</span>: <span class="dv">3</span>,         <span class="co"># Medium-high: interested but needs convincing</span></span>
<span id="cb37-385"><a href="#cb37-385" aria-hidden="true" tabindex="-1"></a>    <span class="st">'P1 - Webinar Demo'</span>: <span class="dv">1</span>,      <span class="co"># Low intent: passive learning (often "tire kickers")</span></span>
<span id="cb37-386"><a href="#cb37-386" aria-hidden="true" tabindex="-1"></a>    <span class="st">'No Priority'</span>: <span class="dv">1</span>,            <span class="co"># Baseline</span></span>
<span id="cb37-387"><a href="#cb37-387" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Priority 1'</span>: <span class="dv">2</span>,             <span class="co"># Generic P1 without qualifier</span></span>
<span id="cb37-388"><a href="#cb37-388" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Priority 2'</span>: <span class="dv">0</span>              <span class="co"># Lowest priority</span></span>
<span id="cb37-389"><a href="#cb37-389" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-390"><a href="#cb37-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-391"><a href="#cb37-391" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Intent Strength Mapping:"</span>)</span>
<span id="cb37-392"><a href="#cb37-392" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k, v <span class="kw">in</span> INTENT_STRENGTH_MAP.items():</span>
<span id="cb37-393"><a href="#cb37-393" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-394"><a href="#cb37-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-395"><a href="#cb37-395" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb37-396"><a href="#cb37-396" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. CHANNEL EFFICIENCY (Tiered Lead Source Quality)</span></span>
<span id="cb37-397"><a href="#cb37-397" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb37-398"><a href="#cb37-398" aria-hidden="true" tabindex="-1"></a><span class="co"># Rationale: 'External Demand Gen' converts at 2.5%. 'Direct/Inbound' converts</span></span>
<span id="cb37-399"><a href="#cb37-399" aria-hidden="true" tabindex="-1"></a><span class="co"># at 18%+. Treating them equally is a modeling failure.</span></span>
<span id="cb37-400"><a href="#cb37-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-401"><a href="#cb37-401" aria-hidden="true" tabindex="-1"></a>CHANNEL_TIER_MAP <span class="op">=</span> {</span>
<span id="cb37-402"><a href="#cb37-402" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Premium Channels (High conversion, high intent)</span></span>
<span id="cb37-403"><a href="#cb37-403" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Direct/Inbound'</span>: <span class="st">'Premium'</span>,</span>
<span id="cb37-404"><a href="#cb37-404" aria-hidden="true" tabindex="-1"></a>    <span class="st">'SEO'</span>: <span class="st">'Premium'</span>,</span>
<span id="cb37-405"><a href="#cb37-405" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Referrals'</span>: <span class="st">'Premium'</span>,</span>
<span id="cb37-406"><a href="#cb37-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-407"><a href="#cb37-407" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standard Channels (Acceptable conversion)</span></span>
<span id="cb37-408"><a href="#cb37-408" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Online Ads'</span>: <span class="st">'Standard'</span>,</span>
<span id="cb37-409"><a href="#cb37-409" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Directory Listing'</span>: <span class="st">'Standard'</span>,</span>
<span id="cb37-410"><a href="#cb37-410" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Events'</span>: <span class="st">'Standard'</span>,</span>
<span id="cb37-411"><a href="#cb37-411" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Outbound Prospecting'</span>: <span class="st">'Standard'</span>,</span>
<span id="cb37-412"><a href="#cb37-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-413"><a href="#cb37-413" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Toxic Channels (Volume without quality)</span></span>
<span id="cb37-414"><a href="#cb37-414" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Email'</span>: <span class="st">'Toxic'</span>,</span>
<span id="cb37-415"><a href="#cb37-415" aria-hidden="true" tabindex="-1"></a>    <span class="st">'External Demand Gen'</span>: <span class="st">'Toxic'</span></span>
<span id="cb37-416"><a href="#cb37-416" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-417"><a href="#cb37-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-418"><a href="#cb37-418" aria-hidden="true" tabindex="-1"></a>CHANNEL_NUMERIC_MAP <span class="op">=</span> {</span>
<span id="cb37-419"><a href="#cb37-419" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Premium'</span>: <span class="dv">3</span>,</span>
<span id="cb37-420"><a href="#cb37-420" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Standard'</span>: <span class="dv">2</span>,</span>
<span id="cb37-421"><a href="#cb37-421" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Toxic'</span>: <span class="dv">1</span>,</span>
<span id="cb37-422"><a href="#cb37-422" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Unknown'</span>: <span class="dv">2</span>  <span class="co"># Default to Standard</span></span>
<span id="cb37-423"><a href="#cb37-423" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-424"><a href="#cb37-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-425"><a href="#cb37-425" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Channel Efficiency Tiers:"</span>)</span>
<span id="cb37-426"><a href="#cb37-426" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> channel, tier <span class="kw">in</span> CHANNEL_TIER_MAP.items():</span>
<span id="cb37-427"><a href="#cb37-427" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>channel<span class="sc">}</span><span class="ss"> -&gt; </span><span class="sc">{</span>tier<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-428"><a href="#cb37-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-429"><a href="#cb37-429" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb37-430"><a href="#cb37-430" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. CAPITAL DENSITY SCORING (Budget Proxy)</span></span>
<span id="cb37-431"><a href="#cb37-431" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb37-432"><a href="#cb37-432" aria-hidden="true" tabindex="-1"></a><span class="co"># Rationale: A "Medium" Pharma company has 3x the budget of a "Medium"</span></span>
<span id="cb37-433"><a href="#cb37-433" aria-hidden="true" tabindex="-1"></a><span class="co"># Consumer Packaged Goods company. Size alone is misleading.</span></span>
<span id="cb37-434"><a href="#cb37-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-435"><a href="#cb37-435" aria-hidden="true" tabindex="-1"></a>INDUSTRY_BUDGET_MULTIPLIER <span class="op">=</span> {</span>
<span id="cb37-436"><a href="#cb37-436" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Pharma &amp; BioTech'</span>: <span class="fl">3.0</span>,</span>
<span id="cb37-437"><a href="#cb37-437" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Blood &amp; Biologics'</span>: <span class="fl">2.5</span>,</span>
<span id="cb37-438"><a href="#cb37-438" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Medical Device'</span>: <span class="fl">2.0</span>,</span>
<span id="cb37-439"><a href="#cb37-439" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Non-Life Science'</span>: <span class="fl">1.0</span>,</span>
<span id="cb37-440"><a href="#cb37-440" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Consumer Packaged Goods'</span>: <span class="fl">0.8</span></span>
<span id="cb37-441"><a href="#cb37-441" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-442"><a href="#cb37-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-443"><a href="#cb37-443" aria-hidden="true" tabindex="-1"></a>TIER_SIZE_MAP <span class="op">=</span> {</span>
<span id="cb37-444"><a href="#cb37-444" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Small'</span>: <span class="dv">50</span>,</span>
<span id="cb37-445"><a href="#cb37-445" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Medium'</span>: <span class="dv">500</span>,</span>
<span id="cb37-446"><a href="#cb37-446" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Large'</span>: <span class="dv">5000</span></span>
<span id="cb37-447"><a href="#cb37-447" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-448"><a href="#cb37-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-449"><a href="#cb37-449" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Capital Density Components:"</span>)</span>
<span id="cb37-450"><a href="#cb37-450" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  Industry Multipliers:"</span>, INDUSTRY_BUDGET_MULTIPLIER)</span>
<span id="cb37-451"><a href="#cb37-451" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  Tier Size ($ proxy):"</span>, TIER_SIZE_MAP)</span>
<span id="cb37-452"><a href="#cb37-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-453"><a href="#cb37-453" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb37-454"><a href="#cb37-454" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. HIDDEN GEM IDENTIFICATION</span></span>
<span id="cb37-455"><a href="#cb37-455" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb37-456"><a href="#cb37-456" aria-hidden="true" tabindex="-1"></a><span class="co"># Rationale: "Not Enough Info Found" and "Non-manufacturing organization" leads</span></span>
<span id="cb37-457"><a href="#cb37-457" aria-hidden="true" tabindex="-1"></a><span class="co"># convert at 30-46%. These are consultants, small firms, and agile buyers that</span></span>
<span id="cb37-458"><a href="#cb37-458" aria-hidden="true" tabindex="-1"></a><span class="co"># traditional firmographic scoring misses entirely.</span></span>
<span id="cb37-459"><a href="#cb37-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-460"><a href="#cb37-460" aria-hidden="true" tabindex="-1"></a>HIDDEN_GEM_SIGNALS <span class="op">=</span> {</span>
<span id="cb37-461"><a href="#cb37-461" aria-hidden="true" tabindex="-1"></a>    <span class="st">'manufacturing_model'</span>: [<span class="st">'Not Enough Info Found'</span>],</span>
<span id="cb37-462"><a href="#cb37-462" aria-hidden="true" tabindex="-1"></a>    <span class="st">'industry'</span>: [<span class="st">'Non-manufacturing organization'</span>]</span>
<span id="cb37-463"><a href="#cb37-463" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-464"><a href="#cb37-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-465"><a href="#cb37-465" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Hidden Gem Signals:"</span>)</span>
<span id="cb37-466"><a href="#cb37-466" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Manufacturing Model: </span><span class="sc">{</span>HIDDEN_GEM_SIGNALS[<span class="st">'manufacturing_model'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-467"><a href="#cb37-467" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Industry: </span><span class="sc">{</span>HIDDEN_GEM_SIGNALS[<span class="st">'industry'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-468"><a href="#cb37-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-469"><a href="#cb37-469" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb37-470"><a href="#cb37-470" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. ROLE-PRODUCT MATCH</span></span>
<span id="cb37-471"><a href="#cb37-471" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb37-472"><a href="#cb37-472" aria-hidden="true" tabindex="-1"></a><span class="co"># Rationale: A "Quality Manager" looking at "Qx" (Quality product) is a better</span></span>
<span id="cb37-473"><a href="#cb37-473" aria-hidden="true" tabindex="-1"></a><span class="co"># fit than looking at "Mx" (Manufacturing product). Alignment = faster sales.</span></span>
<span id="cb37-474"><a href="#cb37-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-475"><a href="#cb37-475" aria-hidden="true" tabindex="-1"></a>PRODUCT_ROLE_ALIGNMENT <span class="op">=</span> {</span>
<span id="cb37-476"><a href="#cb37-476" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Mx'</span>: [<span class="st">'Op'</span>, <span class="st">'Mfg'</span>, <span class="st">'Manuf'</span>, <span class="st">'Production'</span>, <span class="st">'Plant'</span>],</span>
<span id="cb37-477"><a href="#cb37-477" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Qx'</span>: [<span class="st">'Qual'</span>, <span class="st">'QA'</span>, <span class="st">'QC'</span>, <span class="st">'Compliance'</span>, <span class="st">'Validation'</span>]</span>
<span id="cb37-478"><a href="#cb37-478" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-479"><a href="#cb37-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-480"><a href="#cb37-480" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Role-Product Alignment:"</span>)</span>
<span id="cb37-481"><a href="#cb37-481" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> product, roles <span class="kw">in</span> PRODUCT_ROLE_ALIGNMENT.items():</span>
<span id="cb37-482"><a href="#cb37-482" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>product<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>roles<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-483"><a href="#cb37-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-484"><a href="#cb37-484" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb37-485"><a href="#cb37-485" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. HIGH-VALUE TITLE BIGRAMS</span></span>
<span id="cb37-486"><a href="#cb37-486" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb37-487"><a href="#cb37-487" aria-hidden="true" tabindex="-1"></a><span class="co"># Rationale: "Document Control" specialists are 2x more likely to convert.</span></span>
<span id="cb37-488"><a href="#cb37-488" aria-hidden="true" tabindex="-1"></a><span class="co"># Single-word title parsing misses these compound phrases.</span></span>
<span id="cb37-489"><a href="#cb37-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-490"><a href="#cb37-490" aria-hidden="true" tabindex="-1"></a>HIGH_VALUE_BIGRAMS <span class="op">=</span> [</span>
<span id="cb37-491"><a href="#cb37-491" aria-hidden="true" tabindex="-1"></a>    <span class="st">'continuous improvement'</span>,</span>
<span id="cb37-492"><a href="#cb37-492" aria-hidden="true" tabindex="-1"></a>    <span class="st">'document control'</span>,</span>
<span id="cb37-493"><a href="#cb37-493" aria-hidden="true" tabindex="-1"></a>    <span class="st">'process engineer'</span>,</span>
<span id="cb37-494"><a href="#cb37-494" aria-hidden="true" tabindex="-1"></a>    <span class="st">'quality systems'</span>,</span>
<span id="cb37-495"><a href="#cb37-495" aria-hidden="true" tabindex="-1"></a>    <span class="st">'regulatory affairs'</span>,</span>
<span id="cb37-496"><a href="#cb37-496" aria-hidden="true" tabindex="-1"></a>    <span class="st">'quality assurance'</span>,</span>
<span id="cb37-497"><a href="#cb37-497" aria-hidden="true" tabindex="-1"></a>    <span class="st">'validation engineer'</span>,</span>
<span id="cb37-498"><a href="#cb37-498" aria-hidden="true" tabindex="-1"></a>    <span class="st">'compliance manager'</span></span>
<span id="cb37-499"><a href="#cb37-499" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb37-500"><a href="#cb37-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-501"><a href="#cb37-501" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">High-Value Title Bigrams:"</span>)</span>
<span id="cb37-502"><a href="#cb37-502" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> bigram <span class="kw">in</span> HIGH_VALUE_BIGRAMS:</span>
<span id="cb37-503"><a href="#cb37-503" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  - '</span><span class="sc">{</span>bigram<span class="sc">}</span><span class="ss">'"</span>)</span>
<span id="cb37-504"><a href="#cb37-504" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-505"><a href="#cb37-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-506"><a href="#cb37-506" aria-hidden="true" tabindex="-1"></a><span class="fu">## 2.2 The Titan Feature Engineering Pipeline</span></span>
<span id="cb37-507"><a href="#cb37-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-510"><a href="#cb37-510" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-511"><a href="#cb37-511" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: titan-pipeline</span></span>
<span id="cb37-512"><a href="#cb37-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-513"><a href="#cb37-513" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-514"><a href="#cb37-514" aria-hidden="true" tabindex="-1"></a><span class="co"># V7 TITAN: DOMAIN-OPTIMIZED DATA PIPELINE</span></span>
<span id="cb37-515"><a href="#cb37-515" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-516"><a href="#cb37-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-517"><a href="#cb37-517" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> clean_and_engineer_titan(filepath):</span>
<span id="cb37-518"><a href="#cb37-518" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb37-519"><a href="#cb37-519" aria-hidden="true" tabindex="-1"></a><span class="co">    V7 Titan Data Pipeline: Domain-Optimized Feature Engineering.</span></span>
<span id="cb37-520"><a href="#cb37-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-521"><a href="#cb37-521" aria-hidden="true" tabindex="-1"></a><span class="co">    New Features:</span></span>
<span id="cb37-522"><a href="#cb37-522" aria-hidden="true" tabindex="-1"></a><span class="co">    1. intent_strength - Ordinal encoding of priority (5=High, 0=Low)</span></span>
<span id="cb37-523"><a href="#cb37-523" aria-hidden="true" tabindex="-1"></a><span class="co">    2. channel_efficiency - Tiered lead source (Premium/Standard/Toxic)</span></span>
<span id="cb37-524"><a href="#cb37-524" aria-hidden="true" tabindex="-1"></a><span class="co">    3. is_hidden_gem - Flag for high-converting "Unknown" accounts</span></span>
<span id="cb37-525"><a href="#cb37-525" aria-hidden="true" tabindex="-1"></a><span class="co">    4. capital_density_score - Industry-weighted budget proxy</span></span>
<span id="cb37-526"><a href="#cb37-526" aria-hidden="true" tabindex="-1"></a><span class="co">    5. role_product_match - Product-title alignment score</span></span>
<span id="cb37-527"><a href="#cb37-527" aria-hidden="true" tabindex="-1"></a><span class="co">    6. title_bigrams - Flags for high-value compound phrases</span></span>
<span id="cb37-528"><a href="#cb37-528" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb37-529"><a href="#cb37-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-530"><a href="#cb37-530" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-531"><a href="#cb37-531" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"V7 TITAN: DOMAIN-OPTIMIZED FEATURE ENGINEERING"</span>)</span>
<span id="cb37-532"><a href="#cb37-532" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-533"><a href="#cb37-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-534"><a href="#cb37-534" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load data</span></span>
<span id="cb37-535"><a href="#cb37-535" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(filepath)</span>
<span id="cb37-536"><a href="#cb37-536" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Loaded: </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">:,}</span><span class="ss"> rows, </span><span class="sc">{</span><span class="bu">len</span>(df.columns)<span class="sc">}</span><span class="ss"> columns"</span>)</span>
<span id="cb37-537"><a href="#cb37-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-538"><a href="#cb37-538" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standardize column names</span></span>
<span id="cb37-539"><a href="#cb37-539" aria-hidden="true" tabindex="-1"></a>    df.columns <span class="op">=</span> [c.strip().lower().replace(<span class="st">' '</span>, <span class="st">'_'</span>).replace(<span class="st">'/'</span>, <span class="st">'_'</span>).replace(<span class="st">'-'</span>, <span class="st">'_'</span>)</span>
<span id="cb37-540"><a href="#cb37-540" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">for</span> c <span class="kw">in</span> df.columns]</span>
<span id="cb37-541"><a href="#cb37-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-542"><a href="#cb37-542" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Target variable</span></span>
<span id="cb37-543"><a href="#cb37-543" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'is_success'</span> <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb37-544"><a href="#cb37-544" aria-hidden="true" tabindex="-1"></a>        success_stages <span class="op">=</span> [<span class="st">'SQL'</span>, <span class="st">'SQO'</span>, <span class="st">'Won'</span>]</span>
<span id="cb37-545"><a href="#cb37-545" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'is_success'</span>] <span class="op">=</span> df[<span class="st">'next_stage__c'</span>].isin(success_stages).astype(<span class="bu">int</span>)</span>
<span id="cb37-546"><a href="#cb37-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-547"><a href="#cb37-547" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Target Rate: </span><span class="sc">{</span>df[<span class="st">'is_success'</span>]<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb37-548"><a href="#cb37-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-549"><a href="#cb37-549" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb37-550"><a href="#cb37-550" aria-hidden="true" tabindex="-1"></a>    <span class="co"># TITAN FEATURE 1: INTENT STRENGTH</span></span>
<span id="cb37-551"><a href="#cb37-551" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb37-552"><a href="#cb37-552" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[1/6] Engineering: intent_strength"</span>)</span>
<span id="cb37-553"><a href="#cb37-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-554"><a href="#cb37-554" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'priority'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb37-555"><a href="#cb37-555" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'intent_strength'</span>] <span class="op">=</span> df[<span class="st">'priority'</span>].<span class="bu">map</span>(INTENT_STRENGTH_MAP).fillna(<span class="dv">1</span>)</span>
<span id="cb37-556"><a href="#cb37-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-557"><a href="#cb37-557" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Validation</span></span>
<span id="cb37-558"><a href="#cb37-558" aria-hidden="true" tabindex="-1"></a>        intent_conv <span class="op">=</span> df.groupby(<span class="st">'intent_strength'</span>)[<span class="st">'is_success'</span>].agg([<span class="st">'mean'</span>, <span class="st">'count'</span>])</span>
<span id="cb37-559"><a href="#cb37-559" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"  Intent Strength Conversion Rates:"</span>)</span>
<span id="cb37-560"><a href="#cb37-560" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> idx, row <span class="kw">in</span> intent_conv.iterrows():</span>
<span id="cb37-561"><a href="#cb37-561" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"    Level </span><span class="sc">{</span>idx<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>row[<span class="st">'mean'</span>]<span class="sc">:.1%}</span><span class="ss"> (n=</span><span class="sc">{</span>row[<span class="st">'count'</span>]<span class="sc">:,}</span><span class="ss">)"</span>)</span>
<span id="cb37-562"><a href="#cb37-562" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb37-563"><a href="#cb37-563" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'intent_strength'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb37-564"><a href="#cb37-564" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"  [WARNING] 'priority' column not found. Defaulting to 1."</span>)</span>
<span id="cb37-565"><a href="#cb37-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-566"><a href="#cb37-566" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb37-567"><a href="#cb37-567" aria-hidden="true" tabindex="-1"></a>    <span class="co"># TITAN FEATURE 2: CHANNEL EFFICIENCY</span></span>
<span id="cb37-568"><a href="#cb37-568" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb37-569"><a href="#cb37-569" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[2/6] Engineering: channel_efficiency"</span>)</span>
<span id="cb37-570"><a href="#cb37-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-571"><a href="#cb37-571" aria-hidden="true" tabindex="-1"></a>    channel_col <span class="op">=</span> <span class="st">'last_tactic_campaign_channel'</span> <span class="cf">if</span> <span class="st">'last_tactic_campaign_channel'</span> <span class="kw">in</span> df.columns <span class="cf">else</span> <span class="st">'lead_source'</span></span>
<span id="cb37-572"><a href="#cb37-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-573"><a href="#cb37-573" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> channel_col <span class="kw">in</span> df.columns:</span>
<span id="cb37-574"><a href="#cb37-574" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Map to tier</span></span>
<span id="cb37-575"><a href="#cb37-575" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'channel_tier'</span>] <span class="op">=</span> df[channel_col].<span class="bu">map</span>(CHANNEL_TIER_MAP).fillna(<span class="st">'Standard'</span>)</span>
<span id="cb37-576"><a href="#cb37-576" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'channel_efficiency'</span>] <span class="op">=</span> df[<span class="st">'channel_tier'</span>].<span class="bu">map</span>(CHANNEL_NUMERIC_MAP)</span>
<span id="cb37-577"><a href="#cb37-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-578"><a href="#cb37-578" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Validation</span></span>
<span id="cb37-579"><a href="#cb37-579" aria-hidden="true" tabindex="-1"></a>        tier_conv <span class="op">=</span> df.groupby(<span class="st">'channel_tier'</span>)[<span class="st">'is_success'</span>].agg([<span class="st">'mean'</span>, <span class="st">'count'</span>])</span>
<span id="cb37-580"><a href="#cb37-580" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"  Channel Tier Conversion Rates:"</span>)</span>
<span id="cb37-581"><a href="#cb37-581" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> tier <span class="kw">in</span> [<span class="st">'Premium'</span>, <span class="st">'Standard'</span>, <span class="st">'Toxic'</span>]:</span>
<span id="cb37-582"><a href="#cb37-582" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> tier <span class="kw">in</span> tier_conv.index:</span>
<span id="cb37-583"><a href="#cb37-583" aria-hidden="true" tabindex="-1"></a>                row <span class="op">=</span> tier_conv.loc[tier]</span>
<span id="cb37-584"><a href="#cb37-584" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"    </span><span class="sc">{</span>tier<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>row[<span class="st">'mean'</span>]<span class="sc">:.1%}</span><span class="ss"> (n=</span><span class="sc">{</span>row[<span class="st">'count'</span>]<span class="sc">:,}</span><span class="ss">)"</span>)</span>
<span id="cb37-585"><a href="#cb37-585" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb37-586"><a href="#cb37-586" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'channel_tier'</span>] <span class="op">=</span> <span class="st">'Standard'</span></span>
<span id="cb37-587"><a href="#cb37-587" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'channel_efficiency'</span>] <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb37-588"><a href="#cb37-588" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  [WARNING] Channel column not found. Defaulting to Standard."</span>)</span>
<span id="cb37-589"><a href="#cb37-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-590"><a href="#cb37-590" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb37-591"><a href="#cb37-591" aria-hidden="true" tabindex="-1"></a>    <span class="co"># TITAN FEATURE 3: HIDDEN GEM IDENTIFICATION</span></span>
<span id="cb37-592"><a href="#cb37-592" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb37-593"><a href="#cb37-593" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[3/6] Engineering: is_hidden_gem"</span>)</span>
<span id="cb37-594"><a href="#cb37-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-595"><a href="#cb37-595" aria-hidden="true" tabindex="-1"></a>    model_col <span class="op">=</span> <span class="st">'acct_manufacturing_model'</span> <span class="cf">if</span> <span class="st">'acct_manufacturing_model'</span> <span class="kw">in</span> df.columns <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb37-596"><a href="#cb37-596" aria-hidden="true" tabindex="-1"></a>    industry_col <span class="op">=</span> <span class="st">'acct_target_industry'</span> <span class="cf">if</span> <span class="st">'acct_target_industry'</span> <span class="kw">in</span> df.columns <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb37-597"><a href="#cb37-597" aria-hidden="true" tabindex="-1"></a>    site_col <span class="op">=</span> <span class="st">'acct_primary_site_function'</span> <span class="cf">if</span> <span class="st">'acct_primary_site_function'</span> <span class="kw">in</span> df.columns <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb37-598"><a href="#cb37-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-599"><a href="#cb37-599" aria-hidden="true" tabindex="-1"></a>    hidden_gem_mask <span class="op">=</span> pd.Series(<span class="va">False</span>, index<span class="op">=</span>df.index)</span>
<span id="cb37-600"><a href="#cb37-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-601"><a href="#cb37-601" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> model_col:</span>
<span id="cb37-602"><a href="#cb37-602" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check for "Not Enough Info Found" in manufacturing model</span></span>
<span id="cb37-603"><a href="#cb37-603" aria-hidden="true" tabindex="-1"></a>        hidden_gem_mask <span class="op">|=</span> df[model_col].<span class="bu">str</span>.contains(<span class="st">'Not Enough Info'</span>, case<span class="op">=</span><span class="va">False</span>, na<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb37-604"><a href="#cb37-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-605"><a href="#cb37-605" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> site_col:</span>
<span id="cb37-606"><a href="#cb37-606" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check for "Non-manufacturing organization" in site function</span></span>
<span id="cb37-607"><a href="#cb37-607" aria-hidden="true" tabindex="-1"></a>        hidden_gem_mask <span class="op">|=</span> df[site_col].<span class="bu">str</span>.contains(<span class="st">'Non-manufacturing'</span>, case<span class="op">=</span><span class="va">False</span>, na<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb37-608"><a href="#cb37-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-609"><a href="#cb37-609" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> industry_col:</span>
<span id="cb37-610"><a href="#cb37-610" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check for non-standard industries</span></span>
<span id="cb37-611"><a href="#cb37-611" aria-hidden="true" tabindex="-1"></a>        hidden_gem_mask <span class="op">|=</span> df[industry_col].<span class="bu">str</span>.contains(<span class="st">'Non-manufacturing'</span>, case<span class="op">=</span><span class="va">False</span>, na<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb37-612"><a href="#cb37-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-613"><a href="#cb37-613" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'is_hidden_gem'</span>] <span class="op">=</span> hidden_gem_mask.astype(<span class="bu">int</span>)</span>
<span id="cb37-614"><a href="#cb37-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-615"><a href="#cb37-615" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Validation</span></span>
<span id="cb37-616"><a href="#cb37-616" aria-hidden="true" tabindex="-1"></a>    gem_conv <span class="op">=</span> df.groupby(<span class="st">'is_hidden_gem'</span>)[<span class="st">'is_success'</span>].agg([<span class="st">'mean'</span>, <span class="st">'count'</span>])</span>
<span id="cb37-617"><a href="#cb37-617" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"  Hidden Gem Conversion Rates:"</span>)</span>
<span id="cb37-618"><a href="#cb37-618" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, row <span class="kw">in</span> gem_conv.iterrows():</span>
<span id="cb37-619"><a href="#cb37-619" aria-hidden="true" tabindex="-1"></a>        label <span class="op">=</span> <span class="st">"Hidden Gem"</span> <span class="cf">if</span> idx <span class="op">==</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">"Standard"</span></span>
<span id="cb37-620"><a href="#cb37-620" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"    </span><span class="sc">{</span>label<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>row[<span class="st">'mean'</span>]<span class="sc">:.1%}</span><span class="ss"> (n=</span><span class="sc">{</span>row[<span class="st">'count'</span>]<span class="sc">:,}</span><span class="ss">)"</span>)</span>
<span id="cb37-621"><a href="#cb37-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-622"><a href="#cb37-622" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb37-623"><a href="#cb37-623" aria-hidden="true" tabindex="-1"></a>    <span class="co"># TITAN FEATURE 4: CAPITAL DENSITY SCORE</span></span>
<span id="cb37-624"><a href="#cb37-624" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb37-625"><a href="#cb37-625" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[4/6] Engineering: capital_density_score"</span>)</span>
<span id="cb37-626"><a href="#cb37-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-627"><a href="#cb37-627" aria-hidden="true" tabindex="-1"></a>    tier_col <span class="op">=</span> <span class="st">'acct_tier_rollup'</span> <span class="cf">if</span> <span class="st">'acct_tier_rollup'</span> <span class="kw">in</span> df.columns <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb37-628"><a href="#cb37-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-629"><a href="#cb37-629" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> industry_col <span class="kw">and</span> tier_col:</span>
<span id="cb37-630"><a href="#cb37-630" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get industry multiplier</span></span>
<span id="cb37-631"><a href="#cb37-631" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'industry_multiplier'</span>] <span class="op">=</span> df[industry_col].<span class="bu">map</span>(</span>
<span id="cb37-632"><a href="#cb37-632" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> x: <span class="bu">next</span>((v <span class="cf">for</span> k, v <span class="kw">in</span> INDUSTRY_BUDGET_MULTIPLIER.items()</span>
<span id="cb37-633"><a href="#cb37-633" aria-hidden="true" tabindex="-1"></a>                           <span class="cf">if</span> k.lower() <span class="kw">in</span> <span class="bu">str</span>(x).lower()), <span class="fl">1.0</span>)</span>
<span id="cb37-634"><a href="#cb37-634" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb37-635"><a href="#cb37-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-636"><a href="#cb37-636" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get tier size</span></span>
<span id="cb37-637"><a href="#cb37-637" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'tier_size'</span>] <span class="op">=</span> df[tier_col].<span class="bu">map</span>(TIER_SIZE_MAP).fillna(<span class="dv">500</span>)</span>
<span id="cb37-638"><a href="#cb37-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-639"><a href="#cb37-639" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Capital Density = Multiplier * Size</span></span>
<span id="cb37-640"><a href="#cb37-640" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'capital_density_score'</span>] <span class="op">=</span> df[<span class="st">'industry_multiplier'</span>] <span class="op">*</span> df[<span class="st">'tier_size'</span>]</span>
<span id="cb37-641"><a href="#cb37-641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-642"><a href="#cb37-642" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Log transform for normalization</span></span>
<span id="cb37-643"><a href="#cb37-643" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'capital_density_log'</span>] <span class="op">=</span> np.log1p(df[<span class="st">'capital_density_score'</span>])</span>
<span id="cb37-644"><a href="#cb37-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-645"><a href="#cb37-645" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Clean up intermediate columns</span></span>
<span id="cb37-646"><a href="#cb37-646" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df.drop(columns<span class="op">=</span>[<span class="st">'industry_multiplier'</span>, <span class="st">'tier_size'</span>], errors<span class="op">=</span><span class="st">'ignore'</span>)</span>
<span id="cb37-647"><a href="#cb37-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-648"><a href="#cb37-648" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Capital Density Range: </span><span class="sc">{</span>df[<span class="st">'capital_density_score'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:.0f}</span><span class="ss"> - </span><span class="sc">{</span>df[<span class="st">'capital_density_score'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:.0f}</span><span class="ss">"</span>)</span>
<span id="cb37-649"><a href="#cb37-649" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Capital Density Mean: </span><span class="sc">{</span>df[<span class="st">'capital_density_score'</span>]<span class="sc">.</span>mean()<span class="sc">:.0f}</span><span class="ss">"</span>)</span>
<span id="cb37-650"><a href="#cb37-650" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb37-651"><a href="#cb37-651" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'capital_density_score'</span>] <span class="op">=</span> <span class="dv">500</span></span>
<span id="cb37-652"><a href="#cb37-652" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'capital_density_log'</span>] <span class="op">=</span> np.log1p(<span class="dv">500</span>)</span>
<span id="cb37-653"><a href="#cb37-653" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"  [WARNING] Industry/Tier columns not found. Defaulting to 500."</span>)</span>
<span id="cb37-654"><a href="#cb37-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-655"><a href="#cb37-655" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb37-656"><a href="#cb37-656" aria-hidden="true" tabindex="-1"></a>    <span class="co"># TITAN FEATURE 5: ROLE-PRODUCT MATCH</span></span>
<span id="cb37-657"><a href="#cb37-657" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb37-658"><a href="#cb37-658" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[5/6] Engineering: role_product_match"</span>)</span>
<span id="cb37-659"><a href="#cb37-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-660"><a href="#cb37-660" aria-hidden="true" tabindex="-1"></a>    title_col <span class="op">=</span> <span class="st">'contact_lead_title'</span> <span class="cf">if</span> <span class="st">'contact_lead_title'</span> <span class="kw">in</span> df.columns <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb37-661"><a href="#cb37-661" aria-hidden="true" tabindex="-1"></a>    product_col <span class="op">=</span> <span class="st">'product_segment'</span> <span class="cf">if</span> <span class="st">'product_segment'</span> <span class="kw">in</span> df.columns <span class="cf">else</span> <span class="st">'solution_rollup'</span></span>
<span id="cb37-662"><a href="#cb37-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-663"><a href="#cb37-663" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> title_col <span class="kw">and</span> product_col <span class="kw">in</span> df.columns:</span>
<span id="cb37-664"><a href="#cb37-664" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> check_role_product_match(row):</span>
<span id="cb37-665"><a href="#cb37-665" aria-hidden="true" tabindex="-1"></a>            title <span class="op">=</span> <span class="bu">str</span>(row[title_col]).lower() <span class="cf">if</span> pd.notna(row[title_col]) <span class="cf">else</span> <span class="st">''</span></span>
<span id="cb37-666"><a href="#cb37-666" aria-hidden="true" tabindex="-1"></a>            product <span class="op">=</span> <span class="bu">str</span>(row[product_col]) <span class="cf">if</span> pd.notna(row[product_col]) <span class="cf">else</span> <span class="st">''</span></span>
<span id="cb37-667"><a href="#cb37-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-668"><a href="#cb37-668" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> product <span class="kw">in</span> PRODUCT_ROLE_ALIGNMENT:</span>
<span id="cb37-669"><a href="#cb37-669" aria-hidden="true" tabindex="-1"></a>                keywords <span class="op">=</span> PRODUCT_ROLE_ALIGNMENT[product]</span>
<span id="cb37-670"><a href="#cb37-670" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> kw <span class="kw">in</span> keywords:</span>
<span id="cb37-671"><a href="#cb37-671" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> kw.lower() <span class="kw">in</span> title:</span>
<span id="cb37-672"><a href="#cb37-672" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb37-673"><a href="#cb37-673" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb37-674"><a href="#cb37-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-675"><a href="#cb37-675" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'role_product_match'</span>] <span class="op">=</span> df.<span class="bu">apply</span>(check_role_product_match, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb37-676"><a href="#cb37-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-677"><a href="#cb37-677" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Validation</span></span>
<span id="cb37-678"><a href="#cb37-678" aria-hidden="true" tabindex="-1"></a>        match_conv <span class="op">=</span> df.groupby(<span class="st">'role_product_match'</span>)[<span class="st">'is_success'</span>].agg([<span class="st">'mean'</span>, <span class="st">'count'</span>])</span>
<span id="cb37-679"><a href="#cb37-679" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"  Role-Product Match Conversion:"</span>)</span>
<span id="cb37-680"><a href="#cb37-680" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> idx, row <span class="kw">in</span> match_conv.iterrows():</span>
<span id="cb37-681"><a href="#cb37-681" aria-hidden="true" tabindex="-1"></a>            label <span class="op">=</span> <span class="st">"Matched"</span> <span class="cf">if</span> idx <span class="op">==</span> <span class="dv">1</span> <span class="cf">else</span> <span class="st">"Not Matched"</span></span>
<span id="cb37-682"><a href="#cb37-682" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"    </span><span class="sc">{</span>label<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>row[<span class="st">'mean'</span>]<span class="sc">:.1%}</span><span class="ss"> (n=</span><span class="sc">{</span>row[<span class="st">'count'</span>]<span class="sc">:,}</span><span class="ss">)"</span>)</span>
<span id="cb37-683"><a href="#cb37-683" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb37-684"><a href="#cb37-684" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'role_product_match'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb37-685"><a href="#cb37-685" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"  [WARNING] Title/Product columns not found. Defaulting to 0."</span>)</span>
<span id="cb37-686"><a href="#cb37-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-687"><a href="#cb37-687" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb37-688"><a href="#cb37-688" aria-hidden="true" tabindex="-1"></a>    <span class="co"># TITAN FEATURE 6: TITLE BIGRAMS</span></span>
<span id="cb37-689"><a href="#cb37-689" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb37-690"><a href="#cb37-690" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">[6/6] Engineering: title_bigrams"</span>)</span>
<span id="cb37-691"><a href="#cb37-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-692"><a href="#cb37-692" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> title_col <span class="kw">and</span> title_col <span class="kw">in</span> df.columns:</span>
<span id="cb37-693"><a href="#cb37-693" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> bigram <span class="kw">in</span> HIGH_VALUE_BIGRAMS:</span>
<span id="cb37-694"><a href="#cb37-694" aria-hidden="true" tabindex="-1"></a>            col_name <span class="op">=</span> <span class="st">'has_'</span> <span class="op">+</span> bigram.replace(<span class="st">' '</span>, <span class="st">'_'</span>)</span>
<span id="cb37-695"><a href="#cb37-695" aria-hidden="true" tabindex="-1"></a>            df[col_name] <span class="op">=</span> df[title_col].<span class="bu">str</span>.lower().<span class="bu">str</span>.contains(bigram, na<span class="op">=</span><span class="va">False</span>).astype(<span class="bu">int</span>)</span>
<span id="cb37-696"><a href="#cb37-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-697"><a href="#cb37-697" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Summary count</span></span>
<span id="cb37-698"><a href="#cb37-698" aria-hidden="true" tabindex="-1"></a>        bigram_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> df.columns <span class="cf">if</span> c.startswith(<span class="st">'has_'</span>)]</span>
<span id="cb37-699"><a href="#cb37-699" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'title_bigram_count'</span>] <span class="op">=</span> df[bigram_cols].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb37-700"><a href="#cb37-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-701"><a href="#cb37-701" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Created </span><span class="sc">{</span><span class="bu">len</span>(bigram_cols)<span class="sc">}</span><span class="ss"> bigram flags"</span>)</span>
<span id="cb37-702"><a href="#cb37-702" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Leads with 1+ bigram: </span><span class="sc">{</span>(df[<span class="st">'title_bigram_count'</span>] <span class="op">&gt;</span> <span class="dv">0</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb37-703"><a href="#cb37-703" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb37-704"><a href="#cb37-704" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'title_bigram_count'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb37-705"><a href="#cb37-705" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"  [WARNING] Title column not found. Skipping bigrams."</span>)</span>
<span id="cb37-706"><a href="#cb37-706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-707"><a href="#cb37-707" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb37-708"><a href="#cb37-708" aria-hidden="true" tabindex="-1"></a>    <span class="co"># RETAINED V6 FEATURES</span></span>
<span id="cb37-709"><a href="#cb37-709" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb37-710"><a href="#cb37-710" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb37-711"><a href="#cb37-711" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"RETAINING V6 FEATURES"</span>)</span>
<span id="cb37-712"><a href="#cb37-712" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb37-713"><a href="#cb37-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-714"><a href="#cb37-714" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Product segmentation</span></span>
<span id="cb37-715"><a href="#cb37-715" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'product_segment'</span> <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb37-716"><a href="#cb37-716" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> segment_product(sol):</span>
<span id="cb37-717"><a href="#cb37-717" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">str</span>(sol) <span class="op">==</span> <span class="st">'Mx'</span>: <span class="cf">return</span> <span class="st">'Mx'</span></span>
<span id="cb37-718"><a href="#cb37-718" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> <span class="bu">str</span>(sol) <span class="op">==</span> <span class="st">'Qx'</span>: <span class="cf">return</span> <span class="st">'Qx'</span></span>
<span id="cb37-719"><a href="#cb37-719" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">'Other'</span></span>
<span id="cb37-720"><a href="#cb37-720" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'product_segment'</span>] <span class="op">=</span> df[<span class="st">'solution_rollup'</span>].<span class="bu">apply</span>(segment_product)</span>
<span id="cb37-721"><a href="#cb37-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-722"><a href="#cb37-722" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Title parsing (Seniority, Function, Scope)</span></span>
<span id="cb37-723"><a href="#cb37-723" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'title_seniority'</span> <span class="kw">not</span> <span class="kw">in</span> df.columns <span class="kw">and</span> title_col <span class="kw">and</span> title_col <span class="kw">in</span> df.columns:</span>
<span id="cb37-724"><a href="#cb37-724" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> parse_seniority(t):</span>
<span id="cb37-725"><a href="#cb37-725" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pd.isna(t): <span class="cf">return</span> <span class="st">'Unknown'</span></span>
<span id="cb37-726"><a href="#cb37-726" aria-hidden="true" tabindex="-1"></a>            t <span class="op">=</span> <span class="bu">str</span>(t).lower()</span>
<span id="cb37-727"><a href="#cb37-727" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> re.search(<span class="vs">r'</span><span class="dv">\b</span><span class="kw">(</span><span class="vs">ceo</span><span class="cf">|</span><span class="vs">cfo</span><span class="cf">|</span><span class="vs">coo</span><span class="cf">|</span><span class="vs">cto</span><span class="cf">|</span><span class="vs">cio</span><span class="cf">|</span><span class="vs">chief</span><span class="cf">|</span><span class="vs">c-level</span><span class="cf">|</span><span class="vs">president</span><span class="kw">)</span><span class="dv">\b</span><span class="vs">'</span>, t): <span class="cf">return</span> <span class="st">'C-Suite'</span></span>
<span id="cb37-728"><a href="#cb37-728" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> re.search(<span class="vs">r'</span><span class="dv">\b</span><span class="kw">(</span><span class="vs">svp</span><span class="cf">|</span><span class="vs">senior vice president</span><span class="cf">|</span><span class="vs">evp</span><span class="kw">)</span><span class="dv">\b</span><span class="vs">'</span>, t): <span class="cf">return</span> <span class="st">'SVP'</span></span>
<span id="cb37-729"><a href="#cb37-729" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> re.search(<span class="vs">r'</span><span class="dv">\b</span><span class="kw">(</span><span class="vs">vp</span><span class="cf">|</span><span class="vs">vice president</span><span class="kw">)</span><span class="dv">\b</span><span class="vs">'</span>, t): <span class="cf">return</span> <span class="st">'VP'</span></span>
<span id="cb37-730"><a href="#cb37-730" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> re.search(<span class="vs">r'</span><span class="dv">\b</span><span class="kw">(</span><span class="vs">director</span><span class="cf">|</span><span class="vs">head of</span><span class="kw">)</span><span class="dv">\b</span><span class="vs">'</span>, t): <span class="cf">return</span> <span class="st">'Director'</span></span>
<span id="cb37-731"><a href="#cb37-731" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> re.search(<span class="vs">r'</span><span class="dv">\b</span><span class="kw">(</span><span class="vs">manager</span><span class="cf">|</span><span class="vs">mgr</span><span class="cf">|</span><span class="vs">supervisor</span><span class="cf">|</span><span class="vs">lead</span><span class="kw">)</span><span class="dv">\b</span><span class="vs">'</span>, t): <span class="cf">return</span> <span class="st">'Manager'</span></span>
<span id="cb37-732"><a href="#cb37-732" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> re.search(<span class="vs">r'</span><span class="dv">\b</span><span class="kw">(</span><span class="vs">analyst</span><span class="cf">|</span><span class="vs">engineer</span><span class="cf">|</span><span class="vs">specialist</span><span class="cf">|</span><span class="vs">associate</span><span class="cf">|</span><span class="vs">coordinator</span><span class="kw">)</span><span class="dv">\b</span><span class="vs">'</span>, t): <span class="cf">return</span> <span class="st">'IC'</span></span>
<span id="cb37-733"><a href="#cb37-733" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">'Other'</span></span>
<span id="cb37-734"><a href="#cb37-734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-735"><a href="#cb37-735" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> parse_function(t):</span>
<span id="cb37-736"><a href="#cb37-736" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pd.isna(t): <span class="cf">return</span> <span class="st">'Unknown'</span></span>
<span id="cb37-737"><a href="#cb37-737" aria-hidden="true" tabindex="-1"></a>            t <span class="op">=</span> <span class="bu">str</span>(t).lower()</span>
<span id="cb37-738"><a href="#cb37-738" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> re.search(<span class="vs">r'</span><span class="dv">\b</span><span class="kw">(</span><span class="vs">quality</span><span class="cf">|</span><span class="vs">qa</span><span class="cf">|</span><span class="vs">qc</span><span class="cf">|</span><span class="vs">qms</span><span class="cf">|</span><span class="vs">compliance</span><span class="cf">|</span><span class="vs">validation</span><span class="cf">|</span><span class="vs">capa</span><span class="kw">)</span><span class="dv">\b</span><span class="vs">'</span>, t): <span class="cf">return</span> <span class="st">'Quality'</span></span>
<span id="cb37-739"><a href="#cb37-739" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> re.search(<span class="vs">r'</span><span class="dv">\b</span><span class="kw">(</span><span class="vs">regulatory</span><span class="cf">|</span><span class="vs">reg affairs</span><span class="cf">|</span><span class="vs">submissions</span><span class="kw">)</span><span class="dv">\b</span><span class="vs">'</span>, t): <span class="cf">return</span> <span class="st">'Regulatory'</span></span>
<span id="cb37-740"><a href="#cb37-740" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> re.search(<span class="vs">r'</span><span class="dv">\b</span><span class="kw">(</span><span class="vs">manufacturing</span><span class="cf">|</span><span class="vs">production</span><span class="cf">|</span><span class="vs">operations</span><span class="cf">|</span><span class="vs">ops</span><span class="cf">|</span><span class="vs">plant</span><span class="cf">|</span><span class="vs">supply</span><span class="kw">)</span><span class="dv">\b</span><span class="vs">'</span>, t): <span class="cf">return</span> <span class="st">'Mfg/Ops'</span></span>
<span id="cb37-741"><a href="#cb37-741" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> re.search(<span class="vs">r'</span><span class="dv">\b</span><span class="kw">(</span><span class="vs">it</span><span class="cf">|</span><span class="vs">information tech</span><span class="cf">|</span><span class="vs">software</span><span class="cf">|</span><span class="vs">systems</span><span class="cf">|</span><span class="vs">data</span><span class="kw">)</span><span class="dv">\b</span><span class="vs">'</span>, t): <span class="cf">return</span> <span class="st">'IT'</span></span>
<span id="cb37-742"><a href="#cb37-742" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> re.search(<span class="vs">r'</span><span class="dv">\b</span><span class="kw">(</span><span class="vs">r&amp;d</span><span class="cf">|</span><span class="vs">research</span><span class="cf">|</span><span class="vs">development</span><span class="cf">|</span><span class="vs">scientist</span><span class="cf">|</span><span class="vs">clinical</span><span class="cf">|</span><span class="vs">lab</span><span class="kw">)</span><span class="dv">\b</span><span class="vs">'</span>, t): <span class="cf">return</span> <span class="st">'R&amp;D'</span></span>
<span id="cb37-743"><a href="#cb37-743" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> re.search(<span class="vs">r'</span><span class="dv">\b</span><span class="kw">(</span><span class="vs">project</span><span class="cf">|</span><span class="vs">program</span><span class="cf">|</span><span class="vs">pmo</span><span class="kw">)</span><span class="dv">\b</span><span class="vs">'</span>, t): <span class="cf">return</span> <span class="st">'PMO'</span></span>
<span id="cb37-744"><a href="#cb37-744" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">'Other'</span></span>
<span id="cb37-745"><a href="#cb37-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-746"><a href="#cb37-746" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> parse_scope(t):</span>
<span id="cb37-747"><a href="#cb37-747" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pd.isna(t): <span class="cf">return</span> <span class="st">'Standard'</span></span>
<span id="cb37-748"><a href="#cb37-748" aria-hidden="true" tabindex="-1"></a>            t <span class="op">=</span> <span class="bu">str</span>(t).lower()</span>
<span id="cb37-749"><a href="#cb37-749" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> re.search(<span class="vs">r'</span><span class="dv">\b</span><span class="kw">(</span><span class="vs">global</span><span class="cf">|</span><span class="vs">worldwide</span><span class="cf">|</span><span class="vs">international</span><span class="cf">|</span><span class="vs">corporate</span><span class="cf">|</span><span class="vs">enterprise</span><span class="kw">)</span><span class="dv">\b</span><span class="vs">'</span>, t): <span class="cf">return</span> <span class="st">'Global'</span></span>
<span id="cb37-750"><a href="#cb37-750" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> re.search(<span class="vs">r'</span><span class="dv">\b</span><span class="kw">(</span><span class="vs">regional</span><span class="cf">|</span><span class="vs">division</span><span class="cf">|</span><span class="vs">group</span><span class="kw">)</span><span class="dv">\b</span><span class="vs">'</span>, t): <span class="cf">return</span> <span class="st">'Regional'</span></span>
<span id="cb37-751"><a href="#cb37-751" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> re.search(<span class="vs">r'</span><span class="dv">\b</span><span class="kw">(</span><span class="vs">site</span><span class="cf">|</span><span class="vs">plant</span><span class="cf">|</span><span class="vs">facility</span><span class="cf">|</span><span class="vs">local</span><span class="kw">)</span><span class="dv">\b</span><span class="vs">'</span>, t): <span class="cf">return</span> <span class="st">'Site'</span></span>
<span id="cb37-752"><a href="#cb37-752" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">'Standard'</span></span>
<span id="cb37-753"><a href="#cb37-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-754"><a href="#cb37-754" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'title_seniority'</span>] <span class="op">=</span> df[title_col].<span class="bu">apply</span>(parse_seniority)</span>
<span id="cb37-755"><a href="#cb37-755" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'title_function'</span>] <span class="op">=</span> df[title_col].<span class="bu">apply</span>(parse_function)</span>
<span id="cb37-756"><a href="#cb37-756" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'title_scope'</span>] <span class="op">=</span> df[title_col].<span class="bu">apply</span>(parse_scope)</span>
<span id="cb37-757"><a href="#cb37-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-758"><a href="#cb37-758" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Decision maker flag</span></span>
<span id="cb37-759"><a href="#cb37-759" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'is_decision_maker'</span> <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb37-760"><a href="#cb37-760" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'is_decision_maker'</span>] <span class="op">=</span> df[<span class="st">'title_seniority'</span>].isin([<span class="st">'C-Suite'</span>, <span class="st">'SVP'</span>, <span class="st">'VP'</span>, <span class="st">'Director'</span>]).astype(<span class="bu">int</span>)</span>
<span id="cb37-761"><a href="#cb37-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-762"><a href="#cb37-762" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Temporal features</span></span>
<span id="cb37-763"><a href="#cb37-763" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'cohort_date'</span> <span class="kw">in</span> df.columns <span class="kw">or</span> <span class="st">'qal_cohort_date'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb37-764"><a href="#cb37-764" aria-hidden="true" tabindex="-1"></a>        cohort_col <span class="op">=</span> <span class="st">'qal_cohort_date'</span> <span class="cf">if</span> <span class="st">'qal_cohort_date'</span> <span class="kw">in</span> df.columns <span class="cf">else</span> <span class="st">'cohort_date'</span></span>
<span id="cb37-765"><a href="#cb37-765" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'cohort_date'</span>] <span class="op">=</span> pd.to_datetime(df[cohort_col], errors<span class="op">=</span><span class="st">'coerce'</span>)</span>
<span id="cb37-766"><a href="#cb37-766" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'lead_age_days'</span> <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb37-767"><a href="#cb37-767" aria-hidden="true" tabindex="-1"></a>            snapshot_date <span class="op">=</span> df[<span class="st">'cohort_date'</span>].<span class="bu">max</span>()</span>
<span id="cb37-768"><a href="#cb37-768" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">'lead_age_days'</span>] <span class="op">=</span> (snapshot_date <span class="op">-</span> df[<span class="st">'cohort_date'</span>]).dt.days</span>
<span id="cb37-769"><a href="#cb37-769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-770"><a href="#cb37-770" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Velocity tiers</span></span>
<span id="cb37-771"><a href="#cb37-771" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'lead_age_days'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb37-772"><a href="#cb37-772" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'velocity_tier'</span>] <span class="op">=</span> pd.cut(</span>
<span id="cb37-773"><a href="#cb37-773" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">'lead_age_days'</span>].fillna(<span class="dv">0</span>),</span>
<span id="cb37-774"><a href="#cb37-774" aria-hidden="true" tabindex="-1"></a>            bins<span class="op">=</span>[<span class="op">-</span><span class="dv">1</span>, <span class="dv">30</span>, <span class="dv">60</span>, <span class="dv">90</span>, <span class="dv">180</span>, <span class="dv">9999</span>],</span>
<span id="cb37-775"><a href="#cb37-775" aria-hidden="true" tabindex="-1"></a>            labels<span class="op">=</span>[<span class="st">'Hot'</span>, <span class="st">'Warm'</span>, <span class="st">'Cooling'</span>, <span class="st">'Cold'</span>, <span class="st">'Stale'</span>]</span>
<span id="cb37-776"><a href="#cb37-776" aria-hidden="true" tabindex="-1"></a>        ).astype(<span class="bu">str</span>)</span>
<span id="cb37-777"><a href="#cb37-777" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'is_fresh'</span>] <span class="op">=</span> (df[<span class="st">'lead_age_days'</span>] <span class="op">&lt;=</span> <span class="dv">30</span>).astype(<span class="bu">int</span>)</span>
<span id="cb37-778"><a href="#cb37-778" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'is_stale'</span>] <span class="op">=</span> (df[<span class="st">'lead_age_days'</span>] <span class="op">&gt;</span> <span class="dv">180</span>).astype(<span class="bu">int</span>)</span>
<span id="cb37-779"><a href="#cb37-779" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-780"><a href="#cb37-780" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Power Trio interactions (V6)</span></span>
<span id="cb37-781"><a href="#cb37-781" aria-hidden="true" tabindex="-1"></a>    seniority_col <span class="op">=</span> <span class="st">'title_seniority'</span> <span class="cf">if</span> <span class="st">'title_seniority'</span> <span class="kw">in</span> df.columns <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb37-782"><a href="#cb37-782" aria-hidden="true" tabindex="-1"></a>    industry_col <span class="op">=</span> <span class="st">'acct_target_industry'</span> <span class="cf">if</span> <span class="st">'acct_target_industry'</span> <span class="kw">in</span> df.columns <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb37-783"><a href="#cb37-783" aria-hidden="true" tabindex="-1"></a>    model_col <span class="op">=</span> <span class="st">'acct_manufacturing_model'</span> <span class="cf">if</span> <span class="st">'acct_manufacturing_model'</span> <span class="kw">in</span> df.columns <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb37-784"><a href="#cb37-784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-785"><a href="#cb37-785" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> seniority_col <span class="kw">and</span> industry_col <span class="kw">and</span> model_col:</span>
<span id="cb37-786"><a href="#cb37-786" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'seniority_x_industry'</span>] <span class="op">=</span> df[seniority_col].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> df[industry_col].astype(<span class="bu">str</span>)</span>
<span id="cb37-787"><a href="#cb37-787" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'seniority_x_model'</span>] <span class="op">=</span> df[seniority_col].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> df[model_col].astype(<span class="bu">str</span>)</span>
<span id="cb37-788"><a href="#cb37-788" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'industry_x_model'</span>] <span class="op">=</span> df[industry_col].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span> df[model_col].astype(<span class="bu">str</span>)</span>
<span id="cb37-789"><a href="#cb37-789" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'power_trio'</span>] <span class="op">=</span> (df[seniority_col].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span></span>
<span id="cb37-790"><a href="#cb37-790" aria-hidden="true" tabindex="-1"></a>                           df[industry_col].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">'_'</span> <span class="op">+</span></span>
<span id="cb37-791"><a href="#cb37-791" aria-hidden="true" tabindex="-1"></a>                           df[model_col].astype(<span class="bu">str</span>))</span>
<span id="cb37-792"><a href="#cb37-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-793"><a href="#cb37-793" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Golden Segment (V6)</span></span>
<span id="cb37-794"><a href="#cb37-794" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> seniority_col <span class="kw">and</span> industry_col <span class="kw">and</span> model_col:</span>
<span id="cb37-795"><a href="#cb37-795" aria-hidden="true" tabindex="-1"></a>        senior_mask <span class="op">=</span> df[seniority_col].isin([<span class="st">'Director'</span>, <span class="st">'VP'</span>, <span class="st">'SVP'</span>, <span class="st">'C-Suite'</span>])</span>
<span id="cb37-796"><a href="#cb37-796" aria-hidden="true" tabindex="-1"></a>        pharma_mask <span class="op">=</span> df[industry_col].<span class="bu">str</span>.contains(<span class="st">'Pharma|Life|Bio'</span>, case<span class="op">=</span><span class="va">False</span>, na<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb37-797"><a href="#cb37-797" aria-hidden="true" tabindex="-1"></a>        inhouse_mask <span class="op">=</span> df[model_col].<span class="bu">str</span>.contains(<span class="st">'In-House|In House|Inhouse'</span>, case<span class="op">=</span><span class="va">False</span>, na<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb37-798"><a href="#cb37-798" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'is_golden_segment'</span>] <span class="op">=</span> (senior_mask <span class="op">&amp;</span> pharma_mask <span class="op">&amp;</span> inhouse_mask).astype(<span class="bu">int</span>)</span>
<span id="cb37-799"><a href="#cb37-799" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'is_senior_pharma'</span>] <span class="op">=</span> (senior_mask <span class="op">&amp;</span> pharma_mask).astype(<span class="bu">int</span>)</span>
<span id="cb37-800"><a href="#cb37-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-801"><a href="#cb37-801" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Global scope indicator</span></span>
<span id="cb37-802"><a href="#cb37-802" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'title_scope'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb37-803"><a href="#cb37-803" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'is_global_scope'</span>] <span class="op">=</span> (df[<span class="st">'title_scope'</span>] <span class="op">==</span> <span class="st">'Global'</span>).astype(<span class="bu">int</span>)</span>
<span id="cb37-804"><a href="#cb37-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-805"><a href="#cb37-805" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fill missing categoricals</span></span>
<span id="cb37-806"><a href="#cb37-806" aria-hidden="true" tabindex="-1"></a>    categorical_cols <span class="op">=</span> [<span class="st">'acct_manufacturing_model'</span>, <span class="st">'acct_primary_site_function'</span>,</span>
<span id="cb37-807"><a href="#cb37-807" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'acct_target_industry'</span>, <span class="st">'acct_territory_rollup'</span>,</span>
<span id="cb37-808"><a href="#cb37-808" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'title_seniority'</span>, <span class="st">'title_function'</span>, <span class="st">'title_scope'</span>,</span>
<span id="cb37-809"><a href="#cb37-809" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'channel_tier'</span>]</span>
<span id="cb37-810"><a href="#cb37-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-811"><a href="#cb37-811" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> categorical_cols:</span>
<span id="cb37-812"><a href="#cb37-812" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> col <span class="kw">in</span> df.columns:</span>
<span id="cb37-813"><a href="#cb37-813" aria-hidden="true" tabindex="-1"></a>            df[col] <span class="op">=</span> df[col].fillna(<span class="st">'Unknown'</span>)</span>
<span id="cb37-814"><a href="#cb37-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-815"><a href="#cb37-815" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb37-816"><a href="#cb37-816" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SUMMARY</span></span>
<span id="cb37-817"><a href="#cb37-817" aria-hidden="true" tabindex="-1"></a>    <span class="co"># =========================================================================</span></span>
<span id="cb37-818"><a href="#cb37-818" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-819"><a href="#cb37-819" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"V7 TITAN FEATURE ENGINEERING COMPLETE"</span>)</span>
<span id="cb37-820"><a href="#cb37-820" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-821"><a href="#cb37-821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-822"><a href="#cb37-822" aria-hidden="true" tabindex="-1"></a>    titan_features <span class="op">=</span> [<span class="st">'intent_strength'</span>, <span class="st">'channel_efficiency'</span>, <span class="st">'is_hidden_gem'</span>,</span>
<span id="cb37-823"><a href="#cb37-823" aria-hidden="true" tabindex="-1"></a>                      <span class="st">'capital_density_score'</span>, <span class="st">'capital_density_log'</span>,</span>
<span id="cb37-824"><a href="#cb37-824" aria-hidden="true" tabindex="-1"></a>                      <span class="st">'role_product_match'</span>, <span class="st">'title_bigram_count'</span>]</span>
<span id="cb37-825"><a href="#cb37-825" aria-hidden="true" tabindex="-1"></a>    titan_features <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> titan_features <span class="cf">if</span> f <span class="kw">in</span> df.columns]</span>
<span id="cb37-826"><a href="#cb37-826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-827"><a href="#cb37-827" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"New Titan Features: </span><span class="sc">{</span>titan_features<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-828"><a href="#cb37-828" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Total columns: </span><span class="sc">{</span><span class="bu">len</span>(df.columns)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-829"><a href="#cb37-829" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-830"><a href="#cb37-830" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb37-831"><a href="#cb37-831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-832"><a href="#cb37-832" aria-hidden="true" tabindex="-1"></a><span class="co"># Execute pipeline</span></span>
<span id="cb37-833"><a href="#cb37-833" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> clean_and_engineer_titan(DATA_PATH)</span>
<span id="cb37-834"><a href="#cb37-834" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-835"><a href="#cb37-835" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-836"><a href="#cb37-836" aria-hidden="true" tabindex="-1"></a><span class="fu">## 2.3 Titan Feature Correlation Analysis</span></span>
<span id="cb37-837"><a href="#cb37-837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-840"><a href="#cb37-840" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-841"><a href="#cb37-841" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: titan-correlation</span></span>
<span id="cb37-842"><a href="#cb37-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-843"><a href="#cb37-843" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-844"><a href="#cb37-844" aria-hidden="true" tabindex="-1"></a><span class="co"># TITAN FEATURE CORRELATION WITH TARGET</span></span>
<span id="cb37-845"><a href="#cb37-845" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-846"><a href="#cb37-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-847"><a href="#cb37-847" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-848"><a href="#cb37-848" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"TITAN FEATURE CORRELATION ANALYSIS"</span>)</span>
<span id="cb37-849"><a href="#cb37-849" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-850"><a href="#cb37-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-851"><a href="#cb37-851" aria-hidden="true" tabindex="-1"></a><span class="co"># Select Titan features for correlation</span></span>
<span id="cb37-852"><a href="#cb37-852" aria-hidden="true" tabindex="-1"></a>titan_numeric_features <span class="op">=</span> [</span>
<span id="cb37-853"><a href="#cb37-853" aria-hidden="true" tabindex="-1"></a>    <span class="st">'intent_strength'</span>, <span class="st">'channel_efficiency'</span>, <span class="st">'is_hidden_gem'</span>,</span>
<span id="cb37-854"><a href="#cb37-854" aria-hidden="true" tabindex="-1"></a>    <span class="st">'capital_density_log'</span>, <span class="st">'role_product_match'</span>, <span class="st">'title_bigram_count'</span>,</span>
<span id="cb37-855"><a href="#cb37-855" aria-hidden="true" tabindex="-1"></a>    <span class="st">'is_golden_segment'</span>, <span class="st">'is_decision_maker'</span>, <span class="st">'is_fresh'</span>, <span class="st">'is_stale'</span>,</span>
<span id="cb37-856"><a href="#cb37-856" aria-hidden="true" tabindex="-1"></a>    <span class="st">'is_global_scope'</span>, <span class="st">'lead_age_days'</span></span>
<span id="cb37-857"><a href="#cb37-857" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb37-858"><a href="#cb37-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-859"><a href="#cb37-859" aria-hidden="true" tabindex="-1"></a>titan_numeric_features <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> titan_numeric_features <span class="cf">if</span> f <span class="kw">in</span> df.columns]</span>
<span id="cb37-860"><a href="#cb37-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-861"><a href="#cb37-861" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate correlations with target</span></span>
<span id="cb37-862"><a href="#cb37-862" aria-hidden="true" tabindex="-1"></a>correlations <span class="op">=</span> df[titan_numeric_features <span class="op">+</span> [<span class="st">'is_success'</span>]].corr()[<span class="st">'is_success'</span>].drop(<span class="st">'is_success'</span>)</span>
<span id="cb37-863"><a href="#cb37-863" aria-hidden="true" tabindex="-1"></a>correlations <span class="op">=</span> correlations.sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb37-864"><a href="#cb37-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-865"><a href="#cb37-865" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Feature Correlations with is_success:"</span>)</span>
<span id="cb37-866"><a href="#cb37-866" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">40</span>)</span>
<span id="cb37-867"><a href="#cb37-867" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> feat, corr <span class="kw">in</span> correlations.items():</span>
<span id="cb37-868"><a href="#cb37-868" aria-hidden="true" tabindex="-1"></a>    direction <span class="op">=</span> <span class="st">"+"</span> <span class="cf">if</span> corr <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">"-"</span></span>
<span id="cb37-869"><a href="#cb37-869" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>feat<span class="sc">:30s}</span><span class="ss">: </span><span class="sc">{</span>direction<span class="sc">}{</span><span class="bu">abs</span>(corr)<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb37-870"><a href="#cb37-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-871"><a href="#cb37-871" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualization</span></span>
<span id="cb37-872"><a href="#cb37-872" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb37-873"><a href="#cb37-873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-874"><a href="#cb37-874" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 1: Correlation Bar Chart</span></span>
<span id="cb37-875"><a href="#cb37-875" aria-hidden="true" tabindex="-1"></a>ax1 <span class="op">=</span> axes[<span class="dv">0</span>]</span>
<span id="cb37-876"><a href="#cb37-876" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [PROJECT_COLS[<span class="st">'Success'</span>] <span class="cf">if</span> c <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> PROJECT_COLS[<span class="st">'Failure'</span>] <span class="cf">for</span> c <span class="kw">in</span> correlations.values]</span>
<span id="cb37-877"><a href="#cb37-877" aria-hidden="true" tabindex="-1"></a>correlations.plot(kind<span class="op">=</span><span class="st">'barh'</span>, ax<span class="op">=</span>ax1, color<span class="op">=</span>colors)</span>
<span id="cb37-878"><a href="#cb37-878" aria-hidden="true" tabindex="-1"></a>ax1.axvline(x<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb37-879"><a href="#cb37-879" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">'Correlation with is_success'</span>)</span>
<span id="cb37-880"><a href="#cb37-880" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="st">'Titan Feature Correlations'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-881"><a href="#cb37-881" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-882"><a href="#cb37-882" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 2: Channel Tier Conversion Comparison</span></span>
<span id="cb37-883"><a href="#cb37-883" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> axes[<span class="dv">1</span>]</span>
<span id="cb37-884"><a href="#cb37-884" aria-hidden="true" tabindex="-1"></a>channel_conv <span class="op">=</span> df.groupby(<span class="st">'channel_tier'</span>)[<span class="st">'is_success'</span>].mean().reindex([<span class="st">'Premium'</span>, <span class="st">'Standard'</span>, <span class="st">'Toxic'</span>])</span>
<span id="cb37-885"><a href="#cb37-885" aria-hidden="true" tabindex="-1"></a>tier_colors <span class="op">=</span> [PROJECT_COLS[<span class="st">'Premium'</span>], PROJECT_COLS[<span class="st">'Neutral'</span>], PROJECT_COLS[<span class="st">'Toxic'</span>]]</span>
<span id="cb37-886"><a href="#cb37-886" aria-hidden="true" tabindex="-1"></a>channel_conv.plot(kind<span class="op">=</span><span class="st">'bar'</span>, ax<span class="op">=</span>ax2, color<span class="op">=</span>tier_colors, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb37-887"><a href="#cb37-887" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">'Conversion Rate'</span>)</span>
<span id="cb37-888"><a href="#cb37-888" aria-hidden="true" tabindex="-1"></a>ax2.set_xlabel(<span class="st">'Channel Tier'</span>)</span>
<span id="cb37-889"><a href="#cb37-889" aria-hidden="true" tabindex="-1"></a>ax2.set_title(<span class="st">'Conversion by Channel Tier'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-890"><a href="#cb37-890" aria-hidden="true" tabindex="-1"></a>ax2.set_xticklabels(ax2.get_xticklabels(), rotation<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb37-891"><a href="#cb37-891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-892"><a href="#cb37-892" aria-hidden="true" tabindex="-1"></a><span class="co"># Add value labels</span></span>
<span id="cb37-893"><a href="#cb37-893" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, v <span class="kw">in</span> <span class="bu">enumerate</span>(channel_conv):</span>
<span id="cb37-894"><a href="#cb37-894" aria-hidden="true" tabindex="-1"></a>    ax2.text(i, v <span class="op">+</span> <span class="fl">0.005</span>, <span class="ss">f'</span><span class="sc">{</span>v<span class="sc">:.1%}</span><span class="ss">'</span>, ha<span class="op">=</span><span class="st">'center'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-895"><a href="#cb37-895" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-896"><a href="#cb37-896" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb37-897"><a href="#cb37-897" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb37-898"><a href="#cb37-898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-899"><a href="#cb37-899" aria-hidden="true" tabindex="-1"></a><span class="co"># Print key insights</span></span>
<span id="cb37-900"><a href="#cb37-900" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-901"><a href="#cb37-901" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"KEY TITAN INSIGHTS"</span>)</span>
<span id="cb37-902"><a href="#cb37-902" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-903"><a href="#cb37-903" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-904"><a href="#cb37-904" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'channel_tier'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb37-905"><a href="#cb37-905" aria-hidden="true" tabindex="-1"></a>    premium_rate <span class="op">=</span> df[df[<span class="st">'channel_tier'</span>] <span class="op">==</span> <span class="st">'Premium'</span>][<span class="st">'is_success'</span>].mean()</span>
<span id="cb37-906"><a href="#cb37-906" aria-hidden="true" tabindex="-1"></a>    toxic_rate <span class="op">=</span> df[df[<span class="st">'channel_tier'</span>] <span class="op">==</span> <span class="st">'Toxic'</span>][<span class="st">'is_success'</span>].mean()</span>
<span id="cb37-907"><a href="#cb37-907" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Premium Channel Conversion: </span><span class="sc">{</span>premium_rate<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb37-908"><a href="#cb37-908" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Toxic Channel Conversion: </span><span class="sc">{</span>toxic_rate<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb37-909"><a href="#cb37-909" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Lift from Premium vs Toxic: </span><span class="sc">{</span>premium_rate<span class="op">/</span>toxic_rate<span class="sc">:.1f}</span><span class="ss">x"</span>)</span>
<span id="cb37-910"><a href="#cb37-910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-911"><a href="#cb37-911" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'is_hidden_gem'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb37-912"><a href="#cb37-912" aria-hidden="true" tabindex="-1"></a>    gem_rate <span class="op">=</span> df[df[<span class="st">'is_hidden_gem'</span>] <span class="op">==</span> <span class="dv">1</span>][<span class="st">'is_success'</span>].mean()</span>
<span id="cb37-913"><a href="#cb37-913" aria-hidden="true" tabindex="-1"></a>    baseline_rate <span class="op">=</span> df[<span class="st">'is_success'</span>].mean()</span>
<span id="cb37-914"><a href="#cb37-914" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Hidden Gem Conversion: </span><span class="sc">{</span>gem_rate<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb37-915"><a href="#cb37-915" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Baseline Conversion: </span><span class="sc">{</span>baseline_rate<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb37-916"><a href="#cb37-916" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Hidden Gem Lift: </span><span class="sc">{</span>gem_rate<span class="op">/</span>baseline_rate<span class="sc">:.1f}</span><span class="ss">x"</span>)</span>
<span id="cb37-917"><a href="#cb37-917" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-918"><a href="#cb37-918" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-919"><a href="#cb37-919" aria-hidden="true" tabindex="-1"></a><span class="fu">## 2.4 Feature Matrix Preparation</span></span>
<span id="cb37-920"><a href="#cb37-920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-923"><a href="#cb37-923" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-924"><a href="#cb37-924" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: feature-matrix</span></span>
<span id="cb37-925"><a href="#cb37-925" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-926"><a href="#cb37-926" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-927"><a href="#cb37-927" aria-hidden="true" tabindex="-1"></a><span class="co"># FEATURE MATRIX CONSTRUCTION</span></span>
<span id="cb37-928"><a href="#cb37-928" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-929"><a href="#cb37-929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-930"><a href="#cb37-930" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_feature_matrix(df):</span>
<span id="cb37-931"><a href="#cb37-931" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Prepare the feature matrix for modeling with Titan features."""</span></span>
<span id="cb37-932"><a href="#cb37-932" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-933"><a href="#cb37-933" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-934"><a href="#cb37-934" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"FEATURE MATRIX PREPARATION"</span>)</span>
<span id="cb37-935"><a href="#cb37-935" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-936"><a href="#cb37-936" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-937"><a href="#cb37-937" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> df[<span class="st">'is_success'</span>].values</span>
<span id="cb37-938"><a href="#cb37-938" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-939"><a href="#cb37-939" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Categorical features</span></span>
<span id="cb37-940"><a href="#cb37-940" aria-hidden="true" tabindex="-1"></a>    categorical_features <span class="op">=</span> [</span>
<span id="cb37-941"><a href="#cb37-941" aria-hidden="true" tabindex="-1"></a>        <span class="st">'title_seniority'</span>, <span class="st">'title_function'</span>, <span class="st">'title_scope'</span>,</span>
<span id="cb37-942"><a href="#cb37-942" aria-hidden="true" tabindex="-1"></a>        <span class="st">'acct_target_industry'</span>, <span class="st">'acct_manufacturing_model'</span>,</span>
<span id="cb37-943"><a href="#cb37-943" aria-hidden="true" tabindex="-1"></a>        <span class="st">'acct_primary_site_function'</span>, <span class="st">'acct_territory_rollup'</span>,</span>
<span id="cb37-944"><a href="#cb37-944" aria-hidden="true" tabindex="-1"></a>        <span class="st">'product_segment'</span>, <span class="st">'channel_tier'</span>  <span class="co"># V7: Added channel_tier</span></span>
<span id="cb37-945"><a href="#cb37-945" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb37-946"><a href="#cb37-946" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-947"><a href="#cb37-947" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Interaction features</span></span>
<span id="cb37-948"><a href="#cb37-948" aria-hidden="true" tabindex="-1"></a>    interaction_features <span class="op">=</span> [</span>
<span id="cb37-949"><a href="#cb37-949" aria-hidden="true" tabindex="-1"></a>        <span class="st">'seniority_x_industry'</span>, <span class="st">'seniority_x_model'</span>, <span class="st">'industry_x_model'</span>,</span>
<span id="cb37-950"><a href="#cb37-950" aria-hidden="true" tabindex="-1"></a>        <span class="st">'power_trio'</span></span>
<span id="cb37-951"><a href="#cb37-951" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb37-952"><a href="#cb37-952" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-953"><a href="#cb37-953" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Velocity categorical</span></span>
<span id="cb37-954"><a href="#cb37-954" aria-hidden="true" tabindex="-1"></a>    velocity_cats <span class="op">=</span> [<span class="st">'velocity_tier'</span>]</span>
<span id="cb37-955"><a href="#cb37-955" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-956"><a href="#cb37-956" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter to existing</span></span>
<span id="cb37-957"><a href="#cb37-957" aria-hidden="true" tabindex="-1"></a>    categorical_features <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> categorical_features <span class="cf">if</span> c <span class="kw">in</span> df.columns]</span>
<span id="cb37-958"><a href="#cb37-958" aria-hidden="true" tabindex="-1"></a>    interaction_features <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> interaction_features <span class="cf">if</span> c <span class="kw">in</span> df.columns]</span>
<span id="cb37-959"><a href="#cb37-959" aria-hidden="true" tabindex="-1"></a>    velocity_cats <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> velocity_cats <span class="cf">if</span> c <span class="kw">in</span> df.columns]</span>
<span id="cb37-960"><a href="#cb37-960" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-961"><a href="#cb37-961" aria-hidden="true" tabindex="-1"></a>    all_categoricals <span class="op">=</span> categorical_features <span class="op">+</span> interaction_features <span class="op">+</span> velocity_cats</span>
<span id="cb37-962"><a href="#cb37-962" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-963"><a href="#cb37-963" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Numeric features (including V7 Titan Features)</span></span>
<span id="cb37-964"><a href="#cb37-964" aria-hidden="true" tabindex="-1"></a>    numeric_features <span class="op">=</span> [</span>
<span id="cb37-965"><a href="#cb37-965" aria-hidden="true" tabindex="-1"></a>        <span class="st">'lead_age_days'</span>, <span class="st">'is_decision_maker'</span>, <span class="st">'is_fresh'</span>, <span class="st">'is_stale'</span>,</span>
<span id="cb37-966"><a href="#cb37-966" aria-hidden="true" tabindex="-1"></a>        <span class="co"># V6 Golden Features</span></span>
<span id="cb37-967"><a href="#cb37-967" aria-hidden="true" tabindex="-1"></a>        <span class="st">'is_golden_segment'</span>, <span class="st">'is_senior_pharma'</span>, <span class="st">'is_global_scope'</span>,</span>
<span id="cb37-968"><a href="#cb37-968" aria-hidden="true" tabindex="-1"></a>        <span class="co"># V7 TITAN Features</span></span>
<span id="cb37-969"><a href="#cb37-969" aria-hidden="true" tabindex="-1"></a>        <span class="st">'intent_strength'</span>, <span class="st">'channel_efficiency'</span>, <span class="st">'is_hidden_gem'</span>,</span>
<span id="cb37-970"><a href="#cb37-970" aria-hidden="true" tabindex="-1"></a>        <span class="st">'capital_density_log'</span>, <span class="st">'role_product_match'</span>, <span class="st">'title_bigram_count'</span></span>
<span id="cb37-971"><a href="#cb37-971" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb37-972"><a href="#cb37-972" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-973"><a href="#cb37-973" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add bigram flags</span></span>
<span id="cb37-974"><a href="#cb37-974" aria-hidden="true" tabindex="-1"></a>    bigram_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> df.columns <span class="cf">if</span> c.startswith(<span class="st">'has_'</span>)]</span>
<span id="cb37-975"><a href="#cb37-975" aria-hidden="true" tabindex="-1"></a>    numeric_features.extend(bigram_cols)</span>
<span id="cb37-976"><a href="#cb37-976" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-977"><a href="#cb37-977" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'record_completeness'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb37-978"><a href="#cb37-978" aria-hidden="true" tabindex="-1"></a>        numeric_features.append(<span class="st">'record_completeness'</span>)</span>
<span id="cb37-979"><a href="#cb37-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-980"><a href="#cb37-980" aria-hidden="true" tabindex="-1"></a>    numeric_features <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> numeric_features <span class="cf">if</span> c <span class="kw">in</span> df.columns]</span>
<span id="cb37-981"><a href="#cb37-981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-982"><a href="#cb37-982" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Text feature</span></span>
<span id="cb37-983"><a href="#cb37-983" aria-hidden="true" tabindex="-1"></a>    text_col <span class="op">=</span> <span class="st">'contact_lead_title'</span> <span class="cf">if</span> <span class="st">'contact_lead_title'</span> <span class="kw">in</span> df.columns <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb37-984"><a href="#cb37-984" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-985"><a href="#cb37-985" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build feature dataframe</span></span>
<span id="cb37-986"><a href="#cb37-986" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> df[all_categoricals <span class="op">+</span> numeric_features].copy()</span>
<span id="cb37-987"><a href="#cb37-987" aria-hidden="true" tabindex="-1"></a>    text_data <span class="op">=</span> df[text_col].fillna(<span class="st">''</span>) <span class="cf">if</span> text_col <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb37-988"><a href="#cb37-988" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-989"><a href="#cb37-989" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Categorical features: </span><span class="sc">{</span><span class="bu">len</span>(all_categoricals)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-990"><a href="#cb37-990" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Base: </span><span class="sc">{</span>categorical_features<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-991"><a href="#cb37-991" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Interactions: </span><span class="sc">{</span>interaction_features<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-992"><a href="#cb37-992" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Numeric features: </span><span class="sc">{</span><span class="bu">len</span>(numeric_features)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-993"><a href="#cb37-993" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-994"><a href="#cb37-994" aria-hidden="true" tabindex="-1"></a>    titan_nums <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> numeric_features <span class="cf">if</span> c <span class="kw">in</span></span>
<span id="cb37-995"><a href="#cb37-995" aria-hidden="true" tabindex="-1"></a>                  [<span class="st">'intent_strength'</span>, <span class="st">'channel_efficiency'</span>, <span class="st">'is_hidden_gem'</span>,</span>
<span id="cb37-996"><a href="#cb37-996" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'capital_density_log'</span>, <span class="st">'role_product_match'</span>, <span class="st">'title_bigram_count'</span>]]</span>
<span id="cb37-997"><a href="#cb37-997" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  V7 Titan: </span><span class="sc">{</span>titan_nums<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-998"><a href="#cb37-998" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-999"><a href="#cb37-999" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Text feature: </span><span class="sc">{</span>text_col<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-1000"><a href="#cb37-1000" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1001"><a href="#cb37-1001" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> X, y, text_data, all_categoricals, numeric_features</span>
<span id="cb37-1002"><a href="#cb37-1002" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1003"><a href="#cb37-1003" aria-hidden="true" tabindex="-1"></a>X, y, text_data, cat_cols, num_cols <span class="op">=</span> prepare_feature_matrix(df)</span>
<span id="cb37-1004"><a href="#cb37-1004" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-1005"><a href="#cb37-1005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1006"><a href="#cb37-1006" aria-hidden="true" tabindex="-1"></a><span class="fu">## 2.5 Train/Validation/Test Split &amp; Encoding</span></span>
<span id="cb37-1007"><a href="#cb37-1007" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1010"><a href="#cb37-1010" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-1011"><a href="#cb37-1011" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: data-split</span></span>
<span id="cb37-1012"><a href="#cb37-1012" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1013"><a href="#cb37-1013" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1014"><a href="#cb37-1014" aria-hidden="true" tabindex="-1"></a><span class="co"># DATA SPLITTING &amp; TARGET ENCODING</span></span>
<span id="cb37-1015"><a href="#cb37-1015" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1016"><a href="#cb37-1016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1017"><a href="#cb37-1017" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-1018"><a href="#cb37-1018" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"DATA SPLITTING &amp; TARGET ENCODING"</span>)</span>
<span id="cb37-1019"><a href="#cb37-1019" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-1020"><a href="#cb37-1020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1021"><a href="#cb37-1021" aria-hidden="true" tabindex="-1"></a><span class="co"># Stratified split</span></span>
<span id="cb37-1022"><a href="#cb37-1022" aria-hidden="true" tabindex="-1"></a>X_temp, X_test, y_temp, y_test <span class="op">=</span> train_test_split(</span>
<span id="cb37-1023"><a href="#cb37-1023" aria-hidden="true" tabindex="-1"></a>    X, y, test_size<span class="op">=</span>TEST_SIZE, random_state<span class="op">=</span>RANDOM_STATE, stratify<span class="op">=</span>y</span>
<span id="cb37-1024"><a href="#cb37-1024" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-1025"><a href="#cb37-1025" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1026"><a href="#cb37-1026" aria-hidden="true" tabindex="-1"></a>X_train, X_val, y_train, y_val <span class="op">=</span> train_test_split(</span>
<span id="cb37-1027"><a href="#cb37-1027" aria-hidden="true" tabindex="-1"></a>    X_temp, y_temp, test_size<span class="op">=</span>VAL_SIZE<span class="op">/</span>(<span class="dv">1</span><span class="op">-</span>TEST_SIZE), random_state<span class="op">=</span>RANDOM_STATE, stratify<span class="op">=</span>y_temp</span>
<span id="cb37-1028"><a href="#cb37-1028" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-1029"><a href="#cb37-1029" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1030"><a href="#cb37-1030" aria-hidden="true" tabindex="-1"></a><span class="co"># Split text data</span></span>
<span id="cb37-1031"><a href="#cb37-1031" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> text_data <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb37-1032"><a href="#cb37-1032" aria-hidden="true" tabindex="-1"></a>    text_temp, text_test <span class="op">=</span> train_test_split(</span>
<span id="cb37-1033"><a href="#cb37-1033" aria-hidden="true" tabindex="-1"></a>        text_data, test_size<span class="op">=</span>TEST_SIZE, random_state<span class="op">=</span>RANDOM_STATE, stratify<span class="op">=</span>y</span>
<span id="cb37-1034"><a href="#cb37-1034" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-1035"><a href="#cb37-1035" aria-hidden="true" tabindex="-1"></a>    text_train, text_val <span class="op">=</span> train_test_split(</span>
<span id="cb37-1036"><a href="#cb37-1036" aria-hidden="true" tabindex="-1"></a>        text_temp, test_size<span class="op">=</span>VAL_SIZE<span class="op">/</span>(<span class="dv">1</span><span class="op">-</span>TEST_SIZE), random_state<span class="op">=</span>RANDOM_STATE, stratify<span class="op">=</span>y_temp</span>
<span id="cb37-1037"><a href="#cb37-1037" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-1038"><a href="#cb37-1038" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb37-1039"><a href="#cb37-1039" aria-hidden="true" tabindex="-1"></a>    text_train <span class="op">=</span> text_val <span class="op">=</span> text_test <span class="op">=</span> <span class="va">None</span></span>
<span id="cb37-1040"><a href="#cb37-1040" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1041"><a href="#cb37-1041" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Train: </span><span class="sc">{</span><span class="bu">len</span>(X_train)<span class="sc">:,}</span><span class="ss"> (</span><span class="sc">{</span>y_train<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss"> positive)"</span>)</span>
<span id="cb37-1042"><a href="#cb37-1042" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Val:   </span><span class="sc">{</span><span class="bu">len</span>(X_val)<span class="sc">:,}</span><span class="ss"> (</span><span class="sc">{</span>y_val<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss"> positive)"</span>)</span>
<span id="cb37-1043"><a href="#cb37-1043" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Test:  </span><span class="sc">{</span><span class="bu">len</span>(X_test)<span class="sc">:,}</span><span class="ss"> (</span><span class="sc">{</span>y_test<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss"> positive)"</span>)</span>
<span id="cb37-1044"><a href="#cb37-1044" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1045"><a href="#cb37-1045" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1046"><a href="#cb37-1046" aria-hidden="true" tabindex="-1"></a><span class="co"># TARGET ENCODING</span></span>
<span id="cb37-1047"><a href="#cb37-1047" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1048"><a href="#cb37-1048" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1049"><a href="#cb37-1049" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Applying Target Encoding to high-cardinality features..."</span>)</span>
<span id="cb37-1050"><a href="#cb37-1050" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1051"><a href="#cb37-1051" aria-hidden="true" tabindex="-1"></a>target_encode_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> cat_cols <span class="cf">if</span> X_train[c].nunique() <span class="op">&gt;</span> <span class="dv">10</span>]</span>
<span id="cb37-1052"><a href="#cb37-1052" aria-hidden="true" tabindex="-1"></a>standard_encode_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> cat_cols <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> target_encode_cols]</span>
<span id="cb37-1053"><a href="#cb37-1053" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1054"><a href="#cb37-1054" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Target-encoded (</span><span class="sc">{</span><span class="bu">len</span>(target_encode_cols)<span class="sc">}</span><span class="ss">): </span><span class="sc">{</span>target_encode_cols<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-1055"><a href="#cb37-1055" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Label-encoded (</span><span class="sc">{</span><span class="bu">len</span>(standard_encode_cols)<span class="sc">}</span><span class="ss">): </span><span class="sc">{</span>standard_encode_cols<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-1056"><a href="#cb37-1056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1057"><a href="#cb37-1057" aria-hidden="true" tabindex="-1"></a><span class="co"># Manual Target Encoder (fallback)</span></span>
<span id="cb37-1058"><a href="#cb37-1058" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ManualTargetEncoder(BaseEstimator, TransformerMixin):</span>
<span id="cb37-1059"><a href="#cb37-1059" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, columns<span class="op">=</span><span class="va">None</span>, smoothing<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb37-1060"><a href="#cb37-1060" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.columns <span class="op">=</span> columns</span>
<span id="cb37-1061"><a href="#cb37-1061" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.smoothing <span class="op">=</span> smoothing</span>
<span id="cb37-1062"><a href="#cb37-1062" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.encoding_maps_ <span class="op">=</span> {}</span>
<span id="cb37-1063"><a href="#cb37-1063" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.global_mean_ <span class="op">=</span> <span class="va">None</span></span>
<span id="cb37-1064"><a href="#cb37-1064" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1065"><a href="#cb37-1065" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, X, y):</span>
<span id="cb37-1066"><a href="#cb37-1066" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> pd.DataFrame(X) <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(X, pd.DataFrame) <span class="cf">else</span> X</span>
<span id="cb37-1067"><a href="#cb37-1067" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> np.array(y)</span>
<span id="cb37-1068"><a href="#cb37-1068" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.global_mean_ <span class="op">=</span> y.mean()</span>
<span id="cb37-1069"><a href="#cb37-1069" aria-hidden="true" tabindex="-1"></a>        cols_to_encode <span class="op">=</span> <span class="va">self</span>.columns <span class="cf">if</span> <span class="va">self</span>.columns <span class="cf">else</span> X.select_dtypes(include<span class="op">=</span>[<span class="st">'object'</span>, <span class="st">'category'</span>]).columns.tolist()</span>
<span id="cb37-1070"><a href="#cb37-1070" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> col <span class="kw">in</span> cols_to_encode:</span>
<span id="cb37-1071"><a href="#cb37-1071" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> col <span class="kw">in</span> X.columns:</span>
<span id="cb37-1072"><a href="#cb37-1072" aria-hidden="true" tabindex="-1"></a>                df_temp <span class="op">=</span> pd.DataFrame({<span class="st">'col'</span>: X[col].astype(<span class="bu">str</span>), <span class="st">'target'</span>: y})</span>
<span id="cb37-1073"><a href="#cb37-1073" aria-hidden="true" tabindex="-1"></a>                agg <span class="op">=</span> df_temp.groupby(<span class="st">'col'</span>)[<span class="st">'target'</span>].agg([<span class="st">'mean'</span>, <span class="st">'count'</span>])</span>
<span id="cb37-1074"><a href="#cb37-1074" aria-hidden="true" tabindex="-1"></a>                smoothed <span class="op">=</span> (agg[<span class="st">'count'</span>] <span class="op">*</span> agg[<span class="st">'mean'</span>] <span class="op">+</span> <span class="va">self</span>.smoothing <span class="op">*</span> <span class="va">self</span>.global_mean_) <span class="op">/</span> (agg[<span class="st">'count'</span>] <span class="op">+</span> <span class="va">self</span>.smoothing)</span>
<span id="cb37-1075"><a href="#cb37-1075" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.encoding_maps_[col] <span class="op">=</span> smoothed.to_dict()</span>
<span id="cb37-1076"><a href="#cb37-1076" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span></span>
<span id="cb37-1077"><a href="#cb37-1077" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1078"><a href="#cb37-1078" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> transform(<span class="va">self</span>, X):</span>
<span id="cb37-1079"><a href="#cb37-1079" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> pd.DataFrame(X).copy() <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(X, pd.DataFrame) <span class="cf">else</span> X.copy()</span>
<span id="cb37-1080"><a href="#cb37-1080" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> col, mapping <span class="kw">in</span> <span class="va">self</span>.encoding_maps_.items():</span>
<span id="cb37-1081"><a href="#cb37-1081" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> col <span class="kw">in</span> X.columns:</span>
<span id="cb37-1082"><a href="#cb37-1082" aria-hidden="true" tabindex="-1"></a>                X[col <span class="op">+</span> <span class="st">'_encoded'</span>] <span class="op">=</span> X[col].astype(<span class="bu">str</span>).<span class="bu">map</span>(mapping).fillna(<span class="va">self</span>.global_mean_)</span>
<span id="cb37-1083"><a href="#cb37-1083" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> X</span>
<span id="cb37-1084"><a href="#cb37-1084" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1085"><a href="#cb37-1085" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply Target Encoding</span></span>
<span id="cb37-1086"><a href="#cb37-1086" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> TARGET_ENCODER_AVAILABLE <span class="kw">and</span> <span class="bu">len</span>(target_encode_cols) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb37-1087"><a href="#cb37-1087" aria-hidden="true" tabindex="-1"></a>    target_encoder <span class="op">=</span> TargetEncoder(smooth<span class="op">=</span><span class="st">'auto'</span>, target_type<span class="op">=</span><span class="st">'binary'</span>)</span>
<span id="cb37-1088"><a href="#cb37-1088" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1089"><a href="#cb37-1089" aria-hidden="true" tabindex="-1"></a>    X_train_te <span class="op">=</span> X_train.copy()</span>
<span id="cb37-1090"><a href="#cb37-1090" aria-hidden="true" tabindex="-1"></a>    X_val_te <span class="op">=</span> X_val.copy()</span>
<span id="cb37-1091"><a href="#cb37-1091" aria-hidden="true" tabindex="-1"></a>    X_test_te <span class="op">=</span> X_test.copy()</span>
<span id="cb37-1092"><a href="#cb37-1092" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1093"><a href="#cb37-1093" aria-hidden="true" tabindex="-1"></a>    te_train <span class="op">=</span> target_encoder.fit_transform(X_train[target_encode_cols], y_train)</span>
<span id="cb37-1094"><a href="#cb37-1094" aria-hidden="true" tabindex="-1"></a>    te_val <span class="op">=</span> target_encoder.transform(X_val[target_encode_cols])</span>
<span id="cb37-1095"><a href="#cb37-1095" aria-hidden="true" tabindex="-1"></a>    te_test <span class="op">=</span> target_encoder.transform(X_test[target_encode_cols])</span>
<span id="cb37-1096"><a href="#cb37-1096" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1097"><a href="#cb37-1097" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, col <span class="kw">in</span> <span class="bu">enumerate</span>(target_encode_cols):</span>
<span id="cb37-1098"><a href="#cb37-1098" aria-hidden="true" tabindex="-1"></a>        X_train_te[col] <span class="op">=</span> te_train[:, i]</span>
<span id="cb37-1099"><a href="#cb37-1099" aria-hidden="true" tabindex="-1"></a>        X_val_te[col] <span class="op">=</span> te_val[:, i]</span>
<span id="cb37-1100"><a href="#cb37-1100" aria-hidden="true" tabindex="-1"></a>        X_test_te[col] <span class="op">=</span> te_test[:, i]</span>
<span id="cb37-1101"><a href="#cb37-1101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1102"><a href="#cb37-1102" aria-hidden="true" tabindex="-1"></a><span class="cf">elif</span> <span class="bu">len</span>(target_encode_cols) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb37-1103"><a href="#cb37-1103" aria-hidden="true" tabindex="-1"></a>    manual_encoder <span class="op">=</span> ManualTargetEncoder(columns<span class="op">=</span>target_encode_cols, smoothing<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb37-1104"><a href="#cb37-1104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1105"><a href="#cb37-1105" aria-hidden="true" tabindex="-1"></a>    X_train_te <span class="op">=</span> manual_encoder.fit_transform(X_train, y_train)</span>
<span id="cb37-1106"><a href="#cb37-1106" aria-hidden="true" tabindex="-1"></a>    X_val_te <span class="op">=</span> manual_encoder.transform(X_val)</span>
<span id="cb37-1107"><a href="#cb37-1107" aria-hidden="true" tabindex="-1"></a>    X_test_te <span class="op">=</span> manual_encoder.transform(X_test)</span>
<span id="cb37-1108"><a href="#cb37-1108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1109"><a href="#cb37-1109" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> target_encode_cols:</span>
<span id="cb37-1110"><a href="#cb37-1110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> col <span class="op">+</span> <span class="st">'_encoded'</span> <span class="kw">in</span> X_train_te.columns:</span>
<span id="cb37-1111"><a href="#cb37-1111" aria-hidden="true" tabindex="-1"></a>            X_train_te[col] <span class="op">=</span> X_train_te[col <span class="op">+</span> <span class="st">'_encoded'</span>]</span>
<span id="cb37-1112"><a href="#cb37-1112" aria-hidden="true" tabindex="-1"></a>            X_val_te[col] <span class="op">=</span> X_val_te[col <span class="op">+</span> <span class="st">'_encoded'</span>]</span>
<span id="cb37-1113"><a href="#cb37-1113" aria-hidden="true" tabindex="-1"></a>            X_test_te[col] <span class="op">=</span> X_test_te[col <span class="op">+</span> <span class="st">'_encoded'</span>]</span>
<span id="cb37-1114"><a href="#cb37-1114" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb37-1115"><a href="#cb37-1115" aria-hidden="true" tabindex="-1"></a>    X_train_te <span class="op">=</span> X_train.copy()</span>
<span id="cb37-1116"><a href="#cb37-1116" aria-hidden="true" tabindex="-1"></a>    X_val_te <span class="op">=</span> X_val.copy()</span>
<span id="cb37-1117"><a href="#cb37-1117" aria-hidden="true" tabindex="-1"></a>    X_test_te <span class="op">=</span> X_test.copy()</span>
<span id="cb37-1118"><a href="#cb37-1118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1119"><a href="#cb37-1119" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1120"><a href="#cb37-1120" aria-hidden="true" tabindex="-1"></a><span class="co"># LABEL ENCODING</span></span>
<span id="cb37-1121"><a href="#cb37-1121" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1122"><a href="#cb37-1122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1123"><a href="#cb37-1123" aria-hidden="true" tabindex="-1"></a>label_encoders <span class="op">=</span> {}</span>
<span id="cb37-1124"><a href="#cb37-1124" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> standard_encode_cols:</span>
<span id="cb37-1125"><a href="#cb37-1125" aria-hidden="true" tabindex="-1"></a>    le <span class="op">=</span> LabelEncoder()</span>
<span id="cb37-1126"><a href="#cb37-1126" aria-hidden="true" tabindex="-1"></a>    X_train_te[col] <span class="op">=</span> le.fit_transform(X_train_te[col].astype(<span class="bu">str</span>))</span>
<span id="cb37-1127"><a href="#cb37-1127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1128"><a href="#cb37-1128" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> safe_transform(series, encoder):</span>
<span id="cb37-1129"><a href="#cb37-1129" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> series.astype(<span class="bu">str</span>).<span class="bu">apply</span>(</span>
<span id="cb37-1130"><a href="#cb37-1130" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> x: encoder.transform([x])[<span class="dv">0</span>] <span class="cf">if</span> x <span class="kw">in</span> encoder.classes_ <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb37-1131"><a href="#cb37-1131" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb37-1132"><a href="#cb37-1132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1133"><a href="#cb37-1133" aria-hidden="true" tabindex="-1"></a>    X_val_te[col] <span class="op">=</span> safe_transform(X_val_te[col], le)</span>
<span id="cb37-1134"><a href="#cb37-1134" aria-hidden="true" tabindex="-1"></a>    X_test_te[col] <span class="op">=</span> safe_transform(X_test_te[col], le)</span>
<span id="cb37-1135"><a href="#cb37-1135" aria-hidden="true" tabindex="-1"></a>    label_encoders[col] <span class="op">=</span> le</span>
<span id="cb37-1136"><a href="#cb37-1136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1137"><a href="#cb37-1137" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1138"><a href="#cb37-1138" aria-hidden="true" tabindex="-1"></a><span class="co"># DEEP LSA FOR TEXT</span></span>
<span id="cb37-1139"><a href="#cb37-1139" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1140"><a href="#cb37-1140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1141"><a href="#cb37-1141" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> text_train <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb37-1142"><a href="#cb37-1142" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Applying Deep LSA (</span><span class="sc">{</span>LSA_COMPONENTS<span class="sc">}</span><span class="ss"> components)..."</span>)</span>
<span id="cb37-1143"><a href="#cb37-1143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1144"><a href="#cb37-1144" aria-hidden="true" tabindex="-1"></a>    tfidf <span class="op">=</span> TfidfVectorizer(</span>
<span id="cb37-1145"><a href="#cb37-1145" aria-hidden="true" tabindex="-1"></a>        max_features<span class="op">=</span>TFIDF_MAX_FEATURES,</span>
<span id="cb37-1146"><a href="#cb37-1146" aria-hidden="true" tabindex="-1"></a>        ngram_range<span class="op">=</span>(<span class="dv">1</span>, <span class="dv">2</span>),</span>
<span id="cb37-1147"><a href="#cb37-1147" aria-hidden="true" tabindex="-1"></a>        stop_words<span class="op">=</span><span class="st">'english'</span>,</span>
<span id="cb37-1148"><a href="#cb37-1148" aria-hidden="true" tabindex="-1"></a>        min_df<span class="op">=</span><span class="dv">5</span></span>
<span id="cb37-1149"><a href="#cb37-1149" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-1150"><a href="#cb37-1150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1151"><a href="#cb37-1151" aria-hidden="true" tabindex="-1"></a>    tfidf_train <span class="op">=</span> tfidf.fit_transform(text_train)</span>
<span id="cb37-1152"><a href="#cb37-1152" aria-hidden="true" tabindex="-1"></a>    tfidf_val <span class="op">=</span> tfidf.transform(text_val)</span>
<span id="cb37-1153"><a href="#cb37-1153" aria-hidden="true" tabindex="-1"></a>    tfidf_test <span class="op">=</span> tfidf.transform(text_test)</span>
<span id="cb37-1154"><a href="#cb37-1154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1155"><a href="#cb37-1155" aria-hidden="true" tabindex="-1"></a>    svd <span class="op">=</span> TruncatedSVD(n_components<span class="op">=</span>LSA_COMPONENTS, random_state<span class="op">=</span>RANDOM_STATE)</span>
<span id="cb37-1156"><a href="#cb37-1156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1157"><a href="#cb37-1157" aria-hidden="true" tabindex="-1"></a>    lsa_train <span class="op">=</span> svd.fit_transform(tfidf_train)</span>
<span id="cb37-1158"><a href="#cb37-1158" aria-hidden="true" tabindex="-1"></a>    lsa_val <span class="op">=</span> svd.transform(tfidf_val)</span>
<span id="cb37-1159"><a href="#cb37-1159" aria-hidden="true" tabindex="-1"></a>    lsa_test <span class="op">=</span> svd.transform(tfidf_test)</span>
<span id="cb37-1160"><a href="#cb37-1160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1161"><a href="#cb37-1161" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Explained variance: </span><span class="sc">{</span>svd<span class="sc">.</span>explained_variance_ratio_<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb37-1162"><a href="#cb37-1162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1163"><a href="#cb37-1163" aria-hidden="true" tabindex="-1"></a>    lsa_cols <span class="op">=</span> [<span class="ss">f'lsa_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(LSA_COMPONENTS)]</span>
<span id="cb37-1164"><a href="#cb37-1164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1165"><a href="#cb37-1165" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, col <span class="kw">in</span> <span class="bu">enumerate</span>(lsa_cols):</span>
<span id="cb37-1166"><a href="#cb37-1166" aria-hidden="true" tabindex="-1"></a>        X_train_te[col] <span class="op">=</span> lsa_train[:, i]</span>
<span id="cb37-1167"><a href="#cb37-1167" aria-hidden="true" tabindex="-1"></a>        X_val_te[col] <span class="op">=</span> lsa_val[:, i]</span>
<span id="cb37-1168"><a href="#cb37-1168" aria-hidden="true" tabindex="-1"></a>        X_test_te[col] <span class="op">=</span> lsa_test[:, i]</span>
<span id="cb37-1169"><a href="#cb37-1169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1170"><a href="#cb37-1170" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1171"><a href="#cb37-1171" aria-hidden="true" tabindex="-1"></a><span class="co"># FINAL NUMERIC CONVERSION</span></span>
<span id="cb37-1172"><a href="#cb37-1172" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1173"><a href="#cb37-1173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1174"><a href="#cb37-1174" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> X_train_te.columns:</span>
<span id="cb37-1175"><a href="#cb37-1175" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> X_train_te[col].dtype <span class="op">==</span> <span class="st">'object'</span>:</span>
<span id="cb37-1176"><a href="#cb37-1176" aria-hidden="true" tabindex="-1"></a>        le <span class="op">=</span> LabelEncoder()</span>
<span id="cb37-1177"><a href="#cb37-1177" aria-hidden="true" tabindex="-1"></a>        X_train_te[col] <span class="op">=</span> le.fit_transform(X_train_te[col].astype(<span class="bu">str</span>))</span>
<span id="cb37-1178"><a href="#cb37-1178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1179"><a href="#cb37-1179" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> safe_encode(series, encoder):</span>
<span id="cb37-1180"><a href="#cb37-1180" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> series.astype(<span class="bu">str</span>).<span class="bu">apply</span>(</span>
<span id="cb37-1181"><a href="#cb37-1181" aria-hidden="true" tabindex="-1"></a>                <span class="kw">lambda</span> x: encoder.transform([x])[<span class="dv">0</span>] <span class="cf">if</span> x <span class="kw">in</span> encoder.classes_ <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb37-1182"><a href="#cb37-1182" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb37-1183"><a href="#cb37-1183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1184"><a href="#cb37-1184" aria-hidden="true" tabindex="-1"></a>        X_val_te[col] <span class="op">=</span> safe_encode(X_val_te[col], le)</span>
<span id="cb37-1185"><a href="#cb37-1185" aria-hidden="true" tabindex="-1"></a>        X_test_te[col] <span class="op">=</span> safe_encode(X_test_te[col], le)</span>
<span id="cb37-1186"><a href="#cb37-1186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1187"><a href="#cb37-1187" aria-hidden="true" tabindex="-1"></a>X_train_te <span class="op">=</span> X_train_te.fillna(<span class="dv">0</span>)</span>
<span id="cb37-1188"><a href="#cb37-1188" aria-hidden="true" tabindex="-1"></a>X_val_te <span class="op">=</span> X_val_te.fillna(<span class="dv">0</span>)</span>
<span id="cb37-1189"><a href="#cb37-1189" aria-hidden="true" tabindex="-1"></a>X_test_te <span class="op">=</span> X_test_te.fillna(<span class="dv">0</span>)</span>
<span id="cb37-1190"><a href="#cb37-1190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1191"><a href="#cb37-1191" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Final feature matrix shape: </span><span class="sc">{</span>X_train_te<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-1192"><a href="#cb37-1192" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Features: </span><span class="sc">{</span><span class="bu">list</span>(X_train_te.columns)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-1193"><a href="#cb37-1193" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-1194"><a href="#cb37-1194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1195"><a href="#cb37-1195" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb37-1196"><a href="#cb37-1196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1197"><a href="#cb37-1197" aria-hidden="true" tabindex="-1"></a><span class="fu"># Phase 3: Deep Model Tournament</span></span>
<span id="cb37-1198"><a href="#cb37-1198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1199"><a href="#cb37-1199" aria-hidden="true" tabindex="-1"></a>**The Titan Approach:** V7 retains the platinum architecture (CatBoost, Stacking, Deep Search) with the **n_iter=50** search to accommodate increased feature complexity while maintaining robust 5-fold cross-validation.</span>
<span id="cb37-1200"><a href="#cb37-1200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1201"><a href="#cb37-1201" aria-hidden="true" tabindex="-1"></a><span class="fu">## 3.1 Base Model Definitions</span></span>
<span id="cb37-1202"><a href="#cb37-1202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1205"><a href="#cb37-1205" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-1206"><a href="#cb37-1206" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: model-definitions</span></span>
<span id="cb37-1207"><a href="#cb37-1207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1208"><a href="#cb37-1208" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1209"><a href="#cb37-1209" aria-hidden="true" tabindex="-1"></a><span class="co"># PHASE 3: TITAN MODEL TOURNAMENT</span></span>
<span id="cb37-1210"><a href="#cb37-1210" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1211"><a href="#cb37-1211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1212"><a href="#cb37-1212" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-1213"><a href="#cb37-1213" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"TITAN MODEL TOURNAMENT"</span>)</span>
<span id="cb37-1214"><a href="#cb37-1214" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-1215"><a href="#cb37-1215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1216"><a href="#cb37-1216" aria-hidden="true" tabindex="-1"></a>models <span class="op">=</span> {}</span>
<span id="cb37-1217"><a href="#cb37-1217" aria-hidden="true" tabindex="-1"></a>param_grids <span class="op">=</span> {}</span>
<span id="cb37-1218"><a href="#cb37-1218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1219"><a href="#cb37-1219" aria-hidden="true" tabindex="-1"></a>pos_weight <span class="op">=</span> (y_train <span class="op">==</span> <span class="dv">0</span>).<span class="bu">sum</span>() <span class="op">/</span> (y_train <span class="op">==</span> <span class="dv">1</span>).<span class="bu">sum</span>()</span>
<span id="cb37-1220"><a href="#cb37-1220" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Class imbalance ratio: </span><span class="sc">{</span>pos_weight<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb37-1221"><a href="#cb37-1221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1222"><a href="#cb37-1222" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb37-1223"><a href="#cb37-1223" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. CATBOOST (sklearn-compatible wrapper)</span></span>
<span id="cb37-1224"><a href="#cb37-1224" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb37-1225"><a href="#cb37-1225" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> CATBOOST_AVAILABLE:</span>
<span id="cb37-1226"><a href="#cb37-1226" aria-hidden="true" tabindex="-1"></a>    models[<span class="st">'CatBoost'</span>] <span class="op">=</span> SklearnCatBoost(</span>
<span id="cb37-1227"><a href="#cb37-1227" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span>RANDOM_STATE,</span>
<span id="cb37-1228"><a href="#cb37-1228" aria-hidden="true" tabindex="-1"></a>        verbose<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb37-1229"><a href="#cb37-1229" aria-hidden="true" tabindex="-1"></a>        thread_count<span class="op">=</span><span class="dv">1</span>  <span class="co"># Single-threaded for nested parallelism safety</span></span>
<span id="cb37-1230"><a href="#cb37-1230" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-1231"><a href="#cb37-1231" aria-hidden="true" tabindex="-1"></a>    param_grids[<span class="st">'CatBoost'</span>] <span class="op">=</span> {</span>
<span id="cb37-1232"><a href="#cb37-1232" aria-hidden="true" tabindex="-1"></a>        <span class="st">'depth'</span>: [<span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">8</span>, <span class="dv">10</span>],</span>
<span id="cb37-1233"><a href="#cb37-1233" aria-hidden="true" tabindex="-1"></a>        <span class="st">'learning_rate'</span>: [<span class="fl">0.01</span>, <span class="fl">0.03</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>],</span>
<span id="cb37-1234"><a href="#cb37-1234" aria-hidden="true" tabindex="-1"></a>        <span class="st">'iterations'</span>: [<span class="dv">300</span>, <span class="dv">500</span>, <span class="dv">800</span>],</span>
<span id="cb37-1235"><a href="#cb37-1235" aria-hidden="true" tabindex="-1"></a>        <span class="st">'l2_leaf_reg'</span>: [<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>],</span>
<span id="cb37-1236"><a href="#cb37-1236" aria-hidden="true" tabindex="-1"></a>        <span class="st">'border_count'</span>: [<span class="dv">32</span>, <span class="dv">64</span>, <span class="dv">128</span>]</span>
<span id="cb37-1237"><a href="#cb37-1237" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb37-1238"><a href="#cb37-1238" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"CatBoost: Configured with sklearn-compatible wrapper (Thread-Safe)"</span>)</span>
<span id="cb37-1239"><a href="#cb37-1239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1240"><a href="#cb37-1240" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb37-1241"><a href="#cb37-1241" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. XGBOOST</span></span>
<span id="cb37-1242"><a href="#cb37-1242" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb37-1243"><a href="#cb37-1243" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> XGBOOST_AVAILABLE:</span>
<span id="cb37-1244"><a href="#cb37-1244" aria-hidden="true" tabindex="-1"></a>    models[<span class="st">'XGBoost'</span>] <span class="op">=</span> XGBClassifier(</span>
<span id="cb37-1245"><a href="#cb37-1245" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span>RANDOM_STATE,</span>
<span id="cb37-1246"><a href="#cb37-1246" aria-hidden="true" tabindex="-1"></a>        n_jobs<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb37-1247"><a href="#cb37-1247" aria-hidden="true" tabindex="-1"></a>        eval_metric<span class="op">=</span><span class="st">'logloss'</span></span>
<span id="cb37-1248"><a href="#cb37-1248" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-1249"><a href="#cb37-1249" aria-hidden="true" tabindex="-1"></a>    param_grids[<span class="st">'XGBoost'</span>] <span class="op">=</span> {</span>
<span id="cb37-1250"><a href="#cb37-1250" aria-hidden="true" tabindex="-1"></a>        <span class="st">'max_depth'</span>: [<span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">8</span>, <span class="dv">10</span>],</span>
<span id="cb37-1251"><a href="#cb37-1251" aria-hidden="true" tabindex="-1"></a>        <span class="st">'learning_rate'</span>: [<span class="fl">0.01</span>, <span class="fl">0.03</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>],</span>
<span id="cb37-1252"><a href="#cb37-1252" aria-hidden="true" tabindex="-1"></a>        <span class="st">'n_estimators'</span>: [<span class="dv">300</span>, <span class="dv">500</span>, <span class="dv">800</span>],</span>
<span id="cb37-1253"><a href="#cb37-1253" aria-hidden="true" tabindex="-1"></a>        <span class="st">'scale_pos_weight'</span>: [<span class="dv">1</span>, pos_weight],</span>
<span id="cb37-1254"><a href="#cb37-1254" aria-hidden="true" tabindex="-1"></a>        <span class="st">'subsample'</span>: [<span class="fl">0.7</span>, <span class="fl">0.8</span>, <span class="fl">0.9</span>, <span class="fl">1.0</span>],</span>
<span id="cb37-1255"><a href="#cb37-1255" aria-hidden="true" tabindex="-1"></a>        <span class="st">'colsample_bytree'</span>: [<span class="fl">0.7</span>, <span class="fl">0.8</span>, <span class="fl">0.9</span>, <span class="fl">1.0</span>],</span>
<span id="cb37-1256"><a href="#cb37-1256" aria-hidden="true" tabindex="-1"></a>        <span class="st">'reg_alpha'</span>: [<span class="dv">0</span>, <span class="fl">0.1</span>, <span class="fl">0.5</span>],</span>
<span id="cb37-1257"><a href="#cb37-1257" aria-hidden="true" tabindex="-1"></a>        <span class="st">'reg_lambda'</span>: [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">5</span>]</span>
<span id="cb37-1258"><a href="#cb37-1258" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb37-1259"><a href="#cb37-1259" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"XGBoost: Configured with expanded search space"</span>)</span>
<span id="cb37-1260"><a href="#cb37-1260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1261"><a href="#cb37-1261" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb37-1262"><a href="#cb37-1262" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. LIGHTGBM</span></span>
<span id="cb37-1263"><a href="#cb37-1263" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb37-1264"><a href="#cb37-1264" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> LIGHTGBM_AVAILABLE:</span>
<span id="cb37-1265"><a href="#cb37-1265" aria-hidden="true" tabindex="-1"></a>    models[<span class="st">'LightGBM'</span>] <span class="op">=</span> LGBMClassifier(</span>
<span id="cb37-1266"><a href="#cb37-1266" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span>RANDOM_STATE,</span>
<span id="cb37-1267"><a href="#cb37-1267" aria-hidden="true" tabindex="-1"></a>        n_jobs<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb37-1268"><a href="#cb37-1268" aria-hidden="true" tabindex="-1"></a>        verbose<span class="op">=-</span><span class="dv">1</span></span>
<span id="cb37-1269"><a href="#cb37-1269" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-1270"><a href="#cb37-1270" aria-hidden="true" tabindex="-1"></a>    param_grids[<span class="st">'LightGBM'</span>] <span class="op">=</span> {</span>
<span id="cb37-1271"><a href="#cb37-1271" aria-hidden="true" tabindex="-1"></a>        <span class="st">'num_leaves'</span>: [<span class="dv">31</span>, <span class="dv">63</span>, <span class="dv">127</span>, <span class="dv">255</span>],</span>
<span id="cb37-1272"><a href="#cb37-1272" aria-hidden="true" tabindex="-1"></a>        <span class="st">'learning_rate'</span>: [<span class="fl">0.01</span>, <span class="fl">0.03</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>],</span>
<span id="cb37-1273"><a href="#cb37-1273" aria-hidden="true" tabindex="-1"></a>        <span class="st">'n_estimators'</span>: [<span class="dv">300</span>, <span class="dv">500</span>, <span class="dv">800</span>],</span>
<span id="cb37-1274"><a href="#cb37-1274" aria-hidden="true" tabindex="-1"></a>        <span class="st">'class_weight'</span>: [<span class="st">'balanced'</span>, <span class="va">None</span>],</span>
<span id="cb37-1275"><a href="#cb37-1275" aria-hidden="true" tabindex="-1"></a>        <span class="st">'subsample'</span>: [<span class="fl">0.7</span>, <span class="fl">0.8</span>, <span class="fl">0.9</span>, <span class="fl">1.0</span>],</span>
<span id="cb37-1276"><a href="#cb37-1276" aria-hidden="true" tabindex="-1"></a>        <span class="st">'colsample_bytree'</span>: [<span class="fl">0.7</span>, <span class="fl">0.8</span>, <span class="fl">0.9</span>, <span class="fl">1.0</span>],</span>
<span id="cb37-1277"><a href="#cb37-1277" aria-hidden="true" tabindex="-1"></a>        <span class="st">'reg_alpha'</span>: [<span class="dv">0</span>, <span class="fl">0.1</span>, <span class="fl">0.5</span>],</span>
<span id="cb37-1278"><a href="#cb37-1278" aria-hidden="true" tabindex="-1"></a>        <span class="st">'reg_lambda'</span>: [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">5</span>]</span>
<span id="cb37-1279"><a href="#cb37-1279" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb37-1280"><a href="#cb37-1280" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"LightGBM: Configured with expanded search space"</span>)</span>
<span id="cb37-1281"><a href="#cb37-1281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1282"><a href="#cb37-1282" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb37-1283"><a href="#cb37-1283" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. GRADIENT BOOSTING (Fallback)</span></span>
<span id="cb37-1284"><a href="#cb37-1284" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb37-1285"><a href="#cb37-1285" aria-hidden="true" tabindex="-1"></a>models[<span class="st">'GradientBoosting'</span>] <span class="op">=</span> GradientBoostingClassifier(</span>
<span id="cb37-1286"><a href="#cb37-1286" aria-hidden="true" tabindex="-1"></a>    random_state<span class="op">=</span>RANDOM_STATE</span>
<span id="cb37-1287"><a href="#cb37-1287" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-1288"><a href="#cb37-1288" aria-hidden="true" tabindex="-1"></a>param_grids[<span class="st">'GradientBoosting'</span>] <span class="op">=</span> {</span>
<span id="cb37-1289"><a href="#cb37-1289" aria-hidden="true" tabindex="-1"></a>    <span class="st">'n_estimators'</span>: [<span class="dv">100</span>, <span class="dv">200</span>, <span class="dv">300</span>],</span>
<span id="cb37-1290"><a href="#cb37-1290" aria-hidden="true" tabindex="-1"></a>    <span class="st">'max_depth'</span>: [<span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">8</span>],</span>
<span id="cb37-1291"><a href="#cb37-1291" aria-hidden="true" tabindex="-1"></a>    <span class="st">'learning_rate'</span>: [<span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.2</span>],</span>
<span id="cb37-1292"><a href="#cb37-1292" aria-hidden="true" tabindex="-1"></a>    <span class="st">'subsample'</span>: [<span class="fl">0.8</span>, <span class="fl">0.9</span>, <span class="fl">1.0</span>]</span>
<span id="cb37-1293"><a href="#cb37-1293" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-1294"><a href="#cb37-1294" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"GradientBoosting: Configured as fallback"</span>)</span>
<span id="cb37-1295"><a href="#cb37-1295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1296"><a href="#cb37-1296" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb37-1297"><a href="#cb37-1297" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. RANDOM FOREST</span></span>
<span id="cb37-1298"><a href="#cb37-1298" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------------------------------------------------------</span></span>
<span id="cb37-1299"><a href="#cb37-1299" aria-hidden="true" tabindex="-1"></a>models[<span class="st">'RandomForest'</span>] <span class="op">=</span> RandomForestClassifier(</span>
<span id="cb37-1300"><a href="#cb37-1300" aria-hidden="true" tabindex="-1"></a>    random_state<span class="op">=</span>RANDOM_STATE,</span>
<span id="cb37-1301"><a href="#cb37-1301" aria-hidden="true" tabindex="-1"></a>    n_jobs<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb37-1302"><a href="#cb37-1302" aria-hidden="true" tabindex="-1"></a>    class_weight<span class="op">=</span><span class="st">'balanced'</span></span>
<span id="cb37-1303"><a href="#cb37-1303" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-1304"><a href="#cb37-1304" aria-hidden="true" tabindex="-1"></a>param_grids[<span class="st">'RandomForest'</span>] <span class="op">=</span> {</span>
<span id="cb37-1305"><a href="#cb37-1305" aria-hidden="true" tabindex="-1"></a>    <span class="st">'n_estimators'</span>: [<span class="dv">100</span>, <span class="dv">200</span>, <span class="dv">300</span>],</span>
<span id="cb37-1306"><a href="#cb37-1306" aria-hidden="true" tabindex="-1"></a>    <span class="st">'max_depth'</span>: [<span class="dv">10</span>, <span class="dv">15</span>, <span class="dv">20</span>, <span class="va">None</span>],</span>
<span id="cb37-1307"><a href="#cb37-1307" aria-hidden="true" tabindex="-1"></a>    <span class="st">'min_samples_split'</span>: [<span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">10</span>],</span>
<span id="cb37-1308"><a href="#cb37-1308" aria-hidden="true" tabindex="-1"></a>    <span class="st">'min_samples_leaf'</span>: [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>]</span>
<span id="cb37-1309"><a href="#cb37-1309" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-1310"><a href="#cb37-1310" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"RandomForest: Configured with balanced class weights"</span>)</span>
<span id="cb37-1311"><a href="#cb37-1311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1312"><a href="#cb37-1312" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Total models in tournament: </span><span class="sc">{</span><span class="bu">len</span>(models)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-1313"><a href="#cb37-1313" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Search iterations per model: </span><span class="sc">{</span>N_ITER_SEARCH<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-1314"><a href="#cb37-1314" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Cross-validation folds: </span><span class="sc">{</span>CV_FOLDS<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-1315"><a href="#cb37-1315" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-1316"><a href="#cb37-1316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1317"><a href="#cb37-1317" aria-hidden="true" tabindex="-1"></a><span class="fu">## 3.2 Hyperparameter Search</span></span>
<span id="cb37-1318"><a href="#cb37-1318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1321"><a href="#cb37-1321" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-1322"><a href="#cb37-1322" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: hyperparameter-search</span></span>
<span id="cb37-1323"><a href="#cb37-1323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1324"><a href="#cb37-1324" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1325"><a href="#cb37-1325" aria-hidden="true" tabindex="-1"></a><span class="co"># RANDOMIZED SEARCH (n_iter=50, cv=5)</span></span>
<span id="cb37-1326"><a href="#cb37-1326" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1327"><a href="#cb37-1327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1328"><a href="#cb37-1328" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-1329"><a href="#cb37-1329" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"TITAN HYPERPARAMETER OPTIMIZATION (n_iter=50, cv=5)"</span>)</span>
<span id="cb37-1330"><a href="#cb37-1330" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-1331"><a href="#cb37-1331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1332"><a href="#cb37-1332" aria-hidden="true" tabindex="-1"></a>cv <span class="op">=</span> StratifiedKFold(n_splits<span class="op">=</span>CV_FOLDS, shuffle<span class="op">=</span><span class="va">True</span>, random_state<span class="op">=</span>RANDOM_STATE)</span>
<span id="cb37-1333"><a href="#cb37-1333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1334"><a href="#cb37-1334" aria-hidden="true" tabindex="-1"></a>best_models <span class="op">=</span> {}</span>
<span id="cb37-1335"><a href="#cb37-1335" aria-hidden="true" tabindex="-1"></a>cv_results <span class="op">=</span> {}</span>
<span id="cb37-1336"><a href="#cb37-1336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1337"><a href="#cb37-1337" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, model <span class="kw">in</span> models.items():</span>
<span id="cb37-1338"><a href="#cb37-1338" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">50</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-1339"><a href="#cb37-1339" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Tuning: </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-1340"><a href="#cb37-1340" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'='</span><span class="op">*</span><span class="dv">50</span><span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-1341"><a href="#cb37-1341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1342"><a href="#cb37-1342" aria-hidden="true" tabindex="-1"></a>    search <span class="op">=</span> RandomizedSearchCV(</span>
<span id="cb37-1343"><a href="#cb37-1343" aria-hidden="true" tabindex="-1"></a>        estimator<span class="op">=</span>model,</span>
<span id="cb37-1344"><a href="#cb37-1344" aria-hidden="true" tabindex="-1"></a>        param_distributions<span class="op">=</span>param_grids[name],</span>
<span id="cb37-1345"><a href="#cb37-1345" aria-hidden="true" tabindex="-1"></a>        n_iter<span class="op">=</span>N_ITER_SEARCH,</span>
<span id="cb37-1346"><a href="#cb37-1346" aria-hidden="true" tabindex="-1"></a>        cv<span class="op">=</span>cv,</span>
<span id="cb37-1347"><a href="#cb37-1347" aria-hidden="true" tabindex="-1"></a>        scoring<span class="op">=</span><span class="st">'roc_auc'</span>,</span>
<span id="cb37-1348"><a href="#cb37-1348" aria-hidden="true" tabindex="-1"></a>        n_jobs<span class="op">=</span>N_JOBS,</span>
<span id="cb37-1349"><a href="#cb37-1349" aria-hidden="true" tabindex="-1"></a>        random_state<span class="op">=</span>RANDOM_STATE,</span>
<span id="cb37-1350"><a href="#cb37-1350" aria-hidden="true" tabindex="-1"></a>        verbose<span class="op">=</span><span class="dv">1</span></span>
<span id="cb37-1351"><a href="#cb37-1351" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-1352"><a href="#cb37-1352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1353"><a href="#cb37-1353" aria-hidden="true" tabindex="-1"></a>    search.fit(X_train_te, y_train)</span>
<span id="cb37-1354"><a href="#cb37-1354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1355"><a href="#cb37-1355" aria-hidden="true" tabindex="-1"></a>    best_models[name] <span class="op">=</span> search.best_estimator_</span>
<span id="cb37-1356"><a href="#cb37-1356" aria-hidden="true" tabindex="-1"></a>    cv_results[name] <span class="op">=</span> {</span>
<span id="cb37-1357"><a href="#cb37-1357" aria-hidden="true" tabindex="-1"></a>        <span class="st">'best_score'</span>: search.best_score_,</span>
<span id="cb37-1358"><a href="#cb37-1358" aria-hidden="true" tabindex="-1"></a>        <span class="st">'best_params'</span>: search.best_params_,</span>
<span id="cb37-1359"><a href="#cb37-1359" aria-hidden="true" tabindex="-1"></a>        <span class="st">'cv_results'</span>: search.cv_results_</span>
<span id="cb37-1360"><a href="#cb37-1360" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb37-1361"><a href="#cb37-1361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1362"><a href="#cb37-1362" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Best CV AUC: </span><span class="sc">{</span>search<span class="sc">.</span>best_score_<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb37-1363"><a href="#cb37-1363" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Best params: </span><span class="sc">{</span>search<span class="sc">.</span>best_params_<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-1364"><a href="#cb37-1364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1365"><a href="#cb37-1365" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1366"><a href="#cb37-1366" aria-hidden="true" tabindex="-1"></a><span class="co"># VALIDATION SET EVALUATION</span></span>
<span id="cb37-1367"><a href="#cb37-1367" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1368"><a href="#cb37-1368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1369"><a href="#cb37-1369" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-1370"><a href="#cb37-1370" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"VALIDATION SET PERFORMANCE"</span>)</span>
<span id="cb37-1371"><a href="#cb37-1371" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-1372"><a href="#cb37-1372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1373"><a href="#cb37-1373" aria-hidden="true" tabindex="-1"></a>val_results <span class="op">=</span> {}</span>
<span id="cb37-1374"><a href="#cb37-1374" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, model <span class="kw">in</span> best_models.items():</span>
<span id="cb37-1375"><a href="#cb37-1375" aria-hidden="true" tabindex="-1"></a>    probs <span class="op">=</span> model.predict_proba(X_val_te)[:, <span class="dv">1</span>]</span>
<span id="cb37-1376"><a href="#cb37-1376" aria-hidden="true" tabindex="-1"></a>    auc <span class="op">=</span> roc_auc_score(y_val, probs)</span>
<span id="cb37-1377"><a href="#cb37-1377" aria-hidden="true" tabindex="-1"></a>    val_results[name] <span class="op">=</span> {<span class="st">'auc'</span>: auc, <span class="st">'probs'</span>: probs}</span>
<span id="cb37-1378"><a href="#cb37-1378" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">: AUC = </span><span class="sc">{</span>auc<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb37-1379"><a href="#cb37-1379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1380"><a href="#cb37-1380" aria-hidden="true" tabindex="-1"></a>val_ranking <span class="op">=</span> <span class="bu">sorted</span>(val_results.items(), key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>][<span class="st">'auc'</span>], reverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb37-1381"><a href="#cb37-1381" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Validation Ranking:"</span>)</span>
<span id="cb37-1382"><a href="#cb37-1382" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (name, res) <span class="kw">in</span> <span class="bu">enumerate</span>(val_ranking, <span class="dv">1</span>):</span>
<span id="cb37-1383"><a href="#cb37-1383" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">. </span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>res[<span class="st">'auc'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb37-1384"><a href="#cb37-1384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1385"><a href="#cb37-1385" aria-hidden="true" tabindex="-1"></a><span class="co"># Print tournament results for PDF</span></span>
<span id="cb37-1386"><a href="#cb37-1386" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n\n</span><span class="st">MODEL TOURNAMENT RESULTS (For PDF Extraction):"</span>)</span>
<span id="cb37-1387"><a href="#cb37-1387" aria-hidden="true" tabindex="-1"></a>tournament_df <span class="op">=</span> pd.DataFrame([</span>
<span id="cb37-1388"><a href="#cb37-1388" aria-hidden="true" tabindex="-1"></a>    {<span class="st">'Model'</span>: name, <span class="st">'CV AUC'</span>: <span class="ss">f"</span><span class="sc">{</span>cv_results[name][<span class="st">'best_score'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>,</span>
<span id="cb37-1389"><a href="#cb37-1389" aria-hidden="true" tabindex="-1"></a>     <span class="st">'Val AUC'</span>: <span class="ss">f"</span><span class="sc">{</span>val_results[name][<span class="st">'auc'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>}</span>
<span id="cb37-1390"><a href="#cb37-1390" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> best_models.keys()</span>
<span id="cb37-1391"><a href="#cb37-1391" aria-hidden="true" tabindex="-1"></a>]).sort_values(<span class="st">'Val AUC'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb37-1392"><a href="#cb37-1392" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tournament_df.to_markdown(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb37-1393"><a href="#cb37-1393" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-1394"><a href="#cb37-1394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1395"><a href="#cb37-1395" aria-hidden="true" tabindex="-1"></a><span class="fu">## 3.3 Stacking Ensemble</span></span>
<span id="cb37-1396"><a href="#cb37-1396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1399"><a href="#cb37-1399" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-1400"><a href="#cb37-1400" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: stacking-ensemble</span></span>
<span id="cb37-1401"><a href="#cb37-1401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1402"><a href="#cb37-1402" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1403"><a href="#cb37-1403" aria-hidden="true" tabindex="-1"></a><span class="co"># STACKING ENSEMBLE</span></span>
<span id="cb37-1404"><a href="#cb37-1404" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1405"><a href="#cb37-1405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1406"><a href="#cb37-1406" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-1407"><a href="#cb37-1407" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"STACKING ENSEMBLE CONSTRUCTION"</span>)</span>
<span id="cb37-1408"><a href="#cb37-1408" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-1409"><a href="#cb37-1409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1410"><a href="#cb37-1410" aria-hidden="true" tabindex="-1"></a>top_3_names <span class="op">=</span> [name <span class="cf">for</span> name, _ <span class="kw">in</span> val_ranking[:<span class="dv">3</span>]]</span>
<span id="cb37-1411"><a href="#cb37-1411" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Base learners: </span><span class="sc">{</span>top_3_names<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-1412"><a href="#cb37-1412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1413"><a href="#cb37-1413" aria-hidden="true" tabindex="-1"></a>stacking_estimators <span class="op">=</span> [(name, best_models[name]) <span class="cf">for</span> name <span class="kw">in</span> top_3_names]</span>
<span id="cb37-1414"><a href="#cb37-1414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1415"><a href="#cb37-1415" aria-hidden="true" tabindex="-1"></a>meta_learner <span class="op">=</span> LogisticRegression(</span>
<span id="cb37-1416"><a href="#cb37-1416" aria-hidden="true" tabindex="-1"></a>    random_state<span class="op">=</span>RANDOM_STATE,</span>
<span id="cb37-1417"><a href="#cb37-1417" aria-hidden="true" tabindex="-1"></a>    max_iter<span class="op">=</span><span class="dv">1000</span>,</span>
<span id="cb37-1418"><a href="#cb37-1418" aria-hidden="true" tabindex="-1"></a>    class_weight<span class="op">=</span><span class="st">'balanced'</span></span>
<span id="cb37-1419"><a href="#cb37-1419" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-1420"><a href="#cb37-1420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1421"><a href="#cb37-1421" aria-hidden="true" tabindex="-1"></a>stacking_clf <span class="op">=</span> StackingClassifier(</span>
<span id="cb37-1422"><a href="#cb37-1422" aria-hidden="true" tabindex="-1"></a>    estimators<span class="op">=</span>stacking_estimators,</span>
<span id="cb37-1423"><a href="#cb37-1423" aria-hidden="true" tabindex="-1"></a>    final_estimator<span class="op">=</span>meta_learner,</span>
<span id="cb37-1424"><a href="#cb37-1424" aria-hidden="true" tabindex="-1"></a>    cv<span class="op">=</span>CV_FOLDS,</span>
<span id="cb37-1425"><a href="#cb37-1425" aria-hidden="true" tabindex="-1"></a>    stack_method<span class="op">=</span><span class="st">'predict_proba'</span>,</span>
<span id="cb37-1426"><a href="#cb37-1426" aria-hidden="true" tabindex="-1"></a>    n_jobs<span class="op">=</span>N_JOBS,</span>
<span id="cb37-1427"><a href="#cb37-1427" aria-hidden="true" tabindex="-1"></a>    passthrough<span class="op">=</span><span class="va">False</span></span>
<span id="cb37-1428"><a href="#cb37-1428" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-1429"><a href="#cb37-1429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1430"><a href="#cb37-1430" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Training Stacking Ensemble..."</span>)</span>
<span id="cb37-1431"><a href="#cb37-1431" aria-hidden="true" tabindex="-1"></a>stacking_clf.fit(X_train_te, y_train)</span>
<span id="cb37-1432"><a href="#cb37-1432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1433"><a href="#cb37-1433" aria-hidden="true" tabindex="-1"></a>stack_val_probs <span class="op">=</span> stacking_clf.predict_proba(X_val_te)[:, <span class="dv">1</span>]</span>
<span id="cb37-1434"><a href="#cb37-1434" aria-hidden="true" tabindex="-1"></a>stack_val_auc <span class="op">=</span> roc_auc_score(y_val, stack_val_probs)</span>
<span id="cb37-1435"><a href="#cb37-1435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1436"><a href="#cb37-1436" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Stacking Ensemble Validation AUC: </span><span class="sc">{</span>stack_val_auc<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb37-1437"><a href="#cb37-1437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1438"><a href="#cb37-1438" aria-hidden="true" tabindex="-1"></a>best_individual_auc <span class="op">=</span> val_ranking[<span class="dv">0</span>][<span class="dv">1</span>][<span class="st">'auc'</span>]</span>
<span id="cb37-1439"><a href="#cb37-1439" aria-hidden="true" tabindex="-1"></a>improvement <span class="op">=</span> stack_val_auc <span class="op">-</span> best_individual_auc</span>
<span id="cb37-1440"><a href="#cb37-1440" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Improvement over best individual (</span><span class="sc">{</span>val_ranking[<span class="dv">0</span>][<span class="dv">0</span>]<span class="sc">}</span><span class="ss">): </span><span class="sc">{</span>improvement<span class="sc">:+.4f}</span><span class="ss">"</span>)</span>
<span id="cb37-1441"><a href="#cb37-1441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1442"><a href="#cb37-1442" aria-hidden="true" tabindex="-1"></a>best_models[<span class="st">'StackingEnsemble'</span>] <span class="op">=</span> stacking_clf</span>
<span id="cb37-1443"><a href="#cb37-1443" aria-hidden="true" tabindex="-1"></a>val_results[<span class="st">'StackingEnsemble'</span>] <span class="op">=</span> {<span class="st">'auc'</span>: stack_val_auc, <span class="st">'probs'</span>: stack_val_probs}</span>
<span id="cb37-1444"><a href="#cb37-1444" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-1445"><a href="#cb37-1445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1446"><a href="#cb37-1446" aria-hidden="true" tabindex="-1"></a><span class="fu">## 3.4 Final Model Selection &amp; Test Evaluation</span></span>
<span id="cb37-1447"><a href="#cb37-1447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1450"><a href="#cb37-1450" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-1451"><a href="#cb37-1451" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: final-evaluation</span></span>
<span id="cb37-1452"><a href="#cb37-1452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1453"><a href="#cb37-1453" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1454"><a href="#cb37-1454" aria-hidden="true" tabindex="-1"></a><span class="co"># FINAL </span><span class="al">TEST</span><span class="co"> SET EVALUATION</span></span>
<span id="cb37-1455"><a href="#cb37-1455" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1456"><a href="#cb37-1456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1457"><a href="#cb37-1457" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-1458"><a href="#cb37-1458" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"FINAL TEST SET EVALUATION"</span>)</span>
<span id="cb37-1459"><a href="#cb37-1459" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-1460"><a href="#cb37-1460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1461"><a href="#cb37-1461" aria-hidden="true" tabindex="-1"></a>champion_name <span class="op">=</span> <span class="bu">max</span>(val_results.items(), key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>][<span class="st">'auc'</span>])[<span class="dv">0</span>]</span>
<span id="cb37-1462"><a href="#cb37-1462" aria-hidden="true" tabindex="-1"></a>champion_model <span class="op">=</span> best_models[champion_name]</span>
<span id="cb37-1463"><a href="#cb37-1463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1464"><a href="#cb37-1464" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Champion Model: </span><span class="sc">{</span>champion_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-1465"><a href="#cb37-1465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1466"><a href="#cb37-1466" aria-hidden="true" tabindex="-1"></a>test_probs <span class="op">=</span> champion_model.predict_proba(X_test_te)[:, <span class="dv">1</span>]</span>
<span id="cb37-1467"><a href="#cb37-1467" aria-hidden="true" tabindex="-1"></a>test_preds <span class="op">=</span> (test_probs <span class="op">&gt;=</span> <span class="fl">0.5</span>).astype(<span class="bu">int</span>)</span>
<span id="cb37-1468"><a href="#cb37-1468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1469"><a href="#cb37-1469" aria-hidden="true" tabindex="-1"></a>test_auc <span class="op">=</span> roc_auc_score(y_test, test_probs)</span>
<span id="cb37-1470"><a href="#cb37-1470" aria-hidden="true" tabindex="-1"></a>test_ap <span class="op">=</span> average_precision_score(y_test, test_probs)</span>
<span id="cb37-1471"><a href="#cb37-1471" aria-hidden="true" tabindex="-1"></a>test_brier <span class="op">=</span> brier_score_loss(y_test, test_probs)</span>
<span id="cb37-1472"><a href="#cb37-1472" aria-hidden="true" tabindex="-1"></a>test_logloss <span class="op">=</span> log_loss(y_test, test_probs)</span>
<span id="cb37-1473"><a href="#cb37-1473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1474"><a href="#cb37-1474" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Test Set Metrics:"</span>)</span>
<span id="cb37-1475"><a href="#cb37-1475" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  AUC-ROC:        </span><span class="sc">{</span>test_auc<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb37-1476"><a href="#cb37-1476" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Average Prec:   </span><span class="sc">{</span>test_ap<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb37-1477"><a href="#cb37-1477" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Brier Score:    </span><span class="sc">{</span>test_brier<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb37-1478"><a href="#cb37-1478" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Log Loss:       </span><span class="sc">{</span>test_logloss<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb37-1479"><a href="#cb37-1479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1480"><a href="#cb37-1480" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Classification Report (threshold=0.5):"</span>)</span>
<span id="cb37-1481"><a href="#cb37-1481" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(classification_report(y_test, test_preds, target_names<span class="op">=</span>[<span class="st">'Not SQL'</span>, <span class="st">'SQL'</span>]))</span>
<span id="cb37-1482"><a href="#cb37-1482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1483"><a href="#cb37-1483" aria-hidden="true" tabindex="-1"></a>cm <span class="op">=</span> confusion_matrix(y_test, test_preds)</span>
<span id="cb37-1484"><a href="#cb37-1484" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Confusion Matrix:"</span>)</span>
<span id="cb37-1485"><a href="#cb37-1485" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(cm)</span>
<span id="cb37-1486"><a href="#cb37-1486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1487"><a href="#cb37-1487" aria-hidden="true" tabindex="-1"></a>FINAL_AUC <span class="op">=</span> test_auc</span>
<span id="cb37-1488"><a href="#cb37-1488" aria-hidden="true" tabindex="-1"></a>CHAMPION_MODEL <span class="op">=</span> champion_model</span>
<span id="cb37-1489"><a href="#cb37-1489" aria-hidden="true" tabindex="-1"></a>CHAMPION_NAME <span class="op">=</span> champion_name</span>
<span id="cb37-1490"><a href="#cb37-1490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1491"><a href="#cb37-1491" aria-hidden="true" tabindex="-1"></a><span class="co"># AUC Target Check</span></span>
<span id="cb37-1492"><a href="#cb37-1492" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-1493"><a href="#cb37-1493" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> FINAL_AUC <span class="op">&gt;=</span> <span class="fl">0.90</span>:</span>
<span id="cb37-1494"><a href="#cb37-1494" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"TARGET ACHIEVED: AUC &gt;= 0.90!"</span>)</span>
<span id="cb37-1495"><a href="#cb37-1495" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb37-1496"><a href="#cb37-1496" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"AUC: </span><span class="sc">{</span>FINAL_AUC<span class="sc">:.4f}</span><span class="ss"> (Target: 0.90, Gap: </span><span class="sc">{</span><span class="fl">0.90</span> <span class="op">-</span> FINAL_AUC<span class="sc">:.4f}</span><span class="ss">)"</span>)</span>
<span id="cb37-1497"><a href="#cb37-1497" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-1498"><a href="#cb37-1498" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-1499"><a href="#cb37-1499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1500"><a href="#cb37-1500" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb37-1501"><a href="#cb37-1501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1502"><a href="#cb37-1502" aria-hidden="true" tabindex="-1"></a><span class="fu"># Phase 4: Profit Maximization &amp; Waste Reduction</span></span>
<span id="cb37-1503"><a href="#cb37-1503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1504"><a href="#cb37-1504" aria-hidden="true" tabindex="-1"></a>**The Real Metric is Profit:** With a **\$50 cost per call** and **\$6,000 value per SQL**, we calculate the exact threshold where expected revenue exceeds expected cost. V7 adds **Waste Reduction Analysis** to quantify savings from cutting toxic channels.</span>
<span id="cb37-1505"><a href="#cb37-1505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1508"><a href="#cb37-1508" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-1509"><a href="#cb37-1509" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: profit-optimization</span></span>
<span id="cb37-1510"><a href="#cb37-1510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1511"><a href="#cb37-1511" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1512"><a href="#cb37-1512" aria-hidden="true" tabindex="-1"></a><span class="co"># PHASE 4: PROFIT CURVE OPTIMIZATION</span></span>
<span id="cb37-1513"><a href="#cb37-1513" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1514"><a href="#cb37-1514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1515"><a href="#cb37-1515" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-1516"><a href="#cb37-1516" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"PROFIT CURVE OPTIMIZATION"</span>)</span>
<span id="cb37-1517"><a href="#cb37-1517" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-1518"><a href="#cb37-1518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1519"><a href="#cb37-1519" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_profit_curve(y_true, y_probs, cost_per_call<span class="op">=</span>COST_PER_CALL, value_per_sql<span class="op">=</span>VALUE_PER_SQL):</span>
<span id="cb37-1520"><a href="#cb37-1520" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Calculate profit at various thresholds."""</span></span>
<span id="cb37-1521"><a href="#cb37-1521" aria-hidden="true" tabindex="-1"></a>    order <span class="op">=</span> np.argsort(y_probs)[::<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb37-1522"><a href="#cb37-1522" aria-hidden="true" tabindex="-1"></a>    y_sorted <span class="op">=</span> y_true[order]</span>
<span id="cb37-1523"><a href="#cb37-1523" aria-hidden="true" tabindex="-1"></a>    probs_sorted <span class="op">=</span> y_probs[order]</span>
<span id="cb37-1524"><a href="#cb37-1524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1525"><a href="#cb37-1525" aria-hidden="true" tabindex="-1"></a>    n_total <span class="op">=</span> <span class="bu">len</span>(y_true)</span>
<span id="cb37-1526"><a href="#cb37-1526" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb37-1527"><a href="#cb37-1527" aria-hidden="true" tabindex="-1"></a>    cumsum_success <span class="op">=</span> np.cumsum(y_sorted)</span>
<span id="cb37-1528"><a href="#cb37-1528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1529"><a href="#cb37-1529" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n_total <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb37-1530"><a href="#cb37-1530" aria-hidden="true" tabindex="-1"></a>        threshold <span class="op">=</span> probs_sorted[k<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb37-1531"><a href="#cb37-1531" aria-hidden="true" tabindex="-1"></a>        n_calls <span class="op">=</span> k</span>
<span id="cb37-1532"><a href="#cb37-1532" aria-hidden="true" tabindex="-1"></a>        n_sqls <span class="op">=</span> cumsum_success[k<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb37-1533"><a href="#cb37-1533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1534"><a href="#cb37-1534" aria-hidden="true" tabindex="-1"></a>        revenue <span class="op">=</span> n_sqls <span class="op">*</span> value_per_sql</span>
<span id="cb37-1535"><a href="#cb37-1535" aria-hidden="true" tabindex="-1"></a>        cost <span class="op">=</span> n_calls <span class="op">*</span> cost_per_call</span>
<span id="cb37-1536"><a href="#cb37-1536" aria-hidden="true" tabindex="-1"></a>        profit <span class="op">=</span> revenue <span class="op">-</span> cost</span>
<span id="cb37-1537"><a href="#cb37-1537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1538"><a href="#cb37-1538" aria-hidden="true" tabindex="-1"></a>        pct_population <span class="op">=</span> k <span class="op">/</span> n_total</span>
<span id="cb37-1539"><a href="#cb37-1539" aria-hidden="true" tabindex="-1"></a>        pct_sqls_captured <span class="op">=</span> n_sqls <span class="op">/</span> y_true.<span class="bu">sum</span>() <span class="cf">if</span> y_true.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb37-1540"><a href="#cb37-1540" aria-hidden="true" tabindex="-1"></a>        lift <span class="op">=</span> (n_sqls <span class="op">/</span> k) <span class="op">/</span> (y_true.<span class="bu">sum</span>() <span class="op">/</span> n_total) <span class="cf">if</span> k <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb37-1541"><a href="#cb37-1541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1542"><a href="#cb37-1542" aria-hidden="true" tabindex="-1"></a>        results.append({</span>
<span id="cb37-1543"><a href="#cb37-1543" aria-hidden="true" tabindex="-1"></a>            <span class="st">'threshold'</span>: threshold,</span>
<span id="cb37-1544"><a href="#cb37-1544" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_calls'</span>: n_calls,</span>
<span id="cb37-1545"><a href="#cb37-1545" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_sqls'</span>: n_sqls,</span>
<span id="cb37-1546"><a href="#cb37-1546" aria-hidden="true" tabindex="-1"></a>            <span class="st">'revenue'</span>: revenue,</span>
<span id="cb37-1547"><a href="#cb37-1547" aria-hidden="true" tabindex="-1"></a>            <span class="st">'cost'</span>: cost,</span>
<span id="cb37-1548"><a href="#cb37-1548" aria-hidden="true" tabindex="-1"></a>            <span class="st">'profit'</span>: profit,</span>
<span id="cb37-1549"><a href="#cb37-1549" aria-hidden="true" tabindex="-1"></a>            <span class="st">'pct_population'</span>: pct_population,</span>
<span id="cb37-1550"><a href="#cb37-1550" aria-hidden="true" tabindex="-1"></a>            <span class="st">'pct_sqls_captured'</span>: pct_sqls_captured,</span>
<span id="cb37-1551"><a href="#cb37-1551" aria-hidden="true" tabindex="-1"></a>            <span class="st">'lift'</span>: lift</span>
<span id="cb37-1552"><a href="#cb37-1552" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb37-1553"><a href="#cb37-1553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1554"><a href="#cb37-1554" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results)</span>
<span id="cb37-1555"><a href="#cb37-1555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1556"><a href="#cb37-1556" aria-hidden="true" tabindex="-1"></a>profit_df <span class="op">=</span> calculate_profit_curve(y_test, test_probs)</span>
<span id="cb37-1557"><a href="#cb37-1557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1558"><a href="#cb37-1558" aria-hidden="true" tabindex="-1"></a>optimal_idx <span class="op">=</span> profit_df[<span class="st">'profit'</span>].idxmax()</span>
<span id="cb37-1559"><a href="#cb37-1559" aria-hidden="true" tabindex="-1"></a>optimal_row <span class="op">=</span> profit_df.iloc[optimal_idx]</span>
<span id="cb37-1560"><a href="#cb37-1560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1561"><a href="#cb37-1561" aria-hidden="true" tabindex="-1"></a>OPTIMAL_THRESHOLD <span class="op">=</span> optimal_row[<span class="st">'threshold'</span>]</span>
<span id="cb37-1562"><a href="#cb37-1562" aria-hidden="true" tabindex="-1"></a>MAX_PROFIT <span class="op">=</span> optimal_row[<span class="st">'profit'</span>]</span>
<span id="cb37-1563"><a href="#cb37-1563" aria-hidden="true" tabindex="-1"></a>OPTIMAL_CALLS <span class="op">=</span> optimal_row[<span class="st">'n_calls'</span>]</span>
<span id="cb37-1564"><a href="#cb37-1564" aria-hidden="true" tabindex="-1"></a>OPTIMAL_SQLS <span class="op">=</span> optimal_row[<span class="st">'n_sqls'</span>]</span>
<span id="cb37-1565"><a href="#cb37-1565" aria-hidden="true" tabindex="-1"></a>OPTIMAL_PCT_POP <span class="op">=</span> optimal_row[<span class="st">'pct_population'</span>]</span>
<span id="cb37-1566"><a href="#cb37-1566" aria-hidden="true" tabindex="-1"></a>OPTIMAL_PCT_CAPTURE <span class="op">=</span> optimal_row[<span class="st">'pct_sqls_captured'</span>]</span>
<span id="cb37-1567"><a href="#cb37-1567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1568"><a href="#cb37-1568" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Optimal Profit Configuration:"</span>)</span>
<span id="cb37-1569"><a href="#cb37-1569" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Threshold:       </span><span class="sc">{</span>OPTIMAL_THRESHOLD<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb37-1570"><a href="#cb37-1570" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Max Profit:      $</span><span class="sc">{</span>MAX_PROFIT<span class="sc">:,.0f}</span><span class="ss">"</span>)</span>
<span id="cb37-1571"><a href="#cb37-1571" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Calls Required:  </span><span class="sc">{</span>OPTIMAL_CALLS<span class="sc">:,}</span><span class="ss"> (</span><span class="sc">{</span>OPTIMAL_PCT_POP<span class="sc">:.1%}</span><span class="ss"> of population)"</span>)</span>
<span id="cb37-1572"><a href="#cb37-1572" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  SQLs Captured:   </span><span class="sc">{</span>OPTIMAL_SQLS<span class="sc">:,}</span><span class="ss"> (</span><span class="sc">{</span>OPTIMAL_PCT_CAPTURE<span class="sc">:.1%}</span><span class="ss"> of all SQLs)"</span>)</span>
<span id="cb37-1573"><a href="#cb37-1573" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Lift:            </span><span class="sc">{</span>OPTIMAL_PCT_CAPTURE<span class="op">/</span>OPTIMAL_PCT_POP<span class="sc">:.1f}</span><span class="ss">x over random"</span>)</span>
<span id="cb37-1574"><a href="#cb37-1574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1575"><a href="#cb37-1575" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1576"><a href="#cb37-1576" aria-hidden="true" tabindex="-1"></a><span class="co"># V7 TITAN: WASTE REDUCTION ANALYSIS</span></span>
<span id="cb37-1577"><a href="#cb37-1577" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1578"><a href="#cb37-1578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1579"><a href="#cb37-1579" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-1580"><a href="#cb37-1580" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"V7 TITAN: WASTE REDUCTION ANALYSIS"</span>)</span>
<span id="cb37-1581"><a href="#cb37-1581" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-1582"><a href="#cb37-1582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1583"><a href="#cb37-1583" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate waste from toxic channels</span></span>
<span id="cb37-1584"><a href="#cb37-1584" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'channel_tier'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb37-1585"><a href="#cb37-1585" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get test set indices</span></span>
<span id="cb37-1586"><a href="#cb37-1586" aria-hidden="true" tabindex="-1"></a>    test_indices <span class="op">=</span> X_test.index</span>
<span id="cb37-1587"><a href="#cb37-1587" aria-hidden="true" tabindex="-1"></a>    test_df <span class="op">=</span> df.loc[test_indices].copy()</span>
<span id="cb37-1588"><a href="#cb37-1588" aria-hidden="true" tabindex="-1"></a>    test_df[<span class="st">'test_prob'</span>] <span class="op">=</span> test_probs</span>
<span id="cb37-1589"><a href="#cb37-1589" aria-hidden="true" tabindex="-1"></a>    test_df[<span class="st">'test_actual'</span>] <span class="op">=</span> y_test</span>
<span id="cb37-1590"><a href="#cb37-1590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1591"><a href="#cb37-1591" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Analyze by channel tier</span></span>
<span id="cb37-1592"><a href="#cb37-1592" aria-hidden="true" tabindex="-1"></a>    channel_analysis <span class="op">=</span> test_df.groupby(<span class="st">'channel_tier'</span>).agg({</span>
<span id="cb37-1593"><a href="#cb37-1593" aria-hidden="true" tabindex="-1"></a>        <span class="st">'test_actual'</span>: [<span class="st">'sum'</span>, <span class="st">'count'</span>, <span class="st">'mean'</span>],</span>
<span id="cb37-1594"><a href="#cb37-1594" aria-hidden="true" tabindex="-1"></a>        <span class="st">'test_prob'</span>: <span class="st">'mean'</span></span>
<span id="cb37-1595"><a href="#cb37-1595" aria-hidden="true" tabindex="-1"></a>    }).<span class="bu">round</span>(<span class="dv">3</span>)</span>
<span id="cb37-1596"><a href="#cb37-1596" aria-hidden="true" tabindex="-1"></a>    channel_analysis.columns <span class="op">=</span> [<span class="st">'SQLs'</span>, <span class="st">'Total'</span>, <span class="st">'Conv_Rate'</span>, <span class="st">'Avg_Score'</span>]</span>
<span id="cb37-1597"><a href="#cb37-1597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1598"><a href="#cb37-1598" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Channel Tier Performance (Test Set):"</span>)</span>
<span id="cb37-1599"><a href="#cb37-1599" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(channel_analysis.to_string())</span>
<span id="cb37-1600"><a href="#cb37-1600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1601"><a href="#cb37-1601" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate waste from toxic channels</span></span>
<span id="cb37-1602"><a href="#cb37-1602" aria-hidden="true" tabindex="-1"></a>    toxic_df <span class="op">=</span> test_df[test_df[<span class="st">'channel_tier'</span>] <span class="op">==</span> <span class="st">'Toxic'</span>]</span>
<span id="cb37-1603"><a href="#cb37-1603" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(toxic_df) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb37-1604"><a href="#cb37-1604" aria-hidden="true" tabindex="-1"></a>        toxic_calls <span class="op">=</span> <span class="bu">len</span>(toxic_df)</span>
<span id="cb37-1605"><a href="#cb37-1605" aria-hidden="true" tabindex="-1"></a>        toxic_sqls <span class="op">=</span> toxic_df[<span class="st">'test_actual'</span>].<span class="bu">sum</span>()</span>
<span id="cb37-1606"><a href="#cb37-1606" aria-hidden="true" tabindex="-1"></a>        toxic_cost <span class="op">=</span> toxic_calls <span class="op">*</span> COST_PER_CALL</span>
<span id="cb37-1607"><a href="#cb37-1607" aria-hidden="true" tabindex="-1"></a>        toxic_revenue <span class="op">=</span> toxic_sqls <span class="op">*</span> VALUE_PER_SQL</span>
<span id="cb37-1608"><a href="#cb37-1608" aria-hidden="true" tabindex="-1"></a>        toxic_profit <span class="op">=</span> toxic_revenue <span class="op">-</span> toxic_cost</span>
<span id="cb37-1609"><a href="#cb37-1609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1610"><a href="#cb37-1610" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">TOXIC CHANNEL WASTE:"</span>)</span>
<span id="cb37-1611"><a href="#cb37-1611" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Toxic Calls: </span><span class="sc">{</span>toxic_calls<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb37-1612"><a href="#cb37-1612" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Toxic SQLs: </span><span class="sc">{</span>toxic_sqls<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb37-1613"><a href="#cb37-1613" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Toxic Cost: $</span><span class="sc">{</span>toxic_cost<span class="sc">:,.0f}</span><span class="ss">"</span>)</span>
<span id="cb37-1614"><a href="#cb37-1614" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Toxic Revenue: $</span><span class="sc">{</span>toxic_revenue<span class="sc">:,.0f}</span><span class="ss">"</span>)</span>
<span id="cb37-1615"><a href="#cb37-1615" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Toxic Profit: $</span><span class="sc">{</span>toxic_profit<span class="sc">:,.0f}</span><span class="ss">"</span>)</span>
<span id="cb37-1616"><a href="#cb37-1616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1617"><a href="#cb37-1617" aria-hidden="true" tabindex="-1"></a>        <span class="co"># What if we cut toxic channels?</span></span>
<span id="cb37-1618"><a href="#cb37-1618" aria-hidden="true" tabindex="-1"></a>        non_toxic_df <span class="op">=</span> test_df[test_df[<span class="st">'channel_tier'</span>] <span class="op">!=</span> <span class="st">'Toxic'</span>]</span>
<span id="cb37-1619"><a href="#cb37-1619" aria-hidden="true" tabindex="-1"></a>        non_toxic_profit <span class="op">=</span> non_toxic_df[<span class="st">'test_actual'</span>].<span class="bu">sum</span>() <span class="op">*</span> VALUE_PER_SQL <span class="op">-</span> <span class="bu">len</span>(non_toxic_df) <span class="op">*</span> COST_PER_CALL</span>
<span id="cb37-1620"><a href="#cb37-1620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1621"><a href="#cb37-1621" aria-hidden="true" tabindex="-1"></a>        waste_reduction <span class="op">=</span> toxic_cost <span class="op">-</span> (toxic_sqls <span class="op">*</span> VALUE_PER_SQL)</span>
<span id="cb37-1622"><a href="#cb37-1622" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">  WASTE REDUCTION (by cutting Toxic): $</span><span class="sc">{</span>waste_reduction<span class="sc">:,.0f}</span><span class="ss">"</span>)</span>
<span id="cb37-1623"><a href="#cb37-1623" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-1624"><a href="#cb37-1624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1627"><a href="#cb37-1627" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-1628"><a href="#cb37-1628" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: profit-visualization</span></span>
<span id="cb37-1629"><a href="#cb37-1629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1630"><a href="#cb37-1630" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1631"><a href="#cb37-1631" aria-hidden="true" tabindex="-1"></a><span class="co"># PROFIT CURVE VISUALIZATION</span></span>
<span id="cb37-1632"><a href="#cb37-1632" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1633"><a href="#cb37-1633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1634"><a href="#cb37-1634" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-1635"><a href="#cb37-1635" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"BUSINESS IMPACT TABLE (For PDF Extraction)"</span>)</span>
<span id="cb37-1636"><a href="#cb37-1636" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-1637"><a href="#cb37-1637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1638"><a href="#cb37-1638" aria-hidden="true" tabindex="-1"></a>business_impact_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb37-1639"><a href="#cb37-1639" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Metric'</span>: [<span class="st">'Optimal Threshold'</span>, <span class="st">'Leads to Contact'</span>, <span class="st">'SQLs Captured'</span>,</span>
<span id="cb37-1640"><a href="#cb37-1640" aria-hidden="true" tabindex="-1"></a>               <span class="st">'Contact %'</span>, <span class="st">'Capture %'</span>, <span class="st">'Total Cost'</span>, <span class="st">'Total Revenue'</span>, <span class="st">'Net Profit'</span>],</span>
<span id="cb37-1641"><a href="#cb37-1641" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Value'</span>: [<span class="ss">f'</span><span class="sc">{</span>OPTIMAL_THRESHOLD<span class="sc">:.3f}</span><span class="ss">'</span>, <span class="ss">f'</span><span class="sc">{</span>OPTIMAL_CALLS<span class="sc">:,}</span><span class="ss">'</span>, <span class="ss">f'</span><span class="sc">{</span>OPTIMAL_SQLS<span class="sc">:,}</span><span class="ss">'</span>,</span>
<span id="cb37-1642"><a href="#cb37-1642" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f'</span><span class="sc">{</span>OPTIMAL_PCT_POP<span class="sc">:.1%}</span><span class="ss">'</span>, <span class="ss">f'</span><span class="sc">{</span>OPTIMAL_PCT_CAPTURE<span class="sc">:.1%}</span><span class="ss">'</span>,</span>
<span id="cb37-1643"><a href="#cb37-1643" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f'$</span><span class="sc">{</span>OPTIMAL_CALLS <span class="op">*</span> COST_PER_CALL<span class="sc">:,.0f}</span><span class="ss">'</span>, <span class="ss">f'$</span><span class="sc">{</span>OPTIMAL_SQLS <span class="op">*</span> VALUE_PER_SQL<span class="sc">:,.0f}</span><span class="ss">'</span>,</span>
<span id="cb37-1644"><a href="#cb37-1644" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f'$</span><span class="sc">{</span>MAX_PROFIT<span class="sc">:,.0f}</span><span class="ss">'</span>]</span>
<span id="cb37-1645"><a href="#cb37-1645" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb37-1646"><a href="#cb37-1646" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(business_impact_df.to_markdown(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb37-1647"><a href="#cb37-1647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1648"><a href="#cb37-1648" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">10</span>))</span>
<span id="cb37-1649"><a href="#cb37-1649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1650"><a href="#cb37-1650" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Profit Curve</span></span>
<span id="cb37-1651"><a href="#cb37-1651" aria-hidden="true" tabindex="-1"></a>ax1 <span class="op">=</span> axes[<span class="dv">0</span>, <span class="dv">0</span>]</span>
<span id="cb37-1652"><a href="#cb37-1652" aria-hidden="true" tabindex="-1"></a>ax1.plot(profit_df[<span class="st">'pct_population'</span>] <span class="op">*</span> <span class="dv">100</span>, profit_df[<span class="st">'profit'</span>] <span class="op">/</span> <span class="dv">1000</span>,</span>
<span id="cb37-1653"><a href="#cb37-1653" aria-hidden="true" tabindex="-1"></a>         color<span class="op">=</span>PROJECT_COLS[<span class="st">'Profit'</span>], linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb37-1654"><a href="#cb37-1654" aria-hidden="true" tabindex="-1"></a>ax1.axvline(x<span class="op">=</span>OPTIMAL_PCT_POP <span class="op">*</span> <span class="dv">100</span>, color<span class="op">=</span>PROJECT_COLS[<span class="st">'Gold'</span>], linestyle<span class="op">=</span><span class="st">'--'</span>,</span>
<span id="cb37-1655"><a href="#cb37-1655" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="ss">f'Optimal: </span><span class="sc">{</span>OPTIMAL_PCT_POP<span class="sc">:.1%}</span><span class="ss">'</span>)</span>
<span id="cb37-1656"><a href="#cb37-1656" aria-hidden="true" tabindex="-1"></a>ax1.scatter([OPTIMAL_PCT_POP <span class="op">*</span> <span class="dv">100</span>], [MAX_PROFIT <span class="op">/</span> <span class="dv">1000</span>],</span>
<span id="cb37-1657"><a href="#cb37-1657" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>PROJECT_COLS[<span class="st">'Gold'</span>], s<span class="op">=</span><span class="dv">100</span>, zorder<span class="op">=</span><span class="dv">5</span>, marker<span class="op">=</span><span class="st">'*'</span>)</span>
<span id="cb37-1658"><a href="#cb37-1658" aria-hidden="true" tabindex="-1"></a>ax1.fill_between(profit_df[<span class="st">'pct_population'</span>] <span class="op">*</span> <span class="dv">100</span>, <span class="dv">0</span>, profit_df[<span class="st">'profit'</span>] <span class="op">/</span> <span class="dv">1000</span>,</span>
<span id="cb37-1659"><a href="#cb37-1659" aria-hidden="true" tabindex="-1"></a>                 alpha<span class="op">=</span><span class="fl">0.3</span>, color<span class="op">=</span>PROJECT_COLS[<span class="st">'Profit'</span>])</span>
<span id="cb37-1660"><a href="#cb37-1660" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">'</span><span class="sc">% o</span><span class="st">f Leads Contacted'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb37-1661"><a href="#cb37-1661" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">'Profit ($K)'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb37-1662"><a href="#cb37-1662" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="st">'Profit Curve: Finding the "Money Point"'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-1663"><a href="#cb37-1663" aria-hidden="true" tabindex="-1"></a>ax1.legend()</span>
<span id="cb37-1664"><a href="#cb37-1664" aria-hidden="true" tabindex="-1"></a>ax1.set_xlim(<span class="dv">0</span>, <span class="dv">100</span>)</span>
<span id="cb37-1665"><a href="#cb37-1665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1666"><a href="#cb37-1666" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Cumulative Gains</span></span>
<span id="cb37-1667"><a href="#cb37-1667" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> axes[<span class="dv">0</span>, <span class="dv">1</span>]</span>
<span id="cb37-1668"><a href="#cb37-1668" aria-hidden="true" tabindex="-1"></a>ax2.plot(profit_df[<span class="st">'pct_population'</span>] <span class="op">*</span> <span class="dv">100</span>, profit_df[<span class="st">'pct_sqls_captured'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb37-1669"><a href="#cb37-1669" aria-hidden="true" tabindex="-1"></a>         color<span class="op">=</span>PROJECT_COLS[<span class="st">'Success'</span>], linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'Model'</span>)</span>
<span id="cb37-1670"><a href="#cb37-1670" aria-hidden="true" tabindex="-1"></a>ax2.plot([<span class="dv">0</span>, <span class="dv">100</span>], [<span class="dv">0</span>, <span class="dv">100</span>], <span class="st">'k--'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, label<span class="op">=</span><span class="st">'Random'</span>)</span>
<span id="cb37-1671"><a href="#cb37-1671" aria-hidden="true" tabindex="-1"></a>ax2.axhline(y<span class="op">=</span><span class="dv">90</span>, color<span class="op">=</span>PROJECT_COLS[<span class="st">'Gold'</span>], linestyle<span class="op">=</span><span class="st">':'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span><span class="st">'90% Capture'</span>)</span>
<span id="cb37-1672"><a href="#cb37-1672" aria-hidden="true" tabindex="-1"></a>ax2.fill_between(profit_df[<span class="st">'pct_population'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb37-1673"><a href="#cb37-1673" aria-hidden="true" tabindex="-1"></a>                 profit_df[<span class="st">'pct_population'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb37-1674"><a href="#cb37-1674" aria-hidden="true" tabindex="-1"></a>                 profit_df[<span class="st">'pct_sqls_captured'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb37-1675"><a href="#cb37-1675" aria-hidden="true" tabindex="-1"></a>                 alpha<span class="op">=</span><span class="fl">0.3</span>, color<span class="op">=</span>PROJECT_COLS[<span class="st">'Success'</span>])</span>
<span id="cb37-1676"><a href="#cb37-1676" aria-hidden="true" tabindex="-1"></a>ax2.set_xlabel(<span class="st">'</span><span class="sc">% o</span><span class="st">f Leads Contacted'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb37-1677"><a href="#cb37-1677" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">'</span><span class="sc">% o</span><span class="st">f SQLs Captured'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb37-1678"><a href="#cb37-1678" aria-hidden="true" tabindex="-1"></a>ax2.set_title(<span class="st">'Cumulative Gains Chart'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-1679"><a href="#cb37-1679" aria-hidden="true" tabindex="-1"></a>ax2.legend(loc<span class="op">=</span><span class="st">'lower right'</span>)</span>
<span id="cb37-1680"><a href="#cb37-1680" aria-hidden="true" tabindex="-1"></a>ax2.set_xlim(<span class="dv">0</span>, <span class="dv">100</span>)</span>
<span id="cb37-1681"><a href="#cb37-1681" aria-hidden="true" tabindex="-1"></a>ax2.set_ylim(<span class="dv">0</span>, <span class="dv">100</span>)</span>
<span id="cb37-1682"><a href="#cb37-1682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1683"><a href="#cb37-1683" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Lift Chart</span></span>
<span id="cb37-1684"><a href="#cb37-1684" aria-hidden="true" tabindex="-1"></a>ax3 <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">0</span>]</span>
<span id="cb37-1685"><a href="#cb37-1685" aria-hidden="true" tabindex="-1"></a>ax3.plot(profit_df[<span class="st">'pct_population'</span>] <span class="op">*</span> <span class="dv">100</span>, profit_df[<span class="st">'lift'</span>],</span>
<span id="cb37-1686"><a href="#cb37-1686" aria-hidden="true" tabindex="-1"></a>         color<span class="op">=</span>PROJECT_COLS[<span class="st">'Highlight'</span>], linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb37-1687"><a href="#cb37-1687" aria-hidden="true" tabindex="-1"></a>ax3.axhline(y<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, label<span class="op">=</span><span class="st">'Baseline (1.0x)'</span>)</span>
<span id="cb37-1688"><a href="#cb37-1688" aria-hidden="true" tabindex="-1"></a>ax3.fill_between(profit_df[<span class="st">'pct_population'</span>] <span class="op">*</span> <span class="dv">100</span>, <span class="dv">1</span>, profit_df[<span class="st">'lift'</span>],</span>
<span id="cb37-1689"><a href="#cb37-1689" aria-hidden="true" tabindex="-1"></a>                 where<span class="op">=</span>profit_df[<span class="st">'lift'</span>] <span class="op">&gt;</span> <span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.3</span>, color<span class="op">=</span>PROJECT_COLS[<span class="st">'Success'</span>])</span>
<span id="cb37-1690"><a href="#cb37-1690" aria-hidden="true" tabindex="-1"></a>ax3.set_xlabel(<span class="st">'</span><span class="sc">% o</span><span class="st">f Leads Contacted'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb37-1691"><a href="#cb37-1691" aria-hidden="true" tabindex="-1"></a>ax3.set_ylabel(<span class="st">'Lift (vs Random)'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb37-1692"><a href="#cb37-1692" aria-hidden="true" tabindex="-1"></a>ax3.set_title(<span class="st">'Lift Chart: Predictive Advantage'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-1693"><a href="#cb37-1693" aria-hidden="true" tabindex="-1"></a>ax3.legend()</span>
<span id="cb37-1694"><a href="#cb37-1694" aria-hidden="true" tabindex="-1"></a>ax3.set_xlim(<span class="dv">0</span>, <span class="dv">100</span>)</span>
<span id="cb37-1695"><a href="#cb37-1695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1696"><a href="#cb37-1696" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. ROI by Decile</span></span>
<span id="cb37-1697"><a href="#cb37-1697" aria-hidden="true" tabindex="-1"></a>ax4 <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb37-1698"><a href="#cb37-1698" aria-hidden="true" tabindex="-1"></a>decile_profits <span class="op">=</span> []</span>
<span id="cb37-1699"><a href="#cb37-1699" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb37-1700"><a href="#cb37-1700" aria-hidden="true" tabindex="-1"></a>    start_pct <span class="op">=</span> i <span class="op">*</span> <span class="fl">0.1</span></span>
<span id="cb37-1701"><a href="#cb37-1701" aria-hidden="true" tabindex="-1"></a>    end_pct <span class="op">=</span> (i <span class="op">+</span> <span class="dv">1</span>) <span class="op">*</span> <span class="fl">0.1</span></span>
<span id="cb37-1702"><a href="#cb37-1702" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> (profit_df[<span class="st">'pct_population'</span>] <span class="op">&gt;</span> start_pct) <span class="op">&amp;</span> (profit_df[<span class="st">'pct_population'</span>] <span class="op">&lt;=</span> end_pct)</span>
<span id="cb37-1703"><a href="#cb37-1703" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mask.<span class="bu">any</span>():</span>
<span id="cb37-1704"><a href="#cb37-1704" aria-hidden="true" tabindex="-1"></a>        decile_row <span class="op">=</span> profit_df[mask].iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb37-1705"><a href="#cb37-1705" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb37-1706"><a href="#cb37-1706" aria-hidden="true" tabindex="-1"></a>            decile_profit <span class="op">=</span> decile_row[<span class="st">'profit'</span>]</span>
<span id="cb37-1707"><a href="#cb37-1707" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb37-1708"><a href="#cb37-1708" aria-hidden="true" tabindex="-1"></a>            prev_row <span class="op">=</span> profit_df[profit_df[<span class="st">'pct_population'</span>] <span class="op">&lt;=</span> start_pct].iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb37-1709"><a href="#cb37-1709" aria-hidden="true" tabindex="-1"></a>            decile_profit <span class="op">=</span> decile_row[<span class="st">'profit'</span>] <span class="op">-</span> prev_row[<span class="st">'profit'</span>]</span>
<span id="cb37-1710"><a href="#cb37-1710" aria-hidden="true" tabindex="-1"></a>        decile_profits.append(decile_profit <span class="op">/</span> <span class="dv">1000</span>)</span>
<span id="cb37-1711"><a href="#cb37-1711" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb37-1712"><a href="#cb37-1712" aria-hidden="true" tabindex="-1"></a>        decile_profits.append(<span class="dv">0</span>)</span>
<span id="cb37-1713"><a href="#cb37-1713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1714"><a href="#cb37-1714" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [PROJECT_COLS[<span class="st">'Success'</span>] <span class="cf">if</span> p <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> PROJECT_COLS[<span class="st">'Failure'</span>] <span class="cf">for</span> p <span class="kw">in</span> decile_profits]</span>
<span id="cb37-1715"><a href="#cb37-1715" aria-hidden="true" tabindex="-1"></a>ax4.bar(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">11</span>), decile_profits, color<span class="op">=</span>colors, edgecolor<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb37-1716"><a href="#cb37-1716" aria-hidden="true" tabindex="-1"></a>ax4.axhline(y<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'black'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb37-1717"><a href="#cb37-1717" aria-hidden="true" tabindex="-1"></a>ax4.set_xlabel(<span class="st">'Decile (1 = Highest Score)'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb37-1718"><a href="#cb37-1718" aria-hidden="true" tabindex="-1"></a>ax4.set_ylabel(<span class="st">'Incremental Profit ($K)'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb37-1719"><a href="#cb37-1719" aria-hidden="true" tabindex="-1"></a>ax4.set_title(<span class="st">'Profit by Decile: Where the Money Is'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-1720"><a href="#cb37-1720" aria-hidden="true" tabindex="-1"></a>ax4.set_xticks(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">11</span>))</span>
<span id="cb37-1721"><a href="#cb37-1721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1722"><a href="#cb37-1722" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb37-1723"><a href="#cb37-1723" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb37-1724"><a href="#cb37-1724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1725"><a href="#cb37-1725" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">THE MONEY SLIDE:"</span>)</span>
<span id="cb37-1726"><a href="#cb37-1726" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  By prioritizing leads with Score &gt; </span><span class="sc">{</span>OPTIMAL_THRESHOLD<span class="sc">:.2f}</span><span class="ss">, we capture"</span>)</span>
<span id="cb37-1727"><a href="#cb37-1727" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>OPTIMAL_PCT_CAPTURE<span class="sc">:.0%}</span><span class="ss"> of revenue with </span><span class="sc">{</span>OPTIMAL_PCT_POP<span class="sc">:.0%}</span><span class="ss"> of the effort."</span>)</span>
<span id="cb37-1728"><a href="#cb37-1728" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Maximum Profit: $</span><span class="sc">{</span>MAX_PROFIT<span class="sc">:,.0f}</span><span class="ss">"</span>)</span>
<span id="cb37-1729"><a href="#cb37-1729" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-1730"><a href="#cb37-1730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1731"><a href="#cb37-1731" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb37-1732"><a href="#cb37-1732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1733"><a href="#cb37-1733" aria-hidden="true" tabindex="-1"></a><span class="fu"># Phase 5: Executive Dashboard</span></span>
<span id="cb37-1734"><a href="#cb37-1734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1735"><a href="#cb37-1735" aria-hidden="true" tabindex="-1"></a>**Four Panels for Leadership:** (1) Discriminative power, (2) Imbalanced performance, (3) Profit maximization, (4) Channel tier analysis.</span>
<span id="cb37-1736"><a href="#cb37-1736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1739"><a href="#cb37-1739" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-1740"><a href="#cb37-1740" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: executive-dashboard</span></span>
<span id="cb37-1741"><a href="#cb37-1741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1742"><a href="#cb37-1742" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1743"><a href="#cb37-1743" aria-hidden="true" tabindex="-1"></a><span class="co"># PHASE 5: EXECUTIVE DASHBOARD</span></span>
<span id="cb37-1744"><a href="#cb37-1744" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1745"><a href="#cb37-1745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1746"><a href="#cb37-1746" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-1747"><a href="#cb37-1747" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"EXECUTIVE DASHBOARD"</span>)</span>
<span id="cb37-1748"><a href="#cb37-1748" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-1749"><a href="#cb37-1749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1750"><a href="#cb37-1750" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">MODEL PERFORMANCE METRICS (For PDF Extraction):"</span>)</span>
<span id="cb37-1751"><a href="#cb37-1751" aria-hidden="true" tabindex="-1"></a>dashboard_metrics <span class="op">=</span> pd.DataFrame({</span>
<span id="cb37-1752"><a href="#cb37-1752" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Metric'</span>: [<span class="st">'AUC-ROC'</span>, <span class="st">'Average Precision'</span>, <span class="st">'Brier Score'</span>, <span class="st">'Log Loss'</span>,</span>
<span id="cb37-1753"><a href="#cb37-1753" aria-hidden="true" tabindex="-1"></a>               <span class="st">'Optimal Threshold'</span>, <span class="st">'Max Profit'</span>],</span>
<span id="cb37-1754"><a href="#cb37-1754" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Value'</span>: [<span class="ss">f'</span><span class="sc">{</span>test_auc<span class="sc">:.4f}</span><span class="ss">'</span>, <span class="ss">f'</span><span class="sc">{</span>test_ap<span class="sc">:.4f}</span><span class="ss">'</span>, <span class="ss">f'</span><span class="sc">{</span>test_brier<span class="sc">:.4f}</span><span class="ss">'</span>, <span class="ss">f'</span><span class="sc">{</span>test_logloss<span class="sc">:.4f}</span><span class="ss">'</span>,</span>
<span id="cb37-1755"><a href="#cb37-1755" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f'</span><span class="sc">{</span>OPTIMAL_THRESHOLD<span class="sc">:.3f}</span><span class="ss">'</span>, <span class="ss">f'$</span><span class="sc">{</span>MAX_PROFIT<span class="sc">:,.0f}</span><span class="ss">'</span>]</span>
<span id="cb37-1756"><a href="#cb37-1756" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb37-1757"><a href="#cb37-1757" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(dashboard_metrics.to_markdown(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb37-1758"><a href="#cb37-1758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1759"><a href="#cb37-1759" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">12</span>))</span>
<span id="cb37-1760"><a href="#cb37-1760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1761"><a href="#cb37-1761" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 1: ROC Curve</span></span>
<span id="cb37-1762"><a href="#cb37-1762" aria-hidden="true" tabindex="-1"></a>ax1 <span class="op">=</span> axes[<span class="dv">0</span>, <span class="dv">0</span>]</span>
<span id="cb37-1763"><a href="#cb37-1763" aria-hidden="true" tabindex="-1"></a>fpr, tpr, thresholds <span class="op">=</span> roc_curve(y_test, test_probs)</span>
<span id="cb37-1764"><a href="#cb37-1764" aria-hidden="true" tabindex="-1"></a>ax1.plot(fpr, tpr, color<span class="op">=</span>PROJECT_COLS[<span class="st">'Success'</span>], linewidth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb37-1765"><a href="#cb37-1765" aria-hidden="true" tabindex="-1"></a>         label<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>CHAMPION_NAME<span class="sc">}</span><span class="ss"> (AUC = </span><span class="sc">{</span>FINAL_AUC<span class="sc">:.3f}</span><span class="ss">)'</span>)</span>
<span id="cb37-1766"><a href="#cb37-1766" aria-hidden="true" tabindex="-1"></a>ax1.plot([<span class="dv">0</span>, <span class="dv">1</span>], [<span class="dv">0</span>, <span class="dv">1</span>], <span class="st">'k--'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, label<span class="op">=</span><span class="st">'Random (AUC = 0.500)'</span>)</span>
<span id="cb37-1767"><a href="#cb37-1767" aria-hidden="true" tabindex="-1"></a>ax1.fill_between(fpr, <span class="dv">0</span>, tpr, alpha<span class="op">=</span><span class="fl">0.3</span>, color<span class="op">=</span>PROJECT_COLS[<span class="st">'Success'</span>])</span>
<span id="cb37-1768"><a href="#cb37-1768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1769"><a href="#cb37-1769" aria-hidden="true" tabindex="-1"></a>optimal_idx_roc <span class="op">=</span> np.argmin(np.<span class="bu">abs</span>(thresholds <span class="op">-</span> OPTIMAL_THRESHOLD))</span>
<span id="cb37-1770"><a href="#cb37-1770" aria-hidden="true" tabindex="-1"></a>ax1.scatter([fpr[optimal_idx_roc]], [tpr[optimal_idx_roc]],</span>
<span id="cb37-1771"><a href="#cb37-1771" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>PROJECT_COLS[<span class="st">'Gold'</span>], s<span class="op">=</span><span class="dv">150</span>, marker<span class="op">=</span><span class="st">'*'</span>, zorder<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb37-1772"><a href="#cb37-1772" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="ss">f'Profit-Optimal (t=</span><span class="sc">{</span>OPTIMAL_THRESHOLD<span class="sc">:.2f}</span><span class="ss">)'</span>)</span>
<span id="cb37-1773"><a href="#cb37-1773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1774"><a href="#cb37-1774" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">'False Positive Rate'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb37-1775"><a href="#cb37-1775" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">'True Positive Rate'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb37-1776"><a href="#cb37-1776" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="st">'ROC Curve: Discriminative Power'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-1777"><a href="#cb37-1777" aria-hidden="true" tabindex="-1"></a>ax1.legend(loc<span class="op">=</span><span class="st">'lower right'</span>)</span>
<span id="cb37-1778"><a href="#cb37-1778" aria-hidden="true" tabindex="-1"></a>ax1.set_xlim(<span class="op">-</span><span class="fl">0.02</span>, <span class="fl">1.02</span>)</span>
<span id="cb37-1779"><a href="#cb37-1779" aria-hidden="true" tabindex="-1"></a>ax1.set_ylim(<span class="op">-</span><span class="fl">0.02</span>, <span class="fl">1.02</span>)</span>
<span id="cb37-1780"><a href="#cb37-1780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1781"><a href="#cb37-1781" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> FINAL_AUC <span class="op">&gt;=</span> <span class="fl">0.90</span>:</span>
<span id="cb37-1782"><a href="#cb37-1782" aria-hidden="true" tabindex="-1"></a>    ax1.annotate(<span class="st">'TARGET ACHIEVED!'</span>, xy<span class="op">=</span>(<span class="fl">0.6</span>, <span class="fl">0.3</span>), fontsize<span class="op">=</span><span class="dv">12</span>,</span>
<span id="cb37-1783"><a href="#cb37-1783" aria-hidden="true" tabindex="-1"></a>                 color<span class="op">=</span>PROJECT_COLS[<span class="st">'Success'</span>], fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-1784"><a href="#cb37-1784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1785"><a href="#cb37-1785" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 2: Precision-Recall</span></span>
<span id="cb37-1786"><a href="#cb37-1786" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> axes[<span class="dv">0</span>, <span class="dv">1</span>]</span>
<span id="cb37-1787"><a href="#cb37-1787" aria-hidden="true" tabindex="-1"></a>precision, recall, pr_thresholds <span class="op">=</span> precision_recall_curve(y_test, test_probs)</span>
<span id="cb37-1788"><a href="#cb37-1788" aria-hidden="true" tabindex="-1"></a>ap <span class="op">=</span> average_precision_score(y_test, test_probs)</span>
<span id="cb37-1789"><a href="#cb37-1789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1790"><a href="#cb37-1790" aria-hidden="true" tabindex="-1"></a>ax2.plot(recall, precision, color<span class="op">=</span>PROJECT_COLS[<span class="st">'Highlight'</span>], linewidth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb37-1791"><a href="#cb37-1791" aria-hidden="true" tabindex="-1"></a>         label<span class="op">=</span><span class="ss">f'Model (AP = </span><span class="sc">{</span>ap<span class="sc">:.3f}</span><span class="ss">)'</span>)</span>
<span id="cb37-1792"><a href="#cb37-1792" aria-hidden="true" tabindex="-1"></a>ax2.axhline(y<span class="op">=</span>y_test.mean(), color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb37-1793"><a href="#cb37-1793" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="ss">f'Baseline (</span><span class="sc">{</span>y_test<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss">)'</span>)</span>
<span id="cb37-1794"><a href="#cb37-1794" aria-hidden="true" tabindex="-1"></a>ax2.fill_between(recall, <span class="dv">0</span>, precision, alpha<span class="op">=</span><span class="fl">0.3</span>, color<span class="op">=</span>PROJECT_COLS[<span class="st">'Highlight'</span>])</span>
<span id="cb37-1795"><a href="#cb37-1795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1796"><a href="#cb37-1796" aria-hidden="true" tabindex="-1"></a>ax2.set_xlabel(<span class="st">'Recall (Sensitivity)'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb37-1797"><a href="#cb37-1797" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">'Precision'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb37-1798"><a href="#cb37-1798" aria-hidden="true" tabindex="-1"></a>ax2.set_title(<span class="st">'Precision-Recall: Imbalanced Performance'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-1799"><a href="#cb37-1799" aria-hidden="true" tabindex="-1"></a>ax2.legend(loc<span class="op">=</span><span class="st">'upper right'</span>)</span>
<span id="cb37-1800"><a href="#cb37-1800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1801"><a href="#cb37-1801" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 3: Profit Curve</span></span>
<span id="cb37-1802"><a href="#cb37-1802" aria-hidden="true" tabindex="-1"></a>ax3 <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">0</span>]</span>
<span id="cb37-1803"><a href="#cb37-1803" aria-hidden="true" tabindex="-1"></a>ax3.plot(profit_df[<span class="st">'pct_population'</span>] <span class="op">*</span> <span class="dv">100</span>, profit_df[<span class="st">'profit'</span>] <span class="op">/</span> <span class="dv">1000</span>,</span>
<span id="cb37-1804"><a href="#cb37-1804" aria-hidden="true" tabindex="-1"></a>         color<span class="op">=</span>PROJECT_COLS[<span class="st">'Profit'</span>], linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb37-1805"><a href="#cb37-1805" aria-hidden="true" tabindex="-1"></a>ax3.axvline(x<span class="op">=</span>OPTIMAL_PCT_POP <span class="op">*</span> <span class="dv">100</span>, color<span class="op">=</span>PROJECT_COLS[<span class="st">'Gold'</span>], linestyle<span class="op">=</span><span class="st">'--'</span>,</span>
<span id="cb37-1806"><a href="#cb37-1806" aria-hidden="true" tabindex="-1"></a>            linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="ss">f'Optimal: </span><span class="sc">{</span>OPTIMAL_PCT_POP<span class="sc">:.0%}</span><span class="ss">'</span>)</span>
<span id="cb37-1807"><a href="#cb37-1807" aria-hidden="true" tabindex="-1"></a>ax3.scatter([OPTIMAL_PCT_POP <span class="op">*</span> <span class="dv">100</span>], [MAX_PROFIT <span class="op">/</span> <span class="dv">1000</span>],</span>
<span id="cb37-1808"><a href="#cb37-1808" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>PROJECT_COLS[<span class="st">'Gold'</span>], s<span class="op">=</span><span class="dv">200</span>, marker<span class="op">=</span><span class="st">'*'</span>, zorder<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb37-1809"><a href="#cb37-1809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1810"><a href="#cb37-1810" aria-hidden="true" tabindex="-1"></a>ax3.annotate(<span class="ss">f'Max Profit: $</span><span class="sc">{</span>MAX_PROFIT<span class="sc">:,.0f}</span><span class="ss">'</span>,</span>
<span id="cb37-1811"><a href="#cb37-1811" aria-hidden="true" tabindex="-1"></a>             xy<span class="op">=</span>(OPTIMAL_PCT_POP <span class="op">*</span> <span class="dv">100</span>, MAX_PROFIT <span class="op">/</span> <span class="dv">1000</span>),</span>
<span id="cb37-1812"><a href="#cb37-1812" aria-hidden="true" tabindex="-1"></a>             xytext<span class="op">=</span>(OPTIMAL_PCT_POP <span class="op">*</span> <span class="dv">100</span> <span class="op">+</span> <span class="dv">15</span>, MAX_PROFIT <span class="op">/</span> <span class="dv">1000</span>),</span>
<span id="cb37-1813"><a href="#cb37-1813" aria-hidden="true" tabindex="-1"></a>             fontsize<span class="op">=</span><span class="dv">10</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>,</span>
<span id="cb37-1814"><a href="#cb37-1814" aria-hidden="true" tabindex="-1"></a>             arrowprops<span class="op">=</span><span class="bu">dict</span>(arrowstyle<span class="op">=</span><span class="st">'-&gt;'</span>, color<span class="op">=</span><span class="st">'gray'</span>))</span>
<span id="cb37-1815"><a href="#cb37-1815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1816"><a href="#cb37-1816" aria-hidden="true" tabindex="-1"></a>ax3.fill_between(profit_df[<span class="st">'pct_population'</span>] <span class="op">*</span> <span class="dv">100</span>, <span class="dv">0</span>, profit_df[<span class="st">'profit'</span>] <span class="op">/</span> <span class="dv">1000</span>,</span>
<span id="cb37-1817"><a href="#cb37-1817" aria-hidden="true" tabindex="-1"></a>                 alpha<span class="op">=</span><span class="fl">0.3</span>, color<span class="op">=</span>PROJECT_COLS[<span class="st">'Profit'</span>])</span>
<span id="cb37-1818"><a href="#cb37-1818" aria-hidden="true" tabindex="-1"></a>ax3.set_xlabel(<span class="st">'</span><span class="sc">% o</span><span class="st">f Leads Contacted'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb37-1819"><a href="#cb37-1819" aria-hidden="true" tabindex="-1"></a>ax3.set_ylabel(<span class="st">'Profit ($K)'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb37-1820"><a href="#cb37-1820" aria-hidden="true" tabindex="-1"></a>ax3.set_title(<span class="st">'Profit Maximization: The Business Case'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-1821"><a href="#cb37-1821" aria-hidden="true" tabindex="-1"></a>ax3.legend(loc<span class="op">=</span><span class="st">'upper right'</span>)</span>
<span id="cb37-1822"><a href="#cb37-1822" aria-hidden="true" tabindex="-1"></a>ax3.set_xlim(<span class="dv">0</span>, <span class="dv">100</span>)</span>
<span id="cb37-1823"><a href="#cb37-1823" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1824"><a href="#cb37-1824" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 4: V7 TITAN - Channel Tier Conversion</span></span>
<span id="cb37-1825"><a href="#cb37-1825" aria-hidden="true" tabindex="-1"></a>ax4 <span class="op">=</span> axes[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb37-1826"><a href="#cb37-1826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1827"><a href="#cb37-1827" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'channel_tier'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb37-1828"><a href="#cb37-1828" aria-hidden="true" tabindex="-1"></a>    test_indices <span class="op">=</span> X_test.index</span>
<span id="cb37-1829"><a href="#cb37-1829" aria-hidden="true" tabindex="-1"></a>    test_df_plot <span class="op">=</span> df.loc[test_indices].copy()</span>
<span id="cb37-1830"><a href="#cb37-1830" aria-hidden="true" tabindex="-1"></a>    test_df_plot[<span class="st">'actual'</span>] <span class="op">=</span> y_test</span>
<span id="cb37-1831"><a href="#cb37-1831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1832"><a href="#cb37-1832" aria-hidden="true" tabindex="-1"></a>    channel_conv <span class="op">=</span> test_df_plot.groupby(<span class="st">'channel_tier'</span>)[<span class="st">'actual'</span>].agg([<span class="st">'mean'</span>, <span class="st">'count'</span>])</span>
<span id="cb37-1833"><a href="#cb37-1833" aria-hidden="true" tabindex="-1"></a>    channel_conv <span class="op">=</span> channel_conv.reindex([<span class="st">'Premium'</span>, <span class="st">'Standard'</span>, <span class="st">'Toxic'</span>])</span>
<span id="cb37-1834"><a href="#cb37-1834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1835"><a href="#cb37-1835" aria-hidden="true" tabindex="-1"></a>    tier_colors <span class="op">=</span> [PROJECT_COLS[<span class="st">'Premium'</span>], PROJECT_COLS[<span class="st">'Neutral'</span>], PROJECT_COLS[<span class="st">'Toxic'</span>]]</span>
<span id="cb37-1836"><a href="#cb37-1836" aria-hidden="true" tabindex="-1"></a>    bars <span class="op">=</span> ax4.bar(channel_conv.index, channel_conv[<span class="st">'mean'</span>], color<span class="op">=</span>tier_colors, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb37-1837"><a href="#cb37-1837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1838"><a href="#cb37-1838" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add value labels and count</span></span>
<span id="cb37-1839"><a href="#cb37-1839" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, (idx, row) <span class="kw">in</span> <span class="bu">enumerate</span>(channel_conv.iterrows()):</span>
<span id="cb37-1840"><a href="#cb37-1840" aria-hidden="true" tabindex="-1"></a>        ax4.text(i, row[<span class="st">'mean'</span>] <span class="op">+</span> <span class="fl">0.01</span>, <span class="ss">f'</span><span class="sc">{</span>row[<span class="st">"mean"</span>]<span class="sc">:.1%}</span><span class="ss">'</span>, ha<span class="op">=</span><span class="st">'center'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-1841"><a href="#cb37-1841" aria-hidden="true" tabindex="-1"></a>        ax4.text(i, row[<span class="st">'mean'</span>] <span class="op">/</span> <span class="dv">2</span>, <span class="ss">f'n=</span><span class="sc">{</span><span class="bu">int</span>(row[<span class="st">"count"</span>])<span class="sc">:,}</span><span class="ss">'</span>, ha<span class="op">=</span><span class="st">'center'</span>, color<span class="op">=</span><span class="st">'white'</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb37-1842"><a href="#cb37-1842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1843"><a href="#cb37-1843" aria-hidden="true" tabindex="-1"></a>    ax4.set_ylabel(<span class="st">'Conversion Rate'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb37-1844"><a href="#cb37-1844" aria-hidden="true" tabindex="-1"></a>    ax4.set_xlabel(<span class="st">'Channel Tier'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb37-1845"><a href="#cb37-1845" aria-hidden="true" tabindex="-1"></a>    ax4.set_title(<span class="st">'V7 TITAN: Conversion by Channel Tier'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-1846"><a href="#cb37-1846" aria-hidden="true" tabindex="-1"></a>    ax4.axhline(y<span class="op">=</span>test_df_plot[<span class="st">'actual'</span>].mean(), color<span class="op">=</span><span class="st">'black'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>,</span>
<span id="cb37-1847"><a href="#cb37-1847" aria-hidden="true" tabindex="-1"></a>                alpha<span class="op">=</span><span class="fl">0.5</span>, label<span class="op">=</span><span class="ss">f'Baseline (</span><span class="sc">{</span>test_df_plot[<span class="st">"actual"</span>]<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss">)'</span>)</span>
<span id="cb37-1848"><a href="#cb37-1848" aria-hidden="true" tabindex="-1"></a>    ax4.legend()</span>
<span id="cb37-1849"><a href="#cb37-1849" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb37-1850"><a href="#cb37-1850" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fallback: Feature Importance</span></span>
<span id="cb37-1851"><a href="#cb37-1851" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">hasattr</span>(CHAMPION_MODEL, <span class="st">'feature_importances_'</span>):</span>
<span id="cb37-1852"><a href="#cb37-1852" aria-hidden="true" tabindex="-1"></a>        importances <span class="op">=</span> CHAMPION_MODEL.feature_importances_</span>
<span id="cb37-1853"><a href="#cb37-1853" aria-hidden="true" tabindex="-1"></a>        imp_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb37-1854"><a href="#cb37-1854" aria-hidden="true" tabindex="-1"></a>            <span class="st">'feature'</span>: X_train_te.columns,</span>
<span id="cb37-1855"><a href="#cb37-1855" aria-hidden="true" tabindex="-1"></a>            <span class="st">'importance'</span>: importances</span>
<span id="cb37-1856"><a href="#cb37-1856" aria-hidden="true" tabindex="-1"></a>        }).sort_values(<span class="st">'importance'</span>, ascending<span class="op">=</span><span class="va">True</span>).tail(<span class="dv">15</span>)</span>
<span id="cb37-1857"><a href="#cb37-1857" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1858"><a href="#cb37-1858" aria-hidden="true" tabindex="-1"></a>        ax4.barh(<span class="bu">range</span>(<span class="bu">len</span>(imp_df)), imp_df[<span class="st">'importance'</span>], color<span class="op">=</span>PROJECT_COLS[<span class="st">'Neutral'</span>])</span>
<span id="cb37-1859"><a href="#cb37-1859" aria-hidden="true" tabindex="-1"></a>        ax4.set_yticks(<span class="bu">range</span>(<span class="bu">len</span>(imp_df)))</span>
<span id="cb37-1860"><a href="#cb37-1860" aria-hidden="true" tabindex="-1"></a>        ax4.set_yticklabels(imp_df[<span class="st">'feature'</span>], fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb37-1861"><a href="#cb37-1861" aria-hidden="true" tabindex="-1"></a>        ax4.set_xlabel(<span class="st">'Importance'</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb37-1862"><a href="#cb37-1862" aria-hidden="true" tabindex="-1"></a>        ax4.set_title(<span class="st">'Feature Importance'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-1863"><a href="#cb37-1863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1864"><a href="#cb37-1864" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb37-1865"><a href="#cb37-1865" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="ss">f'V7 Titan Engine: </span><span class="sc">{</span>CHAMPION_NAME<span class="sc">}</span><span class="ss"> Performance Dashboard'</span>,</span>
<span id="cb37-1866"><a href="#cb37-1866" aria-hidden="true" tabindex="-1"></a>             fontsize<span class="op">=</span><span class="dv">14</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, y<span class="op">=</span><span class="fl">1.02</span>)</span>
<span id="cb37-1867"><a href="#cb37-1867" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb37-1868"><a href="#cb37-1868" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-1869"><a href="#cb37-1869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1870"><a href="#cb37-1870" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb37-1871"><a href="#cb37-1871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1872"><a href="#cb37-1872" aria-hidden="true" tabindex="-1"></a><span class="fu"># Phase 6: SHAP Explainability</span></span>
<span id="cb37-1873"><a href="#cb37-1873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1874"><a href="#cb37-1874" aria-hidden="true" tabindex="-1"></a>**Black Box? Not Anymore:** SHAP breaks down every prediction into individual feature contributions.</span>
<span id="cb37-1875"><a href="#cb37-1875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1878"><a href="#cb37-1878" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-1879"><a href="#cb37-1879" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: shap-analysis</span></span>
<span id="cb37-1880"><a href="#cb37-1880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1881"><a href="#cb37-1881" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1882"><a href="#cb37-1882" aria-hidden="true" tabindex="-1"></a><span class="co"># PHASE 6: SHAP EXPLAINABILITY</span></span>
<span id="cb37-1883"><a href="#cb37-1883" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1884"><a href="#cb37-1884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1885"><a href="#cb37-1885" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> SHAP_AVAILABLE:</span>
<span id="cb37-1886"><a href="#cb37-1886" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-1887"><a href="#cb37-1887" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"SHAP EXPLAINABILITY ANALYSIS"</span>)</span>
<span id="cb37-1888"><a href="#cb37-1888" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-1889"><a href="#cb37-1889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1890"><a href="#cb37-1890" aria-hidden="true" tabindex="-1"></a>    np.random.seed(RANDOM_STATE)</span>
<span id="cb37-1891"><a href="#cb37-1891" aria-hidden="true" tabindex="-1"></a>    bg_idx <span class="op">=</span> np.random.choice(<span class="bu">len</span>(X_train_te), <span class="bu">min</span>(SHAP_BACKGROUND_SAMPLES, <span class="bu">len</span>(X_train_te)), replace<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb37-1892"><a href="#cb37-1892" aria-hidden="true" tabindex="-1"></a>    test_idx <span class="op">=</span> np.random.choice(<span class="bu">len</span>(X_test_te), <span class="bu">min</span>(SHAP_TEST_SAMPLES, <span class="bu">len</span>(X_test_te)), replace<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb37-1893"><a href="#cb37-1893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1894"><a href="#cb37-1894" aria-hidden="true" tabindex="-1"></a>    X_bg <span class="op">=</span> X_train_te.iloc[bg_idx]</span>
<span id="cb37-1895"><a href="#cb37-1895" aria-hidden="true" tabindex="-1"></a>    X_explain <span class="op">=</span> X_test_te.iloc[test_idx]</span>
<span id="cb37-1896"><a href="#cb37-1896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1897"><a href="#cb37-1897" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb37-1898"><a href="#cb37-1898" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> CHAMPION_NAME <span class="kw">in</span> [<span class="st">'CatBoost'</span>, <span class="st">'XGBoost'</span>, <span class="st">'LightGBM'</span>, <span class="st">'GradientBoosting'</span>, <span class="st">'RandomForest'</span>]:</span>
<span id="cb37-1899"><a href="#cb37-1899" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> CHAMPION_NAME <span class="op">==</span> <span class="st">'CatBoost'</span> <span class="kw">and</span> <span class="bu">hasattr</span>(CHAMPION_MODEL, <span class="st">'_model'</span>):</span>
<span id="cb37-1900"><a href="#cb37-1900" aria-hidden="true" tabindex="-1"></a>                explainer <span class="op">=</span> shap.TreeExplainer(CHAMPION_MODEL._model)</span>
<span id="cb37-1901"><a href="#cb37-1901" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb37-1902"><a href="#cb37-1902" aria-hidden="true" tabindex="-1"></a>                explainer <span class="op">=</span> shap.TreeExplainer(CHAMPION_MODEL)</span>
<span id="cb37-1903"><a href="#cb37-1903" aria-hidden="true" tabindex="-1"></a>            shap_values <span class="op">=</span> explainer.shap_values(X_explain)</span>
<span id="cb37-1904"><a href="#cb37-1904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1905"><a href="#cb37-1905" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(shap_values, <span class="bu">list</span>):</span>
<span id="cb37-1906"><a href="#cb37-1906" aria-hidden="true" tabindex="-1"></a>                shap_values <span class="op">=</span> shap_values[<span class="dv">1</span>]</span>
<span id="cb37-1907"><a href="#cb37-1907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1908"><a href="#cb37-1908" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> CHAMPION_NAME <span class="op">==</span> <span class="st">'StackingEnsemble'</span>:</span>
<span id="cb37-1909"><a href="#cb37-1909" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Explaining best base estimator..."</span>)</span>
<span id="cb37-1910"><a href="#cb37-1910" aria-hidden="true" tabindex="-1"></a>            best_base_name <span class="op">=</span> top_3_names[<span class="dv">0</span>]</span>
<span id="cb37-1911"><a href="#cb37-1911" aria-hidden="true" tabindex="-1"></a>            best_base_model <span class="op">=</span> best_models[best_base_name]</span>
<span id="cb37-1912"><a href="#cb37-1912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1913"><a href="#cb37-1913" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> best_base_name <span class="op">==</span> <span class="st">'CatBoost'</span> <span class="kw">and</span> <span class="bu">hasattr</span>(best_base_model, <span class="st">'_model'</span>):</span>
<span id="cb37-1914"><a href="#cb37-1914" aria-hidden="true" tabindex="-1"></a>                explainer <span class="op">=</span> shap.TreeExplainer(best_base_model._model)</span>
<span id="cb37-1915"><a href="#cb37-1915" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb37-1916"><a href="#cb37-1916" aria-hidden="true" tabindex="-1"></a>                explainer <span class="op">=</span> shap.TreeExplainer(best_base_model)</span>
<span id="cb37-1917"><a href="#cb37-1917" aria-hidden="true" tabindex="-1"></a>            shap_values <span class="op">=</span> explainer.shap_values(X_explain)</span>
<span id="cb37-1918"><a href="#cb37-1918" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(shap_values, <span class="bu">list</span>):</span>
<span id="cb37-1919"><a href="#cb37-1919" aria-hidden="true" tabindex="-1"></a>                shap_values <span class="op">=</span> shap_values[<span class="dv">1</span>]</span>
<span id="cb37-1920"><a href="#cb37-1920" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"SHAP computed for: </span><span class="sc">{</span>best_base_name<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-1921"><a href="#cb37-1921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1922"><a href="#cb37-1922" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb37-1923"><a href="#cb37-1923" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Using KernelExplainer..."</span>)</span>
<span id="cb37-1924"><a href="#cb37-1924" aria-hidden="true" tabindex="-1"></a>            explainer <span class="op">=</span> shap.KernelExplainer(</span>
<span id="cb37-1925"><a href="#cb37-1925" aria-hidden="true" tabindex="-1"></a>                <span class="kw">lambda</span> x: CHAMPION_MODEL.predict_proba(x)[:, <span class="dv">1</span>],</span>
<span id="cb37-1926"><a href="#cb37-1926" aria-hidden="true" tabindex="-1"></a>                X_bg</span>
<span id="cb37-1927"><a href="#cb37-1927" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb37-1928"><a href="#cb37-1928" aria-hidden="true" tabindex="-1"></a>            shap_values <span class="op">=</span> explainer.shap_values(X_explain, nsamples<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb37-1929"><a href="#cb37-1929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1930"><a href="#cb37-1930" aria-hidden="true" tabindex="-1"></a>        fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>))</span>
<span id="cb37-1931"><a href="#cb37-1931" aria-hidden="true" tabindex="-1"></a>        shap.summary_plot(shap_values, X_explain, plot_type<span class="op">=</span><span class="st">"bar"</span>, show<span class="op">=</span><span class="va">False</span>, max_display<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb37-1932"><a href="#cb37-1932" aria-hidden="true" tabindex="-1"></a>        plt.title(<span class="ss">f'SHAP Feature Importance: </span><span class="sc">{</span>CHAMPION_NAME<span class="sc">}</span><span class="ss">'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-1933"><a href="#cb37-1933" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb37-1934"><a href="#cb37-1934" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb37-1935"><a href="#cb37-1935" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1936"><a href="#cb37-1936" aria-hidden="true" tabindex="-1"></a>        fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">10</span>))</span>
<span id="cb37-1937"><a href="#cb37-1937" aria-hidden="true" tabindex="-1"></a>        shap.summary_plot(shap_values, X_explain, show<span class="op">=</span><span class="va">False</span>, max_display<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb37-1938"><a href="#cb37-1938" aria-hidden="true" tabindex="-1"></a>        plt.title(<span class="ss">f'SHAP Value Distribution'</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>)</span>
<span id="cb37-1939"><a href="#cb37-1939" aria-hidden="true" tabindex="-1"></a>        plt.tight_layout()</span>
<span id="cb37-1940"><a href="#cb37-1940" aria-hidden="true" tabindex="-1"></a>        plt.show()</span>
<span id="cb37-1941"><a href="#cb37-1941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1942"><a href="#cb37-1942" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"SHAP analysis complete."</span>)</span>
<span id="cb37-1943"><a href="#cb37-1943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1944"><a href="#cb37-1944" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb37-1945"><a href="#cb37-1945" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"SHAP analysis failed: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-1946"><a href="#cb37-1946" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Continuing without SHAP visualizations."</span>)</span>
<span id="cb37-1947"><a href="#cb37-1947" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb37-1948"><a href="#cb37-1948" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">SHAP not available. Skipping explainability analysis."</span>)</span>
<span id="cb37-1949"><a href="#cb37-1949" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-1950"><a href="#cb37-1950" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1951"><a href="#cb37-1951" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb37-1952"><a href="#cb37-1952" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1953"><a href="#cb37-1953" aria-hidden="true" tabindex="-1"></a><span class="fu"># The Bottom Line</span></span>
<span id="cb37-1954"><a href="#cb37-1954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1955"><a href="#cb37-1955" aria-hidden="true" tabindex="-1"></a>**Strategic Recommendation:** The V7 Titan Engine delivers domain-optimized predictive power by encoding the "Hidden Gems," correcting for "Toxic Channels," and aligning the algorithm with the financial reality of the buyer.</span>
<span id="cb37-1956"><a href="#cb37-1956" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1959"><a href="#cb37-1959" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-1960"><a href="#cb37-1960" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: bottom-line</span></span>
<span id="cb37-1961"><a href="#cb37-1961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1962"><a href="#cb37-1962" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1963"><a href="#cb37-1963" aria-hidden="true" tabindex="-1"></a><span class="co"># THE BOTTOM LINE</span></span>
<span id="cb37-1964"><a href="#cb37-1964" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-1965"><a href="#cb37-1965" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1966"><a href="#cb37-1966" aria-hidden="true" tabindex="-1"></a>runtime_min <span class="op">=</span> (time.time() <span class="op">-</span> START_TIME) <span class="op">/</span> <span class="dv">60</span></span>
<span id="cb37-1967"><a href="#cb37-1967" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1968"><a href="#cb37-1968" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-1969"><a href="#cb37-1969" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"THE BOTTOM LINE"</span>)</span>
<span id="cb37-1970"><a href="#cb37-1970" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-1971"><a href="#cb37-1971" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1972"><a href="#cb37-1972" aria-hidden="true" tabindex="-1"></a><span class="co"># Revenue projections</span></span>
<span id="cb37-1973"><a href="#cb37-1973" aria-hidden="true" tabindex="-1"></a>baseline_profit <span class="op">=</span> y_test.<span class="bu">sum</span>() <span class="op">*</span> VALUE_PER_SQL <span class="op">-</span> <span class="bu">len</span>(y_test) <span class="op">*</span> COST_PER_CALL</span>
<span id="cb37-1974"><a href="#cb37-1974" aria-hidden="true" tabindex="-1"></a>model_profit <span class="op">=</span> MAX_PROFIT</span>
<span id="cb37-1975"><a href="#cb37-1975" aria-hidden="true" tabindex="-1"></a>monthly_lift <span class="op">=</span> model_profit <span class="op">-</span> baseline_profit</span>
<span id="cb37-1976"><a href="#cb37-1976" aria-hidden="true" tabindex="-1"></a>annualized_lift <span class="op">=</span> monthly_lift <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb37-1977"><a href="#cb37-1977" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1978"><a href="#cb37-1978" aria-hidden="true" tabindex="-1"></a><span class="co"># Hidden Gem analysis</span></span>
<span id="cb37-1979"><a href="#cb37-1979" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'is_hidden_gem'</span> <span class="kw">in</span> X_test.columns:</span>
<span id="cb37-1980"><a href="#cb37-1980" aria-hidden="true" tabindex="-1"></a>    gem_mask <span class="op">=</span> X_test[<span class="st">'is_hidden_gem'</span>] <span class="op">==</span> <span class="dv">1</span></span>
<span id="cb37-1981"><a href="#cb37-1981" aria-hidden="true" tabindex="-1"></a>    gem_conv_rate <span class="op">=</span> y_test[gem_mask.values].mean() <span class="cf">if</span> gem_mask.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb37-1982"><a href="#cb37-1982" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb37-1983"><a href="#cb37-1983" aria-hidden="true" tabindex="-1"></a>    gem_conv_rate <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb37-1984"><a href="#cb37-1984" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1985"><a href="#cb37-1985" aria-hidden="true" tabindex="-1"></a><span class="co"># Channel analysis</span></span>
<span id="cb37-1986"><a href="#cb37-1986" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'channel_tier'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb37-1987"><a href="#cb37-1987" aria-hidden="true" tabindex="-1"></a>    test_indices <span class="op">=</span> X_test.index</span>
<span id="cb37-1988"><a href="#cb37-1988" aria-hidden="true" tabindex="-1"></a>    test_df_final <span class="op">=</span> df.loc[test_indices].copy()</span>
<span id="cb37-1989"><a href="#cb37-1989" aria-hidden="true" tabindex="-1"></a>    test_df_final[<span class="st">'actual'</span>] <span class="op">=</span> y_test</span>
<span id="cb37-1990"><a href="#cb37-1990" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1991"><a href="#cb37-1991" aria-hidden="true" tabindex="-1"></a>    toxic_mask <span class="op">=</span> test_df_final[<span class="st">'channel_tier'</span>] <span class="op">==</span> <span class="st">'Toxic'</span></span>
<span id="cb37-1992"><a href="#cb37-1992" aria-hidden="true" tabindex="-1"></a>    toxic_conv <span class="op">=</span> test_df_final[toxic_mask][<span class="st">'actual'</span>].mean() <span class="cf">if</span> toxic_mask.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb37-1993"><a href="#cb37-1993" aria-hidden="true" tabindex="-1"></a>    toxic_count <span class="op">=</span> toxic_mask.<span class="bu">sum</span>()</span>
<span id="cb37-1994"><a href="#cb37-1994" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1995"><a href="#cb37-1995" aria-hidden="true" tabindex="-1"></a>    premium_mask <span class="op">=</span> test_df_final[<span class="st">'channel_tier'</span>] <span class="op">==</span> <span class="st">'Premium'</span></span>
<span id="cb37-1996"><a href="#cb37-1996" aria-hidden="true" tabindex="-1"></a>    premium_conv <span class="op">=</span> test_df_final[premium_mask][<span class="st">'actual'</span>].mean() <span class="cf">if</span> premium_mask.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb37-1997"><a href="#cb37-1997" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb37-1998"><a href="#cb37-1998" aria-hidden="true" tabindex="-1"></a>    toxic_conv <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb37-1999"><a href="#cb37-1999" aria-hidden="true" tabindex="-1"></a>    toxic_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb37-2000"><a href="#cb37-2000" aria-hidden="true" tabindex="-1"></a>    premium_conv <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb37-2001"><a href="#cb37-2001" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2002"><a href="#cb37-2002" aria-hidden="true" tabindex="-1"></a><span class="co"># Golden segment</span></span>
<span id="cb37-2003"><a href="#cb37-2003" aria-hidden="true" tabindex="-1"></a>top_decile_mask <span class="op">=</span> test_probs <span class="op">&gt;=</span> np.percentile(test_probs, <span class="dv">90</span>)</span>
<span id="cb37-2004"><a href="#cb37-2004" aria-hidden="true" tabindex="-1"></a>golden_segment_rate <span class="op">=</span> y_test[top_decile_mask].mean() <span class="cf">if</span> top_decile_mask.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb37-2005"><a href="#cb37-2005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2006"><a href="#cb37-2006" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"""</span></span>
<span id="cb37-2007"><a href="#cb37-2007" aria-hidden="true" tabindex="-1"></a><span class="ss">================================================================================</span></span>
<span id="cb37-2008"><a href="#cb37-2008" aria-hidden="true" tabindex="-1"></a><span class="ss">V7 TITAN: STRATEGIC RECOMMENDATION</span></span>
<span id="cb37-2009"><a href="#cb37-2009" aria-hidden="true" tabindex="-1"></a><span class="ss">================================================================================</span></span>
<span id="cb37-2010"><a href="#cb37-2010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2011"><a href="#cb37-2011" aria-hidden="true" tabindex="-1"></a><span class="ss">The V7 Titan Engine delivers a projected $</span><span class="sc">{</span>annualized_lift<span class="sc">:,.0f}</span><span class="ss"> annualized revenue lift</span></span>
<span id="cb37-2012"><a href="#cb37-2012" aria-hidden="true" tabindex="-1"></a><span class="ss">by encoding domain expertise into the algorithm.</span></span>
<span id="cb37-2013"><a href="#cb37-2013" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2014"><a href="#cb37-2014" aria-hidden="true" tabindex="-1"></a><span class="ss">MODEL PERFORMANCE:</span></span>
<span id="cb37-2015"><a href="#cb37-2015" aria-hidden="true" tabindex="-1"></a><span class="ss">  - AUC-ROC:          </span><span class="sc">{</span>FINAL_AUC<span class="sc">:.4f}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'[TARGET MET]'</span> <span class="cf">if</span> FINAL_AUC <span class="op">&gt;=</span> <span class="fl">0.90</span> <span class="cf">else</span> <span class="ss">f'(Target: 0.90, Gap: </span><span class="sc">{</span><span class="fl">0.90</span> <span class="op">-</span> FINAL_AUC<span class="sc">:.4f}</span><span class="ss">)'</span><span class="sc">}</span></span>
<span id="cb37-2016"><a href="#cb37-2016" aria-hidden="true" tabindex="-1"></a><span class="ss">  - Average Precision: </span><span class="sc">{</span>test_ap<span class="sc">:.4f}</span></span>
<span id="cb37-2017"><a href="#cb37-2017" aria-hidden="true" tabindex="-1"></a><span class="ss">  - Champion:         </span><span class="sc">{</span>CHAMPION_NAME<span class="sc">}</span></span>
<span id="cb37-2018"><a href="#cb37-2018" aria-hidden="true" tabindex="-1"></a><span class="ss">  - Validation:       5-fold CV (robust generalization)</span></span>
<span id="cb37-2019"><a href="#cb37-2019" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2020"><a href="#cb37-2020" aria-hidden="true" tabindex="-1"></a><span class="ss">NET REVENUE IMPACT:</span></span>
<span id="cb37-2021"><a href="#cb37-2021" aria-hidden="true" tabindex="-1"></a><span class="ss">  - Optimal Threshold:  Score &gt; </span><span class="sc">{</span>OPTIMAL_THRESHOLD<span class="sc">:.3f}</span></span>
<span id="cb37-2022"><a href="#cb37-2022" aria-hidden="true" tabindex="-1"></a><span class="ss">  - Maximum Profit:     $</span><span class="sc">{</span>MAX_PROFIT<span class="sc">:,.0f}</span></span>
<span id="cb37-2023"><a href="#cb37-2023" aria-hidden="true" tabindex="-1"></a><span class="ss">  - Capture Rate:       </span><span class="sc">{</span>OPTIMAL_PCT_CAPTURE<span class="sc">:.0%}</span><span class="ss"> of SQLs with </span><span class="sc">{</span>OPTIMAL_PCT_POP<span class="sc">:.0%}</span><span class="ss"> of calls</span></span>
<span id="cb37-2024"><a href="#cb37-2024" aria-hidden="true" tabindex="-1"></a><span class="ss">  - ROI per Call:       $</span><span class="sc">{</span>(MAX_PROFIT <span class="op">/</span> OPTIMAL_CALLS)<span class="sc">:.2f}</span></span>
<span id="cb37-2025"><a href="#cb37-2025" aria-hidden="true" tabindex="-1"></a><span class="ss">  - Annualized Lift:    $</span><span class="sc">{</span>annualized_lift<span class="sc">:,.0f}</span></span>
<span id="cb37-2026"><a href="#cb37-2026" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2027"><a href="#cb37-2027" aria-hidden="true" tabindex="-1"></a><span class="ss">================================================================================</span></span>
<span id="cb37-2028"><a href="#cb37-2028" aria-hidden="true" tabindex="-1"></a><span class="ss">IMMEDIATE ACTIONS (The "Yield Gap" Strategy)</span></span>
<span id="cb37-2029"><a href="#cb37-2029" aria-hidden="true" tabindex="-1"></a><span class="ss">================================================================================</span></span>
<span id="cb37-2030"><a href="#cb37-2030" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2031"><a href="#cb37-2031" aria-hidden="true" tabindex="-1"></a><span class="ss">1. CUT THE TAIL: Deprioritize "External Demand Gen" leads immediately.</span></span>
<span id="cb37-2032"><a href="#cb37-2032" aria-hidden="true" tabindex="-1"></a><span class="ss">   - Toxic Channel Conversion: </span><span class="sc">{</span>toxic_conv<span class="sc">:.1%}</span></span>
<span id="cb37-2033"><a href="#cb37-2033" aria-hidden="true" tabindex="-1"></a><span class="ss">   - Toxic Channel Volume: </span><span class="sc">{</span>toxic_count<span class="sc">:,}</span><span class="ss"> leads</span></span>
<span id="cb37-2034"><a href="#cb37-2034" aria-hidden="true" tabindex="-1"></a><span class="ss">   - Action: Stop working these leads. They cost more than they return.</span></span>
<span id="cb37-2035"><a href="#cb37-2035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2036"><a href="#cb37-2036" aria-hidden="true" tabindex="-1"></a><span class="ss">2. MINE THE GEMS: Route "Non-Manufacturing" and "Not Enough Info" accounts</span></span>
<span id="cb37-2037"><a href="#cb37-2037" aria-hidden="true" tabindex="-1"></a><span class="ss">   to senior reps.</span></span>
<span id="cb37-2038"><a href="#cb37-2038" aria-hidden="true" tabindex="-1"></a><span class="ss">   - Hidden Gem Conversion Rate: </span><span class="sc">{</span>gem_conv_rate<span class="sc">:.1%}</span></span>
<span id="cb37-2039"><a href="#cb37-2039" aria-hidden="true" tabindex="-1"></a><span class="ss">   - These are agile consultants/small firms that typical scoring misses.</span></span>
<span id="cb37-2040"><a href="#cb37-2040" aria-hidden="true" tabindex="-1"></a><span class="ss">   - Action: Prioritize these for immediate outreach.</span></span>
<span id="cb37-2041"><a href="#cb37-2041" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2042"><a href="#cb37-2042" aria-hidden="true" tabindex="-1"></a><span class="ss">3. SMART ROUTING: Use the Intent Score to differentiate urgency.</span></span>
<span id="cb37-2043"><a href="#cb37-2043" aria-hidden="true" tabindex="-1"></a><span class="ss">   - "Contact Us" P1 = HIGH urgency (Score: 5)</span></span>
<span id="cb37-2044"><a href="#cb37-2044" aria-hidden="true" tabindex="-1"></a><span class="ss">   - "Webinar" P1 = LOW urgency (Score: 1)</span></span>
<span id="cb37-2045"><a href="#cb37-2045" aria-hidden="true" tabindex="-1"></a><span class="ss">   - Action: Route high-intent leads to closers, not nurturers.</span></span>
<span id="cb37-2046"><a href="#cb37-2046" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2047"><a href="#cb37-2047" aria-hidden="true" tabindex="-1"></a><span class="ss">4. PREMIUM CHANNEL FOCUS:</span></span>
<span id="cb37-2048"><a href="#cb37-2048" aria-hidden="true" tabindex="-1"></a><span class="ss">   - Premium Channel Conversion: </span><span class="sc">{</span>premium_conv<span class="sc">:.1%}</span></span>
<span id="cb37-2049"><a href="#cb37-2049" aria-hidden="true" tabindex="-1"></a><span class="ss">   - Invest in SEO and Direct/Inbound acquisition.</span></span>
<span id="cb37-2050"><a href="#cb37-2050" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2051"><a href="#cb37-2051" aria-hidden="true" tabindex="-1"></a><span class="ss">================================================================================</span></span>
<span id="cb37-2052"><a href="#cb37-2052" aria-hidden="true" tabindex="-1"></a><span class="ss">OUTBOUND "HIT LIST" STRATEGY (For Sales VP)</span></span>
<span id="cb37-2053"><a href="#cb37-2053" aria-hidden="true" tabindex="-1"></a><span class="ss">================================================================================</span></span>
<span id="cb37-2054"><a href="#cb37-2054" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2055"><a href="#cb37-2055" aria-hidden="true" tabindex="-1"></a><span class="ss">MasterControl should immediately purchase contact lists matching:</span></span>
<span id="cb37-2056"><a href="#cb37-2056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2057"><a href="#cb37-2057" aria-hidden="true" tabindex="-1"></a><span class="ss">  ROLE:    Directors, VPs, Senior Decision Makers</span></span>
<span id="cb37-2058"><a href="#cb37-2058" aria-hidden="true" tabindex="-1"></a><span class="ss">  SECTOR:  Pharma &amp; BioTech, Life Sciences</span></span>
<span id="cb37-2059"><a href="#cb37-2059" aria-hidden="true" tabindex="-1"></a><span class="ss">  SCOPE:   Global / Corporate (not Site-level)</span></span>
<span id="cb37-2060"><a href="#cb37-2060" aria-hidden="true" tabindex="-1"></a><span class="ss">  MODEL:   In-House Manufacturing operations</span></span>
<span id="cb37-2061"><a href="#cb37-2061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2062"><a href="#cb37-2062" aria-hidden="true" tabindex="-1"></a><span class="ss">  Golden Segment Conversion Rate: </span><span class="sc">{</span>golden_segment_rate<span class="sc">:.1%}</span></span>
<span id="cb37-2063"><a href="#cb37-2063" aria-hidden="true" tabindex="-1"></a><span class="ss">  (vs. Baseline: </span><span class="sc">{</span>y_test<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss">)</span></span>
<span id="cb37-2064"><a href="#cb37-2064" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2065"><a href="#cb37-2065" aria-hidden="true" tabindex="-1"></a><span class="ss">The model confidently identifies the BOTTOM 50% of the funnel as "Noise."</span></span>
<span id="cb37-2066"><a href="#cb37-2066" aria-hidden="true" tabindex="-1"></a><span class="ss">Stop calling them. Focus 100% of Sales energy on the Golden Segments.</span></span>
<span id="cb37-2067"><a href="#cb37-2067" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2068"><a href="#cb37-2068" aria-hidden="true" tabindex="-1"></a><span class="ss">================================================================================</span></span>
<span id="cb37-2069"><a href="#cb37-2069" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2070"><a href="#cb37-2070" aria-hidden="true" tabindex="-1"></a><span class="ss">IMPLEMENTATION CHECKLIST:</span></span>
<span id="cb37-2071"><a href="#cb37-2071" aria-hidden="true" tabindex="-1"></a><span class="ss">  1. Deploy scoring engine to CRM (threshold: </span><span class="sc">{</span>OPTIMAL_THRESHOLD<span class="sc">:.2f}</span><span class="ss">)</span></span>
<span id="cb37-2072"><a href="#cb37-2072" aria-hidden="true" tabindex="-1"></a><span class="ss">  2. Create "Toxic" flag in CRM for External Demand Gen / Email sources</span></span>
<span id="cb37-2073"><a href="#cb37-2073" aria-hidden="true" tabindex="-1"></a><span class="ss">  3. Create "Hidden Gem" flag for Non-Manufacturing accounts</span></span>
<span id="cb37-2074"><a href="#cb37-2074" aria-hidden="true" tabindex="-1"></a><span class="ss">  4. Route high-score leads (&gt;</span><span class="sc">{</span>OPTIMAL_THRESHOLD<span class="sc">:.2f}</span><span class="ss">) to senior reps</span></span>
<span id="cb37-2075"><a href="#cb37-2075" aria-hidden="true" tabindex="-1"></a><span class="ss">  5. Purchase outbound lists matching the Hit List profile</span></span>
<span id="cb37-2076"><a href="#cb37-2076" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2077"><a href="#cb37-2077" aria-hidden="true" tabindex="-1"></a><span class="ss">Runtime: </span><span class="sc">{</span>runtime_min<span class="sc">:.1f}</span><span class="ss"> minutes</span></span>
<span id="cb37-2078"><a href="#cb37-2078" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span>)</span>
<span id="cb37-2079"><a href="#cb37-2079" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2080"><a href="#cb37-2080" aria-hidden="true" tabindex="-1"></a><span class="co"># Final summary table</span></span>
<span id="cb37-2081"><a href="#cb37-2081" aria-hidden="true" tabindex="-1"></a>summary_data <span class="op">=</span> {</span>
<span id="cb37-2082"><a href="#cb37-2082" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Metric'</span>: [<span class="st">'AUC-ROC'</span>, <span class="st">'Average Precision'</span>, <span class="st">'Optimal Threshold'</span>, <span class="st">'Max Profit'</span>,</span>
<span id="cb37-2083"><a href="#cb37-2083" aria-hidden="true" tabindex="-1"></a>               <span class="st">'Annualized Revenue Lift'</span>, <span class="st">'Calls Required'</span>, <span class="st">'SQLs Captured'</span>,</span>
<span id="cb37-2084"><a href="#cb37-2084" aria-hidden="true" tabindex="-1"></a>               <span class="st">'Predictive Lift'</span>, <span class="st">'Hidden Gem Conv Rate'</span>, <span class="st">'Toxic Channel Conv Rate'</span>],</span>
<span id="cb37-2085"><a href="#cb37-2085" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Value'</span>: [<span class="ss">f'</span><span class="sc">{</span>FINAL_AUC<span class="sc">:.4f}</span><span class="ss">'</span>, <span class="ss">f'</span><span class="sc">{</span>test_ap<span class="sc">:.4f}</span><span class="ss">'</span>, <span class="ss">f'</span><span class="sc">{</span>OPTIMAL_THRESHOLD<span class="sc">:.3f}</span><span class="ss">'</span>,</span>
<span id="cb37-2086"><a href="#cb37-2086" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f'$</span><span class="sc">{</span>MAX_PROFIT<span class="sc">:,.0f}</span><span class="ss">'</span>, <span class="ss">f'$</span><span class="sc">{</span>annualized_lift<span class="sc">:,.0f}</span><span class="ss">'</span>, <span class="ss">f'</span><span class="sc">{</span>OPTIMAL_CALLS<span class="sc">:,}</span><span class="ss">'</span>,</span>
<span id="cb37-2087"><a href="#cb37-2087" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f'</span><span class="sc">{</span>OPTIMAL_SQLS<span class="sc">:,}</span><span class="ss"> (</span><span class="sc">{</span>OPTIMAL_PCT_CAPTURE<span class="sc">:.0%}</span><span class="ss">)'</span>,</span>
<span id="cb37-2088"><a href="#cb37-2088" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f'</span><span class="sc">{</span>OPTIMAL_PCT_CAPTURE<span class="op">/</span>OPTIMAL_PCT_POP<span class="sc">:.1f}</span><span class="ss">x'</span>, <span class="ss">f'</span><span class="sc">{</span>gem_conv_rate<span class="sc">:.1%}</span><span class="ss">'</span>,</span>
<span id="cb37-2089"><a href="#cb37-2089" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f'</span><span class="sc">{</span>toxic_conv<span class="sc">:.1%}</span><span class="ss">'</span>]</span>
<span id="cb37-2090"><a href="#cb37-2090" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-2091"><a href="#cb37-2091" aria-hidden="true" tabindex="-1"></a>summary_df <span class="op">=</span> pd.DataFrame(summary_data)</span>
<span id="cb37-2092"><a href="#cb37-2092" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">FINAL SUMMARY TABLE (For PDF Extraction):"</span>)</span>
<span id="cb37-2093"><a href="#cb37-2093" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(summary_df.to_markdown(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb37-2094"><a href="#cb37-2094" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-2095"><a href="#cb37-2095" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2096"><a href="#cb37-2096" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb37-2097"><a href="#cb37-2097" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2098"><a href="#cb37-2098" aria-hidden="true" tabindex="-1"></a><span class="fu"># Phase 9: Sponsor Q&amp;A Data Validation</span></span>
<span id="cb37-2099"><a href="#cb37-2099" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2100"><a href="#cb37-2100" aria-hidden="true" tabindex="-1"></a>**Purpose:** Programmatically validate every strategic claim before the sponsor meeting. No guessing---just data.</span>
<span id="cb37-2101"><a href="#cb37-2101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2104"><a href="#cb37-2104" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-2105"><a href="#cb37-2105" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: sponsor-qa-validation</span></span>
<span id="cb37-2106"><a href="#cb37-2106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2107"><a href="#cb37-2107" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-2108"><a href="#cb37-2108" aria-hidden="true" tabindex="-1"></a><span class="co"># PHASE 9: SPONSOR Q&amp;A DATA VALIDATION</span></span>
<span id="cb37-2109"><a href="#cb37-2109" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-2110"><a href="#cb37-2110" aria-hidden="true" tabindex="-1"></a><span class="co"># This section calculates the ACTUAL conversion rates and lifts for each</span></span>
<span id="cb37-2111"><a href="#cb37-2111" aria-hidden="true" tabindex="-1"></a><span class="co"># strategic question that may arise in the sponsor meeting.</span></span>
<span id="cb37-2112"><a href="#cb37-2112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2113"><a href="#cb37-2113" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-2114"><a href="#cb37-2114" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"PHASE 9: SPONSOR Q&amp;A DATA VALIDATION"</span>)</span>
<span id="cb37-2115"><a href="#cb37-2115" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-2116"><a href="#cb37-2116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2117"><a href="#cb37-2117" aria-hidden="true" tabindex="-1"></a><span class="co"># Create validation dataframe (test set with original features)</span></span>
<span id="cb37-2118"><a href="#cb37-2118" aria-hidden="true" tabindex="-1"></a>test_indices <span class="op">=</span> X_test.index</span>
<span id="cb37-2119"><a href="#cb37-2119" aria-hidden="true" tabindex="-1"></a>validation_df <span class="op">=</span> df.loc[test_indices].copy()</span>
<span id="cb37-2120"><a href="#cb37-2120" aria-hidden="true" tabindex="-1"></a>validation_df[<span class="st">'actual_outcome'</span>] <span class="op">=</span> y_test</span>
<span id="cb37-2121"><a href="#cb37-2121" aria-hidden="true" tabindex="-1"></a>validation_df[<span class="st">'model_score'</span>] <span class="op">=</span> test_probs</span>
<span id="cb37-2122"><a href="#cb37-2122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2123"><a href="#cb37-2123" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate baseline conversion rate</span></span>
<span id="cb37-2124"><a href="#cb37-2124" aria-hidden="true" tabindex="-1"></a>baseline_conv <span class="op">=</span> validation_df[<span class="st">'actual_outcome'</span>].mean()</span>
<span id="cb37-2125"><a href="#cb37-2125" aria-hidden="true" tabindex="-1"></a>baseline_n <span class="op">=</span> <span class="bu">len</span>(validation_df)</span>
<span id="cb37-2126"><a href="#cb37-2126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2127"><a href="#cb37-2127" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Baseline: </span><span class="sc">{</span>baseline_conv<span class="sc">:.1%}</span><span class="ss"> conversion (</span><span class="sc">{</span>baseline_n<span class="sc">:,}</span><span class="ss"> leads in test set)"</span>)</span>
<span id="cb37-2128"><a href="#cb37-2128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2129"><a href="#cb37-2129" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-2130"><a href="#cb37-2130" aria-hidden="true" tabindex="-1"></a><span class="co"># Q1: Is External Demand Gen "Toxic"?</span></span>
<span id="cb37-2131"><a href="#cb37-2131" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-2132"><a href="#cb37-2132" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb37-2133"><a href="#cb37-2133" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Q1: Are 'Toxic' channels (External Demand Gen, Email) dragging us down?"</span>)</span>
<span id="cb37-2134"><a href="#cb37-2134" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb37-2135"><a href="#cb37-2135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2136"><a href="#cb37-2136" aria-hidden="true" tabindex="-1"></a>q1_evidence <span class="op">=</span> <span class="st">""</span></span>
<span id="cb37-2137"><a href="#cb37-2137" aria-hidden="true" tabindex="-1"></a>q1_verdict <span class="op">=</span> <span class="st">""</span></span>
<span id="cb37-2138"><a href="#cb37-2138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2139"><a href="#cb37-2139" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'channel_tier'</span> <span class="kw">in</span> validation_df.columns:</span>
<span id="cb37-2140"><a href="#cb37-2140" aria-hidden="true" tabindex="-1"></a>    toxic_df <span class="op">=</span> validation_df[validation_df[<span class="st">'channel_tier'</span>] <span class="op">==</span> <span class="st">'Toxic'</span>]</span>
<span id="cb37-2141"><a href="#cb37-2141" aria-hidden="true" tabindex="-1"></a>    premium_df <span class="op">=</span> validation_df[validation_df[<span class="st">'channel_tier'</span>] <span class="op">==</span> <span class="st">'Premium'</span>]</span>
<span id="cb37-2142"><a href="#cb37-2142" aria-hidden="true" tabindex="-1"></a>    standard_df <span class="op">=</span> validation_df[validation_df[<span class="st">'channel_tier'</span>] <span class="op">==</span> <span class="st">'Standard'</span>]</span>
<span id="cb37-2143"><a href="#cb37-2143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2144"><a href="#cb37-2144" aria-hidden="true" tabindex="-1"></a>    toxic_conv <span class="op">=</span> toxic_df[<span class="st">'actual_outcome'</span>].mean() <span class="cf">if</span> <span class="bu">len</span>(toxic_df) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb37-2145"><a href="#cb37-2145" aria-hidden="true" tabindex="-1"></a>    toxic_n <span class="op">=</span> <span class="bu">len</span>(toxic_df)</span>
<span id="cb37-2146"><a href="#cb37-2146" aria-hidden="true" tabindex="-1"></a>    premium_conv <span class="op">=</span> premium_df[<span class="st">'actual_outcome'</span>].mean() <span class="cf">if</span> <span class="bu">len</span>(premium_df) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb37-2147"><a href="#cb37-2147" aria-hidden="true" tabindex="-1"></a>    premium_n <span class="op">=</span> <span class="bu">len</span>(premium_df)</span>
<span id="cb37-2148"><a href="#cb37-2148" aria-hidden="true" tabindex="-1"></a>    standard_conv <span class="op">=</span> standard_df[<span class="st">'actual_outcome'</span>].mean() <span class="cf">if</span> <span class="bu">len</span>(standard_df) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb37-2149"><a href="#cb37-2149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2150"><a href="#cb37-2150" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate waste</span></span>
<span id="cb37-2151"><a href="#cb37-2151" aria-hidden="true" tabindex="-1"></a>    toxic_cost <span class="op">=</span> toxic_n <span class="op">*</span> COST_PER_CALL</span>
<span id="cb37-2152"><a href="#cb37-2152" aria-hidden="true" tabindex="-1"></a>    toxic_sqls <span class="op">=</span> toxic_df[<span class="st">'actual_outcome'</span>].<span class="bu">sum</span>()</span>
<span id="cb37-2153"><a href="#cb37-2153" aria-hidden="true" tabindex="-1"></a>    toxic_revenue <span class="op">=</span> toxic_sqls <span class="op">*</span> VALUE_PER_SQL</span>
<span id="cb37-2154"><a href="#cb37-2154" aria-hidden="true" tabindex="-1"></a>    toxic_loss <span class="op">=</span> toxic_cost <span class="op">-</span> toxic_revenue</span>
<span id="cb37-2155"><a href="#cb37-2155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2156"><a href="#cb37-2156" aria-hidden="true" tabindex="-1"></a>    q1_evidence <span class="op">=</span> <span class="ss">f"Toxic: </span><span class="sc">{</span>toxic_conv<span class="sc">:.1%}</span><span class="ss"> (n=</span><span class="sc">{</span>toxic_n<span class="sc">:,}</span><span class="ss">) vs Premium: </span><span class="sc">{</span>premium_conv<span class="sc">:.1%}</span><span class="ss">"</span></span>
<span id="cb37-2157"><a href="#cb37-2157" aria-hidden="true" tabindex="-1"></a>    q1_verdict <span class="op">=</span> <span class="st">"YES - Cut immediately"</span> <span class="cf">if</span> toxic_conv <span class="op">&lt;</span> baseline_conv <span class="op">*</span> <span class="fl">0.5</span> <span class="cf">else</span> <span class="st">"MONITOR"</span></span>
<span id="cb37-2158"><a href="#cb37-2158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2159"><a href="#cb37-2159" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Toxic Channel Conv: </span><span class="sc">{</span>toxic_conv<span class="sc">:.1%}</span><span class="ss"> (n=</span><span class="sc">{</span>toxic_n<span class="sc">:,}</span><span class="ss">)"</span>)</span>
<span id="cb37-2160"><a href="#cb37-2160" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Premium Channel Conv: </span><span class="sc">{</span>premium_conv<span class="sc">:.1%}</span><span class="ss"> (n=</span><span class="sc">{</span>premium_n<span class="sc">:,}</span><span class="ss">)"</span>)</span>
<span id="cb37-2161"><a href="#cb37-2161" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Standard Channel Conv: </span><span class="sc">{</span>standard_conv<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb37-2162"><a href="#cb37-2162" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Baseline Conv: </span><span class="sc">{</span>baseline_conv<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb37-2163"><a href="#cb37-2163" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Toxic Waste: $</span><span class="sc">{</span>toxic_loss<span class="sc">:,.0f}</span><span class="ss"> (cost minus revenue)"</span>)</span>
<span id="cb37-2164"><a href="#cb37-2164" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  VERDICT: </span><span class="sc">{</span>q1_verdict<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-2165"><a href="#cb37-2165" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb37-2166"><a href="#cb37-2166" aria-hidden="true" tabindex="-1"></a>    q1_evidence <span class="op">=</span> <span class="st">"Channel data unavailable"</span></span>
<span id="cb37-2167"><a href="#cb37-2167" aria-hidden="true" tabindex="-1"></a>    q1_verdict <span class="op">=</span> <span class="st">"CANNOT EVALUATE"</span></span>
<span id="cb37-2168"><a href="#cb37-2168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2169"><a href="#cb37-2169" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-2170"><a href="#cb37-2170" aria-hidden="true" tabindex="-1"></a><span class="co"># Q2: Do "Recycled" (Stale) leads convert?</span></span>
<span id="cb37-2171"><a href="#cb37-2171" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-2172"><a href="#cb37-2172" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb37-2173"><a href="#cb37-2173" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Q2: Do 'Recycled' (Stale) leads still convert?"</span>)</span>
<span id="cb37-2174"><a href="#cb37-2174" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb37-2175"><a href="#cb37-2175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2176"><a href="#cb37-2176" aria-hidden="true" tabindex="-1"></a>q2_evidence <span class="op">=</span> <span class="st">""</span></span>
<span id="cb37-2177"><a href="#cb37-2177" aria-hidden="true" tabindex="-1"></a>q2_verdict <span class="op">=</span> <span class="st">""</span></span>
<span id="cb37-2178"><a href="#cb37-2178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2179"><a href="#cb37-2179" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'is_stale'</span> <span class="kw">in</span> validation_df.columns:</span>
<span id="cb37-2180"><a href="#cb37-2180" aria-hidden="true" tabindex="-1"></a>    stale_df <span class="op">=</span> validation_df[validation_df[<span class="st">'is_stale'</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb37-2181"><a href="#cb37-2181" aria-hidden="true" tabindex="-1"></a>    fresh_df <span class="op">=</span> validation_df[validation_df[<span class="st">'is_fresh'</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb37-2182"><a href="#cb37-2182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2183"><a href="#cb37-2183" aria-hidden="true" tabindex="-1"></a>    stale_conv <span class="op">=</span> stale_df[<span class="st">'actual_outcome'</span>].mean() <span class="cf">if</span> <span class="bu">len</span>(stale_df) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb37-2184"><a href="#cb37-2184" aria-hidden="true" tabindex="-1"></a>    stale_n <span class="op">=</span> <span class="bu">len</span>(stale_df)</span>
<span id="cb37-2185"><a href="#cb37-2185" aria-hidden="true" tabindex="-1"></a>    fresh_conv <span class="op">=</span> fresh_df[<span class="st">'actual_outcome'</span>].mean() <span class="cf">if</span> <span class="bu">len</span>(fresh_df) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb37-2186"><a href="#cb37-2186" aria-hidden="true" tabindex="-1"></a>    fresh_n <span class="op">=</span> <span class="bu">len</span>(fresh_df)</span>
<span id="cb37-2187"><a href="#cb37-2187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2188"><a href="#cb37-2188" aria-hidden="true" tabindex="-1"></a>    q2_evidence <span class="op">=</span> <span class="ss">f"Stale (&gt;180d): </span><span class="sc">{</span>stale_conv<span class="sc">:.1%}</span><span class="ss"> (n=</span><span class="sc">{</span>stale_n<span class="sc">:,}</span><span class="ss">) vs Fresh (&lt;30d): </span><span class="sc">{</span>fresh_conv<span class="sc">:.1%}</span><span class="ss">"</span></span>
<span id="cb37-2189"><a href="#cb37-2189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2190"><a href="#cb37-2190" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> stale_conv <span class="op">&gt;</span> baseline_conv <span class="op">*</span> <span class="fl">0.8</span>:</span>
<span id="cb37-2191"><a href="#cb37-2191" aria-hidden="true" tabindex="-1"></a>        q2_verdict <span class="op">=</span> <span class="st">"YES - Still viable"</span></span>
<span id="cb37-2192"><a href="#cb37-2192" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> stale_conv <span class="op">&gt;</span> baseline_conv <span class="op">*</span> <span class="fl">0.5</span>:</span>
<span id="cb37-2193"><a href="#cb37-2193" aria-hidden="true" tabindex="-1"></a>        q2_verdict <span class="op">=</span> <span class="st">"MARGINAL - Deprioritize"</span></span>
<span id="cb37-2194"><a href="#cb37-2194" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb37-2195"><a href="#cb37-2195" aria-hidden="true" tabindex="-1"></a>        q2_verdict <span class="op">=</span> <span class="st">"NO - Cut from funnel"</span></span>
<span id="cb37-2196"><a href="#cb37-2196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2197"><a href="#cb37-2197" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Stale Lead Conv (&gt;180 days): </span><span class="sc">{</span>stale_conv<span class="sc">:.1%}</span><span class="ss"> (n=</span><span class="sc">{</span>stale_n<span class="sc">:,}</span><span class="ss">)"</span>)</span>
<span id="cb37-2198"><a href="#cb37-2198" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Fresh Lead Conv (&lt;30 days): </span><span class="sc">{</span>fresh_conv<span class="sc">:.1%}</span><span class="ss"> (n=</span><span class="sc">{</span>fresh_n<span class="sc">:,}</span><span class="ss">)"</span>)</span>
<span id="cb37-2199"><a href="#cb37-2199" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Baseline Conv: </span><span class="sc">{</span>baseline_conv<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb37-2200"><a href="#cb37-2200" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  VERDICT: </span><span class="sc">{</span>q2_verdict<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-2201"><a href="#cb37-2201" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb37-2202"><a href="#cb37-2202" aria-hidden="true" tabindex="-1"></a>    q2_evidence <span class="op">=</span> <span class="st">"Lead age data unavailable"</span></span>
<span id="cb37-2203"><a href="#cb37-2203" aria-hidden="true" tabindex="-1"></a>    q2_verdict <span class="op">=</span> <span class="st">"CANNOT EVALUATE"</span></span>
<span id="cb37-2204"><a href="#cb37-2204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2205"><a href="#cb37-2205" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-2206"><a href="#cb37-2206" aria-hidden="true" tabindex="-1"></a><span class="co"># Q3: Are "Hidden Gems" (Unknown/Non-Mfg) real?</span></span>
<span id="cb37-2207"><a href="#cb37-2207" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-2208"><a href="#cb37-2208" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb37-2209"><a href="#cb37-2209" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Q3: Are 'Hidden Gems' (Unknown accounts) actually high converters?"</span>)</span>
<span id="cb37-2210"><a href="#cb37-2210" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb37-2211"><a href="#cb37-2211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2212"><a href="#cb37-2212" aria-hidden="true" tabindex="-1"></a>q3_evidence <span class="op">=</span> <span class="st">""</span></span>
<span id="cb37-2213"><a href="#cb37-2213" aria-hidden="true" tabindex="-1"></a>q3_verdict <span class="op">=</span> <span class="st">""</span></span>
<span id="cb37-2214"><a href="#cb37-2214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2215"><a href="#cb37-2215" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'is_hidden_gem'</span> <span class="kw">in</span> validation_df.columns:</span>
<span id="cb37-2216"><a href="#cb37-2216" aria-hidden="true" tabindex="-1"></a>    gem_df <span class="op">=</span> validation_df[validation_df[<span class="st">'is_hidden_gem'</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb37-2217"><a href="#cb37-2217" aria-hidden="true" tabindex="-1"></a>    non_gem_df <span class="op">=</span> validation_df[validation_df[<span class="st">'is_hidden_gem'</span>] <span class="op">==</span> <span class="dv">0</span>]</span>
<span id="cb37-2218"><a href="#cb37-2218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2219"><a href="#cb37-2219" aria-hidden="true" tabindex="-1"></a>    gem_conv <span class="op">=</span> gem_df[<span class="st">'actual_outcome'</span>].mean() <span class="cf">if</span> <span class="bu">len</span>(gem_df) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb37-2220"><a href="#cb37-2220" aria-hidden="true" tabindex="-1"></a>    gem_n <span class="op">=</span> <span class="bu">len</span>(gem_df)</span>
<span id="cb37-2221"><a href="#cb37-2221" aria-hidden="true" tabindex="-1"></a>    non_gem_conv <span class="op">=</span> non_gem_df[<span class="st">'actual_outcome'</span>].mean() <span class="cf">if</span> <span class="bu">len</span>(non_gem_df) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb37-2222"><a href="#cb37-2222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2223"><a href="#cb37-2223" aria-hidden="true" tabindex="-1"></a>    gem_lift <span class="op">=</span> gem_conv <span class="op">/</span> baseline_conv <span class="cf">if</span> baseline_conv <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb37-2224"><a href="#cb37-2224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2225"><a href="#cb37-2225" aria-hidden="true" tabindex="-1"></a>    q3_evidence <span class="op">=</span> <span class="ss">f"Hidden Gems: </span><span class="sc">{</span>gem_conv<span class="sc">:.1%}</span><span class="ss"> (n=</span><span class="sc">{</span>gem_n<span class="sc">:,}</span><span class="ss">), Lift: </span><span class="sc">{</span>gem_lift<span class="sc">:.1f}</span><span class="ss">x"</span></span>
<span id="cb37-2226"><a href="#cb37-2226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2227"><a href="#cb37-2227" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> gem_conv <span class="op">&gt;</span> baseline_conv <span class="op">*</span> <span class="fl">1.5</span>:</span>
<span id="cb37-2228"><a href="#cb37-2228" aria-hidden="true" tabindex="-1"></a>        q3_verdict <span class="op">=</span> <span class="st">"YES - Prioritize immediately"</span></span>
<span id="cb37-2229"><a href="#cb37-2229" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> gem_conv <span class="op">&gt;</span> baseline_conv:</span>
<span id="cb37-2230"><a href="#cb37-2230" aria-hidden="true" tabindex="-1"></a>        q3_verdict <span class="op">=</span> <span class="st">"YES - Above baseline"</span></span>
<span id="cb37-2231"><a href="#cb37-2231" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb37-2232"><a href="#cb37-2232" aria-hidden="true" tabindex="-1"></a>        q3_verdict <span class="op">=</span> <span class="st">"NO - Below baseline"</span></span>
<span id="cb37-2233"><a href="#cb37-2233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2234"><a href="#cb37-2234" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Hidden Gem Conv: </span><span class="sc">{</span>gem_conv<span class="sc">:.1%}</span><span class="ss"> (n=</span><span class="sc">{</span>gem_n<span class="sc">:,}</span><span class="ss">)"</span>)</span>
<span id="cb37-2235"><a href="#cb37-2235" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Non-Gem Conv: </span><span class="sc">{</span>non_gem_conv<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb37-2236"><a href="#cb37-2236" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Baseline Conv: </span><span class="sc">{</span>baseline_conv<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb37-2237"><a href="#cb37-2237" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Lift: </span><span class="sc">{</span>gem_lift<span class="sc">:.1f}</span><span class="ss">x"</span>)</span>
<span id="cb37-2238"><a href="#cb37-2238" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  VERDICT: </span><span class="sc">{</span>q3_verdict<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-2239"><a href="#cb37-2239" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb37-2240"><a href="#cb37-2240" aria-hidden="true" tabindex="-1"></a>    q3_evidence <span class="op">=</span> <span class="st">"Hidden gem flag unavailable"</span></span>
<span id="cb37-2241"><a href="#cb37-2241" aria-hidden="true" tabindex="-1"></a>    q3_verdict <span class="op">=</span> <span class="st">"CANNOT EVALUATE"</span></span>
<span id="cb37-2242"><a href="#cb37-2242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2243"><a href="#cb37-2243" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-2244"><a href="#cb37-2244" aria-hidden="true" tabindex="-1"></a><span class="co"># Q4: Does "Capital Density" (Industry-weighted size) matter?</span></span>
<span id="cb37-2245"><a href="#cb37-2245" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-2246"><a href="#cb37-2246" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb37-2247"><a href="#cb37-2247" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Q4: Does 'Capital Density' (budget proxy) correlate with conversion?"</span>)</span>
<span id="cb37-2248"><a href="#cb37-2248" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb37-2249"><a href="#cb37-2249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2250"><a href="#cb37-2250" aria-hidden="true" tabindex="-1"></a>q4_evidence <span class="op">=</span> <span class="st">""</span></span>
<span id="cb37-2251"><a href="#cb37-2251" aria-hidden="true" tabindex="-1"></a>q4_verdict <span class="op">=</span> <span class="st">""</span></span>
<span id="cb37-2252"><a href="#cb37-2252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2253"><a href="#cb37-2253" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'capital_density_log'</span> <span class="kw">in</span> validation_df.columns:</span>
<span id="cb37-2254"><a href="#cb37-2254" aria-hidden="true" tabindex="-1"></a>    cap_corr <span class="op">=</span> validation_df[<span class="st">'capital_density_log'</span>].corr(validation_df[<span class="st">'actual_outcome'</span>])</span>
<span id="cb37-2255"><a href="#cb37-2255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2256"><a href="#cb37-2256" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Quartile analysis</span></span>
<span id="cb37-2257"><a href="#cb37-2257" aria-hidden="true" tabindex="-1"></a>    validation_df[<span class="st">'cap_quartile'</span>] <span class="op">=</span> pd.qcut(validation_df[<span class="st">'capital_density_log'</span>], <span class="dv">4</span>, labels<span class="op">=</span>[<span class="st">'Q1-Low'</span>, <span class="st">'Q2'</span>, <span class="st">'Q3'</span>, <span class="st">'Q4-High'</span>])</span>
<span id="cb37-2258"><a href="#cb37-2258" aria-hidden="true" tabindex="-1"></a>    quartile_conv <span class="op">=</span> validation_df.groupby(<span class="st">'cap_quartile'</span>)[<span class="st">'actual_outcome'</span>].mean()</span>
<span id="cb37-2259"><a href="#cb37-2259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2260"><a href="#cb37-2260" aria-hidden="true" tabindex="-1"></a>    q1_conv <span class="op">=</span> quartile_conv.get(<span class="st">'Q1-Low'</span>, <span class="dv">0</span>)</span>
<span id="cb37-2261"><a href="#cb37-2261" aria-hidden="true" tabindex="-1"></a>    q4_conv <span class="op">=</span> quartile_conv.get(<span class="st">'Q4-High'</span>, <span class="dv">0</span>)</span>
<span id="cb37-2262"><a href="#cb37-2262" aria-hidden="true" tabindex="-1"></a>    q4_lift <span class="op">=</span> q4_conv <span class="op">/</span> q1_conv <span class="cf">if</span> q1_conv <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb37-2263"><a href="#cb37-2263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2264"><a href="#cb37-2264" aria-hidden="true" tabindex="-1"></a>    q4_evidence <span class="op">=</span> <span class="ss">f"Correlation: </span><span class="sc">{</span>cap_corr<span class="sc">:.3f}</span><span class="ss">, Q4/Q1 Lift: </span><span class="sc">{</span>q4_lift<span class="sc">:.1f}</span><span class="ss">x"</span></span>
<span id="cb37-2265"><a href="#cb37-2265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2266"><a href="#cb37-2266" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">abs</span>(cap_corr) <span class="op">&gt;</span> <span class="fl">0.1</span>:</span>
<span id="cb37-2267"><a href="#cb37-2267" aria-hidden="true" tabindex="-1"></a>        q4_verdict <span class="op">=</span> <span class="st">"YES - Significant signal"</span></span>
<span id="cb37-2268"><a href="#cb37-2268" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">abs</span>(cap_corr) <span class="op">&gt;</span> <span class="fl">0.05</span>:</span>
<span id="cb37-2269"><a href="#cb37-2269" aria-hidden="true" tabindex="-1"></a>        q4_verdict <span class="op">=</span> <span class="st">"WEAK - Minor signal"</span></span>
<span id="cb37-2270"><a href="#cb37-2270" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb37-2271"><a href="#cb37-2271" aria-hidden="true" tabindex="-1"></a>        q4_verdict <span class="op">=</span> <span class="st">"NO - Not predictive"</span></span>
<span id="cb37-2272"><a href="#cb37-2272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2273"><a href="#cb37-2273" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Correlation with target: </span><span class="sc">{</span>cap_corr<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb37-2274"><a href="#cb37-2274" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Q1 (Low Budget) Conv: </span><span class="sc">{</span>q1_conv<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb37-2275"><a href="#cb37-2275" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Q4 (High Budget) Conv: </span><span class="sc">{</span>q4_conv<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb37-2276"><a href="#cb37-2276" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Q4/Q1 Lift: </span><span class="sc">{</span>q4_lift<span class="sc">:.1f}</span><span class="ss">x"</span>)</span>
<span id="cb37-2277"><a href="#cb37-2277" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  VERDICT: </span><span class="sc">{</span>q4_verdict<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-2278"><a href="#cb37-2278" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb37-2279"><a href="#cb37-2279" aria-hidden="true" tabindex="-1"></a>    q4_evidence <span class="op">=</span> <span class="st">"Capital density data unavailable"</span></span>
<span id="cb37-2280"><a href="#cb37-2280" aria-hidden="true" tabindex="-1"></a>    q4_verdict <span class="op">=</span> <span class="st">"CANNOT EVALUATE"</span></span>
<span id="cb37-2281"><a href="#cb37-2281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2282"><a href="#cb37-2282" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-2283"><a href="#cb37-2283" aria-hidden="true" tabindex="-1"></a><span class="co"># Q5: Does "Intent Strength" (Priority Encoding) work?</span></span>
<span id="cb37-2284"><a href="#cb37-2284" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-2285"><a href="#cb37-2285" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb37-2286"><a href="#cb37-2286" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Q5: Does 'Intent Strength' (priority encoding) predict conversion?"</span>)</span>
<span id="cb37-2287"><a href="#cb37-2287" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb37-2288"><a href="#cb37-2288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2289"><a href="#cb37-2289" aria-hidden="true" tabindex="-1"></a>q5_evidence <span class="op">=</span> <span class="st">""</span></span>
<span id="cb37-2290"><a href="#cb37-2290" aria-hidden="true" tabindex="-1"></a>q5_verdict <span class="op">=</span> <span class="st">""</span></span>
<span id="cb37-2291"><a href="#cb37-2291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2292"><a href="#cb37-2292" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'intent_strength'</span> <span class="kw">in</span> validation_df.columns:</span>
<span id="cb37-2293"><a href="#cb37-2293" aria-hidden="true" tabindex="-1"></a>    intent_corr <span class="op">=</span> validation_df[<span class="st">'intent_strength'</span>].corr(validation_df[<span class="st">'actual_outcome'</span>])</span>
<span id="cb37-2294"><a href="#cb37-2294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2295"><a href="#cb37-2295" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Group by intent level</span></span>
<span id="cb37-2296"><a href="#cb37-2296" aria-hidden="true" tabindex="-1"></a>    intent_conv <span class="op">=</span> validation_df.groupby(<span class="st">'intent_strength'</span>)[<span class="st">'actual_outcome'</span>].agg([<span class="st">'mean'</span>, <span class="st">'count'</span>])</span>
<span id="cb37-2297"><a href="#cb37-2297" aria-hidden="true" tabindex="-1"></a>    intent_conv <span class="op">=</span> intent_conv.sort_index(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb37-2298"><a href="#cb37-2298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2299"><a href="#cb37-2299" aria-hidden="true" tabindex="-1"></a>    high_intent_conv <span class="op">=</span> validation_df[validation_df[<span class="st">'intent_strength'</span>] <span class="op">&gt;=</span> <span class="dv">4</span>][<span class="st">'actual_outcome'</span>].mean()</span>
<span id="cb37-2300"><a href="#cb37-2300" aria-hidden="true" tabindex="-1"></a>    low_intent_conv <span class="op">=</span> validation_df[validation_df[<span class="st">'intent_strength'</span>] <span class="op">&lt;=</span> <span class="dv">1</span>][<span class="st">'actual_outcome'</span>].mean()</span>
<span id="cb37-2301"><a href="#cb37-2301" aria-hidden="true" tabindex="-1"></a>    intent_lift <span class="op">=</span> high_intent_conv <span class="op">/</span> low_intent_conv <span class="cf">if</span> low_intent_conv <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb37-2302"><a href="#cb37-2302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2303"><a href="#cb37-2303" aria-hidden="true" tabindex="-1"></a>    q5_evidence <span class="op">=</span> <span class="ss">f"Correlation: </span><span class="sc">{</span>intent_corr<span class="sc">:.3f}</span><span class="ss">, High/Low Lift: </span><span class="sc">{</span>intent_lift<span class="sc">:.1f}</span><span class="ss">x"</span></span>
<span id="cb37-2304"><a href="#cb37-2304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2305"><a href="#cb37-2305" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> intent_corr <span class="op">&gt;</span> <span class="fl">0.1</span>:</span>
<span id="cb37-2306"><a href="#cb37-2306" aria-hidden="true" tabindex="-1"></a>        q5_verdict <span class="op">=</span> <span class="st">"YES - Strong signal"</span></span>
<span id="cb37-2307"><a href="#cb37-2307" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> intent_corr <span class="op">&gt;</span> <span class="fl">0.05</span>:</span>
<span id="cb37-2308"><a href="#cb37-2308" aria-hidden="true" tabindex="-1"></a>        q5_verdict <span class="op">=</span> <span class="st">"WEAK - Minor signal"</span></span>
<span id="cb37-2309"><a href="#cb37-2309" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb37-2310"><a href="#cb37-2310" aria-hidden="true" tabindex="-1"></a>        q5_verdict <span class="op">=</span> <span class="st">"NO - Encoding needs revision"</span></span>
<span id="cb37-2311"><a href="#cb37-2311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2312"><a href="#cb37-2312" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Correlation with target: </span><span class="sc">{</span>intent_corr<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb37-2313"><a href="#cb37-2313" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  High Intent (&gt;=4) Conv: </span><span class="sc">{</span>high_intent_conv<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb37-2314"><a href="#cb37-2314" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Low Intent (&lt;=1) Conv: </span><span class="sc">{</span>low_intent_conv<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb37-2315"><a href="#cb37-2315" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  High/Low Lift: </span><span class="sc">{</span>intent_lift<span class="sc">:.1f}</span><span class="ss">x"</span>)</span>
<span id="cb37-2316"><a href="#cb37-2316" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  VERDICT: </span><span class="sc">{</span>q5_verdict<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-2317"><a href="#cb37-2317" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb37-2318"><a href="#cb37-2318" aria-hidden="true" tabindex="-1"></a>    q5_evidence <span class="op">=</span> <span class="st">"Intent strength data unavailable"</span></span>
<span id="cb37-2319"><a href="#cb37-2319" aria-hidden="true" tabindex="-1"></a>    q5_verdict <span class="op">=</span> <span class="st">"CANNOT EVALUATE"</span></span>
<span id="cb37-2320"><a href="#cb37-2320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2321"><a href="#cb37-2321" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-2322"><a href="#cb37-2322" aria-hidden="true" tabindex="-1"></a><span class="co"># Q6: Does "Role-Product Match" increase conversion?</span></span>
<span id="cb37-2323"><a href="#cb37-2323" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-2324"><a href="#cb37-2324" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb37-2325"><a href="#cb37-2325" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Q6: Does 'Role-Product Match' (title alignment) increase conversion?"</span>)</span>
<span id="cb37-2326"><a href="#cb37-2326" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb37-2327"><a href="#cb37-2327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2328"><a href="#cb37-2328" aria-hidden="true" tabindex="-1"></a>q6_evidence <span class="op">=</span> <span class="st">""</span></span>
<span id="cb37-2329"><a href="#cb37-2329" aria-hidden="true" tabindex="-1"></a>q6_verdict <span class="op">=</span> <span class="st">""</span></span>
<span id="cb37-2330"><a href="#cb37-2330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2331"><a href="#cb37-2331" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'role_product_match'</span> <span class="kw">in</span> validation_df.columns:</span>
<span id="cb37-2332"><a href="#cb37-2332" aria-hidden="true" tabindex="-1"></a>    matched_df <span class="op">=</span> validation_df[validation_df[<span class="st">'role_product_match'</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb37-2333"><a href="#cb37-2333" aria-hidden="true" tabindex="-1"></a>    unmatched_df <span class="op">=</span> validation_df[validation_df[<span class="st">'role_product_match'</span>] <span class="op">==</span> <span class="dv">0</span>]</span>
<span id="cb37-2334"><a href="#cb37-2334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2335"><a href="#cb37-2335" aria-hidden="true" tabindex="-1"></a>    matched_conv <span class="op">=</span> matched_df[<span class="st">'actual_outcome'</span>].mean() <span class="cf">if</span> <span class="bu">len</span>(matched_df) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb37-2336"><a href="#cb37-2336" aria-hidden="true" tabindex="-1"></a>    matched_n <span class="op">=</span> <span class="bu">len</span>(matched_df)</span>
<span id="cb37-2337"><a href="#cb37-2337" aria-hidden="true" tabindex="-1"></a>    unmatched_conv <span class="op">=</span> unmatched_df[<span class="st">'actual_outcome'</span>].mean() <span class="cf">if</span> <span class="bu">len</span>(unmatched_df) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb37-2338"><a href="#cb37-2338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2339"><a href="#cb37-2339" aria-hidden="true" tabindex="-1"></a>    match_lift <span class="op">=</span> matched_conv <span class="op">/</span> unmatched_conv <span class="cf">if</span> unmatched_conv <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb37-2340"><a href="#cb37-2340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2341"><a href="#cb37-2341" aria-hidden="true" tabindex="-1"></a>    q6_evidence <span class="op">=</span> <span class="ss">f"Matched: </span><span class="sc">{</span>matched_conv<span class="sc">:.1%}</span><span class="ss"> (n=</span><span class="sc">{</span>matched_n<span class="sc">:,}</span><span class="ss">), Lift: </span><span class="sc">{</span>match_lift<span class="sc">:.1f}</span><span class="ss">x"</span></span>
<span id="cb37-2342"><a href="#cb37-2342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2343"><a href="#cb37-2343" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> matched_conv <span class="op">&gt;</span> unmatched_conv <span class="op">*</span> <span class="fl">1.2</span>:</span>
<span id="cb37-2344"><a href="#cb37-2344" aria-hidden="true" tabindex="-1"></a>        q6_verdict <span class="op">=</span> <span class="st">"YES - Route by match"</span></span>
<span id="cb37-2345"><a href="#cb37-2345" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb37-2346"><a href="#cb37-2346" aria-hidden="true" tabindex="-1"></a>        q6_verdict <span class="op">=</span> <span class="st">"WEAK - Minor impact"</span></span>
<span id="cb37-2347"><a href="#cb37-2347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2348"><a href="#cb37-2348" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Matched Conv: </span><span class="sc">{</span>matched_conv<span class="sc">:.1%}</span><span class="ss"> (n=</span><span class="sc">{</span>matched_n<span class="sc">:,}</span><span class="ss">)"</span>)</span>
<span id="cb37-2349"><a href="#cb37-2349" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Unmatched Conv: </span><span class="sc">{</span>unmatched_conv<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb37-2350"><a href="#cb37-2350" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Lift: </span><span class="sc">{</span>match_lift<span class="sc">:.1f}</span><span class="ss">x"</span>)</span>
<span id="cb37-2351"><a href="#cb37-2351" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  VERDICT: </span><span class="sc">{</span>q6_verdict<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-2352"><a href="#cb37-2352" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb37-2353"><a href="#cb37-2353" aria-hidden="true" tabindex="-1"></a>    q6_evidence <span class="op">=</span> <span class="st">"Role-product match data unavailable"</span></span>
<span id="cb37-2354"><a href="#cb37-2354" aria-hidden="true" tabindex="-1"></a>    q6_verdict <span class="op">=</span> <span class="st">"CANNOT EVALUATE"</span></span>
<span id="cb37-2355"><a href="#cb37-2355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2356"><a href="#cb37-2356" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-2357"><a href="#cb37-2357" aria-hidden="true" tabindex="-1"></a><span class="co"># GENERATE START-OF-MEETING DATA BRIEF (Markdown Table)</span></span>
<span id="cb37-2358"><a href="#cb37-2358" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-2359"><a href="#cb37-2359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2360"><a href="#cb37-2360" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-2361"><a href="#cb37-2361" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"START-OF-MEETING DATA BRIEF"</span>)</span>
<span id="cb37-2362"><a href="#cb37-2362" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-2363"><a href="#cb37-2363" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"(Copy/Paste Ready for Sponsor Meeting Notes)"</span>)</span>
<span id="cb37-2364"><a href="#cb37-2364" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb37-2365"><a href="#cb37-2365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2366"><a href="#cb37-2366" aria-hidden="true" tabindex="-1"></a>brief_data <span class="op">=</span> {</span>
<span id="cb37-2367"><a href="#cb37-2367" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Strategic Question'</span>: [</span>
<span id="cb37-2368"><a href="#cb37-2368" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Are 'Toxic' channels (Ext Demand Gen) dragging us down?"</span>,</span>
<span id="cb37-2369"><a href="#cb37-2369" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Do 'Recycled' (Stale &gt;180d) leads still convert?"</span>,</span>
<span id="cb37-2370"><a href="#cb37-2370" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Are 'Hidden Gems' (Unknown/Non-Mfg) actually high converters?"</span>,</span>
<span id="cb37-2371"><a href="#cb37-2371" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Does 'Capital Density' (budget proxy) correlate with success?"</span>,</span>
<span id="cb37-2372"><a href="#cb37-2372" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Does 'Intent Strength' (priority encoding) predict conversion?"</span>,</span>
<span id="cb37-2373"><a href="#cb37-2373" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Does 'Role-Product Match' increase conversion?"</span></span>
<span id="cb37-2374"><a href="#cb37-2374" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb37-2375"><a href="#cb37-2375" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Data Evidence'</span>: [</span>
<span id="cb37-2376"><a href="#cb37-2376" aria-hidden="true" tabindex="-1"></a>        q1_evidence,</span>
<span id="cb37-2377"><a href="#cb37-2377" aria-hidden="true" tabindex="-1"></a>        q2_evidence,</span>
<span id="cb37-2378"><a href="#cb37-2378" aria-hidden="true" tabindex="-1"></a>        q3_evidence,</span>
<span id="cb37-2379"><a href="#cb37-2379" aria-hidden="true" tabindex="-1"></a>        q4_evidence,</span>
<span id="cb37-2380"><a href="#cb37-2380" aria-hidden="true" tabindex="-1"></a>        q5_evidence,</span>
<span id="cb37-2381"><a href="#cb37-2381" aria-hidden="true" tabindex="-1"></a>        q6_evidence</span>
<span id="cb37-2382"><a href="#cb37-2382" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb37-2383"><a href="#cb37-2383" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Verdict'</span>: [</span>
<span id="cb37-2384"><a href="#cb37-2384" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"**</span><span class="sc">{</span>q1_verdict<span class="sc">}</span><span class="ss">**"</span>,</span>
<span id="cb37-2385"><a href="#cb37-2385" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"**</span><span class="sc">{</span>q2_verdict<span class="sc">}</span><span class="ss">**"</span>,</span>
<span id="cb37-2386"><a href="#cb37-2386" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"**</span><span class="sc">{</span>q3_verdict<span class="sc">}</span><span class="ss">**"</span>,</span>
<span id="cb37-2387"><a href="#cb37-2387" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"**</span><span class="sc">{</span>q4_verdict<span class="sc">}</span><span class="ss">**"</span>,</span>
<span id="cb37-2388"><a href="#cb37-2388" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"**</span><span class="sc">{</span>q5_verdict<span class="sc">}</span><span class="ss">**"</span>,</span>
<span id="cb37-2389"><a href="#cb37-2389" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"**</span><span class="sc">{</span>q6_verdict<span class="sc">}</span><span class="ss">**"</span></span>
<span id="cb37-2390"><a href="#cb37-2390" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb37-2391"><a href="#cb37-2391" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-2392"><a href="#cb37-2392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2393"><a href="#cb37-2393" aria-hidden="true" tabindex="-1"></a>brief_df <span class="op">=</span> pd.DataFrame(brief_data)</span>
<span id="cb37-2394"><a href="#cb37-2394" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(brief_df.to_markdown(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb37-2395"><a href="#cb37-2395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2396"><a href="#cb37-2396" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-2397"><a href="#cb37-2397" aria-hidden="true" tabindex="-1"></a><span class="co"># ADDITIONAL SPONSOR TALKING POINTS</span></span>
<span id="cb37-2398"><a href="#cb37-2398" aria-hidden="true" tabindex="-1"></a><span class="co"># ==============================================================================</span></span>
<span id="cb37-2399"><a href="#cb37-2399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2400"><a href="#cb37-2400" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-2401"><a href="#cb37-2401" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"SPONSOR TALKING POINTS"</span>)</span>
<span id="cb37-2402"><a href="#cb37-2402" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-2403"><a href="#cb37-2403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2404"><a href="#cb37-2404" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"""</span></span>
<span id="cb37-2405"><a href="#cb37-2405" aria-hidden="true" tabindex="-1"></a><span class="ss">MODEL CREDIBILITY:</span></span>
<span id="cb37-2406"><a href="#cb37-2406" aria-hidden="true" tabindex="-1"></a><span class="ss">  - Test Set AUC: </span><span class="sc">{</span>FINAL_AUC<span class="sc">:.4f}</span><span class="ss"> (Holdout data, no data leakage)</span></span>
<span id="cb37-2407"><a href="#cb37-2407" aria-hidden="true" tabindex="-1"></a><span class="ss">  - 5-Fold Cross-Validation: Robust generalization</span></span>
<span id="cb37-2408"><a href="#cb37-2408" aria-hidden="true" tabindex="-1"></a><span class="ss">  - Champion Model: </span><span class="sc">{</span>CHAMPION_NAME<span class="sc">}</span></span>
<span id="cb37-2409"><a href="#cb37-2409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2410"><a href="#cb37-2410" aria-hidden="true" tabindex="-1"></a><span class="ss">BUSINESS IMPACT (Test Set Projection):</span></span>
<span id="cb37-2411"><a href="#cb37-2411" aria-hidden="true" tabindex="-1"></a><span class="ss">  - Optimal Threshold: </span><span class="sc">{</span>OPTIMAL_THRESHOLD<span class="sc">:.3f}</span></span>
<span id="cb37-2412"><a href="#cb37-2412" aria-hidden="true" tabindex="-1"></a><span class="ss">  - Max Profit: $</span><span class="sc">{</span>MAX_PROFIT<span class="sc">:,.0f}</span></span>
<span id="cb37-2413"><a href="#cb37-2413" aria-hidden="true" tabindex="-1"></a><span class="ss">  - SQLs Captured: </span><span class="sc">{</span>OPTIMAL_PCT_CAPTURE<span class="sc">:.0%}</span><span class="ss"> with </span><span class="sc">{</span>OPTIMAL_PCT_POP<span class="sc">:.0%}</span><span class="ss"> of calls</span></span>
<span id="cb37-2414"><a href="#cb37-2414" aria-hidden="true" tabindex="-1"></a><span class="ss">  - Projected Annual Lift: $</span><span class="sc">{</span>annualized_lift<span class="sc">:,.0f}</span></span>
<span id="cb37-2415"><a href="#cb37-2415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2416"><a href="#cb37-2416" aria-hidden="true" tabindex="-1"></a><span class="ss">KEY FEATURE DISCOVERIES:</span></span>
<span id="cb37-2417"><a href="#cb37-2417" aria-hidden="true" tabindex="-1"></a><span class="ss">  - Toxic Channels account for ~</span><span class="sc">{</span>toxic_n<span class="sc">:,}</span><span class="ss"> leads but convert at </span><span class="sc">{</span>toxic_conv<span class="sc">:.1%}</span></span>
<span id="cb37-2418"><a href="#cb37-2418" aria-hidden="true" tabindex="-1"></a><span class="ss">  - Hidden Gems convert at </span><span class="sc">{</span>gem_conv<span class="sc">:.1%}</span><span class="ss"> (</span><span class="sc">{</span>gem_lift<span class="sc">:.1f}</span><span class="ss">x lift vs baseline)</span></span>
<span id="cb37-2419"><a href="#cb37-2419" aria-hidden="true" tabindex="-1"></a><span class="ss">  - Golden Segment (Top Decile) converts at </span><span class="sc">{</span>golden_segment_rate<span class="sc">:.1%}</span></span>
<span id="cb37-2420"><a href="#cb37-2420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2421"><a href="#cb37-2421" aria-hidden="true" tabindex="-1"></a><span class="ss">RECOMMENDED ACTIONS:</span></span>
<span id="cb37-2422"><a href="#cb37-2422" aria-hidden="true" tabindex="-1"></a><span class="ss">  1. Deploy scoring engine with threshold </span><span class="sc">{</span>OPTIMAL_THRESHOLD<span class="sc">:.2f}</span></span>
<span id="cb37-2423"><a href="#cb37-2423" aria-hidden="true" tabindex="-1"></a><span class="ss">  2. Flag and deprioritize Toxic channel leads in CRM</span></span>
<span id="cb37-2424"><a href="#cb37-2424" aria-hidden="true" tabindex="-1"></a><span class="ss">  3. Create "Hidden Gem" routing rule for consultants/small firms</span></span>
<span id="cb37-2425"><a href="#cb37-2425" aria-hidden="true" tabindex="-1"></a><span class="ss">  4. Purchase outbound lists matching Golden Segment profile</span></span>
<span id="cb37-2426"><a href="#cb37-2426" aria-hidden="true" tabindex="-1"></a><span class="ss">"""</span>)</span>
<span id="cb37-2427"><a href="#cb37-2427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2428"><a href="#cb37-2428" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-2429"><a href="#cb37-2429" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"VALIDATION COMPLETE - READY FOR SPONSOR MEETING"</span>)</span>
<span id="cb37-2430"><a href="#cb37-2430" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb37-2431"><a href="#cb37-2431" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-2432"><a href="#cb37-2432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2433"><a href="#cb37-2433" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb37-2434"><a href="#cb37-2434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2435"><a href="#cb37-2435" aria-hidden="true" tabindex="-1"></a>*Model V9 (Dynamic Semantic Authority Edition) generated for MSBA Capstone Case Competition - Spring 2026*</span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>